# 享元模式

类型：结构型

目的：核心思想是共享尽可能多的对象，以此来减少内存占用和提高性能。

## 结构

享元模式通常包含以下角色：

- **享元工厂（Flyweight Factory）**:负责创建和管理享元对象，通常包含一个池（缓存）用于存储和复用已经创建的享元对象。
- **具体享元（Concrete Flyweight）**:实现了抽象享元接口，包含了内部状态和外部状态。内部状态是可以被共享的，而外部状态则由客户端传递。
- **抽象享元（Flyweight）**:定义了具体享元和非共享享元的接口，通常包含了设置外部状态的方法。
- **非共享具体享元类（UnsharedConcreteFlyweight）（可选）**：如果需要，可以创建一些不共享的享元对象，即不通过享元工厂创建。
- **客户端（Client）**:使用享元工厂获取享元对象，并通过设置外部状态来操作享元对象。客户端通常不需要关心享元对象的具体实现。

## 适用场景

- 当系统中存在大量相似或相同的对象。
- 对象的创建和销毁成本较高。
- 对象的状态可以外部化，即对象的部分状态可以独立于对象本身存在。

## 优缺点

- 优点：
  - **减少内存占用**：通过共享对象减少了内存的占用。
  - **提高性能**：减少了创建对象的时间，提高了性能。

- 缺点：
  - **增加了系统的复杂性**：需要分离出内部状态和外部状态，增加了设计复杂性。
  - **状态共享**：如果享元对象的状态发生变化，可能影响到所有共享该对象的客户端。
  - **线程安全问题**：如果外部状态处理不当，可能会引起线程安全问题。

## 注意事项

- **状态分离**：明确区分内部状态和外部状态，避免混淆。
- **享元工厂**：使用享元工厂来控制对象的创建和复用，确保对象的一致性和完整性。

## 示例

```java
// 享元接口
interface Flyweight {
    void operation(String extrinsicState);
}

// 共享享元
class ConcreteFlyweight implements Flyweight {
    private final String intrinsicState;

    public ConcreteFlyweight(String intrinsicState) {
        this.intrinsicState = intrinsicState;
    }

    @Override
    public void operation(String extrinsicState) {
        // 共享享元的操作，结合内部状态和外部状态
        System.out.println("ConcreteFlyweight with intrinsic state " + intrinsicState + " and extrinsic state " + extrinsicState);
    }
}

// 非共享享元
class UnsharedFlyweight implements Flyweight {
    private String state;

    public UnsharedFlyweight(String state) {
        this.state = state;
    }

    @Override
    public void operation(String extrinsicState) {
        // 非共享享元的操作，通常包含特定于客户端的状态
        System.out.println("UnsharedFlyweight with state " + state + " and extrinsic state " + extrinsicState);
    }
}

// 享元工厂
class FlyweightFactory {
    private static Map<String, Flyweight> flyweights = new HashMap<>();

    public static Flyweight getFlyweight(String intrinsicState) {
        if (!flyweights.containsKey(intrinsicState)) {
            flyweights.put(intrinsicState, new ConcreteFlyweight(intrinsicState));
        }
        return flyweights.get(intrinsicState);
    }
}

// 客户端代码
public class FlyweightPatternDemo {
    public static void main(String[] args) {
        FlyweightFactory factory = new FlyweightFactory();

        // 获取共享享元
        Flyweight sharedFlyweight = factory.getFlyweight("SharedState");
        sharedFlyweight.operation("ExtrinsicState1");

        // 创建非共享享元
        Flyweight unsharedFlyweight = new UnsharedFlyweight("UnsharedState");
        unsharedFlyweight.operation("ExtrinsicState2");
    }
}
```
