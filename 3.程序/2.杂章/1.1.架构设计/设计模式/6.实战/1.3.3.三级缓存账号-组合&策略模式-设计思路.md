
# 设计思路

在账号三级缓存的设计中，**组合模式（Composite Pattern）**和**策略模式（Strategy Pattern）**的结合使用主要基于以下设计目标：**解耦缓存层级结构、灵活管理缓存策略、统一上层调用接口，并支持动态响应缓存数据变化**。以下是具体原因分析：

## **一、组合模式：统一缓存层级结构，简化上层调用**

### 1. **将多级缓存抽象为统一接口**

- 三级缓存（如`localCache`、`memoryCache`、`remoteCache`）具有相似的行为（如`get`、`put`、`delete`），但实现逻辑不同。  
- **组合模式**将单个缓存（叶子节点）和缓存组（组合节点，如多级缓存的组合）抽象为统一的`CacheComponent`接口，上层代码无需关心具体是单个缓存还是组合缓存，只需通过接口调用。  

     ```java
     interface CacheComponent {
         Object get(String key);
         void put(String key, Object value);
         void delete(String key);
         // 新增：支持注册回调（结合策略模式）
         void setUpdateCallback(Callback callback);
     }
     ```

### 2. **灵活构建缓存层级组合**

- 组合模式允许将缓存层级动态组合（如先查本地缓存，再查内存缓存，最后查远程缓存），形成树状结构。  
- 例如，定义`CompositeCache`作为组合节点，包含多个`CacheComponent`子节点（可以是单个缓存或其他组合缓存），遍历子节点实现多级缓存的协同工作。  

     ```java
     class CompositeCache implements CacheComponent {
         private List<CacheComponent> children = new ArrayList<>();
         
         public void addChild(CacheComponent component) {
             children.add(component);
         }
         
         @Override
         public Object get(String key) {
             for (CacheComponent child : children) {
                 Object value = child.get(key);
                 if (value != null) {
                     return value; // 按顺序查询，优先返回命中的缓存
                 }
             }
             return null;
         }
         // 其他方法（put/delete）可根据策略决定是否更新所有子节点
     }
     ```

### 3. **解耦上层逻辑与缓存实现**

- 上层代码（如业务层）只需调用`CacheComponent`接口，无需关心缓存是单层还是多层，也无需处理多级缓存的查询顺序、更新策略等细节。  
- **优点**：简化调用逻辑，增强代码可维护性；方便后续扩展缓存层级（如新增数据库缓存），只需实现`CacheComponent`接口并加入组合即可。

## **二、策略模式：动态管理缓存策略，支持灵活扩展**

### 1. **将差异化逻辑封装为策略**

- 不同缓存层级（如`remoteCache`、`memoryCache`）在数据更新、失效策略、回调机制等方面存在差异。  
- **策略模式**将这些差异化逻辑（如“查询策略”“更新策略”“失效策略”）封装为独立的策略类，实现接口`CacheStrategy`：  

     ```java
     interface CacheStrategy {
         Object doGet(CacheComponent cache, String key); // 查询策略
         void doPut(CacheComponent cache, String key, Object value); // 更新策略
         void doDelete(CacheComponent cache, String key); // 删除策略
     }
     ```

### 2. **动态切换缓存行为**

- 每个缓存组件（如`remoteCache`）可以关联不同的策略对象，例如：  
  - `RemoteCache`使用带回调的更新策略（`CallbackUpdateStrategy`），当数据变化时触发上层回调；  
  - `MemoryCache`使用本地失效策略（`LocalEvictionStrategy`），无需回调。  
- 通过策略模式，缓存组件的行为可以在运行时动态切换，避免硬编码逻辑。

### 3. **支持回调机制的统一处理**

- 在策略模式中，将“回调逻辑”封装到策略类中。例如，当`remoteCache`的数据变化时，其关联的`UpdateStrategy`会调用上层注册的回调方法：  

     ```java
     class CallbackUpdateStrategy implements CacheStrategy {
         private Callback callback;
         
         public void setCallback(Callback callback) {
             this.callback = callback;
         }
         
         @Override
         public void doPut(CacheComponent cache, String key, Object value) {
             // 执行远程缓存更新
             cache.put(key, value);
             // 触发回调
             if (callback != null) {
                 callback.onDataChanged(key, value);
             }
         }
     }
     ```

- 组合模式中的`CompositeCache`可以统一调用子节点的回调方法，确保上层能响应任意层级缓存的变化。

## **三、组合模式 + 策略模式的协同优势**

### 1. **结构与行为的解耦**

- **组合模式**负责管理缓存的层级结构（“有哪些缓存，如何组织”）；  
- **策略模式**负责管理每个缓存的具体行为（“如何查询、更新、失效”）。  
- 两者结合使代码结构清晰，符合“单一职责原则”。

### 2. **灵活扩展与复用**

- 新增缓存层级时，只需实现`CacheComponent`接口并加入组合（组合模式）；  
- 新增缓存策略时，只需实现`CacheStrategy`接口并关联到缓存组件（策略模式）。  
- 原有代码无需修改，符合“开闭原则”。

### 3. **统一接口与动态响应**

- 上层通过统一的`CacheComponent`接口调用缓存，无需关心底层细节；  
- 策略模式确保不同缓存（如`remoteCache`）的特殊行为（如回调）能被正确触发，组合模式则保证多层级缓存的变化能被上层统一感知。

## **总结：为什么选择这两种模式？**

| **设计目标**               | **组合模式的作用**                     | **策略模式的作用**                     |
|----------------------------|----------------------------------------|----------------------------------------|
| 统一多级缓存的调用接口      | 提供`CacheComponent`统一接口           | —                                      |
| 动态构建缓存层级关系        | 支持组合节点（如`CompositeCache`）     | —                                      |
| 解耦缓存行为与实现          | —                                      | 封装差异化策略（查询、更新、回调）     |
| 支持缓存策略动态切换        | —                                      | 策略类可独立扩展，运行时动态替换       |
| 上层统一响应缓存数据变化    | 组合节点遍历子节点触发回调             | 策略类中实现回调逻辑                   |

通过组合模式和策略模式的结合，账号三级缓存系统既能以灵活的结构组织多级缓存，又能通过策略动态管理各层级的特殊行为，同时保证上层代码以简洁的方式响应数据变化，最终实现高内聚、低耦合的可扩展设计。
