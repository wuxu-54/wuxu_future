# 发布依赖

## 普通发布(常用)

发布依赖到 Maven 仓库的具体步骤如下：

### 1. 准备 Maven 仓库

首先，你需要有一个 Maven 仓库。这可以是本地仓库，也可以是远程仓库，如 Sonatype 提供的 Nexus Repository Manager。如果是本地仓库，需要在本地准备一个目录作为 Maven 仓库的存储位置。

### 2. 配置项目属性

在项目的 `gradle.properties` 文件中配置 Maven 仓库信息，包括 POM 文件的相关信息，如 groupId、artifactId、version 等。

```properties
# 包信息
PROJ_GROUP=com.example
PROJ_VERSION=1.0.0

# 项目的描述
PROJ_WEBSITEURL=http://example.com
PROJ_ISSUETRACKERURL=http://example.com/issues
PROJ_DESCRIPTION=Example project

# Licence信息
PROJ_LICENCE_NAME=The Apache Software License, Version 2.0
PROJ_LICENCE_URL=http://www.apache.org/licenses/LICENSE-2.0.txt
PROJ_LICENCE_DEST=repo

# Developer 信息
DEVELOPER_ID=developer
DEVELOPER_NAME=Developer Name
DEVELOPER_EMAIL=developer@example.com
```

### 3. 配置 `build.gradle`

在模块的 `build.gradle` 文件中应用 Maven 插件，并配置上传任务。

```groovy
apply plugin: 'maven'

group = PROJ_GROUP
version = PROJ_VERSION

uploadArchives {
    repositories.mavenDeployer {
        repository(url: uri(PROJ_REPO_URL)) {
            authentication(userName: PROJ_USERNAME, password: PROJ_PASSWORD)
        }
        pom.groupId = PROJ_GROUP
        pom.artifactId = PROJ_ARTIFACTID
        pom.version = PROJ_VERSION
    }
}
```

补充发布到本地maven的示例（使用时，设置本地maven路径，然后引入依赖坐标即可）：

```groovy
apply plugin: 'maven'
uploadArchives {
    repositories {
        mavenDeployer {
            // 配置本地仓库路径，项目根目录下的repository目录中
            repository(url: uri("../build/Lib/repo"))
            pom.groupId = "com.wuxu.gradle"// 唯一标识（通常为模块包名，也可以任意）
            pom.artifactId = "test" // 项目名称（通常为类库模块名称，也可以任意）
            pom.version = "1.1.1" // 版本号
            pom.packaging = 'aar'
        }

    }
}
```

### 4. 执行发布任务

使用 Gradle 执行发布任务。这可以通过命令行或者在 IDE 中运行相应的 Gradle 任务完成。

```shell
./gradlew uploadArchives
```

### 5. 验证发布结果

发布完成后，验证 Maven 仓库中是否正确地包含了发布的构件。对于本地仓库，可以直接查看仓库目录；对于远程仓库，可以通过 Maven 客户端或者仓库的 Web 界面进行验证。

### 6. 发布到中央仓库（可选）

如果是发布到 Maven 中央仓库，需要遵循额外的步骤，包括注册 Sonatype 账号、创建和管理工单、上传依赖到缓存仓库，并进行发布。

以上步骤提供了一个基本的指南，用于将 Gradle 项目构建的构件发布到 Maven 仓库。具体细节可能会根据所使用的仓库和项目配置有所不同。

---

## 使用 Maven Publish 插件发布

### 详解

1. **使用 Maven Publish 插件**：
   要发布依赖到 Maven 仓库，你需要在你的 `build.gradle` 文件中应用 `maven-publish` 插件。这个插件提供了配置发布仓库和定义出版物（publications）的机制。

   ```groovy
   subprojects {
       apply plugin: 'java'
       apply plugin: 'maven-publish'
   }
   ```

2. **配置发布仓库**：
   使用 `publishing` 配置块来定义发布到哪些 Maven 仓库。可以配置本地仓库或远程仓库。

   ```groovy
   publishing {
       repositories {
           maven {
               name = 'localRepo'
               url = "file://${buildDir}/repo"
           }
       }
   }
   ```

3. **定义出版物**：
   在 `publishing` 配置中定义一个或多个出版物，指定构件的 `groupId`、`artifactId` 和 `version`，以及从哪个组件中生成这些构件。

   ```groovy
   publishing {
       publications {
           myApp(MavenPublication) {
               groupId = 'cn.hengyumo'
               artifactId = 'my-app'
               version = '0.0.1'
               from components.java
           }
       }
   }
   ```

4. **生成和发布任务**：
   配置完成后，Gradle 会生成两个任务：`publishMyAppPublicationToLocalRepoRepository` 和 `publishMyAppPublicationToMavenLocal`。这些任务负责将出版物发布到指定的仓库。

   ```sh
   publishMyAppPublicationToLocalRepoRepository - Publishes Maven publication 'myApp' to Maven repository 'localRepo'.
   publishMyAppPublicationToMavenLocal - Publishes Maven publication 'myApp' to the local Maven repository.
   ```

5. **执行发布任务**：
   使用以下命令执行发布操作：

   ```shell
   ./gradlew publishMyAppPublicationToLocalRepoRepository
   ```

   这会将 `myApp` 发布到指定的本地仓库位置，通常是项目的 `build` 目录下的 `repo` 目录。

### 示例

以下是一个完整的示例，展示了如何将一个 Java 库发布到本地 Maven 仓库：

```groovy
// 应用 Maven 插件和 Java 插件
apply plugin: 'java'
apply plugin: 'maven-publish'

// 配置发布仓库
publishing {
    repositories {
        maven {
            name = 'localRepo'
            url = "file://${buildDir}/repo" // 发布到本地仓库
        }
    }
    publications {
        myLib(MavenPublication) {
            // 定义 Maven 坐标
            groupId = 'com.example'
            artifactId = 'my-library'
            version = '1.0.0'

            // 从 Java 组件中生成构件
            from components.java

            // 可以添加额外的构件，如源码和 JavaDoc
            // artifact sourceJar {
            //     classifier "sources"
            // }
            // artifact javadocJar {
            //     classifier "javadoc"
            // }
        }
    }
}

// 创建 sourceJar 和 javadocJar 任务
task sourceJar(type: Jar) {
    from sourceSets.main.allSource
    classifier "sources"
}

task javadocJar(type: Jar) {
    from javadoc
    classifier "javadoc"
}

// 将 sourceJar 和 javadocJar 添加到 publications 中
publishing.publications.myLib.artifact sourceJar
publishing.publications.myLib.artifact javadocJar
```

在这个示例中，我们定义了一个名为 `myLib` 的 Maven 出版物，并将其发布到本地 Maven 仓库。我们还创建了额外的任务来生成源码和 JavaDoc JAR 文件，并将它们添加到出版物中。

通过这些步骤，你可以将 Gradle 项目构建的构件发布到 Maven 仓库，使得其他项目可以像使用常规 Maven 依赖一样使用你的项目。

---

## `uploadArchives`和`publishing`区别

`uploadArchives`和`publishing`（`maven-publish`插件）都是Gradle中用于发布构建产物到Maven仓库的任务和配置，但它们之间存在一些差异：

### uploadArchives

`uploadArchives`是Gradle的一个旧任务，用于将构建的工件（如JAR、WAR文件等）上传到远程或本地的Maven仓库。以下是`uploadArchives`的一些特点：

1. **简单配置**：`uploadArchives`的配置相对简单，适合快速上传构建产物到Maven仓库。
2. **自动POM生成**：`uploadArchives`会自动生成POM文件中的`<dependencies>`节点，使得依赖能够被正确传递。
3. **局限性**：`uploadArchives`不支持一些高级功能，如自定义POM文件、多版本发布等。
4. **使用方式**：在项目的`build.gradle`文件中配置`uploadArchives`，然后通过执行`./gradlew uploadArchives`命令来上传构建产物。

### publishing（maven-publish插件）

`publishing`是Gradle提供的一个新的配置方式，通过`maven-publish`插件实现，用于替代`uploadArchives`。以下是`publishing`的一些特点：

1. **灵活性和可配置性**：`publishing`提供了更高的灵活性和可配置性，允许自定义POM文件、发布多个版本等。
2. **支持多仓库**：可以配置多个仓库，同时支持发布到本地和远程仓库。
3. **高级功能**：支持签名、组件化发布、自定义任务依赖等高级功能。
4. **使用方式**：在项目的`build.gradle`文件中应用`maven-publish`插件，并配置`publishing`块，然后通过执行`./gradlew publish`命令来上传构建产物。

### 总结

- 如果你需要快速简单地上传构建产物到Maven仓库，并且不需要太多自定义配置，`uploadArchives`可能是一个合适的选择。
- 如果你需要更高级的功能，如自定义POM文件、多版本发布、签名等，那么`publishing`（`maven-publish`插件）会是更好的选择。

随着Gradle的发展，`maven-publish`插件逐渐成为推荐的发布方式，因为它提供了更多的功能和更好的扩展性。
