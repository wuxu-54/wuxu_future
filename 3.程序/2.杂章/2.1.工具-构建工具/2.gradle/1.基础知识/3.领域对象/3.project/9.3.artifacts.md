# artifacts

在 Gradle 里，`artifacts` 是一个重要概念，用于管理项目在构建过程中产生的可分发或可发布的文件，以下为你进行详细介绍：

## 基本概念

`artifacts`（构件）指的是项目构建所产生的输出文件，像 JAR 文件、WAR 文件、ZIP 文件、文档等都属于此类。在 Gradle 中，`project.artifacts` 是一个 `ArtifactContainer` 类型的实例，它充当一个容器，用来添加、管理和跟踪这些构建产物。

## 作用

- **构建产物管理**：可以明确指定哪些文件是项目的构建产物，方便对这些文件进行统一管理和操作。
- **发布与分发**：在将项目发布到 Maven 仓库、Nexus 仓库等远程存储库时，`artifacts` 中的文件会被作为发布的内容。
- **依赖传递**：在多模块项目中，一个模块的 `artifacts` 可以作为另一个模块的依赖，实现模块间的依赖传递。

## 内置配置与 `artifacts` 的关联

Gradle 有很多内置配置，部分配置与 `artifacts` 紧密相关，比如：

- **`archives` 配置**：这是一个常用配置，默认会关联项目生成的主要归档文件，像 JAR、WAR 等。例如，Java 项目中使用 `jar` 任务生成的 JAR 文件会自动添加到 `archives` 配置对应的 `artifacts` 中。

```groovy
// Java 项目默认将 JAR 文件添加到 archives 配置的 artifacts 中
apply plugin: 'java'

task customJar(type: Jar) {
    archiveBaseName.set('custom')
    from('src/main/java')
}

artifacts {
    archives customJar
}
```

## 添加 `artifacts`

可以通过 `project.artifacts` 的 `add` 方法将文件添加到构建产物集合中，也可以在 `artifacts` 代码块里添加。

### Groovy DSL 示例

```groovy
// 创建自定义配置
configurations {
    customArtifact
}

// 定义生成 ZIP 文件的任务
task createCustomZip(type: Zip) {
    archiveBaseName.set('custom')
    from('src/main/resources')
}

// 将生成的 ZIP 文件添加到 artifacts 中
artifacts {
    customArtifact createCustomZip.archiveFile
}
```

### Kotlin DSL 示例

```kotlin
// 创建自定义配置
val customArtifact by configurations.creating

// 定义生成 ZIP 文件的任务
val createCustomZip by tasks.creating(Zip::class) {
    archiveBaseName.set("custom")
    from("src/main/resources")
}

// 将生成的 ZIP 文件添加到 artifacts 中
artifacts {
    add("customArtifact", createCustomZip.archiveFile)
}
```

## 查询和使用 `artifacts`

可以通过配置名称来查询特定配置下的 `artifacts`。

### Groovy DSL 示例：查询和使用 `artifacts`

```groovy
configurations.customArtifact.allArtifacts.each { artifact ->
    println "Artifact: ${artifact.name}"
}
```

### Kotlin DSL 示例：查询和使用 `artifacts`

```kotlin
configurations["customArtifact"].allArtifacts.forEach { artifact ->
    println("Artifact: ${artifact.name}")
}
```

## 应用场景

- **多模块项目**：在多模块项目里，一个模块的 `artifacts` 能作为其他模块的依赖。比如，核心模块生成的 JAR 文件可被服务模块依赖使用。
- **发布到远程仓库**：将项目发布到 Maven 中央仓库、公司内部的 Nexus 仓库等远程存储库时，`artifacts` 中的文件会被打包并上传到指定仓库。
- **生成自定义分发包**：可以把项目中的不同文件（如可执行文件、配置文件、文档等）组合成自定义分发包，并添加到 `artifacts` 中，便于分发和部署。

## 注意事项

- **文件路径和名称**：添加 `artifacts` 时，要保证文件路径和名称正确，不然可能导致文件找不到或发布失败。
- **配置关联**：构建产物需与特定配置关联，这样在依赖解析和发布过程中才能正确处理。
- **版本管理**：若构建产物有版本信息，要确保版本号一致，避免在依赖传递和发布过程中出现版本冲突。

---

## 示例

```kotlin
/**
* 添加一个额外的Configuration，用于buildScript中以classpath方式依赖
*/
private fun addJarConfiguration(
    project: Project,
    buildType: String,
    createJarPackageTask: Task
) {
    val configurationName = "jar-${buildType}"
    val jarFile =
        project.file(project.buildDir.path + "/outputs/jar/${project.name}-${buildType}.jar")
    project.configurations.create(configurationName)
    project.artifacts.add(configurationName, jarFile) { //artifacts 是 project 对象的一个属性，表示项目的工件（artifacts）。artifacts 属性允许你添加和管理项目生成的文件（如 JAR、AAR 等），以便在发布或依赖管理时使用。
        it.builtBy(createJarPackageTask)
    }
}
```

### 代码片段回顾

```kotlin
project.artifacts.add(configurationName, jarFile) {
    it.builtBy(createJarPackageTask)
}
```

在这段代码中，`artifacts` 是 `project` 对象的一个属性，表示项目的工件（artifacts）。`artifacts` 属性允许你添加和管理项目生成的文件（如 JAR、AAR 等），以便在发布或依赖管理时使用。

### 具体解释

#### `artifacts` 属性

- **`project.artifacts`**：
  - 这是 Gradle `Project` 对象的一个属性，返回一个 `ArtifactHandler` 实例。
  - `ArtifactHandler` 提供了用于管理和操作项目工件的方法。

#### `add` 方法

- **`add(configurationName, jarFile)`**：
  - `add` 方法用于将指定的文件（`jarFile`）作为工件添加到指定的配置（`configurationName`）中。
  - 第一个参数是配置名称，例如 `jar-debug` 或 `jar-release`。
  - 第二个参数是要添加的文件对象（`jarFile`）。

#### `builtBy` 方法

- **`it.builtBy(createJarPackageTask)`**：
  - `builtBy` 方法指定了生成该工件的任务（`createJarPackageTask`）。
  - 这确保了在需要该工件时，Gradle 会先执行指定的任务以确保文件是最新的。

### 总结

`artifacts` 在这段代码中的作用是：

1. **管理工件**：通过 `project.artifacts` 获取项目的工件管理器。
2. **添加工件**：使用 `add` 方法将生成的 JAR 文件添加到指定的配置中。
3. **关联任务**：使用 `builtBy` 方法指定生成该工件的任务，确保文件是最新的。

### 示例用法

假设 `buildType` 的值为 `debug`，那么这段代码会将 `aar-to-jar-plugin-debug.jar` 文件添加到名为 `jar-debug` 的配置中，并指定 `createJarPackageTask` 任务来生成该文件：

```kotlin
val configurationName = "jar-debug"
val jarFile = project.file("${project.buildDir.path}/outputs/jar/aar-to-jar-plugin-debug.jar")
project.configurations.create(configurationName)
project.artifacts.add(configurationName, jarFile) {
    it.builtBy(createJarPackageTask)
}
```

### 更多信息

如果你想进一步了解 `artifacts` 和相关方法的具体用法，可以参考 [Gradle 官方文档](https://docs.gradle.org/current/dsl/org.gradle.api.artifacts.dsl.ArtifactHandler.html)。
