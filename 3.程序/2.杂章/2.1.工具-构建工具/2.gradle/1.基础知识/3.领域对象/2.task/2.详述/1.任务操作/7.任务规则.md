# 任务规则

在 Gradle 中，`tasks.addRule` 方法用于为任务容器添加规则，这些规则可以根据任务名的模式动态创建任务。以下是如何使用 `tasks.addRule` 方法的一些关键点：

1. **声明任务规则**：
   要添加任务规则，首先需要获得对 `TaskContainer` 的引用，然后可以调用 `addRule` 方法。这个方法包含两个参数，第一个参数是规则的描述信息，第二个参数是一个闭包，用于定义当规则匹配时应该执行的操作。

   ```groovy
   tasks.addRule("Pattern: increment<Classifier>Version – Increments the project version classifier.") { String taskName ->
       if (taskName.startsWith('increment') && taskName.endsWith('Version')) {
           task(taskName) {
               doLast {
                   String classifier = (taskName - 'increment' - 'Version').toLowerCase()
                   String currentVersion = version.toString()
                   switch (classifier) {
                       case 'major': ++version.major; break
                       case 'minor': ++version.minor; break
                       default: throw new GradleException("Invalid version type '$classifier. Allowed types: ['Major', 'Minor']")
                   }
                   String newVersion = version.toString()
                   logger.info "Incrementing $classifier project version: $currentVersion -> $newVersion"
                   ant.propertyfile(file: versionFile) {
                       entry(key: classifier, type: 'int', operation: '+', value: 1)
                   }
               }
           }
       }
   }
   ```

   这段代码定义了一个规则，用于根据任务名动态创建任务，这些任务用于增加项目的版本号。

2. **动态创建任务**：
   使用 `tasks.addRule` 可以动态创建任务。例如，可以创建一个规则，根据任务名的前缀动态创建“ping”任务：

   ```groovy
   tasks.addRule("Pattern: ping<ID>") { String taskName ->
       if (taskName.startsWith('ping')) {
           task(taskName) {
               doLast {
                   println("Pinging: " + (taskName - 'ping'))
               }
           }
       }
   }
   ```

   当执行 `gradle pingServer1` 时，如果 `pingServer1` 任务不存在，上述规则会动态创建该任务，并执行定义的 `doLast` 代码块。

3. **规则的应用**：
   规则不仅在从命令行调用任务时使用，还可以在基于规则的任务上创建 `dependsOn` 关系：

   ```groovy
   tasks.addRule("Pattern: ping<ID>") { String taskName ->
       if (taskName.startsWith('ping')) {
           task(taskName) {
               doLast {
                   println("Pinging: " + (taskName - 'ping'))
               }
           }
       }
   }
   tasks.register("groupPing") {
       dependsOn("pingServer1", "pingServer2")
   }
   ```

   在这个例子中，即使 `pingServer1` 和 `pingServer2` 任务在定义规则之前不存在，`groupPing` 任务也可以依赖于它们。

通过使用 `tasks.addRule` 方法，你可以灵活地处理未知任务的执行，提供更友好的错误消息，或者实现复杂的动态任务创建逻辑。
