# Maven Publish的api说明

Maven Publish 插件是 Gradle 中用于将项目构件（如 JAR、WAR、POM 等）发布到 Maven 仓库的核心插件。以下是 `publishing` 块下的主要配置和 API 的详细说明，结合了常见用法和最佳实践。

---

## **1. 基本结构**

在 `build.gradle` 或 `build.gradle.kts` 中，应用插件后可通过 `publishing` 块配置发布：

```groovy
plugins {
    id 'maven-publish'
}

publishing {
    // 配置发布参数
    publications { ... } // 定义发布内容
    repositories { ... }  // 定义发布到的仓库
}
```

---

## **2. `publications` 配置**

定义要发布的构件（如 JAR、POM 等），支持多模块发布。

### **2.1 创建 Maven 发布**

```groovy
publications {
    // 创建一个名为 "mavenJava" 的发布配置
    mavenJava(MavenPublication) {
        // 基本信息
        groupId = 'com.example'
        artifactId = 'my-library'
        version = '1.0.0'

        // 发布 Java 组件（自动包含 JAR 和 POM）
        from components.java

        // 添加源码 JAR
        artifact sourcesJar {
            classifier = 'sources'
        }

        // 自定义 POM 文件
        pom {
            name = 'My Library'
            description = 'A demonstration of Maven Publish'
            url = 'https://github.com/example/my-library'
            licenses {
                license {
                    name = 'Apache-2.0'
                    url = 'https://opensource.org/licenses/Apache-2.0'
                }
            }
            developers {
                developer {
                    id = 'dev1'
                    name = 'Developer One'
                    email = 'dev1@example.com'
                }
            }
            scm {
                connection = 'scm:git:git://github.com/example/my-library.git'
                developerConnection = 'scm:git:ssh://github.com/example/my-library.git'
                url = 'https://github.com/example/my-library'
            }
        }
    }
}
```

### **2.2 自定义构件**

- **手动添加构件**：

  ```groovy
  artifact(file("build/libs/my-library-1.0.0.jar")) // 指定文件路径
  artifact(tasks.named("jar")) // 通过任务生成
  ```

- **分类器（Classifier）**：

  ```groovy
  artifact sourcesJar {
      classifier = 'sources' // 如 my-library-1.0.0-sources.jar
  }
  ```

### **2.3 动态修改 POM**

通过 `pom.withXml` 直接操作 POM 的 XML：

```groovy
pom.withXml {
    def dependenciesNode = asNode().appendNode('dependencies')
    configurations.implementation.allDependencies.each { dep ->
        if (dep.version != 'unspecified') {
            def dependencyNode = dependenciesNode.appendNode('dependency')
            dependencyNode.appendNode('groupId', dep.group)
            dependencyNode.appendNode('artifactId', dep.name)
            dependencyNode.appendNode('version', dep.version)
        }
    }
}
```

---

## **3. `repositories` 配置**

定义发布的目标仓库，支持本地和远程。

### **3.1 发布到本地 Maven 仓库**

```groovy
repositories {
    mavenLocal() // 默认路径 ~/.m2/repository
}
```

### **3.2 发布到远程仓库**

```groovy
repositories {
    maven {
        name = 'MyRepo'
        url = 'https://repo.example.com/releases'
        credentials {
            username = project.findProperty('repoUser') ?: System.getenv('REPO_USER')
            password = project.findProperty('repoPassword') ?: System.getenv('REPO_PASSWORD')
        }
        // 可选：认证方式（如 AWS S3）
        authentication {
            basic(BasicAuthentication)
        }
    }
}
```

### **3.3 快照仓库**

```groovy
maven {
    url = 'https://repo.example.com/snapshots'
    // 允许发布快照版本
    mavenContent {
        snapshotsOnly()
    }
}
```

---

## **4. 发布任务**

- **生成发布任务**：插件会自动生成任务，命名规则为 `publish<PublicationName>PublicationTo<RepositoryName>Repository`。
  - `publishMavenJavaPublicationToMavenLocal`：发布到本地 Maven 仓库。
  - `publishMavenJavaPublicationToMyRepoRepository`：发布到自定义仓库。
- **聚合任务**：
  - `publish`：发布所有 `publications` 到所有 `repositories`。
  - `publishToMavenLocal`：发布所有 `publications` 到本地 Maven 仓库。

---

## **5. 高级配置**

### **5.1 签名发布**

结合 `signing` 插件对构件签名：

```groovy
plugins {
    id 'signing'
}

signing {
    sign publishing.publications.mavenJava
}
```

### **5.2 条件发布**

仅在特定条件下发布：

```groovy
tasks.withType(PublishToMavenRepository).configureEach {
    onlyIf {
        (repository == publishing.repositories.MyRepo) &&
        project.hasProperty('releaseMode')
    }
}
```

### **5.3 自定义发布名称**

```groovy
publications {
    register('myPublication', MavenPublication) { ... }
}
```

---

## **6. 完整示例**

```groovy
plugins {
    id 'java-library'
    id 'maven-publish'
    id 'signing'
}

group = 'com.example'
version = '1.0.0'

task sourcesJar(type: Jar) {
    classifier = 'sources'
    from sourceSets.main.allJava
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
            artifact sourcesJar
            pom {
                name = 'My Library'
                description = 'A sample library'
                url = 'https://github.com/example/my-library'
                licenses {
                    license {
                        name = 'Apache-2.0'
                        url = 'https://opensource.org/licenses/Apache-2.0'
                    }
                }
                developers { ... }
            }
        }
    }
    repositories {
        maven {
            url = 'https://oss.sonatype.org/service/local/staging/deploy/maven2'
            credentials {
                username = System.getenv('SONATYPE_USER')
                password = System.getenv('SONATYPE_PASSWORD')
            }
        }
    }
}

signing {
    sign publishing.publications.mavenJava
}
```

---

## **7. 常见问题**

- **POM 文件缺失依赖**：确保 `from components.java` 包含 Java 组件，或手动添加依赖。
- **认证失败**：检查 `credentials` 是否正确，或使用环境变量传递敏感信息。
- **Gradle 版本兼容性**：确认插件版本与 Gradle 版本匹配（如 Gradle 6+ 推荐使用新版插件）。

建议参考官方文档：[Maven Publish Plugin](https://docs.gradle.org/current/userguide/publishing_maven.html) 获取最新细节。
