# 创建task任务

[TOC]

## 1. 快速定义任务

使用`task`关键字创建任务，是在脚本编写时就静态定义的任务。

1. 构建build.gradle脚本
2. 使用`task`关键字修饰的函数，即为task任务，在脚本里编写下面代码：

    ```groovy
    //下面是groovy语法，task关键字定义了一个count任务
    task count {
        println("count")
    }

3. 使用 `gradle count`执行

## 2. 动态任务

动态任务是指在构建脚本执行期间根据需要创建的任务，而不是在脚本编写时就静态定义的任务。动态任务创建提供了很大的灵活性，允许你根据项目的不同条件、输入或外部配置来生成任务。

### 使用 `tasks.create()` 动态创建任务

Gradle 提供了 `tasks.create()` 方法来动态创建任务。这个方法允许你指定任务的名称、类型以及一个配置闭包来定义任务的行为。

```groovy
// 动态创建一个名为 'dynamicTask' 的任务
tasks.create(name: 'dynamicTask') {
    doLast {
        println 'This is a dynamically created task!'
    }
}
```

在这个例子中，`dynamicTask` 任务是在构建脚本执行期间创建的，并且当它被执行时，会打印出一条消息。

### 根据条件动态创建任务

你可以根据构建脚本中的条件逻辑来动态创建任务。例如，你可能只想在特定的构建类型或环境变量存在时才创建某些任务。

```groovy
if (project.hasProperty('createDynamicTask')) {
    tasks.create(name: 'conditionalTask') {
        doLast {
            println 'This task was created conditionally!'
        }
    }
}
```

在这个例子中，`conditionalTask` 任务只有在项目属性 `createDynamicTask` 被设置时才会被创建。

### 动态任务之间的依赖关系

动态创建的任务也可以配置依赖关系。你可以使用 `dependsOn` 属性来指定一个任务在执行前必须完成的其他任务。

```groovy
tasks.create(name: 'taskA') {
    doLast {
        println 'Executing task A'
    }
}

tasks.create(name: 'taskB', dependsOn: 'taskA') {
    doLast {
        println 'Executing task B (depends on task A)'
    }
}
```

在这个例子中，`taskB` 依赖于 `taskA`，因此当 `taskB` 被执行时，`taskA` 会首先被执行。

### 使用 `tasks.register()` 替代 `tasks.create()`

在 Gradle 的较新版本中，推荐使用 `tasks.register()` 方法来注册任务，而不是直接使用 `tasks.create()`。`register()` 方法提供了更好的性能和更灵活的配置选项，特别是在配置依赖于其他任务的任务时。

```groovy
tasks.register('anotherDynamicTask') {
    doLast {
        println 'This is another dynamically created task using register!'
    }
}
```

使用 `register()` 方法时，任务是在配置阶段注册的，但实际的创建和配置是在执行阶段进行的。这允许 Gradle 在构建脚本执行期间更有效地管理任务依赖关系和性能。

### 字符串动态引用和创建

动态属性访问和字符串插值功能

```groovy
tasks."generatePomFileFor${publicationName.capitalize()}Publication" {
        destination = file("$buildDir/pom/$publicationName-pom.xml")
        dependsOn(buildSdk)
}
```

`tasks."generatePomFileFor${publicationName.capitalize()}Publication{}` 这种写法使用了 Groovy 的动态属性访问和字符串插值功能。它允许你动态地引用或创建任务名称，而不需要硬编码具体的任务名

- `tasks."generatePomFileFor${publicationName.capitalize()}Publication"`：这里的双引号和 `${}` 表示使用了 Groovy 的字符串插值功能。
- `publicationName.capitalize()`：将 publicationName 的首字母大写。例如，如果 publicationName 是 maven，则结果是 Maven。
- 整个表达式会生成一个类似 `generatePomFileForMavenPublication` 的任务名称

## 3. 默认任务

默认任务是指在执行 Gradle 命令时没有明确指定任务名称时，Gradle 会自动执行的任务。设置默认任务可以提高构建过程的便捷性，使用户能够更快地执行常用的构建任务。

### 设置默认任务的方法

在 Gradle 构建脚本（通常是 `build.gradle` 文件）中，可以通过以下几种方式设置默认任务：

1. **使用 `defaultTasks` 方法**：
   在构建脚本的开头或适当位置，可以使用 `defaultTasks` 方法来指定一个或多个默认任务。例如：

   ```groovy
   defaultTasks 'taskA', 'taskB'
   ```

   在这个例子中，当执行 `gradle` 命令（不带任何任务名称）时，Gradle 会依次执行 `taskA` 和 `taskB`。

2. **在命令行中指定默认任务**（虽然这不是在构建脚本中设置的方式，但值得提及）：
   虽然这不是直接在构建脚本中设置默认任务的方法，但用户可以在命令行中通过添加 `-m` 或 `--task-name` 选项来指定要执行的任务。然而，这并不是设置“默认任务”的正式方法，因为它仍然需要用户在每次执行时指定任务。

   注意：`-m` 选项实际上用于显示任务的更多信息，而不是直接执行任务。这里提及它是因为有时用户可能会混淆命令行选项和默认任务的概念。正确的做法是使用 `defaultTasks` 方法在构建脚本中设置默认任务。

### 注意事项

- **任务顺序**：当设置多个默认任务时，Gradle 会按照 `defaultTasks` 方法中指定的顺序依次执行这些任务。
- **任务依赖**：默认任务也可以有依赖关系。如果某个默认任务依赖于其他任务，那么这些依赖任务会在默认任务执行之前被自动执行。
- **可维护性**：虽然设置默认任务可以提高构建过程的便捷性，但过多的默认任务可能会使构建脚本变得难以理解和维护。因此，建议谨慎使用默认任务，并确保它们与项目的构建需求保持一致。

### 示例

以下是一个简单的 Gradle 构建脚本示例，其中设置了两个默认任务 `taskA` 和 `taskB`：

```groovy
// build.gradle

task taskA {
    doLast {
        println 'Executing task A'
    }
}

task taskB {
    doLast {
        println 'Executing task B'
    }
}

// 设置默认任务
defaultTasks 'taskA', 'taskB'
```

当执行 `gradle` 命令时，输出将是：

```txt
> Task :taskA
Executing task A

> Task :taskB
Executing task B
```

这表明 `taskA` 和 `taskB` 已经被依次执行。
