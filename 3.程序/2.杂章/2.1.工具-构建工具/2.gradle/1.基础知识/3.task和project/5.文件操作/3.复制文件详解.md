# 复制文件详解

在 Gradle 中复制文件是一个常见的任务，可以通过内置的 `Copy` 类型任务来实现。以下是关于 Gradle 复制文件的详解：

## 1. 创建复制任务

要复制文件，你需要定义一个类型为 `Copy` 的任务：

```groovy
task copyTask(type: Copy) {
    from 'src/main/webapp'
    into 'build/explodedWar'
}
```

### copy方法最新检查构建的问题

你也可以使用 Project.copy() 方法复制文件,它的工作方式有一些限制,首先该方法不是增量的,请参考 第 3.2.2.1.5 节 [跳过任务](../../3.task%E5%92%8Cproject/2.task/2.%E8%AF%A6%E8%BF%B0/1.%E4%BB%BB%E5%8A%A1%E6%93%8D%E4%BD%9C/6.%E5%A3%B0%E6%98%8E%E4%BB%BB%E5%8A%A1%E7%9A%84%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA.md),当一个任务被用作复制源时(例如 from() 方法的参数), copy() 方法不能够实现任务依赖,因为它是一个普通的方法不是一个任务.因此,如果你使用 copy()方法作为一个任务的一部分功能,你需要显式的声明所有的输入和输出以确保获得正确的结果.
>简单来说，需要通过输入输出的生命来设定是否重新加载。仅copy方法，如果文件路径变化，是不会引起此复制任务跟着构建的。

不使用最新检查方式下用copy方法复制文件（此时会有上面描述的问题）

```groovy
task copyMethod << {
    copy {
        from 'src/main/webapp'
        into 'build/explodedWar'
        include '**/*.html'
        include '**/*.jsp'
    }
}
```

使用最新的检查方式下用 copy() 方法复制文件

```groovy
task copyMethodWithExplicitDependencies{
     // 对输入做最新检查,添加 copyTask 作为依赖
    inputs.file copyTask
    outputs.dir 'some-dir' //对输出做最新检查
    doLast{
        copy {
            // 复制 copyTask 的输出
            from copyTask
            into 'some-dir'
        }
    }
}
```

建议尽可能的使用复制任务,因为它支持增量化的构建和任务依赖推理，而不需要去额外的费力处理这些.不过 copy() 方法可以用作复制任务实现的一部分.即该 方法被在自定义复制任务中使用,请参考 第60章 编写自定义任务.在这样的场景下，自定义任务应该充分声明与复制操作相关的输入/输出。

## 2. 指定源和目标

使用 `from` 方法指定源文件或目录，使用 `into` 方法指定目标目录：

```groovy
task anotherCopyTask(type: Copy) {
    // 复制 src/main/webapp 目录下的所有文件
    from 'src/main/webapp'
    // 复制一个单独文件
    from 'src/staging/index.html'
    // 复制一个任务输出的文件
    from copyTask
    // 显式使用任务的 outputs 属性复制任务的输出文件
    from copyTaskWithPatterns.outputs
    // 复制一个 ZIP 压缩文件的内容
    from zipTree('src/main/assets.zip')
    // 最后指定目标目录
    into { getDestDir() }
}
```

## 3. 包含和排除文件

你可以使用 `include` 和 `exclude` 方法来指定需要复制的文件模式，这使用 Ant 风格的模式匹配：

```groovy
task copyFiles(type: Copy) {
    from 'src/main/resources'
    include '**/*.txt'
    exclude '**/*.tmp'
    into 'build/resources'
}
```

## 4. 文件重命名和属性替换

在复制过程中，你可以使用 `rename` 方法来重命名文件，或者使用 `expand` 方法来进行属性替换：

```groovy
task copyFiles(type: Copy) {
    from 'src/main/resources'
    rename { String fileName -> fileName.toUpperCase() }
    expand(version: '1.0')
    into 'build/resources'
}
```

## 5. 复制目录结构

如果你需要保留目录结构，只需将目录作为 `from` 方法的参数：

```groovy
task copyFiles(type: Copy) {
    from 'src/main/resources'
    into 'build/resources'
}
```

## 6. 使用文件树

`fileTree` 方法允许你将目录转换为文件树，并对文件树进行操作，如过滤和遍历：

```groovy
task copyFiles(type: Copy) {
    from fileTree('src/main/resources').matching {
        include '**/*.txt'
    }
    into 'build/resources'
}
```

## 7. 处理文件复制细节

`CopySpec` 提供了更多细节控制，如文件权限设置：

```groovy
task copyFiles(type: Copy) {
    from 'src/main/resources' 
    into 'build/resources'
    doLast {
        eachFile { CopySpec spec ->
            spec.mode = 0644 // 设置文件权限
        }
    }
}
```

## 8. 同步文件

如果你想要在源文件有更新时才复制文件，可以使用 `sync` 方法：

```groovy
task copyFiles(type: Sync) {
    from 'src/main/resources'
    into 'build/resources'
}
```

`Sync` 任务是 `Copy` 任务的一个特殊类型，它只会同步那些有变化的文件。

## 9. 创建归档文件

在 Gradle 中创建归档文件，如 ZIP、TAR、JAR 或 WAR 等，可以通过使用内置的 `Copy` 类型任务来完成。以下是创建不同类型归档文件的步骤和示例：

### 1. 创建 ZIP 归档文件

```groovy
task zipFile(type: Copy) {
    from 'src'
    into 'build/distributions'
    rename { String fileName -> fileName + '.zip' }
    includeEmptyDirs = false
    doLast {
        copy {
            from 'build/distributions'
            into 'build/distributions'
            rename { String fileName -> fileName.replace('.zip', '_modified.zip') }
            includeEmptyDirs = false
        }
        assert file('build/distributions/modified.zip').exists()
    }
}
```

### 2. 创建 TAR 归档文件

```groovy
task tarFile(type: Tar) {
    from 'src'
    archiveName = 'archive.tar'
    destinationDirectory = file('build/distributions')
}
```

### 3. 创建 GZIP 压缩的 TAR 归档文件

```groovy
task gzippedTarFile(type: Tar) {
    from 'src'
    archiveName = 'archive.tar.gz'
    compression = Compression.GZIP
    destinationDirectory = file('build/distributions')
}
```

### 4. 创建 BZIP2 压缩的 TAR 归档文件

```groovy
task bzippedTarFile(type: Tar) {
    from 'src'
    archiveName = 'archive.tar.bz2'
    compression = Compression.BZIP2
    destinationDirectory = file('build/distributions')
}
```

### 5. 创建 JAR 文件

```groovy
task createJar(type: Jar) {
    from 'src'
    destinationDirectory = file('build/libs')
    archiveName = 'my-library.jar'
}
```

### 6. 创建 WAR 文件

```groovy
task createWar(type: War) {
    from 'src/main/webapp'
    destinationDirectory = file('build/libs')
    archiveName = 'my-webapp.war'
}
```

### 7. 自定义归档文件内容

你可以使用 `CopySpec` 来自定义归档文件中的内容，例如包含或排除特定文件：

```groovy
task customZipFile(type: Zip) {
    into('lib') {
        from configurations.runtimeClasspath
        exclude '**/*.txt'
    }
    into('docs') {
        from 'src/docs'
    }
    destinationDirectory = file('build/distributions')
    archiveName = 'custom.zip'
}
```

### 8. 执行归档任务

归档任务定义完成后，你可以通过执行以下命令来创建归档文件：

```shell
./gradlew zipFile
./gradlew tarFile
./gradlew createJar
```

这些示例展示了如何在 Gradle 中创建不同类型的归档文件。你可以根据项目的具体需求调整源目录、目标目录、归档名称和归档类型。通过这些任务，你可以轻松地将项目资源打包成所需的格式，以便于分发和部署。

## 总结

通过这些方法，你可以灵活地在 Gradle 构建中复制文件和目录。这些操作对于管理资源文件、配置文件和其他资产非常有用。

---

## CopySpec

`CopySpec` 是 Gradle 中用于定义复制文件规则的接口，它提供了丰富的方法来配置文件复制任务。以下是 `CopySpec` 的一些关键用法和详解：

### 1. 基本用法

`CopySpec` 可以通过 `from` 方法指定源文件或目录，通过 `into` 方法指定目标目录。

- **from**: 指定要复制的文件或目录。
- **into**: 指定复制到的目标目录。

```groovy
task copyFiles(type: Copy) {
    from 'src/main/resources'
    into 'build/resources'
}
```

### 2. 包含和排除文件

使用 `include` 和 `exclude` 方法来指定复制时包含或排除的文件模式。

```groovy
copyFiles {
    from 'src/main/resources'
    include '**/*.txt'
    exclude '**/*.tmp'
    into 'build/resources'
}
```

### 3. 文件重命名和过滤

`CopySpec` 允许你在复制过程中重命名文件或对文件内容进行过滤。

- **rename**: 重命名文件。
- **filter**: 对文件内容进行过滤。

```groovy
copyFiles {
    from 'src/main/resources'
    rename { String fileName -> fileName.toUpperCase() }
    filter { String line -> line.replaceAll('DEBUG', 'RELEASE') }
    into 'build/resources'
}
```

### 4. 处理重复文件

`CopySpec` 提供了 `duplicatesStrategy` 属性，用于处理复制过程中的重复文件问题。

- **duplicatesStrategy**: 可以设置为 `include`, `exclude`, `warn`, 或 `fail`。

```groovy
copyFiles {
    duplicatesStrategy = 'warn'
    from 'src'
    into 'dest'
}
```

### 5. 文件树映射

`CopySpec` 支持文件树映射，允许你将目录转换为文件树并进行操作。

```groovy
task copyTree(type: Copy) {
    from fileTree('src') {
        include '**/*.java'
    }
    into 'build/src'
}
```

### 6. 共享复制规范

`CopySpec` 可以通过 `with` 方法在不同的任务中共享。

```groovy
def commonSpec = copySpec {
    from 'common/src'
}

task copyToLib(type: Copy) {
    with commonSpec
    into 'lib'
}

task copyToDist(type: Copy) {
    with commonSpec
    into 'dist'
}
```

### 7. 扩展属性和方法

`CopySpec` 还支持通过 `eachFile` 和 `filesMatching` 方法对每个文件进行更细粒度的操作。

```groovy
copyFiles {
    eachFile { FileCopyDetails details ->
        if (details.file.name.contains('old')) {
            details.exclude()
        }
    }
    filesMatching '**/*.tmp' {
        exclude()
    }
    into 'build/resources'
}
```

以上是 `CopySpec` 的一些基本用法和详解，通过这些方法，你可以灵活地配置文件复制任务，以满足不同的构建需求。  
