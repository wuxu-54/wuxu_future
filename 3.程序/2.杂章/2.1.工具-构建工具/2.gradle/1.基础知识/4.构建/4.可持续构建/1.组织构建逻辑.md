# 组织 Gradle 项目

每个软件项目的源代码和构建逻辑都应该以有意义的方式组织。此页面列出了导致可读、可维护项目的最佳实践。以下部分还涉及常见问题以及如何避免这些问题。
>[传送门](https://doc.qzxdp.cn/gradle/8.1.1/userguide/organizing_gradle_projects.html)

## 单独的特定于语言的源文件

Gradle 的语言插件建立了发现和编译源代码的约定。例如，应用了Java插件的工程会自动编译src/main/java目录下的代码。其他语言插件遵循相同的模式。目录路径的最后部分通常指示源文件的预期语言。

一些编译器能够在同一源目录中交叉编译多种语言。 Groovy 编译器可以处理混合位于 src/main/groovy 中的 Java 和 Groovy 源文件的场景。 Gradle 建议您根据语言将源放在目录中，因为构建的性能更高，并且用户和构建都可以做出更强的假设。

以下源代码树包含 Java 和 Kotlin 源文件。 Java 源文件位于 src/main/java 中，而 Kotlin 源文件位于 src/main/kotlin 中。

```kotlin
.
├── build.gradle.kts
└── src
    └── main
        ├── java
        │   └── HelloWorld.java
        └── kotlin
            └── Utils.kt
```

## 每个测试类型单独的源文件

一个项目定义和执行不同类型的测试是很常见的，例如单元测试、集成测试、功能测试或冒烟测试。最佳情况下，每种测试类型的测试源代码应存储在专用的源目录中。分离的测试源代码对可维护性和关注点分离有积极影响，因为您可以运行彼此独立的测试类型。

查看演示如何将单独的集成测试配置添加到基于 Java 的项目的 样本。

## 尽可能使用标准约定

所有 Gradle 核心插件都遵循软件工程范式 约定优于配置 。插件逻辑在特定上下文中为用户提供合理的默认值和标准、约定。我们以Java插件为例。

- 它将目录 src/main/java 定义为编译的默认源目录。
- 已编译源代码和其他构件（如 JAR 文件）的输出目录是 build 。

通过坚持默认约定，项目的新开发人员立即知道如何找到解决方法。虽然可以重新配置这些约定，但构建脚本的用户和作者更难管理构建逻辑及其结果。尽量坚持默认约定，除非您需要适应遗留项目的布局。请参阅相关插件的参考页面以了解其默认约定。

## 总是定义一个设置文件

Gradle 会在每次调用构建时尝试定位 settings.gradle (Groovy DSL) 或 settings.gradle.kts (Kotlin DSL) 文件。为此，运行时遍历目录树的层次结构直到根目录。一旦找到设置文件，算法就会停止搜索。

始终将 settings.gradle 添加到构建的根目录以避免初始性能影响。该文件可以是空的，也可以定义项目的所需名称。

多项目构建必须在多项目层次结构的根项目中有一个 settings.gradle(.kts) 文件。这是必需的，因为设置文件定义了哪些项目参与 多项目构建 。除了定义包含的项目外，您可能还需要它将库添加到构建脚本类路径 。

以下示例显示了标准的 Gradle 项目布局：

```kotlin
.
├── settings.gradle.kts
├── subproject-one
│   └── build.gradle.kts
└── subproject-two
    └── build.gradle.kts
```

## Use buildSrc to abstract imperative logic

复杂的构建逻辑通常很适合封装为自定义任务或二进制插件。自定义任务和插件实现不应存在于构建脚本中。只要代码不需要在多个独立项目之间共享，使用 buildSrc 就非常方便。

目录 buildSrc 被视为 包含构建 。发现目录后，Gradle 会自动编译和测试此代码，并将其放入构建脚本的类路径中。对于多项目构建，只能有一个 buildSrc 目录，它必须位于项目根目录中。 buildSrc 应该优于 脚本插件，因为它更容易维护、重构和测试代码。

buildSrc 使用适用于 Java 和 Groovy 项目的相同 源代码约定。它还提供对 Gradle API 的直接访问。可以在 buildSrc 下的专用 build.gradle 中声明其他依赖项。

示例 1.自定义 buildSrc 构建脚本

```kotlin
// buildSrc/build.gradle.kts
repositories {
    mavenCentral()
}

dependencies {
    testImplementation("junit:junit:4.13")
}
```

包括 buildSrc 在内的典型项目具有以下布局。 buildSrc 下的任何代码都应使用类似于应用程序代码的包。如果需要额外的配置（例如，应用插件或声明依赖项），buildSrc 目录可以托管构建脚本。

```kotlin
.
├── buildSrc
│   ├── build.gradle.kts
│   └── src
│       ├── main
│       │   └── java
│       │       └── com
│       │           └── enterprise
│       │               ├── Deploy.java
│       │               └── DeploymentPlugin.java
│       └── test
│           └── java
│               └── com
│                   └── enterprise
│                       └── DeploymentPluginTest.java
├── settings.gradle.kts
├── subproject-one
│   └── build.gradle.kts
└── subproject-two
    └── build.gradle.kts
```

>buildSrc 中的更改会导致整个项目变得过时。因此，在进行小的增量更改时，`--no-rebuild command-line option` 通常有助于获得更快的反馈。不过，请记住定期或至少在完成后运行完整构建。

## Declare properties in gradle.properties file

在 Gradle 中，可以在构建脚本、gradle.properties 文件中或作为命令行参数定义属性。

为临时场景在命令行上声明属性是很常见的。例如，您可能希望传入一个特定的属性值来控制仅针对这一次构建调用的运行时行为。构建脚本中的属性很容易成为维护问题并使构建脚本逻辑复杂化。 gradle.properties 有助于将属性与构建脚本分开，应该作为可行的选项进行探索。这是放置 控制构建环境的属性 的好位置。

典型的项目设置将 gradle.properties 文件放在构建的根目录中。或者，如果您希望该文件应用于计算机上的所有构建，该文件也可以位于 GRADLE_USER_HOME 目录中。

```kotlin
.
├── gradle.properties
└── settings.gradle.kts
├── subproject-a
│   └── build.gradle.kts
└── subproject-b
    └── build.gradle.kts
```

## 避免重叠的任务输出

任务应定义输入和输出以获得 增量构建功能 的性能优势。在声明任务的输出时，请确保写入输出的目录在项目中的所有任务中是唯一的。

混合或覆盖不同任务产生的输出文件会影响最新检查，从而导致构建速度变慢。反过来，这些文件系统更改可能会阻止 Gradle 的 建立缓存 正确识别和缓存原本可缓存的任务。

## 使用自定义 Gradle 分发标准化构建

企业通常希望通过定义通用约定或规则来标准化组织中所有项目的构建平台。您可以在初始化脚本的帮助下实现这一点。 初始化脚本 使得在一台机器上跨所有项目应用构建逻辑变得极其容易。例如，声明内部仓库及其凭据。

该方法有一些缺点。首先，您必须在公司的所有开发人员之间传达设置过程。此外，统一更新初始化脚本逻辑可能具有挑战性。

自定义 Gradle 发行版是解决这个问题的实用方法。自定义 Gradle 发行版由标准 Gradle 发行版加上一个或多个自定义初始化脚本组成。初始化脚本与发行版捆绑在一起，并在每次运行构建时应用。开发人员只需将他们签入的 Wrapper 文件指向自定义 Gradle 分发的 URL。

自定义 Gradle 发行版还可能在发行版的根目录中包含一个 gradle.properties 文件，它提供了一个组织范围的 一组控制构建环境的属性 。

以下步骤是创建自定义 Gradle 发行版的典型步骤：

1. 实现下载和重新打包 Gradle 发行版的逻辑。

2. 使用所需的逻辑定义一个或多个初始化脚本。

3. 将初始化脚本与 Gradle 分发捆绑在一起。

4. 将 Gradle 分发存档上传到 HTTP 服务器。

5. 将所有项目的 Wrapper 文件更改为指向自定义 Gradle 分发的 URL。

示例 2.构建自定义 Gradle 发行版

```groovy
// build.gradle
plugins {
    id 'base'
}

// This is defined in buildSrc
import org.gradle.distribution.DownloadGradle

version = '0.1'

tasks.register('downloadGradle', DownloadGradle) {
    description = 'Downloads the Gradle distribution with a given version.'
    gradleVersion = '4.6'
}

tasks.register('createCustomGradleDistribution', Zip) {
    description = 'Builds custom Gradle distribution and bundles initialization scripts.'

    dependsOn downloadGradle

    def projectVersion = project.version
    archiveFileName = downloadGradle.gradleVersion.map { gradleVersion ->
        "mycompany-gradle-${gradleVersion}-${projectVersion}-bin.zip"
    }

    from zipTree(downloadGradle.destinationFile)

    from('src/init.d') {
        into "${downloadGradle.distributionNameBase.get()}/init.d"
    }
}
```
