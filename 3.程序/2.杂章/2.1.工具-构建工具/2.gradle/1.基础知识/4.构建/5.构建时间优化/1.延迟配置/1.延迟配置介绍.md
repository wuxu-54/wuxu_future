# 延迟配置

在Gradle中，延迟配置（Lazy Configuration）是一种优化构建性能的技术，它允许你在需要时才计算任务的配置值，而不是在构建脚本解析时就立即计算。这种技术可以减少不必要的计算和IO操作，从而提高构建速度。以下是一些关于Gradle延迟配置的关键点和示例：

## 关键点

1. **延迟属性（Lazy Properties）**：
   - Gradle提供了`Lazy<T>`类型，用于表示一个延迟计算的值。
   - 你可以使用`project.property("someProperty").getOrElse("defaultValue")`或`provider { ... }`来创建延迟属性。

2. **延迟任务配置（Lazy Task Configuration）**：
   - 在任务配置中，你可以使用`doFirst`、`doLast`、`onlyIf`等方法来延迟任务的执行逻辑。
   - 避免在任务配置闭包中直接执行耗时的操作，而是将它们放在这些延迟执行的方法中。

3. **依赖解析的延迟（Lazy Dependency Resolution）**：
   - Gradle在解析依赖时会尽量延迟，直到真正需要时才去下载和解析。
   - 你可以通过配置缓存（Build Cache）和离线模式（Offline Mode）来进一步优化依赖解析过程。

## 示例

1. **延迟属性示例**：

    ```groovy
    // 使用provider创建延迟属性
    def lazyValue = provider {
        // 这里可以放置耗时的计算或IO操作
        "Computed Value"
    }

    task printLazyValue {
        doLast {
            println lazyValue.get() // 在任务执行时才计算值
        }
    }
    ```

2. **延迟任务配置示例**：

    ```groovy
    task myTask {
        // 避免在任务配置闭包中直接执行耗时操作
        doFirst {
            // 这里放置任务开始前的准备工作，如检查条件、设置环境等
            println 'Task is starting...'
        }

        doLast {
            // 这里放置任务执行的主要逻辑
            println 'Task is finished.'
        }

        onlyIf {
            // 这里放置决定是否执行任务的条件判断
            return true // 或者某个条件表达式
        }
    }
    ```

3. **依赖解析的延迟示例**：

    ```groovy
    // 使用构建缓存来加速依赖解析
    buildCache {
        local {
            enabled = true
        }
    }

    // 启用离线模式以减少网络请求（注意：仅当所有依赖都已下载到本地时才有效）
    org.gradle.offline=true // 在gradle.properties文件中设置
    ```

## 注意事项

- 延迟配置并不意味着你可以无限制地推迟所有计算，而是应该在合适的时机进行必要的计算。
- 在使用延迟配置时，要确保你的构建脚本仍然具有可读性和可维护性。
- 延迟配置通常与Gradle的性能优化策略相结合，如构建缓存、并行执行等。

通过合理地使用Gradle的延迟配置技术，你可以显著提高构建性能，减少不必要的资源消耗，并使你的构建过程更加高效和可靠。
