# 构建缓存

Gradle构建缓存是一种优化特性，它可以重用跨不同构建的输出，从而避免重复的工作，显著提高构建效率。以下是关于Gradle构建缓存的详解：

## 构建缓存的工作原理

Gradle构建缓存通过存储构建输出（本地或远程）并在确定输入未更改时允许构建从缓存中获取这些输出，避免重新生成它们的昂贵工作。当执行任务时，Gradle会检查该任务的输入和输出文件，如果这些文件在之前的构建中已经生成过并且没有发生变化，那么Gradle会直接跳过该任务，使用缓存结果。

## 启用构建缓存

默认情况下，Gradle构建缓存未启用。你可以通过在`gradle.properties`中添加以下配置来启用缓存：

```properties
org.gradle.caching=true
```

或者在命令行进行构建的时候添加 `--build-cache` 参数，例如：

```shell
./gradlew build --build-cache
```

这会为当前构建启用构建缓存。

## 配置本地构建缓存

Gradle支持配置本地构建缓存，你可以设置本地仓库的路径，以便Gradle可以缓存下载的依赖。此外，还可以配置持久化缓存和清理缓存的任务。例如，在`settings.gradle`中配置缓存的持久化：

```groovy
persistentCache {
    cacheDir = new File(buildDir, 'persistent-cache')
}
```

以及配置本地缓存目录和清理策略：

```groovy
buildCache {
    local {
        directory = File(rootDir, "build-cache")
        removeUnusedEntriesAfterDays = 30
    }
}
```

这会指定构建缓存的存储位置，并设置删除30天内未使用的缓存条目的策略。

## 配置远程构建缓存

在分布式构建环境中，可以配置远程构建缓存。这通常用于持续集成环境，其中CI服务器填充远程缓存，从而加快构建速度。配置远程缓存需要指定远程服务器的URL以及访问凭证：

```groovy
buildCache {
    remote(HttpBuildCache) {
        url = 'https://example.com:8123/cache/'
        credentials {
            username = 'build-cache-user-name'
            password = 'build-cache-password'
        }
    }
}
```

这样配置后，Gradle会尝试从远程缓存中加载构建输出，如果找到则存储在本地缓存中，以便下次直接使用。

## 监控缓存使用情况

Gradle提供了监控构建过程中缓存命中率和使用情况的方法。可以通过`--info`参数来监控缓存的使用情况：

```shell
./gradlew build --info
```

这将提供关于缓存命中率和性能的详细信息。

通过合理配置和使用构建缓存，可以显著减少构建时间并优化资源使用，尤其是在大型项目和频繁构建的场景中。
