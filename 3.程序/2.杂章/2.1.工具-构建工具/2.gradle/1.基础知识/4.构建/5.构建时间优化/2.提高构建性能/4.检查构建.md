# 检查 Gradle 构建

Gradle 提供了多种方法来检查您的构建：

- 带有构建扫描的配置文件
- 本地概况报告
- 低级分析

## 什么是构建扫描？

构建扫描 是运行构建时发生的事情的持久的、可共享的记录。构建扫描提供对构建的洞察力，您可以使用它来识别和修复性能瓶颈。

在 Gradle 4.3 及更高版本中，您可以使用 --scan 命令行选项创建构建扫描：

```sh
$gradle build --scan
```

对于较旧的 Gradle 版本，构建扫描插件用户手册 解释了如何启用构建扫描。

在构建结束时，Gradle 会显示一个 URL，您可以在其中找到构建扫描：

```sh
BUILD SUCCESSFUL in 2s
4 actionable tasks: 4 executed

Publishing build scan...
https://gradle.com/s/e6ircx2wjbf7e
```

本节介绍如何使用构建扫描分析构建。

## 带有构建扫描的配置文件

性能页面可以帮助使用构建扫描来分析构建。要到达那里，请单击左侧导航菜单中的 "Performance" 或点击构建扫描主页上的“探索性能”链接：

build scan home

![构建扫描主页上的性能页面链接](https://doc.qzxdp.cn/gradle/8.1.1/userguide/img/performance/build-scan-home.png)

性能页面显示完成构建的不同阶段所花费的时间。此页面显示花了多长时间：

- 启动
- 配置构建的项目
- 解析依赖关系
- 执行任务

您还可以获得有关环境属性的详细信息，例如是否使用了守护进程。

build scan performance page

![构建扫描性能页面](https://doc.qzxdp.cn/gradle/8.1.1/userguide/img/performance/build-scan-performance-page.png)

在上面的构建扫描中，配置需要超过 13 秒。单击 "Configuration" 选项卡将此阶段分解为多个组成部分，从而揭示缓慢的原因。

build scan configuration breakdown

![构建扫描配置分解](https://doc.qzxdp.cn/gradle/8.1.1/userguide/img/performance/build-scan-configuration-breakdown.png)

在这里，您可以看到应用到项目的脚本和插件，按应用时间的降序排列。最慢的插件和脚本应用程序很适合进行优化。例如，脚本 script-b.gradle 应用了一次，但用了 3 秒。展开该行以查看构建应用此脚本的位置。

script b application

![显示 script-b.gradle 对构建的应用](https://doc.qzxdp.cn/gradle/8.1.1/userguide/img/performance/script-b-application.png)

您可以看到子项目 :app1 从该子项目的 build.gradle 文件内部应用了一次脚本。

## 简介报告

如果您不想使用构建扫描，您可以在根项目的 `build/reports/profile` 目录中生成 HTML 报告。要生成此报告，请使用 --profile 命令行选项：

```sh
$gradle --profile <tasks>
```

每个配置文件报告的名称中都有一个时间戳，以避免覆盖现有报告。

该报告显示运行构建所用时间的细目分类。但是，此细分不如构建扫描详细。以下配置文件报告显示了可用的不同类别：

Sample Gradle profile report
![示例配置文件报告](https://doc.qzxdp.cn/gradle/8.1.1/userguide/img/performance/gradle-profile-report.png)

## 低级分析

有时，即使您的构建脚本一切正常，您的构建速度也会很慢。这通常归结为插件和自定义任务效率低下或资源受限。使用 Gradle 探查器 查找这些类型的瓶颈。使用 Gradle Profiler，您可以定义诸如“在进行 ABI 破坏性更改后运行‘assemble’”之类的场景，并多次运行您的构建以收集分析数据。使用 Profiler 生成构建扫描。或者将它与 JProfiler 和 YourKit 等方法分析器结合使用。这些分析器可以帮助您找到自定义插件中的低效算法。如果您发现 Gradle 中的某些东西本身会减慢您的构建速度，请不要犹豫，将分析器快照发送到 `performance@gradle.com` 。

## 性能类别

构建扫描和本地配置文件报告都将构建执行分解为相同的类别。以下部分解释了这些类别。

### 启动

这反映了 Gradle 的初始化时间，主要包括：

- JVM 初始化和类加载
- 如果您使用包装器，请下载 Gradle 发行版
- 如果合适的守护进程尚未运行，则启动守护进程
- 执行 Gradle 初始化脚本

即使构建执行的启动时间很长，后续运行的启动时间通常也会急剧下降。构建启动时间持续缓慢通常是 init 脚本中出现问题的结果。仔细检查您在那里所做的工作是否必要且高效。

### Settings and buildSrc

启动后，Gradle 会初始化您的项目。通常，Gradle 只处理您的设置文件。如果您在 buildSrc 目录中有自定义构建逻辑，Gradle 也会处理该逻辑。构建 buildSrc 一次后，Gradle 认为它是最新的。与逻辑处理相比，最新检查所花费的时间要少得多。如果您的 buildSrc 阶段花费太多时间，请考虑将其分解为一个单独的项目。然后，您可以将该项目的 JAR 构件添加为依赖项。

设置文件很少包含具有重要 I/O 或计算的代码。如果您发现 Gradle 处理它需要很长时间，请使用更传统的分析方法（如 Gradle 分析器 ）来确定原因。

### 加载项目

加载项目通常不会花费大量时间，您也无法控制它。在这里花费的时间基本上是您在构建中拥有的项目数量的函数。
