# 生命周期

Gradle 构建项目的生命周期分为三个主要阶段：**初始化（Initialization）**、**配置（Configuration）** 和 **执行（Execution）**。每个阶段都有特定的目标和行为，理解这些阶段有助于优化构建脚本和调试构建问题。

---

## 1. **初始化阶段（Initialization）**

**目标**：确定哪些项目（Projects）会参与构建，并为每个项目创建对应的 `Project` 实例。

- **单项目构建**：直接使用当前目录下的项目。
- **多项目构建**：解析 `settings.gradle`（或 `settings.gradle.kts`）文件，确定包含哪些子项目。
  - `settings.gradle` 定义了项目的层次结构，例如：

    ```groovy
    include 'app', 'lib'  // 包含子项目 app 和 lib
    ```

  - Gradle 会为每个子项目创建对应的 `Project` 实例。

**生命周期钩子**：

- 在 `settings.gradle` 中可以通过 `gradle.settingsEvaluated` 监听初始化完成事件。

---

## 2. **配置阶段（Configuration）**

**目标**：解析项目的 `build.gradle`（或 `build.gradle.kts`）文件，配置任务（Tasks）和依赖关系。

- **执行所有构建脚本**：Gradle 会按顺序执行所有项目的 `build.gradle` 文件中的代码。
  - 即使某些任务不执行，配置阶段的代码也会运行（例如 `println` 在配置阶段就会输出）。
- **构建任务依赖图**：确定任务之间的依赖关系，形成有向无环图（DAG）。

**关键行为**：

- 定义任务（如 `task myTask { ... }`）。
- 配置任务属性（如输入/输出、依赖关系）。
- 应用插件（如 `plugins { id 'java' }`）。

**生命周期钩子**：

- `beforeProject`：在配置项目前触发。
- `afterProject`：在配置项目后触发。
- `gradle.projectsLoaded`：所有项目加载完成时触发。
- `gradle.beforeSettings`：`settings.gradle` 执行前触发。

---

## 3. **执行阶段（Execution）**

**目标**：运行指定的任务及其依赖任务。

- Gradle 根据任务依赖图确定执行顺序。
- 仅执行在命令行中指定的任务及其依赖的任务。
- 任务的 `doFirst` 和 `doLast` 闭包中的代码在此阶段运行。

**关键行为**：

- 执行任务的 Action（通过 `doFirst` 和 `doLast` 定义）。
- 处理任务的输入/输出（例如增量构建）。

**生命周期钩子**：

- `gradle.taskGraph.whenReady`：任务图（Task Graph）构建完成后触发。
- `gradle.taskGraph.beforeTask`：任务执行前触发。
- `gradle.taskGraph.afterTask`：任务执行后触发。

---

## 生命周期流程图

```plaintext
初始化阶段
├─ 解析 settings.gradle
├─ 创建 Project 实例
└─ 触发 projectsLoaded 事件

配置阶段
├─ 执行 build.gradle 代码
├─ 构建任务依赖图（DAG）
└─ 触发 afterEvaluate 事件

执行阶段
├─ 根据任务依赖图执行任务
├─ 运行任务的 doFirst/doLast
└─ 触发任务执行前后的事件
```

---

## 常用生命周期监听示例

在 `build.gradle` 或 `settings.gradle` 中添加监听逻辑：

```groovy
// 监听初始化阶段
gradle.projectsLoaded { 
    println "所有项目已加载"
}

// 监听配置阶段
project.afterEvaluate {
    println "项目 ${it.name} 配置完成"
}

// 监听执行阶段
gradle.taskGraph.whenReady { taskGraph ->
    println "任务依赖图已构建，将执行 ${taskGraph.allTasks.size} 个任务"
}

gradle.taskGraph.beforeTask { task ->
    println "即将执行任务: ${task.name}"
}
```

---

## 注意事项

1. **避免在配置阶段执行耗时操作**：配置阶段的代码会每次构建都执行，即使不运行任务。
2. **利用增量构建**：通过正确声明任务的输入/输出，Gradle 可以跳过未更改的任务。
3. **调试生命周期**：通过添加 `--console=verbose` 参数查看详细生命周期日志。

理解 Gradle 的生命周期可以帮助你优化构建性能，合理组织构建逻辑，并在适当的位置插入自定义逻辑（如代码检查、资源预处理等）。
