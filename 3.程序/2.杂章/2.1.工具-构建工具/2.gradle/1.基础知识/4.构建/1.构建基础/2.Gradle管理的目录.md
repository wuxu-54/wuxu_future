# Gradle 使用的目录和文件

Gradle 使用两个主要目录来执行和管理其工作：Gradle 用户主目录 和 项目根目录。以下两节描述了它们各自存储的内容以及如何清理临时文件和目录。

## Gradle 用户主目录

Gradle 用户主目录（默认为`<home directory of the current user>/.gradle`）用于存储全局配置属性和初始化脚本以及缓存和日志文件。大致结构如下：

```txt
├── caches 
│   ├── 4.8 
│   ├── 4.9 
│   ├── ⋮
│   ├── jars-3 
│   └── modules-2 
├── daemon 
│   ├── ⋮
│   ├── 4.8
│   └── 4.9
├── init.d 
│   └── my-setup.gradle
├── jdks 
│   ├── ⋮
│   └── jdk-14.0.2+12
├── wrapper
│   └── dists 
│       ├── ⋮
│       ├── gradle-4.8-bin
│       ├── gradle-4.9-all
│       └── gradle-4.9-bin
└── gradle.properties 
```

- 全局缓存目录（用于非项目特定的所有内容）
- 特定于版本的缓存（例如，支持增量构建）
- 共享缓存（例如，用于依赖项的构件）
- Gradle守护进程 的注册表和日志
- 全球初始化脚本
- 工具链支持 下载的 JDK
- Gradle Wrapper 下载的发行版
- 全球Gradle 配置属性

## 清理缓存和分发

Gradle 会自动清理其用户主目录。默认情况下，清理在 Gradle 守护进程停止或关闭时在后台运行。如果使用 --no-daemon ，它会在构建会话后在前台运行，并带有可视进度指示器。

定期应用以下清理策略（默认情况下，每 24 小时一次）：

- 检查 `caches/<gradle-version>/` 中特定于版本的缓存是否仍在使用中。如果不是，发布版本的目录在 30 天不活动后删除，快照版本在 7 天不活动后删除。
- 检查 `caches/` 中的共享缓存（例如 jars-* ）是否仍在使用中。如果没有仍在使用它们的 Gradle 版本，它们将被删除。
- 检查 `caches/` 中当前 Gradle 版本（例如 jars-3 或 modules-2 ）使用的共享缓存中的文件上次访问的时间。根据文件是可以在本地重新创建还是必须再次从远程仓库下载，它将分别在 7 天或 30 天未被访问后删除。
- 检查 `wrapper/dists/` 中的 Gradle 发行版是否仍在使用，即是否有相应的特定于版本的缓存目录。未使用的分配被删除。

## 配置缓存和分发的清理

可以配置各种缓存的保留期。缓存分为四类：

- 发布的包装器分布：与已发布版本（例如 4.6.2 或 8.0 ）相对应的发行版和相关的特定于版本的缓存。未使用版本的默认保留期为 30 天。
- 快照包装器分布：与快照版本（例如 7.6-20221130141522+0000 ）相对应的发行版和相关的特定于版本的缓存。未使用版本的默认保留期为 7 天。
- 下载的资源：从远程仓库下载的共享缓存（例如缓存的依赖项）。未使用资源的默认保留期为 30 天。
- 创建的资源：Gradle 在构建过程中创建的共享缓存（例如构件转换）。未使用资源的默认保留期为 7 天。

每个类别的保留期可以通过 Gradle User Home 中的初始化脚本独立配置：

示例 1.配置缓存保留

```Groovy
gradleUserHome/init.d/cache-settings.gradle
beforeSettings { settings ->
    settings.caches {
        releasedWrappers.removeUnusedEntriesAfterDays = 45
        snapshotWrappers.removeUnusedEntriesAfterDays = 10
        downloadedResources.removeUnusedEntriesAfterDays = 45
        createdResources.removeUnusedEntriesAfterDays = 10
    }
}
```

```kotlin
gradleUserHome/init.d/cache-settings.gradle.kts
beforeSettings {
    caches {
        releasedWrappers.setRemoveUnusedEntriesAfterDays(45)
        snapshotWrappers.setRemoveUnusedEntriesAfterDays(10)
        downloadedResources.setRemoveUnusedEntriesAfterDays(45)
        createdResources.setRemoveUnusedEntriesAfterDays(10)
    }
}
```

调用缓存清理的频率也是可配置的。共有三种可能的设置：

- **DEFAULT**:清理在后台定期执行（目前每 24 小时一次）。
- **DISABLED**:永远不要清理 Gradle 用户主页。这在 Gradle 用户主页是短暂的或者希望将清理延迟到将来的某个明确时间点的情况下很有用。
- **ALWAYS**:清理在每个构建会话结束时执行。这在需要确保在继续之前确实进行了清理的情况下很有用。但是，这确实会在构建期间（而不是在后台）执行缓存清理，这可能是一项昂贵的操作，因此只有在绝对必要时才应使用此选项。

示例 2.禁用缓存清理

```Groovy
gradleUserHome/init.d/cache-settings.gradle
beforeSettings { settings ->
    settings.caches {
        cleanup = Cleanup.DISABLED
    }
}
```

请注意，缓存清理设置只能通过初始化脚本进行配置，并且应放置在 Gradle 用户主目录的 `init.d` 目录下。这有效地将缓存清理的配置耦合到这些设置适用的 Gradle 用户主目录，并限制了来自不同项目的不同冲突设置被应用到同一目录的可能性。

## 在多个版本的 Gradle 之间共享一个 Gradle 用户主目录

在多个版本的 Gradle 之间共享单个 Gradle 用户主目录是很常见的。如上所述，Gradle 用户主页中有特定于版本的缓存。通常，不同版本的 Gradle 只会对与每个版本相关联的特定于版本的缓存执行维护。另一方面，还有其他缓存在版本之间共享（例如，依赖构件缓存或构件转换缓存）。从 Gradle 版本 8.0 开始，可以将缓存清理设置配置为自定义保留期。但是，旧版本的保留期是固定的（7 天或 30 天，具体取决于缓存），因此共享缓存可以由具有不同缓存构件保留设置的 Gradle 版本访问。这意味着：

- 如果保留期是not自定义的，那么所有执行清理的版本将具有相同的保留期，并且不会因为与多个版本共享一个 Gradle 用户主目录而产生任何影响。

- 如果为大于或等于版本 8.0 的 Gradle 版本自定义保留期以使用保留期shorter而不是之前固定的期限，也不会产生任何影响。了解这些设置的 Gradle 版本将比以前固定的保留期更早地清理构件，而旧版本实际上不会参与共享缓存的清理。

- 如果为大于或等于版本 8.0 的 Gradle 版本自定义保留期以使用比之前固定的保留期longer，则旧版本的 Gradle 可能会比配置的更早清理共享缓存。在这种情况下，如果希望为新版本保留这些共享缓存条目更长的保留期，它们将无法与旧版本共享 Gradle 用户主目录，需要使用单独的目录。

与版本 8.0 之前的 Gradle 版本共享 Gradle 用户主目录时的另一个考虑因素是用于配置缓存保留设置的 DSL 元素在早期版本中不可用，因此必须在版本之间共享的任何初始化脚本中考虑到这一点。这可以通过有条件地应用符合版本的脚本轻松处理。请注意，符合版本的脚本应位于 init.d 目录以外的其他位置（例如子目录），以便不会自动应用。

示例 3.以版本安全的方式配置缓存清理

```Groovy
gradleUserHome/init.d/cache-settings.gradle
if (GradleVersion.current() >= GradleVersion.version('8.0')) {
    apply from: "gradle8/cache-settings.gradle"
}
```

示例 4.版本兼容的缓存配置脚本

```Groovy
gradleUserHome/init.d/gradle8/cache-settings.gradle
beforeSettings { settings ->
    settings.caches {
        releasedWrappers.removeUnusedEntriesAfterDays = 45
        snapshotWrappers.removeUnusedEntriesAfterDays = 10
        downloadedResources.removeUnusedEntriesAfterDays = 45
        createdResources.removeUnusedEntriesAfterDays = 10
    }
}
```

## 缓存标记

从 Gradle 版本 8.1 开始，Gradle 支持使用 CACHEDIR.TAG 文件标记缓存。它遵循 缓存目录标记规范 中描述的格式。该文件的目的是让工具识别不需要搜索或备份的目录。默认情况下，Gradle 用户主目录中的目录 caches 、 wrapper/dists 、 daemon 和 jdks 被标记为该文件。

## 配置缓存标记

缓存标记功能可以通过 Gradle 用户主目录中的初始化脚本进行配置：

示例 5.配置缓存标记

```Groovy
gradleUserHome/init.d/cache-settings.gradle
beforeSettings { settings ->
    settings.caches {
        // Disable cache marking for all caches
        markingStrategy = MarkingStrategy.NONE
    }
}
```

请注意，缓存标记设置只能通过初始化脚本进行配置，并且应放置在 Gradle 用户主目录的 init.d 目录下。这有效地将缓存标记的配置耦合到这些设置适用的 Gradle 用户主目录，并限制了来自不同项目的不同冲突设置被应用到同一目录的可能性。

## 项目根目录

项目根目录包含属于项目的所有源文件。此外，它还包含 Gradle 生成的文件和目录，例如 .gradle 和 build 。前者通常签入源代码管理，而后者是 Gradle 用来支持增量构建等功能的临时文件。总的来说，典型项目根目录的剖析大致如下所示：

```txt
├── .gradle 
│   ├── 4.8 
│   ├── 4.9 
│   └── ⋮
├── build 
├── gradle
│   └── wrapper 
├── gradle.properties 
├── gradlew 
├── gradlew.bat 
├── settings.gradle or settings.gradle.kts 
├── subproject-one 
|   └── build.gradle or build.gradle.kts 
├── subproject-two 
|   └── build.gradle or build.gradle.kts 
└── ⋮
```

- Gradle 生成的项目特定的缓存目录
- 特定于版本的缓存（例如，支持增量构建）
- 此项目的构建目录，Gradle 在其中生成所有构建构件。
- 包含 Gradle Wrapper 的 JAR 文件和配置
- 项目特定 Gradle 配置属性
- 使用 Gradle Wrapper 执行构建的脚本
- 定义子项目列表的项目的设置文件
- 通常一个项目被组织成一个或多个子项目
- 每个子项目都有自己的 Gradle 构建脚本

## 项目缓存清理

从 4.10 版本开始，Gradle 会自动清理项目特定的缓存目录。构建项目后，会定期（最多每 24 小时）检查 `.gradle/<gradle-version>/` 中特定于版本的缓存目录是否仍在使用中。如果 7 天未使用，它们将被删除。
