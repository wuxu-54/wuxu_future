# `maven-publish`插件

maven-publish是一个Gradle插件，它允许用户将编译的输出物（artifacts），如aar、jar等库文件，发布到Apache Maven仓库中。这样，其他项目就可以通过Gradle或Maven进行远程依赖使用这些发布的库。以下是对maven-publish的详细解析：

## 一、引入插件

在需要使用maven-publish插件的Gradle模块的`build.gradle`文件中，可以通过以下两种方式之一引入插件：

1. 使用`apply plugin`语句：

    ```gradle
    apply plugin: 'maven-publish'
    ```

2. 在`plugins`块中声明：

    ```gradle
    plugins {
        id 'maven-publish'
    }
    ```

## 二、配置插件

引入插件后，需要在`build.gradle`文件中配置`publishing`块，以定义要发布的工件（artifacts）和仓库（repositories）。

### 1. 配置publications

`publications`块用于定义要发布的工件。每个工件都是一个`MavenPublication`对象，可以配置其`groupId`、`artifactId`、`version`等属性，并指定要发布的组件（如`components.java`）或自定义工件。

例如：

```gradle
publishing {
    publications {
        myPublication(MavenPublication) {
            groupId = 'org.example'
            artifactId = 'my-library'
            version = '1.0'
            from components.java
        }
    }
}
```

### 2. 配置repositories

`repositories`块用于定义工件要发布的仓库。可以配置本地仓库或远程仓库，并指定仓库的URL和认证信息（如用户名和密码）。

例如，配置本地仓库：

```gradle
publishing {
    repositories {
        mavenLocal()
    }
}
```

配置远程仓库：

```gradle
publishing {
    repositories {
        maven {
            url = 'https://my.repository.com/repo'
            credentials {
                username = 'myUsername'
                password = 'myPassword'
            }
        }
    }
}
```

## 三、使用任务发布工件

maven-publish插件提供了`publishToMavenLocal`任务，用于将工件发布到本地Maven仓库。可以通过在命令行中执行以下命令来运行此任务：

```bash
gradle publishToMavenLocal
```

此外，还可以配置自定义的发布任务，将工件发布到远程Maven仓库。这通常需要在`build.gradle`文件中定义额外的任务和配置。

## 四、高级配置

除了基本的工件和仓库配置外，maven-publish还支持许多高级配置选项，如自定义POM文件内容、添加依赖项、配置SCM信息等。这些配置可以通过在`MavenPublication`对象的`pom`块中进行。

例如，自定义POM文件内容：

```gradle
publishing {
    publications {
        myPublication(MavenPublication) {
            // ... 其他配置 ...
            pom {
                name = 'My Library'
                description = 'A demonstration of Maven POM customization'
                url = 'http://www.example.com/project'
                licenses {
                    license {
                        name = 'The Apache License, Version 2.0'
                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                    }
                }
                developers {
                    developer {
                        id = 'johnd'
                        name = 'John Doe'
                        email = 'john.doe@example.com'
                    }
                }
                scm {
                    connection = 'scm:git:git://example.com/my-library.git'
                    developerConnection = 'scm:git:ssh://example.com/my-library.git'
                    url = 'http://example.com/my-library/'
                }
            }
        }
    }
}
```

## 五、发布不同类型的工件

除了发布标准的jar包外，maven-publish还支持发布其他类型的工件，如sources.jar、javadoc.jar和aar包等。这通常需要在`build.gradle`文件中定义额外的任务和配置。

例如，发布sources.jar和javadoc.jar：

```gradle
task sourcesJar(type: Jar, dependsOn: classes) {
    classifier = 'sources'
    from sourceSets.main.allSource
}

task javadocJar(type: Jar, dependsOn: javadoc) {
    classifier = 'javadoc'
    from javadoc.destinationDir
}

publishing {
    publications {
        myPublication(MavenPublication) {
            // ... 其他配置 ...
            artifact sourcesJar
            artifact javadocJar
        }
    }
}
```

发布aar包到自定义Maven服务器：

```gradle
// 在gradle.properties中定义Maven仓库参数
MAVEN_URL_RELEASE=https://release.myrepo.com/repository/lib-release/
MAVEN_URL_SNAPSHOT=https://snapshot.myrepo.com/repository/lib-snapshot/
MAVEN_USER_NAME=myUsername
MAVEN_PWD=myPassword
GROUP_ID=com.mycompany
VERSION=1.0.0-SNAPSHOT

// 在build.gradle中配置maven-publish
apply plugin: 'maven-publish'
apply plugin: 'com.android.library'

task generateSourcesJar(type: Jar) {
    from android.sourceSets.main.java.srcDirs
    classifier = 'sources'
}

publishing {
    repositories {
        maven {
            url = VERSION.endsWith('SNAPSHOT') ? MAVEN_URL_SNAPSHOT : MAVEN_URL_RELEASE
            credentials {
                username = MAVEN_USER_NAME
                password = MAVEN_PWD
            }
        }
    }
    publications {
        myAarPublication(MavenPublication) {
            groupId = GROUP_ID
            artifactId = 'my-aar-library'
            version = VERSION
            from components.androidLibraries
            artifact generateSourcesJar

            // 配置POM文件
            pom.withXml {
                def dependenciesNode = asNode().appendNode('dependencies')
                configurations.implementation.allDependencies.each { dep ->
                    if (dep.group != null && dep.name != null && dep.name != 'unspecified' && dep.version != null) {
                        def dependencyNode = dependenciesNode.appendNode('dependency')
                        dependencyNode.appendNode('groupId', dep.group)
                        dependencyNode.appendNode('artifactId', dep.name)
                        dependencyNode.appendNode('version', dep.version)
                        dependencyNode.appendNode('scope', 'implementation')
                    }
                }
            }
        }
    }
}
```

然后在需要发布aar的module的`build.gradle`文件中引用上述配置：

```gradle
apply from: 'path/to/maven_publish_config.gradle'
```

重新编译项目后，就可以通过运行自定义的发布任务将aar包发布到Maven服务器了。

综上所述，maven-publish插件为Gradle用户提供了强大而灵活的发布机制，使得将编译的工件发布到Maven仓库变得简单而高效。

---

## 有哪些任务

`maven-publish` 插件是 Gradle 中的一个强大工具，它允许用户将他们的构建输出（如 JAR、WAR 文件等）发布到 Maven 仓库中。这个插件提供了一系列任务来帮助用户完成发布过程。以下是一些 `maven-publish` 插件常见的任务：

1. **generatePomFileFor\** 任务：
   - 这个任务系列会为每个定义的发布（Publication）生成一个 POM 文件。POM 文件是 Maven 的核心配置文件，包含了项目的元数据，如项目名称、版本、依赖项等。
   - 任务名称中的 `*` 是一个占位符，代表具体的发布名称。例如，如果你定义了一个名为 `myPublication` 的发布，那么相应的任务名称就会是 `generatePomFileForMyPublication`。

2. **publish\**PublicationToMavenLocal** 任务：
   - 这个任务系列会将指定的发布及其 POM 文件和其他元数据复制到本地 Maven 缓存中。这通常用于在本地环境中测试和验证发布。
   - 同样，任务名称中的 `*` 是一个占位符，代表具体的发布名称。例如，`publishMyPublicationToMavenLocal` 会将名为 `myPublication` 的发布复制到本地 Maven 缓存。

3. **publish\**PublicationToRepoNameRepository** 任务：
   - 这个任务系列会将指定的发布发布到名为 `RepoName` 的 Maven 仓库中。你需要配置仓库的 URL 和其他相关设置。
   - `RepoName` 是一个占位符，代表你配置的仓库名称。例如，`publishMyPublicationToMyRepo` 会将名为 `myPublication` 的发布发布到名为 `MyRepo` 的仓库中。

4. **publish** 任务：
   - 这是一个聚合任务，它依赖于所有 `publish\**PublicationToRepoNameRepository` 任务。当你执行 `publish` 任务时，Gradle 会将所有已定义的发布发布到所有已定义的 Maven 仓库中。

5. **publishToMavenLocal** 任务：
   - 这也是一个聚合任务，它依赖于所有 `publish\**PublicationToMavenLocal` 任务。当你执行 `publishToMavenLocal` 任务时，Gradle 会将所有已定义的发布复制到本地 Maven 缓存中，包括它们的元数据（如 POM 文件）。

这些任务为用户提供了灵活而强大的发布机制。你可以通过配置 `build.gradle` 文件中的 `publishing` 块来定义发布和仓库，并使用 Gradle 的命令行工具或 IDE 中的 Gradle 插件来执行这些任务。

请注意，具体的任务名称可能会根据你的 Gradle 版本和 `maven-publish` 插件的版本而有所不同。因此，建议查阅 Gradle 的官方文档或插件的文档来获取最准确的信息。

---

## `publishMavenPublicationTo***Repository` 和 `publishMavenPluginPublicationTo***Repository`的区别

>*** 是你自己定义的名字

在 Gradle 中，`publishMavenPublicationTo***Repository` 和 `publishMavenPluginPublicationTo***Repository` 是两个不同的任务，它们分别用于发布不同的内容到 Maven 仓库。

1. **`publishMavenPublicationTo***Repository`**：
   - 这个任务是 `maven-publish` 插件提供的，用于将普通的 Maven 出版物（`MavenPublication`）发布到指定的 Maven 仓库（`MavenArtifactRepository`）。这里的 "***Repository" 指的是任意配置的仓库，可以是远程仓库，也可以是本地仓库（例如 `mavenLocal()`）。
   - 这个任务会处理普通的 Java 库或任何其他类型的 Maven 兼容的构件，生成 POM 文件，并将构件（如 JAR、WAR 文件）上传到 Maven 仓库中。
   - 例如，如果你有一个 Java 库，并且想要将其发布到 Maven 仓库，你会使用这个任务来完成发布。

2. **`publishMavenPluginPublicationTo***Repository`**：
   - 这个任务是 `gradle-plugin` 插件提供的，专门用于将 Gradle 插件发布到 Maven 仓库。
   - 当你开发了一个 Gradle 插件，并希望将其发布到 Maven 仓库时，这个任务会处理插件的元数据和构件，确保它们符合 Gradle 插件门户的要求。
   - 这个任务会生成必要的插件标记文件（`plugin_marker.mf`），这是 Gradle 插件门户识别插件的关键文件。
   - 例如，如果你有一个自定义的 Gradle 插件，并且想要将其发布到 Maven 仓库，以便其他用户可以通过 Gradle 插件门户来使用，你会使用这个任务来完成发布。

总结来说，`publishMavenPublicationTo***Repository` 用于发布普通的 Maven 构件，而 `publishMavenPluginPublicationTo***Repository` 用于发布 Gradle 插件。两者的主要区别在于它们处理的构件类型和发布的元数据不同。

---

## publishMavenPluginPublicationTo***Repository 的使用

要在使用 `maven-publish` 插件时设置版本，你需要在 `build.gradle` 文件中配置 `publishing` 部分，并且指定 `groupId`、`artifactId` 和 `version`。以下是具体的配置步骤：

### 1. 声明 `maven-publish` 插件

首先，确保在你的 `build.gradle` 文件中声明了 `maven-publish` 插件：

```groovy
plugins {
    id 'maven-publish'
}
```

### 2. 配置项目信息

在 `publishing` 部分，设置项目的 `groupId`、`artifactId` 和 `version`：
>看了源码，发布插件的配置不支持`artifactId`这个字段的设置。

```groovy
group = 'com.example' // 替换为你的groupId
version = '1.0.0' // 设置你的版本号
```

### 3. 配置出版物

在 `publishing` 的 `publications` 部分，创建一个 `MavenPublication` 对象，并设置相关的构件和元数据：

```groovy
publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java

            // 可以在这里设置groupId、artifactId和version
            groupId project.group
            artifactId project.name
            version project.version

            // 添加额外的构件，例如sources和javadoc
            artifact sourcesJar {
                classifier "sources"
            }
            artifact javadocJar {
                classifier "javadoc"
            }
        }
    }
}
```

### 4. 配置仓库

在 `publishing` 的 `repositories` 部分，配置你想要发布到的 Maven 仓库：

```groovy
repositories {
    maven {
        url uri('file:///path/to/your/local/maven/repo') // 本地仓库路径
        // 如果是远程仓库，替换上面的 URL
        credentials {
            username 'your-username' // 仓库用户名
            password 'your-password' // 仓库密码
        }
    }
}
```

### 5. 执行发布任务

配置完成后，你可以通过执行以下命令来发布你的插件：

```shell
./gradlew publishMavenPluginPublicationTo***Repository
```

这里的 `***Repository` 需要替换为你在 `publishing` 配置中定义的仓库名称。

以上步骤提供了如何在使用 `maven-publish` 插件时设置版本和发布插件的详细指南。确保遵循这些步骤，并根据需要调整 `groupId`、`artifactId`、`version` 和仓库配置。参考自：[Gradle 用户手册]。
