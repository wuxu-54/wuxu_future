# 测试

要测试Gradle自定义插件，包括自动化测试，你可以遵循以下步骤和方法：

## 1. 单元测试

单元测试用于验证最小的代码单元，通常是方法。在基于Java的项目中，这个单元是一个方法。单元测试通常不与系统的其他部分交互，例如数据库或文件系统。与系统其他部分的交互通常在存根或模拟的帮助下被切断。对于POJO和实用程序类，它们是独立的并且不使用Gradle API，是单元测试的良好候选者。

**配置测试框架**：
Gradle不规定使用特定的测试框架。流行的选择包括JUnit、TestNG和Spock。选择一个选项后，您必须将其依赖项添加到测试的编译类路径中。例如，使用Spock进行测试的配置如下：

```groovy
dependencies {
    testImplementation 'org.spockframework:spock-core:2.0-M5-groovy-3.0'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}
```

**示例代码**：

```java
class MyPluginClassTest {
    // 使用Spock或其他测试框架编写单元测试
}
```

[参考来源](https://doc.qzxdp.cn/gradle/8.1.1/userguide/testing_gradle_plugins.html)

## 2. 集成测试

集成测试验证多个类或组件作为一个整体协同工作。被测代码可能会接触到外部子系统。

**配置测试框架**：
与单元测试类似，集成测试也需要添加相应的依赖项。

**示例代码**：

```java
class MyPluginIntegrationTest {
    // 使用Spock或其他测试框架编写集成测试
}
```

[参考来源](https://doc.qzxdp.cn/gradle/8.1.1/userguide/testing_gradle_plugins.html)

## 3. 功能测试

功能测试用于从最终用户的角度测试系统。对于Gradle插件来说，端到端测试建立构建脚本，应用被测插件并使用特定任务执行构建。构建的结果（例如标准输出/错误或生成的构件）验证功能的正确性。

**使用Gradle TestKit进行功能测试**：
Gradle TestKit是一个帮助测试Gradle插件和构建逻辑的库。它允许你以编程方式执行构建，并验证构建的结果。

**示例代码**：

```java
import org.gradle.testkit.runner.GradleRunner;
import static org.gradle.testkit.runner.TaskOutcome.SUCCESS;
import org.junit.Rule;
import org.junit.rules.TemporaryFolder;

public class MyPluginFunctionalTest {
    @Rule
    public final TemporaryFolder testProjectDir = new TemporaryFolder();

    @Test
    public void testMyPlugin() {
        File buildFile = testProjectDir.newFile("build.gradle");
        writePluginToBuildFile(buildFile);

        BuildResult result = GradleRunner.create()
            .withProjectDir(testProjectDir.getRoot())
            .withPluginClasspath()
            .withArguments("helloWorld")
            .build();

        assertEquals(SUCCESS, result.task(":helloWorld").getOutcome());
    }

    private void writePluginToBuildFile(File buildFile) throws IOException {
        // 将插件应用到构建文件中
    }
}
```

[参考来源](https://doc.qzxdp.cn/gradle/8.1.1/userguide/testing_gradle_plugins.html)

通过这些步骤和方法，你可以对你的Gradle自定义插件进行全面的测试，包括单元测试、集成测试和功能测试，确保插件的质量和稳定性。

---

## 案例

根据搜索结果，以下是两个具体的Gradle插件测试案例：

### 案例1：集成测试示例 - `DefaultHttpCaller` 插件

这个示例展示了如何为一个名为 `DefaultHttpCaller` 的HTTP调用类实现集成测试。该测试检查是否可以成功地执行HTTP GET请求。

```groovy
package org.myorg.http
import spock.lang.Specification
import spock.lang.Subject

class DefaultHttpCallerIntegrationTest extends Specification {
    @Subject HttpCaller httpCaller = new DefaultHttpCaller()

    def "can make successful HTTP GET call"() {
        when:
        def httpResponse = httpCaller.get('https://www.google.com/')
        then:
        httpResponse.code == 200
        httpResponse.message == 'OK'
    }

    def "throws exception when calling unknown host via HTTP GET"() {
        when:
        httpCaller.get('https://www.wedonotknowyou123.com/')
        then:
        def t = thrown(HttpCallException)
        t.message == "Failed to call URL 'https://www.wedonotknowyou123.com/' via HTTP GET"
        t.cause instanceof UnknownHostException
    }
}
```

[来源](https://doc.qzxdp.cn/gradle/8.1.1/userguide/testing_gradle_plugins.html)

### 案例2：功能测试示例 - `UrlVerifierPlugin` 插件

这个示例展示了如何为一个名为 `UrlVerifierPlugin` 的插件实现功能测试。该插件创建了一个任务 `verifyUrl` 来检查给定的URL是否可以通过HTTP GET解析。

```groovy
package org.myorg
import org.gradle.testkit.runner.GradleRunner
import spock.lang.Specification
import spock.lang.TempDir
import static org.gradle.testkit.runner.TaskOutcome.SUCCESS

class UrlVerifierPluginFunctionalTest extends Specification {
    @TempDir File testProjectDir
    File buildFile

    def setup() {
        buildFile = new File(testProjectDir, 'build.gradle')
        buildFile << """
            plugins {
                id 'org.myorg.url-verifier'
            }
        """
    }

    def "plugin can be applied and task can be configured"() {
        when:
        def result = GradleRunner.create()
            .withProjectDir(testProjectDir)
            .withArguments('verifyUrl')
            .withPluginClasspath()
            .build()

        then:
        result.task(":verifyUrl").outcome == SUCCESS
    }
}
```

[来源](https://doc.qzxdp.cn/gradle/8.1.1/userguide/testing_gradle_plugins.html)

这两个案例提供了一个关于如何对Gradle插件进行集成测试和功能测试的直观示例。通过这些测试，可以确保插件按预期工作，并在实际的构建环境中正确执行其任务。

---

## 自动化测试示例

Gradle自定义插件的自动化测试是确保插件功能正确性和稳定性的关键步骤。下面将详细介绍Gradle自定义插件自动化测试的过程，并提供一个示例。

### 一、测试环境准备

1. **创建测试项目**：

    * 创建一个新的Gradle项目，用于测试自定义插件。
    * 在该项目的`build.gradle`文件中，添加对自定义插件的依赖。

2. **引入测试框架**：

    * Gradle测试项目通常使用JUnit或TestNG等测试框架。
    * 在测试项目的`build.gradle`文件中，添加对测试框架的依赖。

### 二、编写测试代码

1. **创建测试类**：

    * 在测试项目的`src/test/groovy`（或`src/test/java`，取决于你使用的语言）目录下，创建一个测试类。
    * 该测试类应使用JUnit的注解来标记测试方法。

2. **编写测试方法**：

    * 在测试方法中，使用JUnit的断言来验证自定义插件的行为是否符合预期。
    * 可以使用Gradle的`Project`和`Task` API来模拟插件的执行环境。

### 三、配置测试任务

1. **在`build.gradle`中配置测试任务**：

    * 使用Gradle的测试插件（如`java-test`或`groovy-test`）来配置测试任务。
    * 指定测试类的包名和测试方法的名称（如果需要）。

2. **运行测试任务**：

    * 使用Gradle命令行工具（如`gradle test`）来执行测试任务。
    * Gradle将自动编译测试代码、运行测试并生成测试报告。

### 四、示例

假设我们有一个自定义的Gradle插件`MyCustomPlugin`，它添加了一个名为`hello`的任务，该任务在执行时打印“Hello from MyCustomPlugin!”。

#### 1. 自定义插件代码（`MyCustomPlugin.groovy`）

```groovy
package com.example.plugins

import org.gradle.api.Plugin
import org.gradle.api.Project

class MyCustomPlugin implements Plugin<Project> {
    @Override
    void apply(Project project) {
        project.task('hello') {
            doLast {
                println 'Hello from MyCustomPlugin!'
            }
        }
    }
}
```

#### 2. 测试项目`build.gradle`

```groovy
plugins {
    id 'groovy'
    id 'java-test' // 或使用groovy-test插件，取决于你的需求
}

repositories {
    mavenCentral()
}

dependencies {
    testImplementation 'junit:junit:4.13.2' // 或其他版本的JUnit
    // 添加对自定义插件的依赖（假设插件已发布到本地Maven仓库）
    // implementation files('path/to/my-custom-plugin.jar')
    // 或者使用插件ID（如果插件已发布到Gradle插件仓库）
    // id 'com.example.mycustomplugin' version '1.0.0'
}

// 配置测试任务（这里假设插件源代码在项目的某个子目录中）
test {
    useJUnitPlatform()
    testLogging {
        events "passed", "skipped", "failed"
    }
    // 如果插件源代码在项目的src/main/groovy目录下，可以添加以下配置来编译插件源代码
    // sourceSets {
    //     test {
    //         groovy {
    //             srcDirs = ['src/main/groovy']
    //         }
    //     }
    // }
    // 但通常，插件源代码应该作为一个独立的模块或项目来构建和发布，然后在测试项目中添加依赖
}

// 这里不直接添加插件源代码的依赖，而是假设插件已经作为一个JAR文件发布到某个仓库中
// 在实际测试时，你需要将插件JAR文件添加到项目的依赖中
```

#### 3. 测试类（`MyCustomPluginTest.groovy`）

```groovy
package com.example.test

import org.gradle.api.Project
import org.gradle.testkit.runner.GradleRunner
import org.junit.Rule
import org.junit.Test
import org.junit.contrib.java.lang.system.EnvironmentVariables
import org.junit.contrib.java.lang.system.RestoreSystemProperties
import org.junit.rules.TemporaryFolder
import org.junit.rules.RuleChain

import java.io.File
import java.io.IOException

import static org.junit.Assert.assertTrue

class MyCustomPluginTest {

    @Rule
    public final RuleChain ruleChain = RuleChain
            .outerRule(new TemporaryFolder())
            .around(new RestoreSystemProperties())
            .around(new EnvironmentVariables());

    private final TemporaryFolder tempFolder = new TemporaryFolder();

    @Test
    void testHelloTask() throws IOException {
        // 创建一个临时项目目录
        File projectDir = tempFolder.newFolder("testProject");

        // 创建build.gradle文件并添加插件应用代码
        File buildFile = new File(projectDir, "build.gradle");
        buildFile.write("""
            plugins {
                id 'com.example.mycustomplugin' // 使用插件ID来应用插件
            }
        """.stripIndent());

        // 运行Gradle任务并捕获输出
        GradleRunner runner = GradleRunner.create()
                .withProjectDir(projectDir)
                .withPluginClasspath() // 这将自动包含构建脚本的类路径（但不适用于独立插件测试）
                // 注意：对于独立插件测试，你需要将插件JAR文件添加到类路径中
                // .withClasspath(pluginClasspath)
                .withArguments('hello')
                .forwardStandardOutput(System.out);

        // 执行任务并获取结果
        runner.build();

        // 验证任务输出是否包含预期内容
        String output = runner.getOutput();
        assertTrue(output.contains("Hello from MyCustomPlugin!"));
    }
}
```

**注意**：

1. 在上述测试类中，我们使用了Gradle TestKit来运行Gradle任务并捕获输出。TestKit是一个用于测试Gradle插件和构建脚本的工具包。
2. 由于我们的自定义插件`MyCustomPlugin`还没有作为一个独立的JAR文件发布到某个仓库中，因此在测试类中我们暂时无法直接添加对插件的依赖。在实际测试中，你需要将插件JAR文件添加到项目的依赖中，并使用`withClasspath`方法来指定插件的类路径。
3. 上述测试类中的`testHelloTask`方法创建了一个临时项目目录，并在其中创建了一个`build.gradle`文件来应用自定义插件。然后，它使用GradleRunner来运行`hello`任务，并验证任务输出是否包含预期内容。

### 五、执行测试

在测试项目的根目录下，使用Gradle命令行工具执行测试任务：

```sh
gradle test
```

Gradle将自动编译测试代码、运行测试并生成测试报告。你可以在测试报告中查看测试结果的详细信息。

通过上述步骤，你可以为Gradle自定义插件编写自动化测试，并确保插件的功能正确性和稳定性。
