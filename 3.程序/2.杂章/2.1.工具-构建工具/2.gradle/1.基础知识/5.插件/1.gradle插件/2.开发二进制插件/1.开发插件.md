# 开发自定义 Gradle 插件

Gradle 插件打包了可重用的构建逻辑片段，可用于许多不同的项目和构建。 Gradle 允许您实现自己的插件，因此您可以重用您的构建逻辑，并与他人共享。

您可以用任何您喜欢的语言实现 Gradle 插件，前提是该实现最终被编译为 JVM 字节码。在我们的示例中，我们将使用 Java 作为独立插件项目的实现语言，并在 buildscript 插件示例中使用 Groovy 或 Kotlin。通常，使用静态类型的 Java 或 Kotlin 实现的插件将比使用 Groovy 实现的相同插件表现更好。
>本文是最原始的开发插件的配置方法，真正开发可以看[java-gradle-plugin](../3.%E4%B8%89%E6%96%B9%E6%8F%92%E4%BB%B6/1.java-gradle-plugin.md)章节，此章节讲的是我们常用的开发插件的配置方式。

## Gradle插件开发的详解及示例

Gradle插件是一种用于扩展和定制Gradle构建系统功能的机制。Gradle本身只提供了一个核心框架，而各种构建功能（如编译、依赖管理、打包、测试、生成文档等）都是通过插件来完成的。插件为Gradle提供了灵活性，允许开发者根据特定需求添加自定义行为和功能。以下是Gradle插件开发的详解及示例：

### 一、Gradle插件的意义

1. **封装**：把具体的逻辑抽出去，项目只要运行插件就行，不用将插件放在某一个`build.gradle`文件中，这降低了`build.gradle`的可读性。
2. **复用**：把通用的逻辑抽出去，用的时候只要`apply`应用插件即可，不用一遍一遍地复制，也可以提供给其他项目使用。
3. **定制**：如果需要在编译期做一些插桩、Hook之类的自定义操作，也需要用到编译插件。

### 二、Gradle插件的分类

Android下的Gradle插件分为两种：脚本插件和对象插件。

1. **脚本插件**：在Android工程中创建一个`.gradle`为后缀的文件，然后通过`apply from`的方式去引用这个插件。
2. **对象插件（又叫二进制插件）**：实现了`org.gradle.api.Plugin`接口的插件，Gradle本身就提供了一系列对象插件，如`java`、`groovy`、`maven-publish`等。自定义对象插件有以下三种编写方式：

    * 在`build.gradle`文件中直接编写。
    * 在`buildSrc`默认插件目录下编写。
    * 在自定义项目（即独立项目）下编写，然后通过`apply plugin`或者`plugins{}`引用这个插件。

        >`apply plugin`是旧的用法（Gradle 2.1以下版本的用法），如果使用`buildscript{}`块指定第三方库作为Gradle插件的话，指定插件就需要使用`apply plugin`。`plugins{}`是新的用法（Gradle 2.1及以上最新版本的语法）。

### 三、Gradle插件开发示例

以下是三种方式的详细代码示例，第三种，需要设定`maven-publish`，看发布依赖章节就会使用了。

#### 1. 在`build.gradle`文件中直接编写

在`app`下的`build.gradle`中编写自定义对象插件：

```groovy
// 自定义对象插件
class MyPlugin implements Plugin<Project> {
    @Override
    void apply(Project project) {
        println("this is a plugin:${this.class.name}")
        project.task("MyPluginTask") {
            doLast {
                println("MyPluginTask exec success.")
            }
        }
    }
}

// 应用自定义对象插件
apply plugin: MyPlugin
```

执行命令`./gradlew MyPluginTask`，结果如下：

```shell
Configure project :app
this is a plugin:MyPlugin
Task :app:MyPluginTask
MyPluginTask exec success.
BUILD SUCCESSFUL in 1s
1 actionable task: 1 executed
```

#### 2. 在`buildSrc`默认插件目录下编写

在Android工程中，`buildSrc`是Gradle默认的插件目录，编译Gradle的时候会自动识别这个目录，因此在`buildSrc`下编写的插件，可以直接进行引用（通常用于插件的调试）。但是`buildSrc`方式的插件只能在当前工程中使用，其他的项目工程使用不了。

具体使用步骤如下：

（1）首先创建一个名为`buildSrc`的Module，只保留`build.gradle`文件和`src/main`目录，其余的全部删除。注意：创建的Module名字一定要是`buildSrc`，不然找不到插件。`buildSrc`的执行时机不仅早于任何一个`project(build.gradle)`，而且也早于`settings.gradle`。

（2）修改`build.gradle`文件中的内容：

```groovy
// 依赖groovy插件，这个是Gradle内置的插件
apply plugin: 'groovy'

// 引入相关的依赖
dependencies {
    // Groovy DSL
    implementation gradleApi()
    // Gradle DSL
    implementation localGroovy()
}

// 引入相关的仓库
repositories {
    mavenCentral()
}

// 指定好相关资源目录，实际上也可以不用指定，AndroidStudio能够自动识别出来
sourceSets {
    main {
        groovy {
            srcDir 'src/main/groovy'
        }
        resources {
            srcDir 'src/main/resources'
        }
    }
}
```

（3）在`src/main`下创建`groovy`目录，然后根据自己需求创建插件代码存放的包路径，编写插件即可。例如：

```groovy
package com.example.plugin

import org.gradle.api.Plugin
import org.gradle.api.Project

class MyBuildSrcPlugin implements Plugin<Project> {
    @Override
    void apply(Project project) {
        println("This is a plugin from buildSrc: ${this.class.name}")
        project.task("buildSrcTask") {
            doLast {
                println("buildSrcTask exec success.")
            }
        }
    }
}
```

在`app`下的`build.gradle`中应用这个插件：

```groovy
apply plugin: com.example.plugin.MyBuildSrcPlugin
```

执行命令`./gradlew buildSrcTask`，可以看到插件执行成功。

#### 3. 在自定义项目下编写

新建一个独立的module，在该模块下的`build.gradle`里添加依赖：

```groovy
dependencies {
    implementation gradleApi()
}
```

编写插件类：

```groovy
package com.example.secondplugin

import org.gradle.api.Plugin
import org.gradle.api.Project

class MyClass implements Plugin<Project> {
    @Override
    void apply(Project project) {
        System.out.println("this is third plugin")
        project.task("thirdPluginTask") {
            doLast {
                println("thirdPluginTask exec success.")
            }
        }
    }
}
```

编写插件配置文件（通常在`src/main/resources/META-INF/gradle-plugins`目录下创建文件，文件名格式为`插件ID.properties`，内容为`implementation-class=插件实现类的全限定名`）。

例如，创建一个名为`com.example.myplugin.properties`的文件，内容如下：

```properties
implementation-class=com.example.secondplugin.MyClass
```

发布插件到本地仓库，然后在其他项目中使用这个插件。发布插件需要配置`publishing`代码块，这里不再赘述。

### 四、注意事项

1. 在Kotlin脚本中使用`apply()`方法应用插件时，可能会遇到无法获取自定义插件配置扩展的错误。这时需要本地发布依赖才能正常拉取配置。而在Groovy脚本中使用`apply plugin`则没有这个问题。
2. 插件开发时，建议遵循Gradle的约定和最佳实践，如使用标准的目录结构和命名规范等。
3. 在发布插件时，需要注意插件的版本号、GAV（GroupId、ArtifactId、Version）等信息的正确性。

通过以上步骤和示例，可以了解Gradle插件的基本开发流程和注意事项。在实际开发中，可以根据具体需求进行定制和扩展。

---

## 完整的开发、发布、使用插件

Gradle自定义插件的创建、发布和使用涉及多个步骤。以下是一个详细的指南：

### 一、创建自定义Gradle插件

1. **设置项目结构**：

    * 在Gradle项目中，通常会在`buildSrc`目录下创建插件。`buildSrc`是Gradle的默认插件开发目录，其下的代码会在构建主项目之前被编译和应用。
    * 如果不想在`buildSrc`中开发插件，也可以创建一个独立的Gradle模块来开发插件。

2. **配置build.gradle**：

    * 在插件的`build.gradle`文件中，应用`groovy`或`java`插件（取决于插件的实现语言）。
    * 配置依赖项，如`gradleApi()`和`localGroovy()`（如果使用Groovy）。

3. **实现插件**：

    * 创建一个实现`org.gradle.api.Plugin<Project>`接口的Groovy类或Java类。
    * 在`apply`方法中定义插件的行为，如添加任务、创建扩展属性等。

4. **创建插件的标识文件**：

    * 在`resources/META-INF/gradle-plugins`目录下创建一个以插件ID命名的`.properties`文件。
    * 在该文件中，指定`implementation-class`为插件实现类的全限定名。

### 二、发布自定义Gradle插件

1. **配置发布**：

    * 在插件的`build.gradle`文件中，应用`maven-publish`插件。
    * 配置`publications`块，指定要发布的组件（如Java库）。
    * 配置`repositories`块，指定发布仓库的URL（可以是本地文件系统、远程Maven仓库等）。

2. **执行发布任务**：

    * 使用`gradle publish`命令将插件发布到配置的仓库。

### 三、使用自定义Gradle插件

1. **在主项目中应用插件**：

    * 在主项目的`build.gradle`文件中，使用`apply plugin`语句并指定插件ID来应用插件。
    * 如果插件发布在远程仓库，需要配置仓库的URL并在`buildscript`的`dependencies`块中添加插件的依赖。

2. **配置插件**：

    * 如果插件提供了扩展属性或任务，可以在主项目的`build.gradle`文件中进行配置。

3. **运行构建**：

    * 使用`gradle`命令运行构建，并验证插件是否按预期工作。

### 示例

以下是一个简单的Gradle自定义插件示例：

**插件实现（Groovy）**：

```groovy
// src/main/groovy/com/example/MyPlugin.groovy
package com.example

import org.gradle.api.Plugin
import org.gradle.api.Project

class MyPlugin implements Plugin<Project> {
    @Override
    void apply(Project project) {
        project.extensions.create('myExtension', MyExtension)
        project.task('hello') {
            doLast {
                println "Hello from MyPlugin! Message: ${project.myExtension.message}"
            }
        }
    }
}

// src/main/groovy/com/example/MyExtension.groovy
package com.example

class MyExtension {
    String message = 'Default Message'
}
```

**插件标识文件**：

```properties
// resources/META-INF/gradle-plugins/com.example.my-plugin.properties
implementation-class=com.example.MyPlugin
```

**发布配置**：

```groovy
// build.gradle
plugins {
    id 'groovy'
    id 'maven-publish'
}

repositories {
    mavenCentral()
}

dependencies {
    compile gradleApi()
    compile localGroovy()
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            groupId 'com.example'
            artifactId 'my-plugin'
            version '1.0.0'
            from components.java
        }
    }
    repositories {
        maven {
            url uri('path/to/local/repo') // 替换为实际仓库路径
        }
    }
}
```

**使用插件**：

```groovy
// 主项目 build.gradle
plugins {
    id 'java'
}

buildscript {
    repositories {
        maven {
            url uri('path/to/local/repo') // 替换为插件仓库路径
        }
    }
    dependencies {
        classpath 'com.example:my-plugin:1.0.0'
    }
}

apply plugin: 'com.example.my-plugin'

myExtension {
    message = 'Custom Message'
}
```

通过以上步骤，你可以创建、发布和使用自定义的Gradle插件。请注意，以上示例是简化的，实际项目中可能需要更多的配置和依赖管理。
