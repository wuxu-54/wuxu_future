# 静态库和动态库

在 CMake 构建系统中，静态库（Static Library）和动态库（Dynamic Library，又称共享库 Shared Library）是代码复用和模块化管理的重要方式。CMake 提供了简洁的命令来生成和使用这两种库，它们的核心区别体现在**链接时机**、**文件体积**和**依赖管理**上。以下是详细解释：

## 一、静态库（Static Library）

静态库是编译阶段被完整“复制”到可执行文件中的库文件。在程序运行时，静态库的代码已包含在可执行文件内部，不依赖外部文件。

### 1. 静态库的文件格式

- Linux 系统：通常以 `.a` 为扩展名（如 `libmath.a`）。
- Windows 系统：通常以 `.lib` 为扩展名（注意：Windows 中 `.lib` 也可能是动态库的导入库，需结合上下文区分）。

### 2. CMake 生成静态库

使用 `add_library` 命令，指定 `STATIC` 关键字即可生成静态库：

```cmake
# 生成静态库：将 src/math.cpp 编译为静态库 libmath.a（Linux）或 math.lib（Windows）
add_library(math STATIC src/math.cpp)

# 可选：指定静态库的头文件路径（供其他目标引用）
target_include_directories(math PUBLIC include)
```

- `math` 是库的名称（CMake 会自动添加前缀 `lib` 和扩展名 `.a`/.`lib`）。
- `STATIC` 明确指定生成静态库（若省略，CMake 默认根据项目设置判断，通常优先静态库）。

### 3. CMake 链接静态库

使用 `target_link_libraries` 命令将静态库链接到可执行文件：

```cmake
# 生成可执行文件 main
add_executable(main src/main.cpp)

# 将静态库 math 链接到 main（编译时会将 libmath.a 的代码复制到 main 中）
target_link_libraries(main PRIVATE math)
```

- 链接后，可执行文件 `main` 会包含静态库 `math` 的全部代码，运行时无需依赖 `libmath.a`。

## 二、动态库（Dynamic Library / Shared Library）

动态库是在程序**运行时**被加载的库文件，多个程序可以共享同一份动态库代码，不会被复制到可执行文件中。

### 1. 动态库的文件格式

- Linux 系统：通常以 `.so` 为扩展名（如 `libmath.so`）。
- Windows 系统：通常以 `.dll` 为扩展名（如 `math.dll`），同时会生成对应的导入库 `.lib`（用于编译时链接）。
- macOS 系统：通常以 `.dylib` 为扩展名（如 `libmath.dylib`）。

### 2. CMake 生成动态库

使用 `add_library` 命令，指定 `SHARED` 关键字生成动态库：

```cmake
# 生成动态库：将 src/math.cpp 编译为 libmath.so（Linux）或 math.dll（Windows）
add_library(math SHARED src/math.cpp)

# 指定头文件路径（同静态库）
target_include_directories(math PUBLIC include)

# 可选：指定动态库版本（Linux/macOS 中会生成 libmath.so.1.0 等版本文件）
set_target_properties(math PROPERTIES
    VERSION 1.0          # 版本号
    SOVERSION 1          # API 主版本号
)
```

- `SHARED` 明确指定生成动态库。
- `VERSION` 和 `SOVERSION` 用于版本管理，在 Linux 中会生成符号链接（如 `libmath.so -> libmath.so.1 -> libmath.so.1.0`）。

### 3. CMake 链接动态库

链接方式与静态库相同，但底层机制不同：

```cmake
add_executable(main src/main.cpp)

# 链接动态库 math（编译时仅记录依赖关系，不会复制代码到 main 中）
target_link_libraries(main PRIVATE math)
```

- 编译后，可执行文件 `main` 仅包含动态库的“引用信息”，运行时需要动态库文件（如 `libmath.so`）存在于系统的库路径中（如 Linux 的 `/usr/lib`、`LD_LIBRARY_PATH` 环境变量指定的路径）。

## 三、静态库与动态库的核心区别（在 CMake 构建中）

| 维度                | 静态库（STATIC）                          | 动态库（SHARED）                          |
|---------------------|------------------------------------------|------------------------------------------|
| 链接时机            | 编译阶段（链接器将代码复制到可执行文件）   | 运行阶段（操作系统加载器动态加载）         |
| 可执行文件体积      | 较大（包含库的完整代码）                  | 较小（仅包含库的引用）                    |
| 内存占用            | 多个程序使用时，各自占用一份库代码         | 多个程序共享同一份库代码，节省内存         |
| 库更新              | 库更新后，依赖它的可执行文件需重新编译链接 | 库更新后，无需重新编译可执行文件（兼容前提下） |
| 运行时依赖          | 不依赖外部库文件                          | 必须存在对应的动态库文件，否则程序无法运行  |
| CMake 生成命令      | `add_library(xxx STATIC ...)`             | `add_library(xxx SHARED ...)`             |

## 四、CMake 中库的安装与部署

无论是静态库还是动态库，通常需要通过 `install` 命令指定安装路径，方便其他项目使用：

```cmake
# 安装静态库/动态库到系统库目录（如 /usr/lib 或自定义路径）
install(TARGETS math
    LIBRARY DESTINATION lib  # 动态库安装路径（Linux/macOS）
    ARCHIVE DESTINATION lib  # 静态库安装路径
    RUNTIME DESTINATION bin  # Windows 动态库（.dll）安装路径
)

# 安装头文件（供其他项目引用库的接口）
install(DIRECTORY include/ DESTINATION include)
```

## 五、如何选择？

- **选静态库**：适合小型项目、需要“单文件部署”（无需额外带库）、对库更新频率低的场景。
- **选动态库**：适合大型项目、多个程序共享库代码（节省空间）、库需要独立更新（如插件机制）的场景。

CMake 对两种库的支持非常灵活，通过修改 `add_library` 的关键字即可切换，无需大幅调整项目结构。
