# 依赖规则

Maven 是一个强大的构建工具，它使用一组规则来管理项目的依赖关系。这些规则确保了构建的一致性和可重复性。以下是 Maven 依赖管理的一些关键规则和概念：

1. **依赖范围（Dependency Scope）**：
   Maven 定义了不同的依赖范围，用于指定依赖在不同构建阶段的可用性以及它们是否被包含在最终的部署包中。常见的依赖范围有：
   - `compile`：默认范围，依赖在编译、测试和运行时都可用。
   - `test`：仅在测试编译和执行阶段有效。
   - `provided`：在编译和测试阶段有效，用于那些运行时由运行环境提供的依赖。
   - `runtime`：仅在测试和运行时有效。
   - `system`：依赖于本地系统上的库，不推荐使用，因为它降低了项目的可移植性。

2. **传递性依赖（Transitive Dependencies）**：
   当 A 依赖 B，B 又依赖 C 时，C 被称为 A 的传递性依赖。Maven 会自动解析传递性依赖，除非显式地排除。

3. **依赖排除（Dependency Exclusion）**：
   如果一个依赖带来了你不想要的传递性依赖，你可以在依赖声明中排除它们。例如：

   ```xml
   <dependencies>
     <dependency>
       <groupId>some.group</groupId>
       <artifactId>some-artifact</artifactId>
       <version>1.0</version>
       <exclusions>
         <exclusion>
           <groupId>unwanted.group</groupId>
           <artifactId>unwanted-artifact</artifactId>
         </exclusion>
       </exclusions>
     </dependency>
   </dependencies>
   ```

4. **依赖版本管理**：
   Maven 允许在 `pom.xml` 的 `<dependencyManagement>` 部分统一管理依赖的版本，这样可以避免在多个模块中重复声明相同的依赖版本。

5. **快照版本（Snapshot Versions）**：
   快照版本用于开发中的项目，通常以 `-SNAPSHOT` 结尾。Maven 会定期检查快照版本的更新。

6. **依赖调解（Dependency Mediation）**：
   Maven 使用“最近定义”原则来调解依赖冲突。如果一个依赖在多个地方被声明了不同的版本，Maven 会选择路径最短的那个版本。

7. **依赖锁定（Dependency Locking）**：
   依赖锁定是指在构建过程中固定依赖的版本，以确保每次构建使用相同的依赖版本。这可以通过以下方式实现：
   - 使用 `-U` 参数强制更新依赖。
   - 使用 `-o` 参数使 Maven 离线工作，使用本地仓库中的依赖。
   - 使用 `mvn dependency:purge-local-repository` 清理本地仓库中的所有已解析依赖。
   - 使用 `mvn dependency:resolve` 显示依赖树并锁定版本。

8. **依赖复制（Dependency Copy）**：
   有时你可能需要将依赖复制到项目的特定目录中，可以使用 `mvn dependency:copy` 目标来实现。

9. **依赖分析（Dependency Analysis）**：
   使用 `mvn dependency:tree` 可以查看项目的依赖树，这有助于理解项目的依赖结构和冲突。

10. **依赖隔离（Dependency Isolation）**：
    在多模块项目中，有时需要隔离模块间的依赖，以避免相互影响。这可以通过在父 POM 中配置 `<module>` 标签来实现。

通过遵循这些规则和最佳实践，你可以有效地管理 Maven 项目的依赖关系，并确保构建的稳定性和可预测性。

---

## 依赖冲突选择规则

Maven 在处理依赖版本冲突时遵循两个主要原则：

1. **最短路径原则**：当项目中存在多个版本的同一依赖时，Maven 会选择依赖路径最短的那个版本。也就是说，如果一个依赖通过最短的路径到达项目，那么这个版本的依赖会被使用。例如，如果依赖链路 A -> B -> C -> X(1.0) 的路径长度为3，而另一个依赖链路 F -> D -> X(2.0) 的路径长度为2，那么 Maven 会选择 X(2.0) 版本。

2. **第一声明者优先原则**：当两个依赖项具有相同的最短路径时，Maven 会选择在 POM 文件中首先声明的那个依赖项的版本。子模块中声明的依赖会优先于父模块中的依赖。

如果 Maven 的自动冲突解决机制没有达到预期效果，你可以手动排除不需要的依赖。使用 `<exclusions>` 标签可以在依赖项中排除特定的传递性依赖。例如，如果你不希望某个依赖项带来的特定子依赖，可以这样配置：

```xml
<dependency>
  <groupId>some.group</groupId>
  <artifactId>some-artifact</artifactId>
  <version>1.0</version>
  <exclusions>
    <exclusion>
      <groupId>unwanted.group</groupId>
      <artifactId>unwanted-artifact</artifactId>
    </exclusion>
  </exclusions>
</dependency>
```

此外，可以使用 `mvn dependency:tree` 命令来查看项目的依赖树，这有助于识别冲突的来源。IDE 插件，如 IntelliJ IDEA 中的 Maven Helper，也可以帮助你分析和解决依赖冲突。

在处理依赖冲突时，通常建议尽量使用最新稳定版本的依赖，以减少版本冲突的可能性，并且在团队中统一依赖管理策略，以避免不必要的版本差异。
