# 完整使用简述

Nginx是一款轻量级的Web服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，在BSD-like协议下发行。Nginx支持热部署，启动简单，可以做到7×24不间断运行，几个月都不需要重新启动。以下是对Nginx使用方法的详细介绍：

## 一、安装Nginx

1. **安装依赖插件**

   Nginx需要使用C语言编写，因此运行Nginx需要安装一个编译工具，GCC就是一个开源的编译器集合，用于处理各种各样的语言，其中就包含了C语言。可以使用以下命令来安装GCC及Nginx的其他依赖：

   ```bash
   yum install -y gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel
   ```

   其中，PCRE库（Perl Compatible Regular Expressions，兼容正则表达式库）在Nginx的Rewrite模块和HTTP核心模块中都会使用到PCRE正则表达式语法；zlib库提供了开发人员的压缩算法，Nginx的各个模块中需要使用gzip压缩；OpenSSL是一个开放源代码的软件库包，应用程序可以使用这个包进行安全通信，避免被窃听。

2. **下载并解压Nginx安装包**

   进入[Nginx官网](http://nginx.org/download/)查找需要下载版本的链接地址，然后使用wget命令进行下载，并解压到指定目录。例如：

   ```bash
   cd /usr/local/src/
   wget http://nginx.org/download/nginx-1.xx.x.tar.gz
   tar zxvf nginx-1.xx.x.tar.gz
   ```

3. **编译和安装Nginx**

   进入解压后的Nginx目录，使用`./configure`命令配置Nginx的安装路径和其他选项，然后使用`make`命令编译，最后使用`make install`命令安装Nginx。例如：

   ```bash
   cd nginx-1.xx.x
   ./configure --prefix=/usr/local/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --with-http_ssl_module --with-http_v2_module --with-stream --with-stream_ssl_module --with-mail --with-mail_ssl_module
   make
   make install
   ```

   其中，`--with-http_ssl_module`、`--with-http_v2_module`等选项用于启用Nginx的特定功能模块。

## 二、启动和访问Nginx

1. **启动Nginx**

   在Nginx的安装目录下的sbin目录中执行`nginx`命令，或者配置环境变量后在任何地方执行`nginx`命令来启动Nginx。例如：

   ```bash
   cd /usr/sbin/
   ./nginx
   ```

   或者配置环境变量后：

   ```bash
   nginx
   ```

2. **关闭和重新加载Nginx**

   使用`nginx -s stop`命令关闭Nginx，使用`nginx -s reload`命令重新加载Nginx的配置文件。

3. **访问Nginx**

   在浏览器中访问Nginx服务器的IP地址和端口号（默认端口号为80），如果看到“Welcome to nginx!”页面，则表示Nginx已经成功安装并运行。

## 三、配置Nginx

Nginx的配置文件通常位于`/etc/nginx/nginx.conf`（或安装时指定的其他路径），配置文件的结构包括全局块、events块、http块等。以下是一些常见的配置示例：

1. **配置默认网站**

   当配置文件nginx.conf中有且只有一个server时，该server就被Nginx认为是默认网站，所有发给Nginx服务器80端口的数据都会默认给该server。例如：

   ```nginx
   server {
       listen 80;
       server_name localhost;
       location / {
           root html;
           index index.html index.htm;
       }
       error_page 500 502 503 504 /50x.html;
       location = /50x.html {
           root html;
       }
   }
   ```

2. **配置location**

   location指令用于匹配请求的URI，并根据匹配结果选择不同的处理逻辑。location的具体语法为：`location [ = | ~ | ~* | ^~ ] URL { ... }`。其中，方括号中的符号表示匹配的类型，URL表示要匹配的URI。例如：

   ```nginx
   location /images/ {
       alias /data/images/;
       valid_referers none blocked *.ayitula.com;
       if ($invalid_referer) {
           rewrite ^/ http://www.ayitula.com/daolian.gif;
       }
   }
   ```

3. **配置反向代理**

   Nginx可以通过反向代理实现负载均衡，将客户端请求分发到多个后端服务器上。配置示例如下：

   ```nginx
   http {
       upstream backend {
           server backend1.example.com;
           server backend2.example.com;
           server backend3.example.com;
       }
       server {
           listen 80;
           location / {
               proxy_pass http://backend;
           }
       }
   }
   ```

   其中，upstream指令定义了一个后端服务器组，server指令指定了后端服务器的地址。location指令中的proxy_pass指令将请求转发到后端服务器组。

4. **配置负载均衡策略**

   Nginx支持多种负载均衡策略，如轮询（默认）、权重（weight）、IP哈希（ip_hash）、最少连接（least_conn）等。可以在upstream指令中通过相关参数来配置负载均衡策略。例如：

   ```nginx
   upstream backend {
       server backend1.example.com weight=3;
       server backend2.example.com;
       server backend3.example.com;
   }

   upstream backend_ip_hash {
       ip_hash;
       server backend1.example.com;
       server backend2.example.com;
       server backend3.example.com;
   }

   upstream backend_least_conn {
       least_conn;
       server backend1.example.com;
       server backend2.example.com;
       server backend3.example.com;
   }
   ```

5. **配置限流**

   Nginx可以通过限流模块（ngx_http_limit_req_module）来限制客户端请求的速率，从而保护服务器免受过载攻击。配置示例如下：

   ```nginx
   http {
       limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;
       server {
           listen 80;
           location / {
               limit_req zone=mylimit burst=20 nodelay;
               proxy_pass http://backend;
           }
       }
   }
   ```

   其中，limit_req_zone指令定义了一个限流区域，$binary_remote_addr是客户端IP地址的二进制形式，zone=mylimit指定了区域名称和共享内存大小（10m），rate=10r/s表示每秒最多处理10个请求。limit_req指令应用了限流区域，并设置了允许的突发请求数（burst=20）和超过限速后的处理方式（nodelay表示立即返回错误而不是排队）。

6. **配置动静分离**

   动静分离是指将动态请求和静态请求分开处理，以提高网站的性能。静态资源（如图片、CSS、JS文件）可以直接由Nginx处理，动态请求（如PHP、Python、Java等）则代理到后端应用服务器。配置示例如下：

   ```nginx
   server {
       listen 80;
       location / {
           proxy_pass http://backend;
       }
       location ~* \.(jpg|jpeg|png|gif|css|js|ico|html)$ {
           root /var/www/static;
           expires 30d;
       }
   }
   ```

   其中，location指令中的正则表达式`~* \.(jpg|jpeg|png|gif|css|js|ico|html)$`用于匹配静态资源文件的URI，root指令指定了静态资源的根目录，expires指令设置了浏览器缓存过期时间。

## 四、Nginx性能调优

1. **系统层面调优**

   调整操作系统内核参数以更好地支持Nginx的高并发处理能力。例如，增加系统文件描述符的限制、TCP连接队列的大小等。

2. **Nginx配置调优**

   调整Nginx的配置参数以优化性能。例如，设置Worker进程数等于服务器的CPU核心数、增加每个Worker进程可以打开的连接数、启用HTTP/2等。

3. **缓存利用**

   启用文件缓存和代理缓存以减少磁盘I/O操作和服务器响应时间。例如，使用Nginx作为反向代理服务器时，可以缓存后端服务器的响应内容。

4. **启用Gzip压缩**

   启用Gzip压缩可以减少数据传输量，提高响应速度。可以在Nginx的配置文件中添加相关指令来启用Gzip
