
# Nginx 的配置文件

Nginx 的配置文件（通常为 `/etc/nginx/nginx.conf`）采用分层结构，由全局块、`events` 块、`http` 块（包含 `server` 块和 `location` 块）组成。以下是各部分核心指令的详细解析及作用说明：

## **一、全局块（Global Block）**

**作用**：影响 Nginx 服务器整体运行的全局配置，位于配置文件最外层。

| 指令                | 说明                                                                 | 示例/默认值                     |
|---------------------|----------------------------------------------------------------------|---------------------------------|
| `user <user>`        | 指定 Nginx 工作进程运行的用户（非 root 更安全）。                     | `user www-data;`                |
| `worker_processes <n>` | 工作进程数，建议设为 CPU 核心数（`auto` 自动识别核心数）。           | `worker_processes auto;`        |
| `error_log <path> [level]` | 错误日志路径及级别（`debug`/`info`/`notice`/`warn`/`error`/`crit`）。 | `error_log /var/log/nginx/error.log warn;` |
| `pid <path>`         | 存储主进程 PID 的文件路径。                                           | `pid /var/run/nginx.pid;`       |
| `worker_rlimit_nofile <n>` | 每个工作进程允许打开的最大文件描述符数（优化高并发场景）。           | `worker_rlimit_nofile 65535;`   |
| `daemon [on/off]`    | 是否以守护进程模式运行（默认 `on`，生产环境建议保持默认）。           | `daemon on;`                    |

## **二、events 块（Events Block）**

**作用**：配置 Nginx 如何处理客户端连接的网络事件。

| 指令                | 说明                                                                 | 示例/默认值                     |
|---------------------|----------------------------------------------------------------------|---------------------------------|
| `use <model>`        | 指定事件驱动模型（Linux 推荐 `epoll`，BSD 推荐 `kqueue`，Windows 用 `select`）。 | `use epoll;`                    |
| `worker_connections <n>` | 每个工作进程允许的最大并发连接数（实际最大连接数 ≈ `worker_processes * n`）。 | `worker_connections 1024;`      |
| `multi_accept [on/off]` | 是否允许工作进程一次接受多个新连接（提升高并发性能）。               | `multi_accept on;`              |
| `accept_mutex [on/off]` | 连接接受锁（避免多个进程同时抢占连接，默认 `on`）。                   | `accept_mutex off;`             |

## **三、http 块（HTTP Block）**

**作用**：HTTP 协议相关的全局配置，可包含多个 `server` 块（虚拟主机）。

### **3.1 HTTP 全局指令**

| 指令                | 说明                                                                 | 示例/默认值                     |
|---------------------|----------------------------------------------------------------------|---------------------------------|
| `include <file>`     | 引入其他配置文件（常用于拆分静态资源、反向代理等配置）。             | `include /etc/nginx/mime.types;` |
| `default_type <type>` | 设置默认 MIME 类型（未匹配到 `mime.types` 时使用）。                  | `default_type application/octet-stream;` |
| `sendfile [on/off]`  | 开启零拷贝（提升文件传输效率，需内核支持）。                          | `sendfile on;`                  |
| `tcp_nopush [on/off]` | 结合 `sendfile`，启用 TCP NOPUSH 优化网络包发送（适用于大文件传输）。 | `tcp_nopush on;`                |
| `keepalive_timeout <time>` | 长连接超时时间（客户端与 Nginx 保持连接的时间）。                     | `keepalive_timeout 65;`         |
| `gzip [on/off]`      | 开启 Gzip 压缩（减少响应数据体积，需配合 `gzip_types` 指定压缩类型）。 | `gzip on;`                      |
| `gzip_comp_level <n>`| 压缩等级（1-9，数值越大压缩率越高但CPU消耗越大）。                    | `gzip_comp_level 5;`            |
| `gzip_types <types>` | 需压缩的 MIME 类型（如文本、JSON、CSS 等，避免压缩图片等二进制文件）。| `gzip_types text/plain application/json;` |
| `server_tokens off;` | 隐藏 Nginx 版本信息（降低被攻击风险）。                               | `server_tokens off;`            |

### **3.2 server 块（虚拟主机配置）**

**作用**：单个虚拟主机（网站）的配置，可监听端口、绑定域名、处理请求。

| 指令                | 说明                                                                 | 示例/默认值                     |
|---------------------|----------------------------------------------------------------------|---------------------------------|
| `listen <port>`      | 监听端口，可附加 IP、SSL 等参数（如 `listen 443 ssl;`）。            | `listen 80;`                    |
| `server_name <name>` | 绑定的域名（支持通配符 `*.example.com` 和正则 `~^www\.`）。           | `server_name example.com www.example.com;` |
| `root <path>`        | 请求的根目录（如 `location /` 匹配时，文件路径为 `root + URI`）。     | `root /var/www/html;`           |
| `index <file>`       | 默认索引文件（如 `index.html index.php`）。                           | `index index.html;`             |
| `access_log <path>`  | 访问日志路径（记录客户端请求信息）。                                 | `access_log /var/log/nginx/access.log;` |
| `error_page <code> <path>` | 自定义错误页面（如 `error_page 404 /404.html;`）。                    | `error_page 500 502 /50x.html;` |

### **3.3 location 块（URL 路径匹配）**

**作用**：根据 URL 路径匹配规则，配置不同的处理逻辑（如静态文件、反向代理、URL 重写等）。

| 指令                | 说明                                                                 | 示例/默认值                     |
|---------------------|----------------------------------------------------------------------|---------------------------------|
| `location [=|~|~*|^~] <pattern>` | 匹配规则：<br>`=` 精确匹配<br>`~` 区分大小写正则<br>`~*` 不区分大小写正则<br>`^~` 优先匹配路径前缀 | `location = / { ... }`（首页精确匹配）<br>`location ~* \.(jpg|png)$ { ... }`（图片正则匹配） |
| `alias <path>`       | 路径别名（替代 `root`，如 `location /static/ { alias /data/static/; }`）。 | `alias /data/static/;`          |
| `rewrite <regex> <replacement> [flag]` | URL 重写（`flag` 常用 `last`/`redirect`/`permanent`）。               | `rewrite ^/(.*)$ https://$host/$1 permanent;`（HTTP 转 HTTPS） |
| `proxy_pass <url>`   | 反向代理到后端服务器（如 `proxy_pass http://127.0.0.1:8080;`）。       | `proxy_pass http://backend;`    |
| `proxy_set_header <field> <value>` | 传递给后端服务器的请求头（如添加客户端 IP）。                        | `proxy_set_header X-Real-IP $remote_addr;` |
| `try_files <files> <fallback>` | 按顺序检查文件是否存在，不存在则返回 `fallback`（如 `404` 或内部重定向）。 | `try_files $uri $uri/ /index.php?$args;` |
| `limit_req_zone <key> zone=name:size rate=rate;` | 限流配置（如限制同一 IP 每秒请求数）。                                 | `limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;` |

## **四、SSL/TLS 配置（常见于 server 块）**

**作用**：配置 HTTPS 访问，需先申请 SSL 证书。

| 指令                | 说明                                                                 | 示例/默认值                     |
|---------------------|----------------------------------------------------------------------|---------------------------------|
| `ssl on;`           | 启用 SSL（Nginx 1.15+ 推荐用 `listen 443 ssl;` 替代）。               | `listen 443 ssl;`               |
| `ssl_certificate <path>` | SSL 证书路径（公钥文件）。                                           | `ssl_certificate /etc/ssl/cert.pem;` |
| `ssl_certificate_key <path>` | SSL 私钥路径。                                                       | `ssl_certificate_key /etc/ssl/key.pem;` |
| `ssl_protocols <protocols>` | 允许的 SSL/TLS 协议（建议禁用旧协议如 `TLSv1.2` 以上）。              | `ssl_protocols TLSv1.3 TLSv1.2;` |
| `ssl_ciphers <ciphers>` | 加密算法套件（推荐使用 Mozilla 推荐的强加密组合）。                    | `ssl_ciphers ECDHE+CHACHA20:ECDHE+AESGCM;` |
| `ssl_prefer_server_ciphers on;` | 优先使用服务器端加密算法。                                           | `ssl_prefer_server_ciphers on;` |

## **五、其他常见配置**

### **5.1 防盗链（Referer 校验）**

```nginx
location ~ \.(jpg|png|gif)$ {
    valid_referers none blocked example.com *.example.com;
    if ($invalid_referer) {
        return 403; # 或重定向到占位图
    }
}
```

### **5.2 限流（Limit Request）**

```nginx
http {
    limit_req_zone $binary_remote_addr zone=req_limit:10m rate=5r/s; # 定义限流区域
    server {
        location / {
            limit_req zone=req_limit burst=10 nodelay; # 突发请求数限制
        }
    }
}
```

### **5.3 跨域资源共享（CORS）**

```nginx
location /api/ {
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
    add_header Access-Control-Allow-Headers 'DNT,User-Agent,Content-Type';
    if ($request_method = 'OPTIONS') {
        return 204; # 处理预检请求
    }
}
```

## **六、配置文件最佳实践**

1. **分层管理**：将不同功能的配置拆分到独立文件（如 `conf.d/` 目录），通过 `include` 引入，便于维护。
2. **性能优化**：
   - 静态资源开启 `sendfile` 和 `gzip`；
   - 根据业务场景调整 `worker_processes` 和 `worker_connections`。
3. **安全加固**：
   - 隐藏版本号（`server_tokens off;`）；
   - 限制上传文件大小（`client_max_body_size 10m;`）；
   - 启用 HTTPS 并配置强加密协议。
4. **调试技巧**：
   - 测试配置语法：`nginx -t`；
   - 重新加载配置：`nginx -s reload`；
   - 开启 `debug` 日志定位问题。

通过以上详解，可全面掌握 Nginx 配置文件的结构和核心指令，根据业务需求灵活配置反向代理、负载均衡、静态资源服务等场景。
