# node.js 多进程

在Node.js中，多进程处理是一种提高应用程序性能和稳定性的技术。由于Node.js是单线程的，它不能充分利用多核CPU的计算能力。通过创建多个进程，可以将工作负载分散到不同的CPU核心上，从而提高性能和可靠性。

## Node.js的多进程模型

Node.js提供了几个模块来支持多进程编程：

* **cluster**: 这是一个基于Node.js核心的模块，允许你创建多个工作进程，并在它们之间共享服务器负载。cluster模块是实现简单负载均衡和容错机制的理想选择。

* **child_process**: 这个模块允许你创建子进程，并与它们进行通信。你可以使用它来运行其他Node.js应用程序、系统命令或任何可执行文件。

### 使用cluster模块

cluster模块提供了一个简单的多进程模型，它抽象了底层的进程创建和管理细节。以下是使用cluster模块的基本示例：

```js
const cluster = require('cluster');
const http = require('http');
const numCPUs = require('os').cpus().length;

if (cluster.isMaster) {
  console.log(`Master ${process.pid} is running`);  // 工作进程数量通常与CPU核心数相同
    for (let i = 0; i < numCPUs; i++) {    
        cluster.fork();  
    }

    cluster.on('exit', (worker, code, signal) => {    
        console.log(`worker ${worker.process.pid} died`);
        console.log(`Starting a new worker`);
        cluster.fork();
    });
} else {
  // 工作进程
  http.createServer((req, res) => {
    res.writeHead(200);
    res.end('Hello from worker ' + process.pid);
  }).listen(8000);

  console.log(`Worker ${process.pid} started`);
}
```

在这个例子中，主进程（master）创建了与CPU核心数相同的工作进程（worker），并在工作进程退出时自动重启新的工作进程。每个工作进程都运行一个简单的HTTP服务器。

### 使用child_process模块
  
Node 提供了 `child_process` 模块来创建子进程，方法有：

* **exec - child_process.exec** 使用子进程执行命令，缓存子进程的输出，并将子进程的输出以回调函数参数的形式返回。

* **spawn - child_process.spawn** 使用指定的命令行参数创建新进程。

* **fork - child_process.fork** 是 spawn()的特殊形式，用于在子进程中运行的模块，如 `fork('./son.js')` 相当于 `spawn('node', ['./son.js'])` 。与spawn方法不同的是，fork会在父进程与子进程之间，建立一个通信管道，用于进程之间的通信。

以下是使用`child_process`模块的示例：

```javascript
const { spawn } = require('child_process');// 创建子进程运行一个命令

const ls = spawn('ls', ['-lh', '/usr']);

ls.stdout.on('data', (data) => {  
    console.log(`stdout: ${data}`);
});

ls.stderr.on('data', (data) => {
  console.error(`stderr: ${data}`);
});

ls.on('close', (code) => {  
    console.log(`child process exited with code ${code}`);
});
```

在这个例子中，我们使用spawn方法创建了一个子进程来运行ls命令，并监听了标准输出和标准错误输出。

## 注意事项

* **进程间通信**：在使用多进程时，你需要考虑进程间的通信机制，如IPC（Inter-Process Communication）。
* **资源共享**：Node.js的进程间不共享内存，每个进程都有自己独立的内存空间。
* **负载均衡**：在使用cluster模块时，你需要确保请求能够均匀地分配给所有工作进程。
* **错误处理**：在多进程环境中，一个进程的失败不应该导致整个应用程序的崩溃。你需要适当地处理进程失败和重启。

通过有效地使用多进程，你可以提高Node.js应用程序的性能和可靠性，尤其是在CPU密集型任务和高并发场景下
