# 分组查询

在 MySQL 中，分组查询通常使用 `GROUP BY` 子句来实现。这种查询允许你根据一个或多个列的值将结果集分组，并且可以对每个组执行聚合函数（如 `COUNT()`, `SUM()`, `AVG()`, `MAX()`, `MIN()` 等）。

## 基本结构

`select 字段列表 from 表名[where 条件] group by 分组字段名[having 分组后过滤条件]`

## 基本语法

```sql
SELECT column1, aggregate_function(column2)
FROM table_name
WHERE condition
GROUP BY column1
ORDER BY column1;
```

- `column1`: 用于分组的列。
- `aggregate_function()`: 聚合函数，如 `COUNT()`, `SUM()` 等。
- `column2`: 聚合函数作用的列。

## 示例1

假设有一个名为 `sales` 的表，包含 `product_id`, `quantity`, 和 `price` 这些列：

```sql
-- 计算每种产品的总销售额
SELECT product_id, SUM(quantity * price) AS total_sales
FROM sales
GROUP BY product_id;
```

## 使用 `GROUP BY` 的步骤

1. **选择聚合列**：选择你想要聚合的列（如 `SUM()`, `COUNT()`, `AVG()` 等）。

2. **分组列**：指定一个或多个列作为分组依据。

3. **过滤条件**：使用 `WHERE` 子句来过滤记录（可选）。

4. **排序结果**：使用 `ORDER BY` 子句对结果进行排序（可选）。

## 聚合函数

- `COUNT()`: 计算组中的行数。
- `SUM()`: 计算数值列的总和。
- `AVG()`: 计算数值列的平均值。
- `MAX()`: 返回数值列的最大值。
- `MIN()`: 返回数值列的最小值。

## 示例2

假设有一个名为 `employees` 的表，包含 `department`, `salary`, 和 `hire_date` 这些列：

```sql
-- 查询每个部门的员工人数
SELECT department, COUNT(*) AS number_of_employees
FROM employees
GROUP BY department;

-- 查询每个部门的平均工资
SELECT department, AVG(salary) AS average_salary
FROM employees
GROUP BY department;

-- 查询每个部门的最高薪资
SELECT department, MAX(salary) AS max_salary
FROM employees
GROUP BY department;

-- 查询每个部门的员工数量，并按员工数量排序
SELECT department, COUNT(*) AS number_of_employees
FROM employees
GROUP BY department
ORDER BY number_of_employees DESC;

-- 组合多个聚合函数
SELECT department, COUNT(*) AS number_of_employees, AVG(salary) AS average_salary
FROM employees
GROUP BY department;
```

## 注意事项

- `GROUP BY` 子句中的列必须是查询中出现的列，或者是聚合函数的参数。
- 如果 `SELECT` 子句中包含了不在 `GROUP BY` 中的列，那么这些列必须被包含在聚合函数中。
- 使用 `HAVING` 子句可以对分组后的结果进行过滤，类似于 `WHERE` 子句，但是 `HAVING` 用于过滤组。

## 使用 `HAVING` 子句

```sql
-- 查询每个部门的平均工资，并过滤出平均工资超过 5000 的部门
SELECT department, AVG(salary) AS average_salary
FROM employees
GROUP BY department
HAVING average_salary > 5000;
```

分组查询是数据分析中常用的技巧，可以帮助你理解数据的分布和聚合统计信息。
