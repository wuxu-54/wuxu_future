# sql注入

MySQL 注入，通常指的是 SQL 注入（SQL Injection），是一种攻击数据库的安全漏洞的技术。攻击者通过在应用程序的输入字段中插入恶意 SQL 代码，试图欺骗数据库执行非法的 SQL 语句。这种攻击可以导致数据泄露、数据篡改、数据丢失，甚至完全破坏数据库。

## SQL 注入的常见手段包括

1. **错误信息**：攻击者通过观察应用程序的错误信息来获取数据库结构信息。
2. **联合查询**：使用 `UNION` 语句将恶意 SQL 代码与原有查询合并，以获取数据库中的数据。
3. **布尔盲注**：当应用程序不显示数据库错误信息时，攻击者可以通过判断查询时间的长短来推断数据库信息。
4. **时间盲注**：通过在 SQL 查询中插入等待时间（如 `SLEEP()` 函数），根据应用程序的响应时间来推断数据库信息。
5. **内联注释**：在 SQL 语句中使用注释符号来绕过应用程序的输入验证。

## 示例

以下是一些SQL注入的示例。

### 1. 基本的SQL注入

假设有一个简单的登录表单，后端的SQL查询可能是这样的：

```sql
SELECT * FROM users WHERE username = '$username' AND password = '$password';
```

如果攻击者在用户名输入 `' OR '1'='1`，不输入密码，那么SQL查询将变成：

```sql
SELECT * FROM users WHERE username = '' OR '1'='1' AND password = '';
```

由于 `'1'='1'` 总是为真，这将导致查询返回所有用户的数据。

### 2. 使用注释符号

如果应用程序对单引号进行了过滤，攻击者可以使用注释符号来绕过过滤：

```sql
username = 'admin'--'
```

这将使得SQL查询在 `admin'--` 处被注释掉，后面的部分（包括密码检查）将被忽略。

### 3. 联合查询注入

如果应用程序返回数据库中的数据，攻击者可能会尝试使用联合查询来获取额外的信息：

```sql
username = 'admin' UNION SELECT null, version(), null;
```

这将导致数据库返回当前MySQL版本的信息。

### 4. 错误信息注入

某些情况下，应用程序会显示数据库错误信息。攻击者可以利用这一点来获取数据库结构信息：

```sql
username = 'test'' AND extractvalue(0x0a,0x0a) -- -
```

这个注入尝试执行一个不存在的函数 `extractvalue`，如果应用程序显示错误信息，攻击者可能会看到数据库的内部结构。

### 5. 盲注（Blind SQL Injection）

在盲注的情况下，应用程序不显示任何错误信息，攻击者需要通过应用程序的行为变化来推断信息。例如，攻击者可能会尝试让数据库返回真或假的条件，然后根据应用程序的反应来判断：

```sql
username = 'admin' AND ASCII(SUBSTRING((SELECT version()), 1, 1)) > 52
```

如果应用程序的行为表明条件为真（例如，用户被重定向到一个页面），攻击者可能会推断出数据库版本的第一个字符的ASCII值大于52。

## 防御SQL注入

为了防止SQL注入，应该采取以下措施：

1. 使用参数化查询（也称为预编译语句，如使用mybatis框架会预编译语句，其原理是设置缓存存储已编译的sql语句）。
2. 对所有用户输入进行验证和清理。
3. 使用ORM框架，这些框架通常自带防止SQL注入的机制。
4. 不要向用户显示数据库错误信息。
5. 使用最小权限原则，限制数据库账户的权限。
6. 定期对应用程序进行安全审计。
7. 使用 Web 应用防火墙（WAF）可以帮助检测和阻止 SQL 注入攻击。
8. 不要在错误消息中显示敏感的数据库信息。
9. 使用安全的API和函数，避免使用可能导致注入的函数，如 `EXECUTE`、`EVAL` 等

以下是一个使用参数化查询的示例，这可以有效防止SQL注入：

```sql
-- 假设使用 PHP 的 PDO
$stmt = $pdo->prepare('SELECT * FROM users WHERE username = :username AND password = :password');
$stmt->execute(['username' => $username, 'password' => $password]);
```

在这个例子中，`:username` 和 `:password` 是参数的占位符，它们会被安全地绑定到查询中，从而防止了SQL注入攻击。
