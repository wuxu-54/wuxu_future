# Docker Compose 项目打包成容器镜像

将本地的 Docker Compose 项目打包成容器镜像的过程主要分为两个步骤：**构建镜像** 和 **导出/分发镜像**。以下是详细操作指南：

## **一、构建镜像（基于 Docker Compose）**

### **1. 准备工作**

确保本地项目包含完整的 `docker-compose.yml` 文件，例如：

```yaml
version: '3'
services:
  web:
    build: .  # 基于当前目录的 Dockerfile 构建
    ports:
      - "80:80"
    depends_on:
      - db
  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=secret
```

### **2. 构建镜像**

在项目目录下执行：

```bash
docker-compose build
```

- **参数说明**：
  - `--no-cache`：不使用缓存，强制重新构建
  - `--pull`：构建前拉取最新基础镜像
  - `--parallel`：并行构建多个服务（Docker 19.03+）

### **3. 查看构建好的镜像**

```bash
docker images
# 输出类似：
# REPOSITORY          TAG       IMAGE ID       CREATED          SIZE
# myapp_web           latest    1234567890ab   5 minutes ago    250MB
# mysql               8.0       abcdef123456   2 weeks ago      545MB
```

## **二、导出镜像为文件**

### **1. 单镜像导出**

```bash
docker save -o myapp_images.tar myapp_web:latest mysql:8.0
```

- `-o`：指定输出文件名
- 可同时导出多个镜像（空格分隔）

### **2. 多镜像导出（推荐）**

使用 Docker Compose 批量导出所有服务镜像：

```bash
# 获取所有服务镜像名称
docker-compose images -q > images.list

# 批量导出
docker save -o myapp_full.tar $(cat images.list)
```

## **三、将镜像传输到目标环境**

### **1. 复制到 NAS 或远程服务器**

```bash
# 使用 SCP 传输（替换目标地址）
scp myapp_images.tar username@nas-ip:/volume1/docker/
```

### **2. 使用 Docker Registry（推荐）**

将镜像推送到私有或公共 Registry：

```bash
# 登录 Registry（如 Docker Hub）
docker login

# 打标签
docker tag myapp_web:latest username/myapp-web:v1.0

# 推送
docker push username/myapp-web:v1.0
```

## **四、在目标环境加载并运行**

### **1. 加载镜像文件**

```bash
docker load -i myapp_images.tar
```

### **2. 创建 docker-compose.yml**

在目标环境创建 `docker-compose.yml`，指向已加载的镜像：

```yaml
version: '3'
services:
  web:
    image: myapp_web:latest  # 使用已加载的镜像
    ports:
      - "80:80"
  db:
    image: mysql:8.0
```

### **3. 启动容器**

```bash
docker-compose up -d
```

## **五、进阶技巧**

### **1. 构建并推送到 Registry（自动化）**

使用 Docker Compose 直接构建并推送：

```bash
docker-compose push
```

需在 `docker-compose.yml` 中指定镜像标签：

```yaml
services:
  web:
    build: .
    image: registry.example.com/myapp/web:v1.0  # 指定完整镜像名
```

### **2. 使用 `.dockerignore`**

在项目根目录创建 `.dockerignore`，排除不必要的文件：

```txt
node_modules
.git
*.log
```

### **3. 压缩镜像文件**

```bash
# 导出并压缩
docker save myapp_web:latest | gzip > myapp_web.tar.gz

# 加载压缩文件
docker load < myapp_web.tar.gz
```

## **六、常见问题**

### **1. 镜像体积过大**

- **优化方法**：
  - 使用多阶段构建（Multi-stage Build）
  - 选择轻量级基础镜像（如 `alpine`）
  - 清理构建过程中的临时文件

### **2. 依赖版本不一致**

- 在 `docker-compose.yml` 中固定镜像版本：

  ```yaml
  image: mysql:8.0.34  # 避免使用 latest 标签
  ```

### **3. 数据卷挂载问题**

确保在目标环境创建相同的目录结构，或使用相对路径：

```yaml
volumes:
  - ./data:/app/data  # 相对路径
```

## **七、总结流程**

1. **本地构建**：`docker-compose build`  
2. **导出镜像**：`docker save -o images.tar myapp_web:latest`  
3. **传输文件**：`scp images.tar nas-ip:/volume1/docker/`  
4. **加载镜像**：`docker load -i images.tar`  
5. **启动服务**：`docker-compose up -d`  

通过以上步骤，可将本地 Docker Compose 项目完整迁移到 NAS 或其他环境中运行。
