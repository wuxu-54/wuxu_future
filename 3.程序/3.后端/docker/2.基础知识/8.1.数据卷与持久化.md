# Docker数据卷与持久化

以下是Docker数据卷与持久化的分步指南：

## **一、Docker数据持久化核心机制**

| **类型**        | **说明**                                                                 | **适用场景**                     |
|-----------------|--------------------------------------------------------------------------|----------------------------------|
| **命名卷 (Volumes)** | Docker管理的持久化存储，存储在`/var/lib/docker/volumes`，安全且易管理。 | 生产环境数据库、需要持久化的应用数据 |
| **绑定挂载 (Bind Mounts)** | 直接挂载宿主机目录到容器，路径需手动指定。                               | 开发环境代码热更新、配置文件       |
| **tmpfs挂载**   | 数据存储在内存中，容器停止后消失。                                       | 临时文件、缓存                   |

---

## **二、操作实践**

### **1. 创建与管理命名卷**

```bash
# 创建卷
docker volume create my_volume

# 查看所有卷
docker volume ls

# 查看卷详细信息（包括存储路径）
docker volume inspect my_volume

# 删除未使用的卷
docker volume prune
```

### **2. 运行容器并挂载卷**

```bash
# 挂载命名卷（MySQL示例）
docker run -d --name mysql_db \
  -v my_volume:/var/lib/mysql \
  -e MYSQL_ROOT_PASSWORD=secret \
  mysql:latest

# 绑定挂载宿主机目录（开发环境示例）
docker run -d --name web_app \
  -v /host/code:/app \
  -p 8080:80 \
  my_web_image
```

### **3. 多容器共享卷**

```bash
# 容器1写入数据
docker run --rm -v shared_vol:/data alpine sh -c "echo 'Hello' > /data/test.txt"

# 容器2读取数据
docker run --rm -v shared_vol:/data alpine cat /data/test.txt
```

---

## **三、数据备份与恢复**

### **1. 备份命名卷数据**

```bash
# 停止相关容器
docker stop mysql_db

# 运行临时容器备份数据
docker run --rm -v my_volume:/source -v /host/backup:/backup alpine \
  tar czf /backup/mysql_backup_$(date +%Y%m%d).tar.gz -C /source .

# 启动容器
docker start mysql_db
```

### **2. 恢复数据到新卷**

```bash
# 创建新卷
docker volume create new_volume

# 解压备份到新卷
docker run --rm -v new_volume:/target -v /host/backup:/backup alpine \
  tar xzf /backup/mysql_backup_20231001.tar.gz -C /target

# 使用新卷启动容器
docker run -d --name mysql_new -v new_volume:/var/lib/mysql mysql:latest
```

---

## **四、Docker Compose集成**

### **docker-compose.yml示例**

```yaml
version: '3.8'

services:
  db:
    image: postgres:13
    volumes:
      - db_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: secret

  web:
    image: nginx:alpine
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"

volumes:
  db_data:  # 自动创建命名卷
```

### **操作命令**

```bash
# 启动服务
docker-compose up -d

# 查看卷
docker-compose exec db ls /var/lib/postgresql/data

# 清理（删除容器和网络，保留卷）
docker-compose down
```

---

## **五、高级技巧**

### **1. 使用卷驱动（NFS示例）**

```bash
# 创建NFS卷
docker volume create --driver local \
  --opt type=nfs \
  --opt device=:/nfs_share \
  --opt o=addr=192.168.1.100,rw \
  nfs_volume

# 挂载到容器
docker run -d --name nfs_app -v nfs_volume:/data my_app
```

### **2. 权限管理**

```bash
# 容器内以指定用户运行
docker run -d --name app \
  -v my_volume:/data \
  --user 1000:1000 \
  my_app

# 宿主机设置目录权限
sudo chown -R 1000:1000 /var/lib/docker/volumes/my_volume/_data
```

---

## **六、常见问题解决**

### **1. 容器无法写入挂载目录**

- **原因**：容器用户无宿主机目录权限。
- **解决**：

  ```bash
  # 查看容器用户ID
  docker exec app id

  # 宿主机设置目录权限
  sudo chown -R 1000:1000 /host/path
  ```

### **2. 数据卷占用空间过大**

```bash
# 查看卷大小
docker system df -v

# 清理未使用卷
docker volume prune
```

---

## **七、最佳实践总结**

1. **生产环境优先使用命名卷**：安全且易于迁移备份。
2. **开发环境使用绑定挂载**：方便代码实时修改调试。
3. **定期备份关键数据**：结合cron任务实现自动化。
4. **避免容器直接操作宿主机敏感目录**：使用命名卷隔离风险。
5. **多服务共享数据时注意并发控制**：如数据库锁机制。

通过合理选择数据持久化策略，可确保容器化应用的数据安全性与高可用性。
