# Docker Compose

以下是关于 **Docker Compose** 的详细说明及示例，涵盖核心概念、使用场景和典型配置：

---

## **一、Docker Compose 是什么？**

- **定义**：用于定义和运行多容器 Docker 应用的工具，通过 `docker-compose.yml` 文件配置服务。
- **核心功能**：  
  - 一键启动/停止多个容器。  
  - 管理容器间的依赖关系（如数据库先于应用启动）。  
  - 统一管理网络、存储卷和环境变量。

---

## **二、核心语法与配置**

### **1. 基础 `docker-compose.yml` 示例**

```yaml
version: '3.8'  # Compose 版本

services:
  web:                    # 服务名称（自定义）
    image: nginx:latest   # 使用的镜像
    ports:
      - "80:80"           # 端口映射（宿主机:容器）
    volumes:
      - ./html:/usr/share/nginx/html  # 挂载静态资源目录
    networks:
      - my-network        # 所属网络

  backend:
    image: my-backend-app:latest
    environment:
      - DB_HOST=database  # 环境变量
    depends_on:
      - database          # 依赖的服务
    networks:
      - my-network

  database:
    image: postgres:14
    volumes:
      - pgdata:/var/lib/postgresql/data  # 持久化数据卷
    environment:
      - POSTGRES_PASSWORD=123456
    networks:
      - my-network

volumes:
  pgdata:                 # 定义数据卷

networks:
  my-network:             # 定义自定义网络
    driver: bridge
```

---

## **三、常用命令**

| 命令                      | 作用                                 |
|---------------------------|--------------------------------------|
| `docker-compose up`       | 启动所有服务（前台运行）             |
| `docker-compose up -d`    | 后台启动所有服务                     |
| `docker-compose down`     | 停止并删除容器、网络                 |
| `docker-compose build`    | 构建自定义镜像（配合 `build` 配置项）|
| `docker-compose logs`     | 查看所有容器的日志                   |
| `docker-compose ps`       | 查看运行中的容器状态                 |

---

## **四、典型应用场景**

### **1. 多服务协作（Web + API + 数据库）**

```yaml
services:
  nginx:
    image: nginx
    ports: ["80:80"]
    depends_on: ["backend"]

  backend:
    build: ./backend  # 根据 Dockerfile 构建镜像
    environment:
      - DB_URL=postgres://user:pass@db:5432/mydb

  db:
    image: postgres:14
    volumes: ["pgdata:/var/lib/postgresql/data"]
```

### **2. 开发环境热重载**

```yaml
services:
  frontend:
    build: ./frontend
    volumes:
      - ./frontend:/app   # 代码实时同步到容器
      - /app/node_modules # 避免覆盖容器内的依赖
    ports: ["3000:3000"]
```

### **3. 集成测试环境**

```yaml
services:
  test-db:
    image: mysql:8
    environment:
      - MYSQL_ROOT_PASSWORD=test

  test-runner:
    build: .
    command: pytest tests/
    depends_on:
      - test-db
```

---

## **五、高级配置技巧**

### **1. 环境变量分离**

- 创建 `.env` 文件：

  ```plaintext
  DB_PASSWORD=secret
  API_KEY=xxxx
  ```

- 在 `docker-compose.yml` 中引用：

  ```yaml
  environment:
    - DB_PASSWORD=${DB_PASSWORD}
  ```

### **2. 多环境配置**

- 使用多个 Compose 文件（如 `docker-compose.prod.yml`）：

  ```bash
  docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
  ```

### **3. 资源限制**

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
```

---

## **六、完整项目示例**

### **文件结构**

```txt
my-project/
├── docker-compose.yml
├── backend/
│   ├── Dockerfile
│   └── src/
├── frontend/
│   ├── Dockerfile
│   └── public/
└── .env
```

### **docker-compose.yml**

```yaml
version: '3.8'

services:
  nginx:
    image: nginx:latest
    ports: ["80:80"]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/dist:/usr/share/nginx/html
    depends_on: ["backend"]

  backend:
    build: ./backend
    environment:
      - DB_HOST=postgres
    ports: ["5000:5000"]

  postgres:
    image: postgres:14
    volumes: ["pgdata:/var/lib/postgresql/data"]
    env_file: .env

volumes:
  pgdata:
```

---

## **七、注意事项**

1. **版本兼容性**：不同 Compose 版本支持的功能不同（推荐使用 `3.8` 或更高）。
2. **网络隔离**：默认所有服务共享同一网络，可通过自定义网络实现分段。
3. **生产环境限制**：Compose 适用于开发/测试，生产环境建议使用 Kubernetes 或 Swarm。

---

通过 Docker Compose，可以快速搭建复杂的多服务应用，极大提升开发和部署效率。
