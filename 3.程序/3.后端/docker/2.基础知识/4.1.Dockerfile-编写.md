# Dockerfile 编写指南

以下是 **Dockerfile 编写指南**，涵盖核心指令、最佳实践和常见场景示例，帮助您高效构建容器镜像：

---

## **一、Dockerfile 核心指令**

| 指令            | 说明                                                                 | 示例                                                                 |
|-----------------|----------------------------------------------------------------------|----------------------------------------------------------------------|
| **`FROM`**      | 指定基础镜像（必须为第一条指令）                                      | `FROM ubuntu:22.04`                                                  |
| **`WORKDIR`**   | 设置工作目录（后续指令默认在此目录执行）                              | `WORKDIR /app`                                                       |
| **`COPY`**      | 复制本地文件到镜像                                                   | `COPY ./src /app/src`                                                |
| **`ADD`**       | 类似 `COPY`，但支持自动解压压缩包和远程URL（慎用）                   | `ADD https://example.com/file.tar.gz /app`                           |
| **`RUN`**       | 执行命令（构建时）                                                   | `RUN apt-get update && apt-get install -y python3`                   |
| **`ENV`**       | 设置环境变量                                                         | `ENV NODE_ENV=production`                                            |
| **`ARG`**       | 定义构建参数（仅在构建阶段有效）                                      | `ARG VERSION=1.0`<br>`RUN echo $VERSION`                             |
| **`EXPOSE`**    | 声明容器运行时监听的端口（实际映射需通过 `-p` 参数）                 | `EXPOSE 80`                                                          |
| **`CMD`**       | 容器启动时的默认命令（可被 `docker run` 覆盖）                       | `CMD ["python", "app.py"]`                                           |
| **`ENTRYPOINT`**| 容器启动时的入口命令（与 `CMD` 结合使用）                            | `ENTRYPOINT ["/entrypoint.sh"]`                                      |
| **`USER`**      | 指定运行容器的用户（提升安全性）                                      | `USER appuser`                                                       |
| **`VOLUME`**    | 定义数据卷挂载点                                                     | `VOLUME /data`                                                       |
| **`HEALTHCHECK`**| 定义容器健康检查                                                     | `HEALTHCHECK --interval=30s CMD curl -f <http://localhost/> || exit 1` |

---

## **二、编写最佳实践**

### **1. 减少镜像层数**

- **合并多个 `RUN` 指令**：

  ```dockerfile
  RUN apt-get update && \
      apt-get install -y python3 && \
      rm -rf /var/lib/apt/lists/*
  ```

### **2. 利用缓存加速构建**

- **变动少的指令放前面**：如依赖安装步骤应放在代码复制之前。

  ```dockerfile
  COPY requirements.txt .
  RUN pip install -r requirements.txt  # 依赖变动少，优先执行
  COPY . .                             # 代码变动频繁，放在后面
  ```

### **3. 使用多阶段构建**

- **减少最终镜像体积**（示例为 Go 应用）：

  ```dockerfile
  # 第一阶段：构建二进制文件
  FROM golang:1.20 AS builder
  WORKDIR /app
  COPY . .
  RUN go build -o myapp .

  # 第二阶段：仅复制二进制文件到轻量镜像
  FROM alpine:3.18
  COPY --from=builder /app/myapp /usr/local/bin/myapp
  CMD ["myapp"]
  ```

### **4. 安全加固**

- **避免以 root 用户运行**：

  ```dockerfile
  RUN groupadd -r appuser && useradd -r -g appuser appuser
  USER appuser
  ```

### **5. 清理无用文件**

- **删除临时文件**：

  ```dockerfile
  RUN apt-get install -y build-essential && \
      # ...编译操作... && \
      apt-get remove -y build-essential && \
      apt-get autoremove -y
  ```

---

## **三、完整示例**

### **1. Python Web 应用**

```dockerfile
# 使用官方 Python 基础镜像
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 复制依赖文件并安装
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 设置环境变量
ENV PORT=8000

# 声明端口
EXPOSE $PORT

# 运行命令
CMD ["gunicorn", "--bind", "0.0.0.0:$PORT", "app:app"]
```

### **2. Node.js 前端应用**

```dockerfile
# 第一阶段：构建静态文件
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 第二阶段：托管静态文件
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

---

## **四、常见问题与解决**

### **1. 缓存导致构建失败**

- **问题**：修改了代码但 `COPY` 未触发重新安装依赖。  
- **解决**：调整指令顺序，确保变动频繁的操作放在后面。

### **2. 权限问题**

- **问题**：容器内无法写入挂载的目录。  
- **解决**：在 Dockerfile 中预先创建目录并设置权限：

  ```dockerfile
  RUN mkdir -p /data && chown appuser:appuser /data
  VOLUME /data
  USER appuser
  ```

### **3. 镜像体积过大**

- **解决**：使用多阶段构建，选择更小的基础镜像（如 `alpine`）。

### **4. 时区设置**

```dockerfile
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
```

---

## **五、调试技巧**

### **1. 查看构建中间层**

```bash
docker build -t myapp:debug .
docker run -it --rm myapp:debug /bin/bash  # 进入镜像检查
```

### **2. 忽略文件（.dockerignore）**

创建 `.dockerignore` 文件，排除无需复制的文件：

```
node_modules
.git
*.log
```

### **3. 分阶段调试**

```dockerfile
# 调试阶段（单独构建）
FROM python:3.11-slim AS debug
RUN apt-get update && apt-get install -y curl
# ...其他调试工具...
```

---

## **六、进阶场景**

### **1. 多环境构建**

使用 `ARG` 区分开发和生产环境：

```dockerfile
ARG ENV=production
ENV NODE_ENV=$ENV

# 构建时指定参数
# docker build --build-arg ENV=development -t myapp:dev .
```

### **2. 私有依赖处理**

- **通过 `COPY` 引入私有包**：

  ```dockerfile
  COPY private-pkg.tar.gz /tmp/
  RUN pip install /tmp/private-pkg.tar.gz
  ```

---

通过遵循以上指南，您可以编写高效、安全的 Dockerfile，构建出符合生产标准的容器镜像。
