# docker compose

`docker compose` 是用于定义和运行多容器 Docker 应用的工具，通过 YAML 文件配置应用服务，然后使用单一命令创建并启动所有服务。以下是其核心命令及用法详解：

## **一、基本操作命令**

1. **启动服务**

   ```bash
   docker compose up
   ```

   - `-d`：后台运行容器（detached mode）。
   - `--build`：启动前强制重新构建镜像。
   - `--force-recreate`：强制重新创建容器，即使配置未变。

2. **停止服务**

   ```bash
   docker compose down
   ```

   - `--volumes`：删除服务定义的匿名卷（named volumes 保留）。
   - `--rmi all`：删除所有服务使用的镜像。

3. **查看服务状态**

   ```bash
   docker compose ps
   ```

   - `-a`：显示所有容器（包括已停止的）。

## **二、服务管理命令**

1. **启动/停止特定服务**

   ```bash
   docker compose start [服务名]
   docker compose stop [服务名]
   ```

2. **重启服务**

   ```bash
   docker compose restart [服务名]
   ```

3. **重新创建并启动服务**

   ```bash
   docker compose up --force-recreate -d [服务名]
   ```

## **三、日志与执行命令**

1. **查看服务日志**

   ```bash
   docker compose logs
   ```

   - `-f`：实时跟踪日志输出（类似 `tail -f`）。
   - `--tail [行数]`：显示最近的指定行数日志。

2. **在运行的容器中执行命令**

   ```bash
   docker compose exec [服务名] [命令]
   ```

   例如：进入 Web 服务的 bash 终端

   ```bash
   docker compose exec web bash
   ```

## **四、构建与镜像管理**

1. **构建或重建服务镜像**

   ```bash
   docker compose build
   ```

   - `--no-cache`：构建时不使用缓存。
   - `--pull`：始终尝试拉取最新的基础镜像。

2. **拉取服务依赖的镜像**

   ```bash
   docker compose pull
   ```

## **五、容器资源控制**

1. **查看资源使用情况**

   ```bash
   docker compose top     # 查看进程信息
   docker compose stats   # 实时监控资源使用
   ```

2. **扩展服务副本数量**

   ```bash
   docker compose up -d --scale [服务名]=[数量]
   ```

   例如：启动 3 个 Web 服务实例

   ```bash
   docker compose up -d --scale web=3
   ```

## **六、高级用法**

1. **使用多个配置文件**

   ```bash
   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
   ```

   - 后加载的文件会覆盖前一个文件的配置。

2. **环境变量替换**

   ```bash
   # .env 文件
   DB_PASSWORD=secret

   # docker-compose.yml
   environment:
     - PASSWORD=${DB_PASSWORD}
   ```

3. **清理未使用的资源**

   ```bash
   docker compose down --volumes --remove-orphans
   ```

## **七、常用参数速查表**

| 参数               | 作用                          |
|--------------------|-------------------------------|
| `-f [文件路径]`    | 指定配置文件                  |
| `-p [项目名]`      | 指定项目名称（默认目录名）    |
| `--env-file [路径]`| 指定环境变量文件              |
| `--abort-on-container-exit` | 任一容器退出时停止所有服务 |

## **八、示例场景**

1. **启动开发环境**

   ```bash
   docker compose -f docker-compose.dev.yml up -d
   ```

2. **部署生产环境**

   ```bash
   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
   ```

3. **更新服务**

   ```bash
   docker compose pull && docker compose up -d --build
   ```

## **注意事项**

- **版本差异**：Docker Compose v2 是 CLI 插件形式（`docker compose`），v1 是独立命令（`docker-compose`），语法基本兼容。
- **配置优先级**：命令行参数 > 环境变量 > `docker-compose.yml`。
- **资源限制**：在配置文件中通过 `mem_limit`、`cpus` 等限制容器资源。

通过组合这些命令，你可以高效管理复杂的多容器应用。更多细节可参考 [官方文档](https://docs.docker.com/compose/reference/)。
