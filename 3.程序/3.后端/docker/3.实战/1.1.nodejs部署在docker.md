# Node.js 服务在 Docker 上的完整部署流程

将 Node.js 服务部署到 Docker 容器中可以提供一致的运行环境，简化部署流程。以下是完整的部署步骤：

## 1. 准备 Node.js 应用

首先确保你的 Node.js 应用已经完成开发并通过测试。应用根目录下应该包含以下文件：

- `package.json` - 项目依赖和脚本配置
- `package-lock.json` - 锁定依赖版本
- `index.js` 或其他入口文件
- 项目源代码

## 2. 创建 Dockerfile

在项目根目录下创建一个名为 `Dockerfile` 的文件，用于定义 Docker 镜像的构建步骤：

```dockerfile
# 使用官方 Node.js 基础镜像
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制 package.json 和 package-lock.json
COPY package*.json ./

# 安装生产依赖
RUN npm ci --production

# 复制应用源代码
COPY . .

# 暴露应用运行的端口（根据你的应用修改）
EXPOSE 3000

# 定义启动命令
CMD ["node", "index.js"]
```

## 3. 创建 .dockerignore 文件

为了避免不必要的文件被复制到镜像中，创建一个 `.dockerignore` 文件：

```txt
node_modules
npm-debug.log
Dockerfile
.dockerignore
.git
.gitignore
```

## 4. 构建 Docker 镜像

在项目根目录下执行以下命令构建 Docker 镜像：

```bash
docker build -t my-node-app .
```

参数说明：

- `-t my-node-app` - 指定镜像名称为 `my-node-app`
- `.` - 指定构建上下文为当前目录

## 5. 测试本地镜像

构建完成后，可以运行容器测试应用：

```bash
docker run -p 3000:3000 my-node-app
```

参数说明：

- `-p 3000:3000` - 将宿主机的 3000 端口映射到容器的 3000 端口

访问 `http://localhost:3000` 验证应用是否正常运行。

## 6. 停止并删除测试容器

测试完成后，可以停止并删除容器：

```bash
# 查看正在运行的容器 ID
docker ps

# 停止容器
docker stop <CONTAINER_ID>

# 删除容器
docker rm <CONTAINER_ID>
```

## 7. 推送镜像到 Docker 仓库（可选）

如果需要在其他环境部署，可以将镜像推送到 Docker 仓库：

```bash
# 登录 Docker Hub
docker login

# 为镜像添加标签（替换 YOUR_USERNAME）
docker tag my-node-app YOUR_USERNAME/my-node-app

# 推送镜像
docker push YOUR_USERNAME/my-node-app
```

## 8. 在生产环境部署

在生产服务器上拉取并运行镜像：

```bash
# 拉取镜像
docker pull YOUR_USERNAME/my-node-app

# 运行容器（添加 -d 参数后台运行）
docker run -d -p 3000:3000 YOUR_USERNAME/my-node-app
```

## 9. 管理容器

常用的容器管理命令：

```bash
# 查看运行中的容器
docker ps

# 查看所有容器
docker ps -a

# 查看容器日志
docker logs <CONTAINER_ID>

# 进入容器
docker exec -it <CONTAINER_ID> sh

# 停止容器
docker stop <CONTAINER_ID>

# 启动容器
docker start <CONTAINER_ID>

# 删除容器
docker rm <CONTAINER_ID>

# 删除镜像
docker rmi <IMAGE_ID>
```

## 10. 使用 Docker Compose（可选）

对于复杂应用，可以使用 Docker Compose 管理多容器服务。创建 `docker-compose.yml` 文件：

```yaml
version: '3'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    restart: always
```

使用以下命令启动服务：

```bash
docker-compose up -d
```

以上就是将 Node.js 服务部署到 Docker 的完整流程。根据实际需求，你可能需要调整端口映射、环境变量和其他配置。
