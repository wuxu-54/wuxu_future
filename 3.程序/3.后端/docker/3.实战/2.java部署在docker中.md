# Java 服务项目部署到 Docker 的完整流程

将 Java 服务部署到 Docker 容器中可以提供一致的运行环境，简化部署流程。以下是完整的部署步骤：

## 1. 准备 Java 应用

首先确保你的 Java 应用已经完成开发并通过测试。应用根目录下应该包含以下文件：

- `pom.xml` (Maven 项目) 或 `build.gradle` (Gradle 项目)
- 源代码文件
- 测试文件
- 配置文件

## 2. 构建 Java 应用

使用 Maven 或 Gradle 构建应用的 JAR 或 WAR 文件：

**Maven 项目**：

```bash
mvn clean package
```

**Gradle 项目**：

```bash
gradle build
```

构建成功后，会在 `target` (Maven) 或 `build/libs` (Gradle) 目录下生成 JAR/WAR 文件。

## 3. 创建 Dockerfile

在项目根目录下创建一个名为 `Dockerfile` 的文件，用于定义 Docker 镜像的构建步骤。

**基于 JRE 的轻量级镜像 (推荐)**：

```dockerfile
# 使用官方 OpenJDK 基础镜像
FROM openjdk:17-jre-slim

# 设置工作目录
WORKDIR /app

# 复制构建好的 JAR 文件
COPY target/your-application.jar /app/

# 暴露应用运行的端口（根据你的应用修改）
EXPOSE 8080

# 定义启动命令
CMD ["java", "-jar", "your-application.jar"]
```

**多阶段构建 (减小镜像体积)**：

```dockerfile
# 第一阶段：构建应用
FROM maven:3.8.4-openjdk-17 AS build
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package

# 第二阶段：创建运行时镜像
FROM openjdk:17-jre-slim
WORKDIR /app
COPY --from=build /app/target/your-application.jar .
EXPOSE 8080
CMD ["java", "-jar", "your-application.jar"]
```

## 4. 创建 .dockerignore 文件

为了避免不必要的文件被复制到镜像中，创建一个 `.dockerignore` 文件：

```txt
target
.git
.gitignore
Dockerfile
.dockerignore
```

## 5. 构建 Docker 镜像

在项目根目录下执行以下命令构建 Docker 镜像：

```bash
docker build -t my-java-app .
```

参数说明：

- `-t my-java-app` - 指定镜像名称为 `my-java-app`
- `.` - 指定构建上下文为当前目录

## 6. 测试本地镜像

构建完成后，可以运行容器测试应用：

```bash
docker run -p 8080:8080 my-java-app
```

参数说明：

- `-p 8080:8080` - 将宿主机的 8080 端口映射到容器的 8080 端口

访问 `http://localhost:8080` 验证应用是否正常运行。

## 7. 停止并删除测试容器

测试完成后，可以停止并删除容器：

```bash
# 查看正在运行的容器 ID
docker ps

# 停止容器
docker stop <CONTAINER_ID>

# 删除容器
docker rm <CONTAINER_ID>
```

## 8. 推送镜像到 Docker 仓库（可选）

如果需要在其他环境部署，可以将镜像推送到 Docker 仓库：

```bash
# 登录 Docker Hub
docker login

# 为镜像添加标签（替换 YOUR_USERNAME）
docker tag my-java-app YOUR_USERNAME/my-java-app

# 推送镜像
docker push YOUR_USERNAME/my-java-app
```

## 9. 在生产环境部署

在生产服务器上拉取并运行镜像：

```bash
# 拉取镜像
docker pull YOUR_USERNAME/my-java-app

# 运行容器（添加 -d 参数后台运行）
docker run -d -p 8080:8080 YOUR_USERNAME/my-java-app
```

## 10. 管理容器

常用的容器管理命令：

```bash
# 查看运行中的容器
docker ps

# 查看所有容器
docker ps -a

# 查看容器日志
docker logs <CONTAINER_ID>

# 进入容器
docker exec -it <CONTAINER_ID> sh

# 停止容器
docker stop <CONTAINER_ID>

# 启动容器
docker start <CONTAINER_ID>

# 删除容器
docker rm <CONTAINER_ID>

# 删除镜像
docker rmi <IMAGE_ID>
```

## 11. 使用 Docker Compose（可选）

对于复杂应用，可以使用 Docker Compose 管理多容器服务。创建 `docker-compose.yml` 文件：

```yaml
version: '3'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - JAVA_OPTS=-Xmx512m -Xms256m
    restart: always
```

使用以下命令启动服务：

```bash
docker-compose up -d
```

## 12. 优化建议

1. **使用 Alpine 基础镜像**：Alpine 镜像是轻量级的 Linux 发行版，可以显著减小镜像体积。
2. **多阶段构建**：将构建环境和运行环境分离，只保留运行时必要的文件。
3. **添加健康检查**：在 Dockerfile 中添加 HEALTHCHECK 指令，用于监控应用状态。
4. **环境变量配置**：通过环境变量传递配置参数，避免硬编码。

以上就是将 Java 服务部署到 Docker 的完整流程。根据实际需求，你可能需要调整端口映射、内存分配和其他配置。
