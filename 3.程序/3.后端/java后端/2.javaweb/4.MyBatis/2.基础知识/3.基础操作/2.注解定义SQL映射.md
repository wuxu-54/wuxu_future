# 注解的方式来定义SQL映射

MyBatis 提供了注解的方式来定义 SQL 映射，这种方式将 SQL 直接写在 Java 接口方法上，简化了开发过程，便于维护和使用。以下是一些常用的 MyBatis 注解及其使用方法：

1. **@Select**：用于定义查询语句，可以指定返回的结果集类型。

   ```java
   @Select("SELECT * FROM users WHERE id = #{id}")
   User getUserById(@Param("id") Long id);
   ```

2. **@Insert**：用于定义插入语句，通常与 `@Options` 注解一起使用来设置主键回填。

   ```java
   @Insert("INSERT INTO users(name, age) VALUES(#{name}, #{age})")
   @Options(useGeneratedKeys = true, keyProperty = "id")
   int insertUser(User user);
   ```

3. **@Update**：用于定义更新语句。

   ```java
   @Update("UPDATE users SET name = #{name}, age = #{age} WHERE id = #{id}")
   int updateUser(User user);
   ```

4. **@Delete**：用于定义删除语句。

   ```java
   @Delete("DELETE FROM users WHERE id = #{id}")
   int deleteUserById(@Param("id") Long id);
   ```

5. **@Results**：用于定义结果映射，通常与 `@Result` 注解一起使用来指定映射规则。

   ```java
   @Select("SELECT * FROM users WHERE id = #{id}")
   @Results({
       @Result(property = "id", column = "id"),
       @Result(property = "name", column = "name"),
       @Result(property = "age", column = "age")
   })
   User getUserById(@Param("id") Long id);
   ```

6. **@Result**：用于指定单个属性与结果集中的列之间的映射关系。

   ```java
   @Result(property = "id", column = "id")
   ```

7. **@One** 和 **@Many**：用于处理关联查询，分别用于一对一和一对多关系的结果映射。

8. **@Param**：用于在方法参数上标注，以便在 SQL 语句中引用。

   ```java
   public List<Role> findRoleByNameAndNote(@Param("roleName") String rolename,
                                           @Param("note") String note);
   ```

9. **@TypeDiscriminator**：用于在复杂映射中根据某个字段的值来区分不同的类型。

10. **@CacheNamespace**：用于指定缓存策略。

使用注解的方式可以减少 XML 配置的复杂性，使得 SQL 语句更加集中和易于管理。不过，对于复杂的 SQL 映射，使用 XML 文件可能更加灵活和清晰。在实际开发中，可以根据项目需求和团队习惯选择合适的配置方式。

## 数据映射

三种方式：

1. 起别名：对不一样的列名起别名使其与实体类属性名一样。
2. 手动结果映射：使用`@Results`,`@Result`手动将结果映射给实体类属性。
3. 驼峰命名（推荐）：在配置文件中增加自动映射配置`mybatis.configuration.map-underscore-to-camel-case=true`，如果字段名与类属性名符合驼峰命名（例如：数据库列表字段名`a_column`映射到java类为`aColumn`），mybatis会自动通过驼峰命名映射。

## 补充

1. `#` 在编译时会转换为 `?` 占位符，最终执行sql语句前会将占位符替换为真正的参数。
2. `$` 在编译时将参数直接替换，变为最终的sql执行语句。

---

## 增删改查示例

在 MyBatis 中，可以使用注解的方式来实现增删改查等操作。以下是一些基本的示例：

### 1. 查询（Select）

使用 `@Select` 注解来定义查询语句。

```java
public interface UserMapper {
    @Select("SELECT * FROM users WHERE id = #{id}")
    User selectUserById(int id);
}
```

### 2. 插入（Insert）

使用 `@Insert` 注解来定义插入语句。

```java
public interface UserMapper {
    @Insert("INSERT INTO users(name, email) VALUES(#{name}, #{email})")
    void insertUser(User user);
}
```

### 3. 更新（Update）

使用 `@Update` 注解来定义更新语句。

```java
public interface UserMapper {
    @Update("UPDATE users SET name = #{name}, email = #{email} WHERE id = #{id}")
    void updateUser(User user);
}
```

### 4. 删除（Delete）

使用 `@Delete` 注解来定义删除语句。

```java
public interface UserMapper {
    @Delete("DELETE FROM users WHERE id = #{id}")
    void deleteUser(int id);
}
```

### 5. 使用 `@SelectKey` 获取自动生成的主键

在插入操作后，可以使用 `@SelectKey` 注解来获取自动生成的主键。

```java
public interface UserMapper {
    @Insert("INSERT INTO users(name, email) VALUES(#{name}, #{email})")
    @SelectKey(statement="SELECT LAST_INSERT_ID()", keyProperty="id", before=false, resultType=int.class)
    void insertUser(User user);
}
```

### 6. 批量操作

MyBatis 也支持批量操作，例如批量插入。

```java
public interface UserMapper {
    @Insert({
        "<script>",
        "INSERT INTO users(name, email) VALUES ",
        "<foreach item='user' collection='list' separator=','>",
        "(#{user.name}, #{user.email})",
        "</foreach>",
        "</script>"
    })
    void insertUsers(List<User> users);
}
```

### 7. 动态 SQL

MyBatis 还支持在注解中使用动态 SQL，例如使用 `<if>` 标签。

```java
public interface UserMapper {
    @Select("<script>",
        "SELECT * FROM users WHERE 1=1",
        "<if test='id != null'>",
        "AND id = #{id}",
        "</if>",
        "<if test='name != null'>",
        "AND name = #{name}",
        "</if>",
        "</script>")
    List<User> selectUsers(User user);
}
```

### 8. 复杂查询

对于复杂的查询，可以使用 `@SelectProvider` 注解来指定一个类和方法来提供动态 SQL。

```java
public interface UserMapper {
    @SelectProvider(type=SqlProvider.class, method="selectUsers")
    List<User> selectUsers(User user);
}

public class SqlProvider {
    public String selectUsers(User user) {
        StringBuilder sql = new StringBuilder("SELECT * FROM users WHERE 1=1");
        if (user.getId() != null) {
            sql.append(" AND id = #{id}");
        }
        if (user.getName() != null) {
            sql.append(" AND name = #{name}");
        }
        return sql.toString();
    }
}
```

在使用注解的方式时，需要确保 MyBatis 配置文件中已经注册了相应的 Mapper 接口，或者在 Spring 集成时通过 `@MapperScan` 注解自动扫描 Mapper 接口。此外，注解方式通常用于简单的 SQL 操作，对于复杂的 SQL，使用 XML 映射文件可能更加灵活和清晰。
