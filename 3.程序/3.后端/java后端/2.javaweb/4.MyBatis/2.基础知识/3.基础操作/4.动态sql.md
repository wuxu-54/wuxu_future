# 动态 SQL

MyBatis 的动态 SQL 功能允许开发者在 XML 映射文件中根据不同条件动态构建 SQL 语句，从而实现更加灵活和高效的数据库操作。以下是一些常用的 MyBatis 动态 SQL 标签及其用法：

1. **if 标签**：用于条件判断，类似于 Java 中的 if 语句。只有当 test 属性的条件为真时，其中的 SQL 才会被包含在最终执行的 SQL 中。

   ```xml
   <select id="selectUsersByCondition" resultType="User">
   SELECT * FROM user
   <where>
       <if test="username != null and username != ''">
           AND username = #{username}
       </if>
       <if test="status != null">
           AND status = #{status}
       </if>
   </where>
   </select>
   ```

2. **choose、when、otherwise 标签**：用于多条件选择，类似于 Java 中的 switch 语句。choose 标签中必须包含至少一个 when 标签，可以有零个或多个，以及零个或一个 otherwise 标签。

   ```xml
   <select id="selectUsersByCriteria" resultType="User">
   SELECT * FROM user
   <where>
       <choose>
           <when test="username != null">
               AND username = #{username}
           </when>
           <when test="email != null">
               AND email = #{email}
           </when>
           <otherwise>
               AND status = 'active'
           </otherwise>
       </choose>
   </where>
   </select>
   ```

3. **trim、where、set 标签**：用于处理 SQL 语句的前缀和后缀，避免多余的逗号、AND 或 OR 等关键字。where 标签会自动处理多余的 AND 或 OR。

   ```xml
   <select id="selectUsers" resultType="User">
   SELECT * FROM user
   <where>
       <if test="id != null">
           id = #{id}
       </if>
       <if test="username != null">
           AND username = #{username}
       </if>
   </where>
   </select>
   ```

4. **foreach 标签**：用于遍历集合，常用于构建 IN 条件。它可以处理集合或数组，并允许指定集合项的分隔符。

   ```xml
   <select id="selectUsersByIdList" resultType="User">
   SELECT * FROM user
   WHERE id IN
   <foreach item="id" collection="list" open="(" separator="," close=")">
       #{id}
   </foreach>
   </select>
   ```

5. **bind 标签**：用于创建变量并将其绑定到 OGNL 表达式，可以在复杂的动态 SQL 中使用。

   ```xml
   <select id="selectUsersByName" resultType="User">
   SELECT * FROM user
   WHERE name = #{name}
   <bind name="pattern" value="'%' + name + '%'"/>
   AND name LIKE #{pattern}
   </select>
   ```

这些动态 SQL 标签可以帮助开发者构建复杂的查询，同时保持代码的可读性和维护性。通过合理使用这些标签，可以根据不同的需求灵活地构建 SQL 语句。

---

## `<sql>`标签与`<include>`标签

在 MyBatis 中，`<sql>` 标签和 `<include>` 标签通常一起使用，以实现 SQL 代码的复用。这种机制允许你定义可重用的 SQL 片段，并在多个地方引用它们，从而减少代码重复并提高维护性。

### `<sql>` 标签

`<sql>` 标签用于定义一个 SQL 片段，这个片段可以包含在其他 SQL 语句中。你可以在 `<sql>` 标签中定义表名、字段名、复杂的 SQL 表达式等，并且可以给这个片段设置一个唯一的 `id`。

```xml
<sql id="userColumns">
    id, username, password, email
</sql>
```

### `<include>` 标签

`<include>` 标签用于在其他 SQL 语句中引用 `<sql>` 标签定义的 SQL 片段。通过 `refid` 属性，你可以指定要引用的 SQL 片段的 `id`。

```xml
<select id="selectUsers" resultType="User">
    SELECT
    <include refid="userColumns" />
    FROM users
    WHERE id = #{id}
</select>
```

### 动态参数传递

`<include>` 标签还支持动态参数传递，这可以通过 `<property>` 标签实现。在 `<sql>` 标签中，你可以使用 `${property.name}` 来引用传递的属性值。

```xml
<sql id="userColumns">
    ${tableName}.id, ${tableName}.username, ${tableName}.password, ${tableName}.email
</sql>

<select id="selectUsers" resultType="User">
    SELECT
    <include refid="userColumns">
        <property name="tableName" value="users" />
    </include>
    FROM ${tableName}
    WHERE id = #{id}
</select>
```

在这个例子中，`<property>` 标签用于传递 `tableName` 参数，然后在 SQL 片段中通过 `${tableName}` 引用它。

### 跨文件引用

如果你在不同的 XML 映射文件中定义了 SQL 片段，可以通过完整的命名空间路径来引用它们。

```xml
<!-- 在 ShareMapper.xml 中定义 SQL 片段 -->
<mapper namespace="com.company.ShareMapper">
    <sql id="Base_Column_List">
        id, name, email
    </sql>
</mapper>

<!-- 在 CustomMapper.xml 中引用 SQL 片段 -->
<mapper namespace="com.company.CustomMapper">
    <select id="selectUsers" resultType="User">
        SELECT
        <include refid="com.company.ShareMapper.Base_Column_List" />
        FROM users
        WHERE id = #{id}
    </select>
</mapper>
```

### 注意事项

- `<sql>` 标签定义的 SQL 片段可以包含任何有效的 SQL 代码，包括静态文本和使用 `${}` 包围的动态参数。
- `<include>` 标签不仅可以引用 `<sql>` 标签定义的片段，还可以在 `<if>`、`<choose>`、`<when>`、`<otherwise>` 等动态 SQL 元素中使用。
- 使用 `<include>` 标签时，确保引用的 SQL 片段 `id` 是唯一的，并且在当前的命名空间中是可访问的。
- 在跨文件引用时，使用完整的命名空间路径可以避免 `id` 冲突。

通过合理使用 `<sql>` 和 `<include>` 标签，可以使 MyBatis 映射文件更加整洁和易于管理。
