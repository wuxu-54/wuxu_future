# java后端WebSocket使用

在Java Web中使用WebSocket的详细步骤如下：

## 一、项目创建与依赖添加

1. **创建项目**：
   - 使用IDE（如IntelliJ IDEA或Eclipse）创建一个新的Java Web项目。

2. **添加依赖**：
   - 如果使用Maven管理项目依赖，需要在`pom.xml`文件中添加WebSocket相关的依赖。例如，可以添加`javax.websocket-api`依赖，或者如果使用Spring Boot，可以添加`spring-boot-starter-websocket`依赖。

```xml
<!-- Maven依赖示例 -->
<dependency>
    <groupId>javax.websocket</groupId>
    <artifactId>javax.websocket-api</artifactId>
    <version>1.1</version>
    <scope>provided</scope>
</dependency>
<!-- 或者对于Spring Boot项目 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```

## 二、WebSocket服务器端实现

1. **声明WebSocket端点**：
   - 使用`@ServerEndpoint`注解来声明WebSocket的端点，并指定URL路径。

    ```java
    import javax.websocket.OnClose;
    import javax.websocket.OnMessage;
    import javax.websocket.OnOpen;
    import javax.websocket.Session;
    import javax.websocket.server.ServerEndpoint;

    @ServerEndpoint("/websocket")
    public class MyWebSocketServer {
        // ...
    }
    ```

2. **实现WebSocket事件处理方法**：
   - 实现`@OnOpen`、`@OnClose`、`@OnMessage`和`@OnError`注解的方法来处理WebSocket连接的生命周期事件。

    ```java
    @OnOpen
    public void onOpen(Session session) {
        // 连接打开时执行的逻辑
        System.out.println("客户端连接打开");
    }

    @OnClose
    public void onClose(Session session) {
        // 连接关闭时执行的逻辑
        System.out.println("客户端连接关闭");
    }

    @OnMessage
    public void onMessage(String message, Session session) {
        // 收到客户端消息时执行的逻辑
        System.out.println("收到客户端消息: " + message);
        // 可以向客户端发送消息作为响应
        try {
            session.getBasicRemote().sendText("服务器收到消息: " + message);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @OnError
    public void onError(Session session, Throwable throwable) {
        // 连接发生错误时执行的逻辑
        System.out.println("连接发生错误");
        throwable.printStackTrace();
    }
    ```

## 三、配置WebSocket服务器端点

1. **Spring Boot项目中的配置**：
   - 如果使用Spring Boot，需要配置一个`ServerEndpointExporter` Bean来注册WebSocket服务器端点。

    ```java
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.web.socket.server.standard.ServerEndpointExporter;

    @Configuration
    public class WebSocketConfig {
        @Bean
        public ServerEndpointExporter serverEndpointExporter() {
            return new ServerEndpointExporter();
        }
    }
    ```

2. **非Spring Boot项目的配置**：
   - 对于非Spring Boot项目，需要在Web服务器的配置中注册WebSocket服务器端点，这通常涉及到在`web.xml`中配置Servlet或使用其他Web框架提供的配置机制。

## 四、客户端实现

1. **HTML与JavaScript代码**：
   - 在HTML页面中，使用JavaScript创建WebSocket对象，并指定要连接的WebSocket服务器的URL。
   - 使用WebSocket对象的`onopen`、`onmessage`、`onerror`和`onclose`事件来处理连接成功、接收消息、发生错误和连接关闭的情况。

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Demo</title>
</head>
<body>
    <input id="text" type="text" />
    <button onclick="send()">Send</button>
    <button onclick="closeWebSocket()">Close</button>
    <div id="message"></div>
    <script type="text/javascript">
        var websocket = new WebSocket("ws://localhost:8080/yourProjectName/websocket");

        websocket.onopen = function(event) {
            document.getElementById('message').innerHTML += "连接打开<br/>";
        };

        websocket.onmessage = function(event) {
            document.getElementById('message').innerHTML += "收到消息: " + event.data + "<br/>";
        };

        websocket.onerror = function(event) {
            document.getElementById('message').innerHTML += "连接错误<br/>";
        };

        websocket.onclose = function(event) {
            document.getElementById('message').innerHTML += "连接关闭<br/>";
        };

        function send() {
            var message = document.getElementById('text').value;
            websocket.send(message);
        }

        function closeWebSocket() {
            websocket.close();
        }
    </script>
</body>
</html>
```

## 五、测试与调试

1. **启动服务器**：
   - 启动Java Web服务器（如Tomcat或Spring Boot内嵌的服务器）。

2. **打开客户端页面**：
   - 在浏览器中打开包含WebSocket客户端代码的HTML页面。

3. **发送消息**：
   - 在输入框中输入消息，并点击“Send”按钮发送消息给服务器。

4. **查看消息**：
   - 在页面上查看服务器发送回来的消息，并观察控制台输出以确认连接状态和消息传输情况。

通过以上步骤，您可以在Java Web项目中成功实现WebSocket通信，并测试其功能是否正常。
