# 配置 CORS

在 Java Web 应用中配置 CORS（跨源资源共享）通常涉及在服务器端设置适当的响应头，以允许来自不同源的请求访问资源。CORS 是一种安全特性，它允许服务器放宽同源策略（SOP），从而允许来自不同源的 Web 页面请求资源。

在 Java Web 应用中配置 CORS 可以通过多种方式实现，以下是几种常见的方法：

## 1. 使用 Servlet 过滤器（Filter）

创建一个自定义的 Servlet 过滤器，并在其中添加 CORS 相关的响应头。这是最常见和灵活的方法。

```java
import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

@WebFilter("/*") // 将此过滤器应用于所有请求路径
public class CorsFilter implements Filter {

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // 初始化代码（如果需要）
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletResponse res = (HttpServletResponse) response;
        res.setHeader("Access-Control-Allow-Origin", "*"); // 允许所有源访问，生产环境中应替换为具体域名
        res.setHeader("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS"); // 允许的HTTP方法
        res.setHeader("Access-Control-Allow-Headers", "Content-Type, Authorization"); // 允许的HTTP头

        // 对于预检请求（OPTIONS），直接返回成功响应
        if ("OPTIONS".equalsIgnoreCase(request.getMethod())) {
            res.setStatus(HttpServletResponse.SC_OK);
            return;
        }

        // 继续处理其他请求
        chain.doFilter(request, response);
    }

    @Override
    public void destroy() {
        // 销毁代码（如果需要）
    }
}
```

## 2. 使用 Spring 框架（如果适用）

如果你在使用 Spring MVC 或 Spring Boot，你可以通过配置类来设置 CORS。

### Spring MVC 配置

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOriginPatterns("*") // 允许所有源访问，生产环境中应替换为具体域名
                .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                .allowedHeaders("*")
                .allowCredentials(true);
    }
}
```

### Spring Boot 配置

在 Spring Boot 中，你可以创建一个配置类或使用全局配置属性。

```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig {

    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {
            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**")
                        .allowedOrigins("*")
                        .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                        .allowedHeaders("*")
                        .allowCredentials(true);
            }
        };
    }
}
```

或者，在 `application.properties` 或 `application.yml` 中配置 CORS：

```properties
# application.properties
spring.mvc.cors.mapping-source=/**
spring.mvc.cors.allowed-origins=*
spring.mvc.cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS
spring.mvc.cors.allowed-headers=*
spring.mvc.cors.allow-credentials=true
```

```yaml
# application.yml
spring:
  mvc:
    cors:
      mapping-source: /**
      allowed-origins: "*"
      allowed-methods: GET, POST, PUT, DELETE, OPTIONS
      allowed-headers: "*"
      allow-credentials: true
```

## 3. 使用其他框架或库（如 JAX-RS）

如果你使用的是 JAX-RS（如 Jersey 或 RESTEasy），你也可以通过实现 `ContainerResponseFilter` 来添加 CORS 头。

## 注意事项

- **安全性**：在生产环境中，不要将 `Access-Control-Allow-Origin` 设置为 `*`，而是应该指定具体的域名。
- **凭证**：如果设置了 `allowCredentials(true)`，则 `Access-Control-Allow-Origin` 不能是通配符 `*`，而必须是具体的域名。
- **预检请求**：浏览器在发送跨域请求之前，会先发送一个预检请求（OPTIONS 方法）来检查服务器是否允许跨域请求。你的服务器应该能够正确处理这些预检请求。