# Java Web过滤器

## 一、过滤器的基本概念

1. **定义**：Spring Boot过滤器是一种能够拦截HTTP请求和响应的组件，它允许开发者在请求被处理之前或响应被发送回客户端之后执行特定的操作。
2. **作用**：过滤器通常用于实现权限验证、日志记录、事务管理、请求和响应的修改以及跨域资源共享（CORS）等功能。

## 二、过滤器的作用

1. **拦截请求**：过滤器可以拦截客户端请求，对请求进行验证、过滤或修改，以确保请求符合要求。
2. **过滤响应**：过滤器可以拦截服务器响应，对响应内容进行处理或过滤，以确保响应符合要求。
3. **日志记录**：过滤器可以用于记录请求和响应的日志，帮助开发人员进行调试和监控。
4. **权限控制**：过滤器可以用于进行权限验证，限制用户访问某些资源或操作。
5. **数据压缩**：过滤器可以用于对响应数据进行压缩，减少网络传输流量。
6. **字符编码转换**：过滤器可以用于对请求和响应数据进行字符编码转换，确保数据在不同编码之间正确传输。

## 三、配置过滤器类

过滤器可以通过两种方式进行配置：

### 1.`web.xml`中配置（了解就行，已不使用这种方式）

这种方式适用于Servlet 2.5+版本的Java Web应用。`<filter-name>`标签中的名称应与`<filter-mapping>`中的`<filter-name>`一致，`<url-pattern>`指定了要拦截的URL路径。

```xml
<filter>
<filter-name>MyFilter</filter-name>
<filter-class>com.example.MyFilter</filter-class>
</filter>
<filter-mapping>
<filter-name>MyFilter</filter-name>
<url-pattern>/*</url-pattern>
</filter-mapping>
```

### 2. 注解配置

从Servlet 3.0开始，Java Web应用引入了基于注解的配置方式，使配置更加简洁和可读性更高。

示例：

```java
import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import java.io.IOException;

@WebFilter(urlPatterns = "/*", filterName = "LoggingFilter")
public class LoggingFilter implements Filter {

 @Override
 public void init(FilterConfig filterConfig) throws ServletException {
  // 初始化操作，可以在这里读取配置文件等
 }

 @Override
 public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
   throws IOException, ServletException {
  // 记录请求日志
  System.out.println("Request URL: " + ((HttpServletRequest) request).getRequestURL());
  
  // 放行请求，继续处理链中的下一个过滤器或目标资源
  chain.doFilter(request, response);
  
  // 记录响应日志（注意：这里记录的响应信息可能不完整，因为响应可能已经开始发送）
  // 如果需要记录完整的响应信息，可以使用HttpServletResponseWrapper进行包装
  System.out.println("Response Status: " + ((HttpServletResponse) response).getStatus());
 }

 @Override
 public void destroy() {
  // 释放资源，关闭连接等
 }
}
```

### 3. 过滤器类的生命周期

* 定义一个实现`Filter`接口的类，并重写`init()`、`doFilter()`和`destroy()`三个方法。
* `init()`方法在过滤器初始化时被调用，通常用于进行一些初始化操作。
* `doFilter()`方法是过滤器的核心方法，用于处理请求和响应。在这个方法中，开发者可以编写自己的逻辑来拦截和处理请求。
* `destroy()`方法在过滤器销毁时被调用，通常用于进行一些清理操作。

## 四、注册过滤器

注意，这里是讲在过滤器的配置之后，让他在springboot中生效的处理，即注册。

有以下两种方式：

1. **使用`@WebFilter`注解**：

    * 在过滤器类上使用`@WebFilter`注解来指定要拦截的URL模式。
    * 为了使`@WebFilter`注解生效，需要在主类（Application启动类）上添加`@ServletComponentScan`注解来扫描带有`@WebFilter`、`@WebServlet`和`@WebListener`注解的类。

2. **在配置类中手动注册**：

    * 创建一个配置类，并在该类中定义一个`FilterRegistrationBean`来注册过滤器。
    * 通过设置`FilterRegistrationBean`的属性来指定过滤器的名称、要拦截的URL模式以及过滤器的执行顺序等。

## 五、过滤器常见的应用场景

1. **身份验证和授权**：在请求到达目标Controller之前检查用户的身份和权限。
2. **日志记录**：记录请求的详细信息，如请求URL、请求方法、请求参数、响应状态等。
3. **请求和响应的修改**：修改请求头或响应体，例如添加额外的安全头。
4. **跨域资源共享（CORS）**：处理跨域请求的预检请求。

## 六、注意事项

1. **过滤器的执行顺序**：在Spring Boot中，过滤器的执行顺序非常重要。`web.xml`配置方式中由`<filter-mapping>`的配置顺序决定；注解配置方式中可以通过在`FilterRegistrationBean`中设置`order`属性或在`@WebFilter`注解中使用`order`属性来控制过滤器的执行顺序。
2. **过滤器的线程安全**：由于过滤器是Servlet API的一部分，它们通常是由Servlet容器管理的单例对象。因此，在过滤器中使用的任何状态信息都应该是线程安全的。
3. **性能考虑**：过滤器会拦截所有的HTTP请求和响应，因此它们的性能对应用程序的整体性能有很大影响。在编写过滤器时，应该尽量保持过滤器的逻辑简单和高效。
