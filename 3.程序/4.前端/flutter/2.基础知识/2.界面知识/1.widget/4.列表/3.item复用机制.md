# item复用

在 Flutter 中，ListView 的子组件复用机制主要体现在 ListView.builder 构造函数中。这种机制允许 Flutter 优化长列表的性能，减少内存使用，并提高滚动时的流畅度。
>GridView一样，这里就完全讲ListView了

以下是 ListView.builder 子组件复用机制的详细说明：

## ListView.builder 与 ListView 的区别

* ListView：当使用 ListView 时，所有的子组件（列表项）都会在初始构建时被创建，即使这些子组件当前不在屏幕上。这种方式适用于列表项数量较少的情况。

* ListView.builder：与 ListView 不同，ListView.builder 仅在需要显示时才会创建子组件。当用户滚动列表，使得某些子组件离开屏幕时，这些子组件会被回收，并且它们的内存可以被用来创建新的子组件，以供新滚动到屏幕上的列表项使用。

## 子组件复用机制的工作原理

* **动态创建**：ListView.builder 通过 itemBuilder 回调函数动态创建子组件。只有当子组件即将进入屏幕上的可见区域时，itemBuilder 才会被调用。

* **子组件回收**：当用户滚动列表，使得某些子组件离开屏幕时，Flutter 会将这些子组件标记为可回收。这些子组件的 State 对象会被保留，以便在它们再次变得可见时快速重建。

* **缓存机制**：ListView.builder 会缓存一定数量的子组件，即使这些子组件已经不在屏幕上。这是为了提供平滑的滚动体验，避免因实时创建子组件导致的性能抖动。缓存的数量可以通过 cacheExtent 参数进行配置。

* **滚动性能**：由于子组件的复用，Flutter 不需要每次都重新构建所有的列表项，这显著提高了滚动的性能，尤其是在处理大量数据时。

示例代码

```dart
ListView.builder(
  itemCount: 100, // 假设列表有100个项
  itemBuilder: (context, index) {
    // 只有当这个列表项即将变得可见时，才会调用此回调
    return ListTile(
      title: Text('Item $index'),
    );
  },
)
```

## 如何设定某个item不被复用

使用widget key参数，传入特定的key，可以避免服用。例如：

```dart
ListView(
  children: List.generate(100, (index) {
    return ListTile(
      title: Text('Item $index'),
      // 特定项设置唯一 key，防止复用
      key: Key('unique_key_$index'),
    );
  }),
)
```

## 注意事项

* 确保 itemBuilder 中的逻辑是确定性的，即对于同一个 index，每次调用 itemBuilder 都应该返回相同或等效的 Widget。

* 如果列表项的行为依赖于它们的 Key，使用 ListView.builder 可能会导致意外行为，因为相同的 index 可能会对应不同的 Key。在这种情况下，考虑为每个列表项提供一个唯一的 Key。

* 使用 ListView.builder 时，不要依赖子组件的 GlobalKey，因为这会干扰 Flutter 的子组件回收机制。

通过理解 ListView.builder 的子组件复用机制，你可以更有效地构建长列表，同时保持应用的性能和响应速度。
