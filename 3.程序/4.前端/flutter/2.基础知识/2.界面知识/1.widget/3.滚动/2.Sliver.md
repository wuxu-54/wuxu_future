# sliver

在Flutter中，`Sliver`是一种用于构建滚动视图的特殊组件（只是个名词不是类），主要用于`CustomScrollView`。与`ListView`不同，`Sliver`允许开发者构建更复杂的滚动效果，如无限滚动列表、可伸缩的头部（`SliverAppBar`）等。以下是`Sliver`的详解：

## Sliver 概念

源码注释：

```dart
  /// ## What is a sliver?
  ///
  /// > _**sliver** (noun): a small, thin piece of something._
  ///
  /// A _sliver_ is a widget backed by a [RenderSliver] subclass, i.e. one that
  /// implements the constraint/geometry protocol that uses [SliverConstraints]
  /// and [SliverGeometry].
```

简单来说Sliver就是`RenderSliver`子类支持的Widget，换句话说即：使用`SliverConstraints`和`SliverGeometry`俩个类的任意Widget。

## Sliver 类型

1. **SliverList**：线性布局的列表，类似于`ListView`。
2. **SliverFixedExtentList**：具有固定高度项的列表。
3. **SliverGrid**：网格布局的网格，类似于`GridView`。
4. **SliverAppBar**：可伸缩的顶部导航栏。
5. **SliverFillRemaining**：填充剩余空间的组件。
6. **SliverToBoxAdapter**：将普通`Widget`适配到`CustomScrollView`中。
7. **自定义Sliver**：继承`RenderSliver`，或必须有`RenderSliver`的部件。

## 使用 Sliver

使用`Sliver`通常与`CustomScrollView`一起，因为`ListView`和`GridView`不支持`Sliver`。

```dart
CustomScrollView(
  slivers: [
    SliverAppBar(
      title: Text('Sliver Example'),
      expandedHeight: 200,
      flexibleSpace: FlexibleSpaceBar(
        title: Text('Flexible Space'),
      ),
    ),
    SliverList(
      delegate: SliverChildBuilderDelegate(
        (context, index) => ListTile(title: Text('Item $index')),
        childCount: 50,
      ),
    ),
  ],
)
```

## Sliver 布局

- **线性布局**：使用`SliverList`创建线性布局。
- **网格布局**：使用`SliverGrid`创建网格布局。
- **填充剩余空间**：使用`SliverFillRemaining`填充视口中剩余的空间。

## Sliver 优势

- **灵活性**：`Sliver`提供了更高的布局灵活性，允许创建自定义滚动效果。
- **性能**：`Sliver`可以提高长列表的性能，因为它允许列表项在滚动时被回收和复用。
- **复杂布局**：`Sliver`可以创建复杂的布局，如无限滚动、可伸缩的头部等。

## Sliver属性

时刻注意，Sliver不是具体的类，它是个名词，指代某些Widget，所以这里所谓的属性，是这些Sliver Widget共同常见的某些属性。

1. **child**: 子组件，`Sliver`可以包含一个子组件，例如`SliverList`、`SliverGrid`等。

2. **delegate**: 委托，用于定义`Sliver`的布局和绘制逻辑。例如，在`SliverList`中，`SliverChildDelegate`定义了子组件的生成方式。

3. **addAutomaticKeepAlives**: 是否自动包裹子组件以保持活动状态，防止在滑动过程中被销毁。

4. **addRepaintBoundaries**: 是否添加重绘边界，以优化性能。

5. **addSemanticIndexes**: 是否自动管理语义索引，用于辅助功能。

6. **cacheExtent**: 缓存范围，定义`Sliver`在滚动视图中的缓存行为。

7. **center**: 是否将`Sliver`居中显示。

8. **constraints**: 约束条件，定义`Sliver`在滚动视图中的布局约束。

9. **geometryBuilder**: 几何构建器，用于自定义`Sliver`的几何布局。

10. **layoutExtent**: 布局范围，定义`Sliver`在滚动视图中占用的空间大小。

11. **overflow**: 滚动溢出行为，例如`ClampingScrollPhysics`可以防止内容滚动超出界限。

12. **padding**: 内边距，为`Sliver`添加内边距。

13. **physics**: 滚动物理效果，定义`Sliver`的滚动行为和物理反馈。

14. **position**: 位置，定义`Sliver`在滚动视图中的位置。

15. **removePadding**: 是否移除内边距。

16. **reverse**: 是否反转`Sliver`的滚动方向。

17. **scrollDirection**: 滚动方向，定义`Sliver`的滚动方向，如水平或垂直。

18. **semanticsBuilder**: 语义构建器，用于自定义`Sliver`的辅助功能支持。

19. **shrinkWrap**: 是否包裹内容，如果为`true`，则`Sliver`的大小将根据其子组件的大小调整。

20. **slivers**: `CustomScrollView`中的`Sliver`列表，定义了滚动视图中的所有`Sliver`组件。

## 示例

```dart
class HomePage extends StatefulWidget{
  const HomePage({super.key});
  @override
  State<StatefulWidget> createState() => HomePageState();

}

class HomePageState extends State<HomePage>{
  @override
  Widget build(BuildContext context) {
      return Container(
        width: double.infinity,
        height: double.infinity,
        //CustomScrollView 可以设定不同的sliver，sliver可以是任意widget，如列表、网格、固定头部
        child: CustomScrollView(
          slivers: [
            SliverToBoxAdapter(child: Container(
              alignment: Alignment.centerLeft,
              width: double.infinity,
              height: 20,
              color: Colors.white,
              child: Text("tab bar"),
            ),),
            SliverToBoxAdapter(child: Container(
              alignment: Alignment.centerLeft,
              width: double.infinity,
              height: 100,
              color: Colors.yellow,
              child: Text("轮播图"),
            ),),
            //SliverList 替代 ListView
            SliverList.separated(itemBuilder: (BuildContext context,int index){
              return Container(
                alignment: Alignment.centerLeft,
                width: double.infinity,
                height: 50,
                color: Colors.white,
                child: Text("index $index"),
              );
            }, separatorBuilder: (BuildContext context,int index){
              return Container(
                width: double.infinity,
                height: 1,
                color: Colors.black,
              );
            }, itemCount: 100)
          ],
        ),
      );
  }
}
```

## 注意事项

- 使用`Sliver`时，需要确保理解其布局和渲染机制，以避免布局问题。
- 在使用`Sliver`时，要考虑到性能优化，尤其是在处理长列表时。
- `Sliver`和`ListView`等滚动组件不能混用，因为它们的布局机制不同。
- 非`Sliver`类型布局必须使用`SliverToBoxAdapter`包裹。

通过使用`Sliver`，Flutter开发者可以创建出丰富多样的滚动布局，满足不同的设计需求。

---

## RenderSliver

`RenderSliver`抽象类，`RenderObject`的子类，用于实现滚动视图中的滚动效果。

### RenderSliver基本概念

- **RenderSliver**：是一个抽象类，继承自`RenderObject`，用于实现自定义的滚动渲染逻辑。

### RenderSliver主要属性

- **constraints**：`SliverConstraints`对象，包含了`RenderSliver`在布局时需要遵守的约束条件。
- **geometry**：`SliverGeometry`对象，描述了`RenderSliver`的几何属性，如滚动范围、可见范围等。

### RenderSliver核心方法

- **performLayout**：`RenderSliver`需要实现此方法，以确定其子项的布局。
- **paint**：`RenderSliver`需要实现此方法，以在屏幕上绘制其内容。
- **hitTest**：用于处理触摸事件的命中测试。

### RenderSliver使用场景

- **自定义滚动视图**：当你需要实现非标准的滚动视图时，可以通过继承`RenderSliver`来创建自定义的滚动效果。
- **复杂的滚动效果**：例如，可伸缩的头部、无限滚动列表等。

### RenderSliver示例代码

以下是一个简单的自定义`RenderSliver`示例：

```dart
import 'package:flutter/rendering.dart';

class MyCustomSliver extends RenderSliver {
  @override
  void performLayout() {
    // 根据constraints计算子项布局
  }

  @override
  void paint(PaintingContext context, Offset offset) {
    // 使用canvas在指定位置绘制内容
  }

  @override
  bool hitTest(SliverHitTestResult result, {required double mainAxisPosition, required double crossAxisPosition}) {
    // 处理触摸事件
    return false;
  }
}
```

在这个示例中，`MyCustomSliver`是一个自定义的滚动渲染对象，需要实现`performLayout`、`paint`和`hitTest`方法。

### 常用属性

1. **parentData**: 一个 `SliverPhysicalParentData` 对象，包含了 `RenderSliver` 在父 `RenderSliver` 中的位置和布局信息。

2. **constraints**: `SliverConstraints` 对象，定义了 `RenderSliver` 在布局时需要遵守的约束条件，如剩余空间、滚动方向等。

3. **geometry**: `SliverGeometry` 对象，描述了 `RenderSliver` 的几何属性，包括其在滚动视图中的位置、大小和可见性等。

4. **childManager**: 一个 `SliverChildManager` 对象，用于管理 `RenderSliver` 的子项。这在 `RenderSliver` 需要控制其子项的布局和生命周期时非常重要。

5. **scrollOffset**: 一个 `double` 值，表示 `RenderSliver` 在滚动视图中的当前滚动偏移量。

6. **growthDirection**: `GrowthDirection` 枚举，指示 `RenderSliver` 在主轴方向上的增长方向，可以是 `forward` 或 `reverse`。

7. **mainAxisDirection**: `AxisDirection` 枚举，指示 `RenderSliver` 在主轴方向上的延伸方向。

8. **crossAxisDirection**: `AxisDirection` 枚举，指示 `RenderSliver` 在垂直于主轴方向上的延伸方向。

9. **paintExtent**: 一个 `double` 值，表示 `RenderSliver` 在主轴方向上需要绘制的长度。

10. **maxPaintExtent**: 一个 `double` 值，表示 `RenderSliver` 在主轴方向上可以绘制的最大长度。

11. **layoutExtent**: 一个 `double` 值，表示 `RenderSliver` 在主轴方向上用于布局的长度。

12. **remainingPaintExtent**: 一个 `double` 值，表示在 `RenderSliver` 之后还需要绘制的剩余长度。

13. **remainingCacheExtent**: 一个 `double` 值，表示在 `RenderSliver` 之后还可以缓存的长度。

14. **cacheOrigin**: 一个 `double` 值，表示 `RenderSliver` 缓存的起始位置。

15. **visible**: 一个 `bool` 值，指示 `RenderSliver` 是否在屏幕上至少部分可见。

### RenderSliver注意事项

- 使用`RenderSliver`时，需要确保正确处理布局约束，并在`performLayout`方法中正确计算子项布局。
- 在实现`paint`方法时，应考虑性能和内存使用，避免不必要的绘制和布局计算。
- `RenderSliver`是Flutter渲染系统的一部分，为开发者提供了创建自定义滚动效果的能力。

通过使用`RenderSliver`，你可以创建出丰富多样的滚动效果，满足不同的设计需求。

---

## SliverGeometry

`SliverGeometry` 是 Flutter 中的一个类，它提供了关于 `Sliver` 渲染对象在布局过程中的几何信息。`Sliver` 是一种特殊的渲染对象，用于在滚动视图中创建复杂的滚动效果，如列表和网格。

以下是 `SliverGeometry` 的一些关键信息和用法：

### SliverGeometry属性

- **axisDirection**: 表示 `Sliver` 的滚动轴方向，可以是 `AxisDirection.down`、`AxisDirection.up`、`AxisDirection.left` 或 `AxisDirection.right`。
- **scrollExtent**: 表示 `Sliver` 可以滚动的总距离。
- **paintExtent**: 表示 `Sliver` 在屏幕上绘制的像素距离。
- **maxPaintExtent**: 表示 `Sliver` 可以绘制的最大像素距离。
- **visible**: 一个布尔值，指示 `Sliver` 是否在屏幕上至少部分可见。
- **cacheExtent**: 表示 `Sliver` 应该被缓存的像素距离，以便于滚动时快速重用。
- **paintOrigin**: 表示 `Sliver` 在主轴方向上的起始绘制位置，相对于其父`RenderSliver`的布局起点。

### SliverGeometry使用场景

`SliverGeometry` 主要用于以下几个方面：

1. **布局计算**：在自定义 `Sliver` 渲染对象时，需要根据 `SliverGeometry` 提供的信息来计算布局。
2. **绘制**：确定 `Sliver` 在屏幕上的绘制范围。
3. **滚动**：计算 `Sliver` 的滚动行为，如滚动到特定位置或处理滚动边界。

### SliverGeometry示例代码

```dart
import 'package:flutter/material.dart';

class MyCustomSliver extends SliverComponent {
  @override
  RenderSliver? build() {
    // 创建自定义的 RenderSliver
  }

  @override
  void updateComponent(covariant MyCustomSliver oldComponent) {
    // 更新组件逻辑
  }

  @override
  SliverGeometry? calculateGeometry(SliverConstraints constraints) {
    // 根据约束计算几何信息
  }
}
```

在这个示例中，`MyCustomSliver` 是一个自定义的 `Sliver` 组件，它需要实现 `calculateGeometry` 方法来返回 `SliverGeometry` 对象。

### SliverGeometry注意事项

- `SliverGeometry` 是 `Sliver` 渲染过程中的一个关键组成部分，它提供了布局和绘制所需的几何信息。
- 在自定义 `Sliver` 渲染对象时，需要正确计算和返回 `SliverGeometry` 对象。
- 理解和使用 `SliverGeometry` 可以帮助开发者创建复杂的滚动效果和自定义的滚动视图。

`SliverGeometry` 是 Flutter 中实现自定义滚动视图和 `Sliver` 渲染对象的重要组成部分，通过它，开发者可以获取和控制 `Sliver` 的布局和绘制行为。

---

## SliverConstraints

`SliverConstraints` 是 Flutter 中的一个类，它为 `RenderSliver` 对象提供了布局约束条件。这些约束条件是 `RenderSliver` 进行布局计算时必须考虑的参数。以下是 `SliverConstraints` 的详细解释和属性：

### SliverConstraints属性

1. **axis**: 表示滚动轴的方向，可以是 `Axis.horizontal` 或 `Axis.vertical`。

2. **userScrollDirection**: 用户滚动的方向，可以是 `ScrollDirection.forward` 或 `ScrollDirection.reverse`。

3. **scrollOffset**: 当前滚动视图的滚动偏移量，表示从滚动开始位置到当前位置的水平或垂直距离。

4. **overlap**: 一个介于 0 到 1 之间的值，表示当前 `Sliver` 与其他 `Sliver` 重叠的程度。

5. **remainingPaintExtent**: 在当前 `Sliver` 结束后，还需要绘制的剩余空间大小。

6. **remainingCacheExtent**: 在当前 `Sliver` 结束后，还可以缓存的空间大小。

7. **crossAxisExtent**: 垂直于滚动轴方向的总尺寸，例如，在水平滚动时，它是垂直方向的尺寸。

8. **crossAxisDirection**: 垂直于滚动轴方向的尺寸方向，可以是 `AxisDirection.down` 或 `AxisDirection.up`。

9. **viewportMainAxisExtent**: 滚动视图在主轴方向上的可见尺寸，即滚动视图的宽度或高度。

10. **viewportCrossAxisExtent**: 滚动视图在垂直于滚动轴方向上的可见尺寸。

11. **precedingScrollExtent**: 当前 `Sliver` 之前已经滚动过的滚动范围。

12. **precedingOverscrollExtent**: 当前 `Sliver` 之前超出滚动范围的滚动量。

13. **paintExtent**: 当前 `Sliver` 在主轴方向上需要绘制的尺寸。

14. **cacheOrigin**: 缓存的起点位置，用于确定 `Sliver` 的缓存范围。

15. **parentUsesSize**: 一个布尔值，指示父 `RenderSliver` 是否使用子 `Sliver` 的尺寸。

16. **growthDirection**: 表示 `Sliver` 在主轴方向上的增长方向，可以是 `GrowthDirection.forward` 或 `GrowthDirection.reverse`。

### SliverConstraints使用场景

- **布局计算**：`RenderSliver` 使用 `SliverConstraints` 来计算其在滚动视图中的布局。
- **绘制**：确定 `Sliver` 的绘制范围和可见性。
- **滚动行为**：计算 `Sliver` 的滚动行为，如滚动到特定位置或处理滚动边界。

### SliverConstraints示例代码

在自定义 `RenderSliver` 时，你会在 `performLayout` 方法中使用 `SliverConstraints`：

```dart
@override
void performLayout() {
  // 使用 constraints 来计算布局
  final double availablePaintExtent = constraints.remainingPaintExtent;
  // ... 其他布局逻辑
}
```

### SliverConstraints注意事项

- `SliverConstraints` 提供了丰富的信息，帮助 `RenderSliver` 在滚动视图中正确地布局。
- 在自定义 `Sliver` 渲染对象时，需要根据这些约束条件来计算和确定 `Sliver` 的几何属性。

理解 `SliverConstraints` 对于实现复杂的滚动效果和自定义 `RenderSliver` 是非常重要的。通过这些约束，开发者可以创建出适应不同布局需求的滚动视图。
