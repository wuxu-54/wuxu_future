# widget生命周期

在Flutter中，widget的生命周期与Android和iOS平台上的生命周期有所不同。Flutter的生命周期主要围绕widget的创建、更新和销毁。以下是Flutter中widget生命周期的基本概念：

* 创建：widget被创建并添加到widget树中。
* 构建：widget通过build方法构建自己的UI。
* 更新：当widget的属性发生变化时，widget会重新构建。
* 销毁：当widget不再需要时，它会从widget树中移除并销毁。

## 1. 创建阶段

* **StatelessWidget**：这是一个简单widget，没有自己的状态。它只有一个build方法，每次需要重新构建时都会被调用。

* **StatefulWidget**：这是一个拥有自己状态的widget。它有一个关联的State对象，该对象包含了widget的状态数据和逻辑。
  * **createState**：当StatefulWidget首次插入到widget树中时，Flutter会调用其createState方法来创建相应的State对象。
  * **initState**：紧接着，Flutter会调用State对象的initState方法。这是一个用于初始化状态的好地方，例如订阅数据流或设置一次性任务。
  * **didChangeDependencies**：在initState之后，每次widget的依赖项发生变化时（例如，当它的BuildContext发生变化，或者其ancestor的State发生变化时），都会调用didChangeDependencies。这在initState之后至少会被调用一次。
  * **build**：build方法定义了widget的布局。对于StatelessWidget，这是唯一的方法；对于StatefulWidget，它在State对象中定义。

## 2. 更新阶段

* **didUpdateWidget**：当widget的配置信息（Widget对象的属性）发生变化时，Flutter会调用State对象的didUpdateWidget方法。这允许widget更新其状态以响应新的配置。

## 3. 销毁阶段

* **deactivate**：在widget从widget树中移除时，会调用State对象的deactivate方法。这通常发生在widget不再有子widget或者它被一个新的widget替换时。
* **dispose**：当State对象被销毁时，会调用dispose方法。这是一个清理资源的好地方，例如取消订阅或释放资源。

## 生命周期图示

```txt
Widget
  |
  +--- StatelessWidget (无状态，生命周期简单，只有build)
  |
  +--- StatefulWidget (有状态，生命周期复杂)
          |
          +--- createState (创建State对象)
          |
          +--- initState (初始化状态，只会调用一次)
          |
          +--- didChangeDependencies (依赖项变化时调用)
          |
          +--- build (构建Widget)
          |
          +--- didUpdateWidget (widget配置更新时调用)
          |
          +--- deactivate (widget从树中移除，但State尚未销毁)
          |
          +--- dispose (State对象销毁，清理资源)
```

## 注意事项

* 避免在widget的构造函数中执行复杂的逻辑或分配资源。应该将这些操作放在`initState`或`didChangeDependencies`中。
* `StatefulWidget的State`对象在widget的整个生命周期内保持不变，即使widget的配置信息发生变化。
* 通常，你应该在`dispose`方法中取消在`initState`或`didChangeDependencies`中设置的所有监听器和订阅。
* 了解widget生命周期对于优化性能和避免内存泄漏非常重要。

## 总结

Flutter的widget生命周期可能在不同的widget类型和不同的上下文中有所不同，但上述概述提供了一个通用的生命周期概览。
