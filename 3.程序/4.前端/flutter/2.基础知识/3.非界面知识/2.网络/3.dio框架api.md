# Dio 的 API

以下是 Dio 的 API 详解和封装示例：

## Dio API 详解

1. **创建 Dio 实例**

   ```dart
   Dio dio = Dio();
   ```

2. **配置 Dio 实例**
   - 设置基础 URL、超时时间、请求头等。

   ```dart
   dio.options.baseUrl = "https://api.example.com";
   dio.options.connectTimeout = 5000; // 连接超时时间
   dio.options.receiveTimeout = 3000; // 接收超时时间
   dio.options.headers["Content-Type"] = "application/json";
   ```

3. **发起请求**
   - Dio 支持 GET、POST、PUT、DELETE、PATCH 等 HTTP 方法。

   ```dart
   var response = await dio.get("https://api.example.com/data");
   var response = await dio.post("https://api.example.com/data", data: {
     "key": "value",
   });
    
   //方式2，使用options
   Options option = Options(method: "get");//通过method 指定请求方式
   Response response = await _dio.request(url, data: params, options: option);
   ```

4. **请求参数和头**
   - 通过 `queryParameters` 和 `data` 传递请求参数，通过 `options` 设置请求头。

   ```dart
   var response = await dio.get("https://api.example.com/data", queryParameters: {
     "id": 1,
   });
   var response = await dio.post("https://api.example.com/data", options: Options(headers: {
     "Authorization": "Bearer token",
   }));
   ```

5. **响应处理**
   - 从 `Response` 对象中获取数据、状态码、头部等信息。

   ```dart
   var data = response.data;
   var statusCode = response.statusCode;
   var headers = response.headers;
   ```

6. **错误处理**
   - 使用 `try-catch` 捕获并处理 `DioError`。

   ```dart
   try {
     var response = await dio.get("https://api.example.com/data");
   } catch (e) {
     if (e is DioError) {
       print(e.message);
       if (e.type == DioErrorType.connectTimeout) {
         // 处理连接超时
       }
     }
   }
   ```

7. **拦截器**
   - 添加请求拦截器、响应拦截器和错误拦截器。

   ```dart
   dio.interceptors.add(InterceptorsWrapper(
     onRequest: (options, handler) {
       // 在请求发送前修改选项
       options.headers["Authorization"] = "Bearer token";
       return handler.next(options);
     },
     onResponse: (response, handler) {
       // 在响应返回后处理响应
       return handler.next(response);
     },
     onError: (e, handler) {
       // 在请求失败时处理错误
       return handler.next(e);
     },
   ));
   ```

8. **取消请求**
   - 使用 `CancelToken` 取消正在进行的请求。

   ```dart
   CancelToken cancelToken = CancelToken();
   await dio.get("https://api.example.com/data", cancelToken: cancelToken);
   cancelToken.cancel(); // 取消请求
   ```

9. **文件上传和下载**
   - 支持文件上传和下载功能。

   ```dart
   var response = await dio.post("https://api.example.com/upload", data: FormData.fromMap({
     "file": await MultipartFile.fromFile("/path/to/your/file"),
   }));
   ```

---

## Dio 封装示例

封装 Dio 可以统一管理请求头、拦截器、错误处理等，以下是封装 Dio 的基本步骤：

1. **创建 Dio 实例并配置**

   ```dart
   class HttpManager {
     Dio _dio = Dio();
     Map<String, dynamic> _headers = {};

     HttpManager() {
       _dio.options = BaseOptions(
         baseUrl: "https://api.example.com",
         connectTimeout: 5000,
         receiveTimeout: 3000,
       );
       _headers = {
         "Content-Type": "application/json",
       };
     }

     Dio get dio => _dio;
   }
   ```

2. **添加拦截器**

   ```dart
   void addInterceptor() {
     HttpManager().dio.interceptors.add(InterceptorsWrapper(
       onRequest: (options, handler) {
         options.headers.addAll(HttpManager()._headers);
         return handler.next(options);
       },
       onResponse: (response, handler) {
         // 响应处理
         return handler.next(response);
       },
       onError: (e, handler) {
         // 错误处理
         return handler.next(e);
       },
     ));
   }
   ```

3. **发起请求**

   ```dart
   Future<dynamic> fetch(String url, {Map<String, dynamic> data, Map<String, dynamic> queryParameters}) async {
     try {
       var response;
       if (data != null) {
         response = await HttpManager().dio.post(url, data: data);
       } else {
         response = await HttpManager().dio.get(url, queryParameters: queryParameters);
       }
       return response.data;
     } catch (e) {
       throw Exception("Network error: ${e.toString()}");
     }
   }
   ```

4. **使用封装的 Dio**

   ```dart
   void makeRequest() async {
     var data = await fetch("https://api.example.com/data", data: {
       "key": "value",
     });
     print(data);
   }
   ```

通过封装 Dio，你可以在整个项目中重用配置和逻辑，使代码更加简洁和易于维护。

---

## `PATCH`请求

在 HTTP 协议中，`PATCH` 请求是一种部分更新资源的方法。它允许客户端向服务器发送一个包含更改的 JSON 对象，然后服务器将这个对象与现有资源合并，并更新资源。`PATCH` 请求通常用于更新资源的一部分，而不是整个资源。

### `PATCH` 请求的特点

1. **部分更新**：只更新资源的部分属性，而不是整个资源。
2. **幂等性**：多次执行相同的 `PATCH` 请求结果相同，不会对资源造成其他影响。
3. **发送数据**：通常发送 JSON 格式的数据，描述需要更新的部分。

### 使用 Dio 发起 `PATCH` 请求

在 Dio 中，发起 `PATCH` 请求与发起其他类型的 HTTP 请求类似，使用 `dio.patch` 方法。

#### 示例代码

```dart
import 'package:dio/dio.dart';

void main() async {
  Dio dio = Dio();

  // 假设有一个 API 需要更新资源的部分信息
  String url = "https://api.example.com/resource/1";

  // 定义需要更新的数据
  Map<String, dynamic> updateData = {
    "field1": "newValue1",
    "field2": "newValue2",
  };

  try {
    // 发起 PATCH 请求
    Response response = await dio.patch(url, data: updateData);
    print("Response status: ${response.statusCode}");
    print("Response data: ${response.data}");
  } catch (e) {
    // 错误处理
    print("Error: $e");
  }
}
```

在这个示例中，我们使用 Dio 的 `patch` 方法向服务器发送了部分更新的数据。这个方法接受两个主要参数：

- `url`：要更新资源的 URL。
- `data`：一个 Map 对象，包含需要更新的字段和新值。

#### 注意事项

- 确保服务器支持 `PATCH` 方法，并且知道如何处理部分更新的数据。
- `PATCH` 请求不是幂等的，因为多次执行相同的 `PATCH` 请求可能会累积更新，从而改变资源的状态。如果需要幂等性，应该使用 `PUT` 请求，它要求发送整个资源的完整表示。
- 在实际应用中，`PATCH` 请求通常与 RESTful API 设计原则结合使用，用于实现资源的部分更新。

使用 `PATCH` 请求可以有效地减少网络传输的数据量，因为只需要发送需要更新的部分，而不是整个资源。这在处理大型资源或需要频繁更新的场景中非常有用。
