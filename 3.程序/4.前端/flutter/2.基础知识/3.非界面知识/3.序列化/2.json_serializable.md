# json_serializable

`json_serializable` 是一个Dart包，它通过使用注解处理器来自动生成用于JSON序列化和反序列化的代码。这个包是由`json_annotation`包提供支持的，后者包含了用于标记类的注解。使用`json_serializable`可以减少手动编写样板代码的工作量，同时生成的代码是类型安全的。

## 基本使用步骤

以下是`json_serializable`的基本使用步骤：

### 1. 添加依赖

首先，需要在你的Flutter项目的`pubspec.yaml`文件中添加`json_serializable`、`json_annotation`和`build_runner`的依赖项：

```yaml
dependencies:
  json_annotation: ^4.4.0

dev_dependencies:
  json_serializable: ^6.0.1
  build_runner: ^2.1.5
```

然后运行`flutter pub get`来安装这些依赖。

### 2. 定义数据模型

创建一个Dart类，使用`@JsonSerializable()`注解标记，然后定义你的数据模型：

```dart
import 'package:json_annotation/json_annotation.dart';

part 'example.g.dart'; // 指定生成代码的文件

@JsonSerializable()
class Example {
  final int id;
  @JsonKey(name: 'title') final String name;
  final List<String> tags;

  Example({required this.id, required this.name, required this.tags});

  factory Example.fromJson(Map<String, dynamic> json) =>
      _$ExampleFromJson(json);

  Map<String, dynamic> toJson() => _$ExampleToJson(this);
}
```

### 3. 自动生成代码

使用`build_runner`来生成序列化和反序列化代码：

```sh
flutter pub run build_runner build
```

执行上述命令后，会生成一个`example.g.dart`文件，其中包含了`fromJson`和`toJson`方法。

高版本flutter此命令已废除，使用新命令替代：

```sh
# Deprecated. Use `dart run` instead.
dart run build_runner build
```

### 4. 使用生成的代码

现在你可以使用`fromJson`和`toJson`方法来序列化和反序列化JSON：

```dart
void main() {
  String json = '{"id":1,"title":"example","tags":["one","two"]}';

  Example example = Example.fromJson(jsonDecode(json));

  String outputJson = jsonEncode(example.toJson());
  print(outputJson); // 输出序列化后的JSON字符串
}
```

### 高级特性

`json_serializable`还支持一些高级特性，如自定义转换器、泛型支持和条件序列化：

- **自定义转换器**：通过实现`JsonConverter`接口，可以定义如何将特定的Dart类型转换为JSON。

- **泛型支持**：使用`genericArgumentFactories: true`参数，可以为泛型类型生成序列化和反序列化代码。

- **条件序列化**：使用`includeIfNull: false`参数，可以控制是否序列化`null`值。

- **忽略未注解的字段**：设置`ignoreUnannotated: true`，可以只序列化注解了`@JsonKey`的字段。

### 注意事项

- 确保运行`build_runner build`命令以生成序列化和反序列化代码。
- 使用`part`的文件必须包含生成代码的文件声明，如`part 'example.g.dart';`。
- 每次修改数据模型后，都需要重新运行`build_runner build`来更新生成的代码。

---

## 主要API

以下是`json_serializable`的一些主要API及其详细解释和使用示例：

### 1. `@JsonSerializable`

这是一个类级别的注解，用于告诉`json_serializable`工具为该类生成序列化和反序列化逻辑。

- **示例**：

  ```dart
  import 'package:json_annotation/json_annotation.dart';

  @JsonSerializable()
  class User {
    String name;
    int age;

    User({this.name, this.age});

    factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
    Map<String, dynamic> toJson() => _$UserToJson(this);
  }
  ```

### 2. `@JsonKey`

这是一个字段级别的注解，用于自定义序列化和反序列化行为，比如指定字段的JSON键名、默认值、是否忽略等。

- **示例**：

  ```dart
  @JsonKey(name: "user_name")
  final String name;

  @JsonKey(defaultValue: 'Guest')
  final String nickname;
  ```

### 3. `part`

与`json_serializable`配合使用的关键字，用于将生成的代码分割到不同的文件中。

- **示例**：

  ```dart
  part 'user.g.dart';
  ```

### 4. `factory`

在Dart中，`factory`关键字用于定义工厂构造函数，它可以用于创建类的实例。在`json_serializable`中，通常用于从JSON创建对象。

- **示例**：

  ```dart
  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
  ```

### 5. `toJson`

这是由`json_serializable`生成的方法，用于将对象序列化为JSON映射。

- **示例**：

  ```dart
  Map<String, dynamic> toJson() => _$UserToJson(this);
  ```

### 6. `fromJson`

这是由`json_serializable`生成的方法，用于从JSON映射创建对象实例。

- **示例**：

  ```dart
  factory User.fromJson(Map<String, dynamic> json) => _$UserFromJson(json);
  ```

### 7. `JsonConverter`

这是一个接口，用于自定义复杂的数据类型转换逻辑，比如日期时间、枚举等。

- **示例**：

  ```dart
  class DateTimeConverter implements JsonConverter<DateTime, String> {
    const DateTimeConverter();

    @override
    DateTime fromJson(String json) => DateTime.parse(json);

    @override
    String toJson(DateTime object) => object.toIso8601String();
  }
  ```

### 8. `build_runner`

这是一个命令行工具，用于运行`json_serializable`的代码生成器。

- **使用示例**：

  ```sh
  flutter pub run build_runner build
  ```

### 9. `genericArgumentFactories`

这是一个`JsonSerializable`注解的参数，用于处理泛型类型的序列化和反序列化。

- **示例**：

  ```dart
  @JsonSerializable(genericArgumentFactories: true)
  class Response<T> {
    final T data;

    Response({required this.data});

    factory Response.fromJson(Map<String, dynamic> json, T Function(Object? json) fromJsonT) =>
        _$ResponseFromJson(json, fromJsonT);

    Map<String, dynamic> toJson(Object? Function(T value) toJsonT) => _$ResponseToJson(this, toJsonT);
  }
  ```

### 10. `ignoreUnannotated`

这是一个`JsonSerializable`注解的参数，用于指定是否忽略未注解的字段。

- **示例**：

  ```dart
  @JsonSerializable(ignoreUnannotated: true)
  class User {
    final String name;
    int age;

    User({required this.name, this.age});
  }
  ```

这些API共同构成了`json_serializable`的核心功能，使得在Dart和Flutter中处理JSON数据变得更加容易和可靠。
