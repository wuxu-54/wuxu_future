# Zone

在 Flutter 和 Dart 中，`Zone` 是 `dart:async` 库中的一个类，它提供了一种机制来捕获和处理异步错误、微任务、定时器等。`Zone` 可以看作是一个代码执行的环境范围，类似于沙箱，不同沙箱之间是隔离的，可以捕获、拦截或修改一些代码行为。

## Zone 的主要 API

1. **Zone.current**: 获取当前的 Zone 对象。
2. **Zone.root**: 获取根 Zone 对象。
3. **Zone.fork**: 创建一个新的 Zone，可以指定 `zoneSpecification` 和 `zoneValues`。
4. **runZoned**: 在一个新的 Zone 中运行代码。
5. **runZonedGuarded**: 在一个新的 Zone 中运行代码，并捕获未处理的异常。
6. **handleUncaughtError**: 处理未捕获的异步错误。
7. **registerCallback**: 注册一个回调，可以拦截微任务的调度。
8. **bindCallback**: 绑定一个回调，使其在当前 Zone 中执行。

## 示例

### 1. 创建和使用 Zone

```dart
import 'dart:async';

void main() {
  // 创建一个新的 Zone
  Zone childZone = Zone.current.fork(
    specification: ZoneSpecification(
      print: (self, parent, zone, line) {
        // 修改 print 行为
        parent.print(zone, '[Child Zone] $line');
      },
    ),
  );

  // 在新的 Zone 中运行代码
  childZone.run(() {
    print('This is printed in the child zone.');
  });
}
```

### 2. 使用 runZonedGuarded 捕获异常

```dart
import 'dart:async';

void main() {
  runZonedGuarded(() {
    // 这部分代码在一个新的 Zone 中运行，如果抛出异常，会被 onError 捕获
    throw 'An error occurred!';
  }, (error, stackTrace) {
    // 处理异常
    print('Caught error: $error');
  });
}
```

### 3. 修改微任务行为

```dart
import 'dart:async';

void main() {
  Zone parentZone = Zone.current.fork(
    specification: ZoneSpecification(
      registerCallback: <R>(self, parent, zone, R Function() callback) {
        // 修改微任务行为
        return () {
          print('Before microtask execution.');
          return parent.runUnary(zone, callback);
        };
      },
    ),
  );

  parentZone.run(() {
    // 注册微任务
    Zone.current.registerCallback(() {
      print('This is a microtask.');
    });
  });
}
```

### 4. handleUncaughtError

Zone.current 是全局当前Zone的引用，handleUncaughtError 是一个方法，用于处理在当前Zone中未被捕获的异常。

当你在 Dart 或 Flutter 应用中抛出一个异常，而这个异常没有在调用栈中被任何 `try-catch` 块捕获时，Zone 的 `handleUncaughtError` 方法就会被调用。

`handleUncaughtError` 方法有两个参数：

- `details.exception`：异常对象本身，表示发生了什么错误。
- `details.stack`：异常的调用栈，表示错误发生的位置。

这是一个处理未捕获异常的示例：

```dart
import 'dart:async';

void main() {
  // 创建一个新 Zone
  Zone zone = Zone.current.fork(
    specification: ZoneSpecification(
      // 当前 Zone 中抛出未捕获的异常时调用此回调
      handleUncaughtError: (parent, zone, error, stackTrace) {
        // 打印错误和堆栈跟踪
        if (error is! Exception) {
          print('Error: $error');
        } else {
          print('Exception: $error');
        }
        print('Stack trace: $stackTrace');
        // 可以选择重新抛出异常，或者返回 false 来阻止它继续传播
        return false;
      },
    ),
  );

  // 在新的 Zone 中运行代码
  zone.run(() {
    // 这里抛出一个未捕获的异常
    throw 'This is an uncaught error!';
  });
}
```

---

## 注意事项

- Zone 可以捕获所有未处理的异步异常，对于同步异常，仍然需要使用 try-catch 来捕获。
- Zone 之间的隔离性意味着它们无法通信，它们是独立的执行环境。
- 使用 Zone 时，重要的是要理解 Dart 的异步错误处理机制。
- 正确使用 Zone 可以帮助开发者更好地控制应用的稳定性和错误处理流程。
