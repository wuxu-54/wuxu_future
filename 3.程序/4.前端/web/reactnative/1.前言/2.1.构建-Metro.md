# Metro

原地址：<https://reactnative.cn/docs/next/metro>  

## 概述  

Metro 是 React Native 的官方 JavaScript 打包器（bundler），负责将 React Native 项目中的 JavaScript、TypeScript、图片等资源转换、合并为原生应用可加载的代码包（bundle）。它是 React Native 开发和构建流程的核心工具，提供快速的开发刷新（Fast Refresh）、代码转换、依赖解析和优化打包等能力，确保开发效率和应用性能。

## 核心功能与作用  

Metro 的核心目标是在开发阶段提供快速反馈循环，同时在生产环境生成高效的代码包。主要功能包括：  

1. **依赖解析**：递归解析项目中的 JavaScript 模块依赖，构建依赖关系树。  
2. **代码转换**：将现代 JavaScript/TypeScript 代码转换为目标环境可执行的代码（如通过 Babel 转译），处理 JSX 语法、ES6+ 特性等。  
3. **资源处理**：支持图片、字体等静态资源的打包，生成对应的引用路径。  
4. **开发模式优化**：提供 Fast Refresh 功能，修改代码后快速更新应用，保留组件状态。  
5. **生产打包**：生成经过压缩、混淆和优化的代码包，减小体积并提升加载速度。  
6. **多平台支持**：为 iOS、Android 等不同平台生成适配的代码包。  

## 核心概念与架构  

Metro 的工作流程基于三个核心组件，形成完整的打包流水线：  

### 1. 服务器（Server）  

- **作用**：在开发阶段启动本地服务器，监听文件变化并响应客户端（如 React Native 应用）的代码请求。  
- **核心能力**：支持热重载（Hot Reloading）和 Fast Refresh，当文件修改时，仅重新打包变化的模块并推送更新，避免全量重建。  

### 2. 转换器（Transformer）  

- **作用**：对源代码进行转换处理，将非标准 JavaScript 代码（如 JSX、TypeScript）转换为原生 JavaScript，同时处理静态资源引用。  
- **默认配置**：使用 Babel 作为转换器，通过 `babel.config.js` 配置转译规则（如 React Native 预设 `metro-react-native-babel-preset`）。  
- **自定义扩展**：支持通过配置自定义转换器，处理特殊文件类型或转译需求。  

### 3. 打包器（Bundler）  

- **作用**：根据依赖关系树，将所有模块合并为单个或多个代码包（bundle），并对代码进行优化（如tree-shaking、压缩）。  
- **输出格式**：生成的代码包为 JavaScript 文件（如 `index.bundle`），包含所有模块代码和依赖信息。  

## 配置文件：`metro.config.js`  

Metro 的行为通过项目根目录下的 `metro.config.js` 文件配置。该文件导出一个配置对象，定义打包规则、资源处理、转换器设置等。  

### 基本结构  

```javascript
// metro.config.js
const { getDefaultConfig } = require('expo/metro-config'); // 或从 'metro-config' 导入

const config = getDefaultConfig(__dirname);

// 自定义配置
module.exports = {
  ...config,
  resolver: {
    // 解析器配置
  },
  transformer: {
    // 转换器配置
  },
  server: {
    // 服务器配置
  },
  // 其他配置...
};
```

### 常用配置选项  

| 配置分类       | 关键选项                | 描述                                                                 |
|----------------|-------------------------|----------------------------------------------------------------------|
| **resolver**   | `sourceExts`            | 支持的源代码文件扩展名（如 `['js', 'jsx', 'ts', 'tsx']`）。          |
|                | `assetExts`             | 支持的静态资源扩展名（如 `['png', 'jpg', 'jpeg', 'gif', 'svg']`）。  |
|                | `blacklistRE`           | 正则表达式，指定需忽略的文件/目录（已过时，推荐用 `blockList`）。     |
|                | `blockList`             | 数组，指定需排除的文件/目录路径（如 `[/node_modules\/some-module/]`）。 |
| **transformer**| `babelTransformerPath`  | 自定义 Babel 转换器路径，用于处理特殊文件类型。                      |
|                | `getTransformOptions`   | 函数，动态配置转译选项（如开发/生产环境的不同配置）。                |
| **server**     | `port`                  | 服务器端口（默认 8081）。                                            |
|                | `enableVisualizer`      | 是否启用打包可视化工具（`true` 时生成依赖可视化报告）。              |
| **watchFolders**| 数组                    | 指定额外需要监听的目录（如项目外的共享模块）。                        |
| **maxWorkers**  | 数字                    | 构建时的最大工作进程数（默认根据 CPU 核心数自动调整）。               |

### 示例：自定义资源处理  

```javascript
// 支持更多图片格式
module.exports = {
  resolver: {
    assetExts: [...config.resolver.assetExts, 'webp', 'avif'],
  },
};
```

## 命令行工具  

Metro 提供命令行工具用于启动开发服务器、生成生产代码包等，常用命令如下：  

### 1. 启动开发服务器  

```bash
npx metro start
# 或在 React Native 项目中使用
npx react-native start
```  

- 功能：启动 Metro 服务器，监听文件变化并支持 Fast Refresh。  
- 选项：  
  - `--port <number>`：指定服务器端口（默认 8081）。  
  - `--host <string>`：指定服务器主机地址（默认 `localhost`）。  
  - `--reset-cache`：重置 Metro 缓存，解决缓存导致的问题。  

### 2. 生成生产代码包  

```bash
npx metro bundle \
  --entry-file index.js \  # 入口文件路径
  --platform android \     # 目标平台（ios/android）
  --dev false \            # 生产模式（禁用开发日志）
  --bundle-output ./dist/main.android.bundle \  # 输出路径
  --assets-dest ./dist/assets \                 # 静态资源输出目录
  --minify true           # 启用代码压缩
```  

- 功能：为指定平台生成优化后的生产代码包和资源文件。  
- 关键参数：  
  - `--entry-file`：项目入口文件（通常为 `index.js` 或 `index.tsx`）。  
  - `--platform`：目标平台（`ios` 或 `android`）。  
  - `--dev`：是否启用开发模式（`false` 为生产模式）。  
  - `--minify`：是否压缩代码（生产环境建议开启）。  

### 3. 清空缓存  

```bash
npx metro cache clean
```  

- 功能：清除 Metro 的缓存文件（如转译结果、依赖树），解决缓存导致的代码更新不生效问题。  

## 与 React Native 的集成  

Metro 是 React Native 开发的默认打包工具，与 React Native 工作流深度绑定：  

1. **开发阶段**：  
   - 运行 `npx react-native start` 启动 Metro 服务器。  
   - 启动模拟器或连接设备后，应用会从 Metro 服务器加载代码，支持 Fast Refresh。  

2. **构建阶段**：  
   - 执行 `npx react-native run-android` 或 `npx react-native run-ios` 时，Metro 会为目标平台生成临时代码包并部署到设备。  
   - 生产环境构建（如生成 APK/IPA）时，Metro 预先打包代码包并嵌入应用，避免运行时依赖服务器。  

3. **Fast Refresh 支持**：  
   - Metro 是 Fast Refresh 的核心实现者，通过监听文件变化，仅重新编译修改的模块，并通知应用更新，保留组件状态（如输入框内容、滚动位置）。  

## 高级配置与扩展  

Metro 支持通过配置和插件扩展功能，满足复杂项目需求：  

### 1. 自定义转换器  

通过 `transformer.babelTransformerPath` 指定自定义转换器脚本，处理特殊文件（如 Markdown、Vue 组件等）。例如：  

```javascript
// metro.config.js
module.exports = {
  transformer: {
    babelTransformerPath: require.resolve('./custom-transformer.js'),
  },
};
```  

```javascript
// custom-transformer.js（示例：处理 .md 文件）
const { transform } = require('@babel/core');

module.exports.transform = ({ src, filename }) => {
  if (filename.endsWith('.md')) {
    // 将 Markdown 转换为 React 组件
    const html = convertMarkdownToHtml(src);
    return {
      code: `import React from 'react'; export default () => <div>${html}</div>;`,
      map: null,
    };
  }
  // 其他文件使用默认转换
  return require('metro-react-native-babel-transformer').transform({ src, filename });
};
```

### 2. 缓存管理  

Metro 的缓存默认存储在 `node_modules/.cache/metro` 目录，可通过以下方式管理：  

- 手动清除：`npx metro cache clean`。  
- 配置缓存路径：通过 `cacheDirectory` 选项指定自定义路径。  
- 禁用缓存：开发阶段可通过 `--no-cache` 选项临时禁用缓存（不推荐，会降低速度）。  

### 3. 多入口打包  

通过 `metro bundle` 命令的 `--entry-file` 指定不同入口，为应用的不同模块生成独立代码包，实现按需加载。  

## 常见问题与解决方案  

1. **Fast Refresh 不生效**：  
   - 检查 Metro 服务器是否正常运行，重启服务器（`npx react-native start --reset-cache`）。  
   - 确认文件扩展名在 `resolver.sourceExts` 中配置（如 TypeScript 需包含 `ts`、`tsx`）。  

2. **资源文件找不到**：  
   - 确保资源扩展名在 `resolver.assetExts` 中配置。  
   - 检查资源引用路径是否正确，避免绝对路径（推荐相对路径）。  

3. **打包体积过大**：  
   - 生产模式启用 `--minify` 压缩代码。  
   - 通过 `metro bundle --sourcemap` 生成 sourcemap，分析依赖体积，移除无用代码。  
   - 配置 `resolver.blockList` 排除不需要的依赖或测试文件。  

4. **依赖解析错误**：  
   - 检查 `node_modules` 是否完整，重新安装依赖（`npm install`）。  
   - 排除冲突依赖，通过 `resolver.extraNodeModules` 指定自定义模块路径。  

## Metro 工作流程图  

```mermaid
graph TD
    A[开发阶段] -->|启动命令: npx metro start| B[Metro 服务器启动]
    B --> C[监听文件变化]
    C -->|文件修改| D[触发转换器]
    D -->|Babel 转译/资源处理| E[更新依赖树]
    E --> F[生成增量更新包]
    F --> G[通过 Fast Refresh 推送更新至应用]
    G --> C  # 循环监听
    
    H[生产构建] -->|命令: npx metro bundle| I[解析入口文件依赖]
    I --> J[全量转换代码与资源]
    J --> K[代码压缩与优化]
    K --> L["生成最终代码包（.bundle）"]
    L --> M[输出资源文件至指定目录]
```

## 总结  

Metro 作为 React Native 的官方打包器，是开发和构建流程的核心工具。它通过依赖解析、代码转换、快速刷新和优化打包等功能，确保开发效率和应用性能。通过 `metro.config.js` 可自定义配置，支持扩展转换器、资源处理和缓存管理等高级需求。掌握 Metro 的配置和使用，对于优化 React Native 项目的开发体验和生产性能至关重要。
