# 上架 App Store

原地址：<https://www.react-native.cn/docs/next/publishing-to-app-store>

该网页是 React Native 应用上架至 App Store 的指南文档，主要面向需要将 React Native 开发的 iOS 应用发布到 App Store 的开发者。文档指出，上架流程与原生 iOS 应用类似，但需注意 React Native 特有的配置项，同时针对使用 Expo 的开发者提供了额外参考链接。

## 核心上架步骤与注意事项

### 1. 启用 App Transport Security（ATS）

ATS 是 iOS 9 引入的安全特性，默认拒绝所有非 HTTPS 的 HTTP 请求。React Native 项目为方便开发，默认在 `localhost` 禁用 ATS，上架前需重新启用以符合 App Store 规范。

#### 操作步骤：

- **修改配置文件**：删除 `ios/` 文件夹中 `Info.plist` 文件内 `NSExceptionDomains` 字典中的 `localhost` 条目，并将 `NSAllowsArbitraryLoads` 设置为 `false`。
- **Xcode 可视化配置**：通过 Xcode 打开项目目标属性的 Info 面板，编辑“App Transport Security Settings”条目完成配置。
- **特殊场景处理**：若应用需访问生产环境中的 HTTP 资源，需参考官方文章配置 ATS 例外规则。

### 2. 配置 Release Scheme

Release 模式是上架 App Store 的必要编译配置，与 Debug 模式相比，具有以下特点：

- 自动禁用开发者菜单，避免用户误操作。
- 将 JS 文件和静态图片打包压缩后内置到应用包中，无需依赖开发服务器，提升启动速度。
- 禁用实时更新和调试功能（如需调试需切换回 Debug 模式）。

#### 配置步骤：

- 打开 Xcode，通过菜单栏选择 `Product → Scheme → Edit Scheme`。
- 在侧边栏选择 `Run` 标签，将 `Build Configuration` 下拉选项设置为 `Release`。
- **热更新说明**：Release 模式不支持通过开发服务器实时更新，如需面向用户的热更新需使用专门的热更新服务。

#### 优化建议：

- **避免 Debug 模式生成静态包**：静态包在目标物理设备编译时默认生成，即使 Debug 模式也会耗时。可在 Xcode Build Phase 的 `Bundle React Native code and images` 脚本中添加以下代码，在 Debug 模式下关闭静态包生成：

  ```sh
  if [ "${CONFIGURATION}" == "Debug" ]; then
    export SKIP_BUNDLING=true
  fi
  ```

### 3. 编译发布应用

完成上述配置后，需通过 Release 模式编译应用，生成可提交至 App Store 的安装包。

#### 编译步骤：

- **Xcode 操作**：点击快捷键 `⌘B` 或通过菜单栏选择 `Product → Build` 编译应用。
- **CLI 命令编译**：使用 React Native CLI 执行 `npx react-native run-ios --configuration Release` 命令编译。

#### 后续流程：

编译完成后，可将应用发布给 beta 测试者（如通过 TestFlight），或直接提交至 App Store 审核。

### 4. 启动屏优化技巧

随着应用包大小增长，可能出现启动屏（splash）与根应用视图显示之间的白屏闪现问题。可通过以下代码优化过渡效果：

#### 实现方式：

在 `AppDelegate.m` 文件中，于 `[self.window makeKeyAndVisible]` 之后、`return YES` 之前添加以下代码，使启动屏在应用加载期间保持显示：

```objectivec
UIStoryboard *sb = [UIStoryboard storyboardWithName:@"LaunchScreen" bundle:nil];
UIViewController *vc = [sb instantiateInitialViewController];
rootView.loadingView = vc.view;
```

## 核心要点总结

- **ATS 配置**：必须启用 ATS 以符合安全规范，特殊 HTTP 需求需配置例外。
- **Release 模式**：是上架的必要编译模式，需禁用调试功能并内置静态资源。
- **编译优化**：通过脚本避免 Debug 模式生成静态包，减少开发阶段耗时。
- **启动体验**：添加启动屏过渡代码，避免白屏影响用户体验。

```mermaid
graph TD
    A[上架 App Store 准备] --> B[前提：流程类似原生 iOS 应用，需注意 RN 特有配置]
    A --> C[核心步骤]
    C --> D[启用 App Transport Security (ATS)]
    D --> D1[删除Info.plist中localhost例外]
    D --> D2[设置NSAllowsArbitraryLoads为false]
    D --> D3[特殊HTTP资源需配置例外规则]
    C --> E[配置Release Scheme]
    E --> E1[Xcode中设置Build Configuration为Release]
    E --> E2[特性：禁用开发者菜单，内置JS和静态资源]
    E --> E3[优化：Debug模式添加脚本禁用静态包生成]
    C --> F[编译发布应用]
    F --> F1[Xcode通过⌘B或Product→Build编译]
    F --> F2[CLI命令：npx react-native run-ios --configuration Release]
    C --> G[启动屏优化]
    G --> G1[添加代码保持启动屏显示至应用加载完成]
    C --> H[后续：发布beta测试或提交App Store审核]
```
