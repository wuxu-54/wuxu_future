# 保持组件纯粹

有些 JavaScript 函数是纯函数。纯函数仅执行计算，仅此而已。通过严格地**将你的组件编写为纯函数**，你可以在代码库增长时避免一整类令人困惑的错误和不可预测的行为。但是，要获得这些好处，你必须遵守一些规则。

组件必须是纯粹的，这意味着：

- 它只管自己的事。它不应更改渲染前存在的任何对象或变量。
- 相同的输入，相同的输出。给定相同的输入，组件应该始终返回相同的 JSX。
- 渲染可以随时发生，因此组件不应依赖于彼此的渲染顺序。
- 你不应该改变你的组件用于渲染的任何输入。这包括属性、状态和上下文。要更新屏幕，“set” 状态 而不是改变预先存在的对象。
- 努力在返回的 JSX 中表达组件的逻辑。当你需要 “改变东西” 时，你通常希望在事件处理程序中进行。不得已，你可以 useEffect。
- 编写纯函数需要一些练习，但它释放了 React 范例的力量。

## 组件作为公式

在计算机科学（尤其是函数式编程的世界）中，`纯函数` 是具有以下特性的函数：

- 它只管自己的事。它不会更改调用之前存在的任何对象或变量。
- 相同的输入，相同的输出。给定相同的输入，纯函数应该总是返回相同的结果。

React 就是围绕这个概念设计的。React 假定你编写的每个组件都是纯函数。这意味着你编写的 React 组件必须始终在给定相同输入的情况下返回相同的 JSX。

## 副作用：（非）预期的后果

React 的渲染过程必须始终是纯粹的。组件应该只返回它们的 JSX，而不应该更改渲染之前存在的任何对象或变量 - 这会使它们变得不纯粹！

例子：

```js
let guest = 0;

function Cup() {
  // Bad: changing a preexisting variable!
  guest = guest + 1;  //这里是示例guest作为全局变量在外部被更改，导致数值不如预期的情况
  return <h2>Tea cup for guest #{guest}</h2>;
}

export default function TeaSet() {
  return (
    <>
      <Cup />
      <Cup />
      <Cup />
    </>
  );
}
```

该组件正在读取和写入在其外部声明的 guest 变量。这意味着多次调用该组件将产生不同的 JSX！更重要的是，如果其他组件读取 guest，它们也会生成不同的 JSX，具体取决于它们的渲染时间！这是不可预测的。

你可以通过 将 **guest 作为属性传递** 修复此组件：

```js
function Cup({ guest }) {
  return <h2>Tea cup for guest #{guest}</h2>;
}

export default function TeaSet() {
  return (
    <>
      <Cup guest={1} />
      <Cup guest={2} />
      <Cup guest={3} />
    </>
  );
}
```

## 使用严格模式检测不纯计算

尽管你可能还没有使用过它们，但在 React 中，你可以在渲染时读取三种输入：`属性`、`状态` 和 `上下文`。你应该始终将这些输入视为只读。

当你想要更改某些内容以响应用户输入时，你应该 设置状态 而不是写入变量。当你的组件正在渲染时，你不应该改变预先存在的变量或对象。

React 提供了一个 “严格模式”，它在开发过程中两次调用每个组件的函数。通过两次调用组件函数，严格模式有助于找到违反这些规则的组件。

严格模式对生产没有影响，因此它不会降低用户的应用速度。要选择进入严格模式，你可以将根组件封装到 `<React.StrictMode>` 中。一些框架默认这样做。

## 哪些地方可能会引起副作用

虽然函数式编程在很大程度上依赖于纯粹，但在某个时候，某个地方，某些东西必须改变。这就是编程的意义所在！这些更改（更新屏幕、启动动画、更改数据）称为副作用。它们是 “在旁边” 发生的事情，而不是渲染期间发生的事情。

在 React 中，副作用通常属于 事件处理程序 事件处理程序，是当你执行某些操作（例如，当你单击按钮时）时 React 运行的函数。即使事件处理程序是在你的组件中定义的，它们也不会在渲染期间运行！所以事件处理程序不需要是纯粹的。

如果你已用尽所有其他选项并且找不到适合你的副作用的事件处理程序，你仍然可以通过在组件中调用 useEffect 将其附加到返回的 JSX。这告诉 React 在渲染后允许副作用时稍后执行它。但是，这种方法应该是你最后的选择。

如果可能，请尝试仅通过渲染来表达你的逻辑。你会惊讶于这能带你走多远！

## 为什么 React 关心纯粹？

编写纯函数需要一些习惯和纪律。但它也开启了奇妙的机会：

- 你的组件可以在不同的环境中运行 - 例如，在服务器上！由于它们对相同的输入返回相同的结果，因此一个组件可以满足许多用户请求。

- 你可以通过 跳过渲染 输入未更改的组件来提高性能。这是安全的，因为纯函数总是返回相同的结果，所以它们可以安全地缓存。

- 如果在渲染深层组件树的过程中某些数据发生变化，React 可以重新开始渲染，而不会浪费时间完成过时的渲染。纯粹使你可以安全地随时停止计算。

我们正在构建的每个新 React 功能都利用了纯粹。从数据获取到动画再到性能，保持组件纯粹释放了 React 范例的力量。
