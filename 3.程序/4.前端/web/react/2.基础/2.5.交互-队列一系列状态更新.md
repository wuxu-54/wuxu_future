# 队列一系列状态更新

更新机制：**设置状态函数**将值维护在一个**先进先出队列**中，在渲染时遍历状态队列，取最终结果用于界面渲染。

设置状态变量将使另一个渲染排队。但有时你可能希望在排队下一次渲染之前对值执行多个操作。为此，有助于了解 React 如何批处理状态更新。

## 前文问题描述及答案

上一节问题回顾：多次直接调用修改状态，但结果都是1，而不是3.

你可能希望单击 “+3” 按钮会使计数器递增 3 次，因为它调用了 3 次 setNumber(number + 1)。

原因：

**设置状态函数**将值维护在一个**先进先出队列**中，在渲染时遍历状态队列，取最终结果用于界面渲染。在处理状态更新之前，**React 会等到事件处理程序中的所有代码都已运行，即加入队列后**。这就是为什么重新渲染只发生在所有这些 setNumber() 调用之后。
>此时number还没改变呢。这也就说明了，为什么都是基于`number=0`来处理。也说明了为什么**更新函数**必须带有同类型返回值

解决方案：

不直接使用变量，而是改为函数，了解代码运行机制可以知道，设置状态参数传入一个函数，其真正的逻辑并不会执行，而是在真正调用时（将值放入队列时）才会触发。

```js
import { useState } from 'react';

export default function Counter() {
  const [number, setNumber] = useState(0);

  return (
    <>
      <h1>{number}</h1>
      <button onClick={() => {
        setNumber(n => n + 1);
        setNumber(n => n + 1);
        setNumber(n => n + 1);
      }}>+3</button>
    </>
  )
}
```

这里，`n => n + 1` 被称为**更新器函数**。当你将其传递给状态设置器时：

- 在事件处理程序中的所有其他代码运行之后，React 将此函数排队等待处理。
- 在下一次渲染期间，React 遍历队列并为你提供最终的更新状态。

以下是 React 在执行事件处理程序时如何处理这些代码行：

1. `setNumber(n => n + 1)：n => n + 1` 是一个函数。React 将其添加到队列中。
2. `setNumber(n => n + 1)：n => n + 1` 是一个函数。React 将其添加到队列中。
3. `setNumber(n => n + 1)：n => n + 1` 是一个函数。React 将其添加到队列中。

当你在下一次渲染期间调用 useState 时，React 会遍历队列。之前的 number 状态是 0，所以这就是 React 作为 n 参数传递给第一个更新函数的状态。然后 React 将你之前的更新函数的返回值作为 n 传递给下一个 updater，依此类推：

|排队更新|	n	|返回|
|:-:|:-:|:-:|
|n => n + 1|	0	|0 + 1 = 1|
|n => n + 1|	1	|1 + 1 = 2|
|n => n + 1|	2	|2 + 1 = 3|

## 如果在替换状态后更新状态会发生什么

这个事件处理程序怎么样？你认为 number 会在下一次渲染中出现什么？

```js
<button onClick={() => {
  setNumber(number + 5);
  setNumber(n => n + 1);
}}>
```

答：

1. `setNumber(number + 5)`，number不是函数需要直接取其值，所以`5`放入队列，。
2. `setNumber(n => n + 1)`，`n => n + 1`是个函数,直接放入队列。

在下一次渲染期间，React 遍历状态队列：

1. 取`5`执行，此时number设置为`5`。
2. 取`n => n + 1`执行，取number的当前值作为入参，所以执行结果是6，number设置为6。

## 如果在更新状态后替换它会发生什么

让我们再试一个例子。你认为 number 会在下一次渲染中出现什么？

```js
<button onClick={() => {
  setNumber(number + 5);
  setNumber(n => n + 1);
  setNumber(42);
}}>
```

1. `setNumber(number + 5)`，number不是函数需要直接取其值，所以`5`放入队列，。
2. `setNumber(n => n + 1)`，`n => n + 1`是个函数,直接放入队列。
3. `setNumber(42)`，42放入队列

在下一次渲染期间，React 遍历状态队列：

|排队更新|	n	|返回|
|:-:|:-:|:-:|
|“替换为 5”|	0（未使用）	|5|
|n => n + 1|	5	|5 + 1 = 6|
|“替换为 42”|	6（未使用）	|42|

## 总结

- 设置状态不会更改现有渲染中的变量，但它会请求一个新的渲染。
- React 在事件处理程序完成运行后处理状态更新。这称为批处理。
- 要在一个事件中多次更新某个状态，可以使用**更新函数**,如： `setNumber(n => n + 1)` 。
