# 渲染和提交

在你的组件显示在屏幕上之前，它们必须由 React 渲染，最终提交数据给浏览器做显示。

React 中的渲染意味着什么

React 何时以及为何渲染组件

在屏幕上显示组件所涉及的步骤

为什么渲染并不总是产生 DOM 更新

## 数据显示步骤

### 步骤 1：触发渲染

组件渲染的原因有两个：

- 这是组件的初始渲染。
- 组件（或其祖级之一）的状态已更新。

#### 初始渲染

当你的应用启动时，你需要触发初始渲染。框架和沙箱有时会隐藏此代码，但它是通过使用目标 DOM 节点调用 `createRoot`，然后使用你的组件调用其 render 方法来完成的：

```js
import Image from './Image.js';
import { createRoot } from 'react-dom/client';

const root = createRoot(document.getElementById('root'))
root.render(<Image />);
```

#### 状态更新时重新渲染

组件最初渲染后，你可以通过使用 set 函数 更新其状态来触发进一步的渲染。更新组件的状态会自动对渲染进行排队。（你可以把这些想象成餐厅客人在第一次点菜后点茶、甜点和各种各样的东西，这取决于他们的口渴或饥饿状态。）

### 步骤2 React 渲染你的组件

触发渲染后，React 会调用你的组件来确定要在屏幕上显示的内容。**“渲染” 是 React 调用你的组件**。

- 在初始渲染时，React 将调用根组件。
- 对于后续的渲染，React 将调用其状态更新触发渲染的函数组件。当组件的状态发生变化时，**状态所在的组件会作为渲染的起点**，触发自身重新渲染，然后递归渲染其内部的所有子元素（除非通过优化手段阻止）。

这个过程是**递归**的：如果更新的组件返回一些其他组件，React 将接下来渲染该组件，如果该组件也返回一些东西，它将接下来渲染该组件，依此类推。这个过程将一直持续到没有更多的嵌套组件并且 React 确切地知道应该在屏幕上显示什么。

示例：

```js
export default function Gallery() {
  return (
    <section>
      <h1>Inspiring Sculptures</h1>
      <Image />
      <Image />
      <Image />
    </section>
  );
}

function Image() {
  return (
    <img
      src="https://i.imgur.com/ZF6s192.jpg"
      alt="'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"
    />
  );
}
```

- 在初始渲染期间，React 将为 `<section>`、`<h1>` 和三个 `<img>` 标签使用 ![创建 DOM 节点](https://web.nodejs.cn/docs/Web/API/Document/createElement)。
- 在重新渲染期间，React 将计算自上次渲染以来它们的哪些属性（如果有）发生了更改。在下一步，即提交阶段之前，它不会对这些信息做任何事情。

在 React 中其实是 “组件重新渲染”—— 当状态更新后，组件的函数体会被重新执行一次。重新执行时，会发生这些事情：

1. 重新计算；
2. 重新生成虚拟 DOM（所有子元素）；
3. React 会对比新旧虚拟 DOM，只把变化的部分更新到真实 DOM 中（这一步叫 “协调”，是 React 性能优化的核心）

#### 注意：

**渲染必须始终为 纯计算**：

- 相同的输入，相同的输出。给定相同的输入，组件应该始终返回相同的 JSX。（当有人点西红柿沙拉时，他们不应该收到洋葱沙拉！）
- 它只管自己的事。它不应更改渲染前存在的任何对象或变量。（一个订单不应更改任何其他人的订单。）

否则，随着代码库变得越来越复杂，你可能会遇到令人困惑的错误和不可预知的行为。在 “严格模式” 开发时，React 会调用每个组件的函数两次，这可以帮助表面因函数不纯而导致的错误。

#### 优化性能

如果更新组件在树中的位置非常高，则渲染嵌套在更新组件中的所有组件的默认行为对于性能来说并不是最佳的。如果遇到性能问题，性能 部分中描述了几种选择加入的方法来解决它。不要过早优化！

### 步骤3 React 提交对 DOM 的更改

在渲染（调用）你的组件后，React 将修改 DOM。

- 对于初始渲染，React 将使用 appendChild() DOM API 将其创建的所有 DOM 节点放在屏幕上。
- 对于重新渲染，React 将应用最少的必要操作（在渲染时计算！）以使 DOM 匹配最新的渲染输出。

如果渲染之间存在差异，React 只会更改 DOM 节点。例如，这里有一个组件每秒使用从其父级传递的不同属性重新渲染。请注意如何将一些文本添加到 `<input>` 中，更新其`value`，但当组件重新渲染时文本不会消失：

### 最后：浏览器画图

渲染完成并且 React 更新 DOM 后，浏览器将重新绘制屏幕。尽管此过程称为 “浏览器渲染”，但我们将其称为 “绘制” 以避免在整个文档中造成混淆。

## 说明

- React 应用中的任何屏幕更新都分三步进行：触发->渲染->提交
    1. 状态属于所在组件
    2. ”实时渲染“本质是组件函数的重新执行
    3. 渲染范围是”自顶向下“
- 你可以使用严格模式查找组件中的错误
- 如果渲染结果与上次相同，React 不会触及 DOM
