# 修改屏幕密度

今日头条适配方案是一种基于修改系统密度（Density）的屏幕适配方法，由今日头条团队提出。该方案通过统一设计稿与设备的尺寸比例，实现UI在不同屏幕上的一致性显示。以下是其核心原理和实现方式：

## **核心原理**

Android 中的尺寸单位 `dp` 会根据设备密度（Density）转换为像素（px），计算公式为：  
**px = dp × density**  

例如，在 1080×1920 分辨率、5 英寸的设备上：  

- 屏幕密度为 **3.0**（对应 xhdpi）  
- 1dp 对应 3px  

今日头条方案通过修改系统的 `density` 值，强制让设备的 **总宽度 dp 值** 等于设计稿的宽度 dp 值，从而实现按比例缩放。

## **实现步骤**

### 1. **确定设计稿基准宽度**

假设设计稿宽度为 **375dp**（如 iPhone 6/7/8 尺寸）。

### 2. **计算目标密度（Target Density）**

通过设备的实际像素宽度和设计稿宽度计算新的 density：  
**targetDensity = 设备宽度像素值 / 设计稿宽度 dp 值**  

例如，对于 1080px 宽的设备：  
**targetDensity = 1080 / 375 = 2.88**

### 3. **修改系统密度参数**

在 Application 或 Activity 中修改 `DisplayMetrics` 的密度参数：

```java
public class Density {
    private static float sNoncompatDensity;
    private static float sNoncompatScaledDensity;

    public static void setDensity(final Application application, final float designWidthInDp) {
        final DisplayMetrics displayMetrics = application.getResources().getDisplayMetrics();
        
        if (sNoncompatDensity == 0) {
            // 保存系统原始密度
            sNoncompatDensity = displayMetrics.density;
            sNoncompatScaledDensity = displayMetrics.scaledDensity;
            
            // 监听系统字体变化
            application.registerComponentCallbacks(new ComponentCallbacks() {
                @Override
                public void onConfigurationChanged(Configuration newConfig) {
                    if (newConfig != null && newConfig.fontScale > 0) {
                        sNoncompatScaledDensity = application.getResources().getDisplayMetrics().scaledDensity;
                    }
                }

                @Override
                public void onLowMemory() {}
            });
        }
        
        // 计算目标密度
        final float targetDensity = displayMetrics.widthPixels / designWidthInDp;
        final float targetScaledDensity = targetDensity * (sNoncompatScaledDensity / sNoncompatDensity);
        final int targetDensityDpi = (int) (160 * targetDensity);
        
        // 应用新的密度参数
        displayMetrics.density = targetDensity;
        displayMetrics.scaledDensity = targetScaledDensity;
        displayMetrics.densityDpi = targetDensityDpi;
        
        // 对 Application 生效
        final DisplayMetrics appDisplayMetrics = application.getResources().getDisplayMetrics();
        appDisplayMetrics.density = targetDensity;
        appDisplayMetrics.scaledDensity = targetScaledDensity;
        appDisplayMetrics.densityDpi = targetDensityDpi;
    }
}
```

### 4. **在 Application 中初始化**

```java
public class MyApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
        // 假设设计稿宽度为 375dp
        Density.setDensity(this, 375f);
    }
}
```

### 5. **对 Activity 单独处理（可选）**

若某些 Activity 需要特殊适配：

```java
public class BaseActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        // 为每个 Activity 设置密度
        Density.setDensity(getApplication(), 375f);
    }
}
```

## **方案优势**

1. **一套设计稿**：无需为不同屏幕尺寸创建多套资源。
2. **精准适配**：元素尺寸严格按设计稿比例缩放，避免变形。
3. **简单易用**：只需一次配置，后续直接使用 dp 单位。
4. **兼容刘海屏**：自然适配异形屏，无需额外处理。

## **注意事项**

1. **系统组件适配**：修改全局密度可能影响系统控件（如 Toast、Dialog）的显示，需测试确认。
2. **第三方库兼容性**：部分依赖系统密度的库可能显示异常，需针对性处理。
3. **字体适配**：需单独处理字体缩放，避免文字过大或过小：

   ```java
   // 在计算 targetScaledDensity 时加入字体缩放因子
   final float fontScale = 1.0f; // 自定义字体缩放比例
   final float targetScaledDensity = targetDensity * (sNoncompatScaledDensity / sNoncompatDensity) * fontScale;
   ```

4. **横屏适配**：如需横屏适配，可根据屏幕方向切换基准宽度：

   ```java
   // 在 Activity 中根据方向设置不同的设计稿宽度
   @Override
   public void onConfigurationChanged(Configuration newConfig) {
       super.onConfigurationChanged(newConfig);
       if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE) {
           Density.setDensity(this, 667f); // 横屏设计稿宽度
       } else {
           Density.setDensity(this, 375f); // 竖屏设计稿宽度
       }
   }
   ```

## **与其他方案对比**

| 方案               | 优点                      | 缺点                          |
|--------------------|---------------------------|-------------------------------|
| **今日头条方案**   | 一套设计稿，精准按比例缩放 | 可能影响系统组件和第三方库    |
| **ConstraintLayout** | 灵活布局，官方支持        | 复杂布局约束关系调试繁琐      |
| **Smallest Width** | 适配不同尺寸设备          | 需要维护多套布局资源          |
| **AutoSize**       | 自动化适配多种场景        | 引入第三方依赖                |

## **总结**

今日头条适配方案通过强制统一设备的逻辑密度，实现了 UI 在不同屏幕上的等比例缩放，尤其适合需要严格按照设计稿还原的应用。但在使用时需注意系统组件和第三方库的兼容性问题，建议在项目初期就确定适配方案，避免后期重构成本。
