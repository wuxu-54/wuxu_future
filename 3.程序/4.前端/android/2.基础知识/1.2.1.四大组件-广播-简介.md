# 广播

在 Android 中，广播（Broadcast）是一种跨组件通信机制，用于在应用内或应用间传递消息。以下是广播的三种常见类型及示例代码：

---

## 一、全局广播（普通广播）

### 1. 发送全局广播

```java
// 发送普通广播
Intent intent = new Intent("com.example.MY_GLOBAL_ACTION");
intent.putExtra("data", "Hello Global Broadcast!");
context.sendBroadcast(intent);
```

### 2. 接收全局广播

**方式一：动态注册（推荐在 Activity/Fragment 中使用）**：

```java
// 定义接收器
private BroadcastReceiver globalReceiver = new BroadcastReceiver() {
    @Override
    public void onReceive(Context context, Intent intent) {
        String data = intent.getStringExtra("data");
        Log.d("GlobalReceiver", "Received: " + data);
    }
};

// 注册接收器（通常在 onResume 中）
IntentFilter filter = new IntentFilter("com.example.MY_GLOBAL_ACTION");
context.registerReceiver(globalReceiver, filter);

// 取消注册（在 onPause 或 onDestroy 中）
context.unregisterReceiver(globalReceiver);
```

**方式二：静态注册（在 AndroidManifest.xml 中声明）**：

```xml
<receiver android:name=".MyGlobalReceiver">
    <intent-filter>
        <action android:name="com.example.MY_GLOBAL_ACTION" />
    </intent-filter>
</receiver>
```

```java
// MyGlobalReceiver.java
public class MyGlobalReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        String data = intent.getStringExtra("data");
        Log.d("MyGlobalReceiver", "Received: " + data);
    }
}
```

---

## 二、本地广播（Local Broadcast）

使用 `LocalBroadcastManager`（仅限应用内通信，更安全高效）

### 1. 发送本地广播

```java
// 发送本地广播
LocalBroadcastManager lbm = LocalBroadcastManager.getInstance(context);
Intent intent = new Intent("com.example.MY_LOCAL_ACTION");
intent.putExtra("data", "Hello Local Broadcast!");
lbm.sendBroadcast(intent);
```

### 2. 接收本地广播

```java
// 定义接收器
private BroadcastReceiver localReceiver = new BroadcastReceiver() {
    @Override
    public void onReceive(Context context, Intent intent) {
        String data = intent.getStringExtra("data");
        Log.d("LocalReceiver", "Received: " + data);
    }
};

// 注册接收器
LocalBroadcastManager lbm = LocalBroadcastManager.getInstance(context);
IntentFilter filter = new IntentFilter("com.example.MY_LOCAL_ACTION");
lbm.registerReceiver(localReceiver, filter);

// 取消注册
lbm.unregisterReceiver(localReceiver);
```

---

## 三、带权限的广播

### 1. 发送带权限的广播

**发送方声明权限（AndroidManifest.xml）**：

```xml
<permission android:name="com.example.MY_PERMISSION" />
```

**发送带权限的广播**：

```java
Intent intent = new Intent("com.example.PROTECTED_ACTION");
intent.putExtra("data", "Secure Data");
context.sendBroadcast(intent, "com.example.MY_PERMISSION"); // 添加权限
```

### 2. 接收带权限的广播

**方式一：接收方声明权限**：

```xml
<uses-permission android:name="com.example.MY_PERMISSION" />
```

```java
// 动态注册接收器（代码同全局广播）
context.registerReceiver(protectedReceiver, filter);
```

**方式二：发送方要求接收方权限**：

```java
// 发送广播时要求接收方有权限
Intent intent = new Intent("com.example.PROTECTED_ACTION");
context.sendBroadcast(intent, "com.example.RECEIVER_PERMISSION");
```

---

## 注意事项

1. **全局广播限制**：Android 8.0+ 对隐式广播（未指定包名的广播）有限制，建议使用 `setPackage()` 指定接收方包名：

   ```java
   intent.setPackage("com.example.targetapp");
   ```

2. **本地广播优势**：无需跨进程，性能更高且无需担心安全漏洞。

3. **权限机制**：可通过 `android:protectionLevel` 控制权限级别（如 `signature` 限制同签名应用）。

4. **避免 ANR**：`onReceive()` 方法需在 10 秒内完成，否则会触发 ANR。

---

## 总结

| 类型        | 使用场景                   | 特点                      |
|-----------|------------------------|-------------------------|
| 全局广播      | 跨应用通信                 | 需要权限控制，可能被恶意应用监听     |
| 本地广播      | 应用内通信                 | 安全高效，无需权限              |
| 带权限的广播    | 敏感操作或跨应用安全通信         | 通过权限控制发送/接收方           |

根据需求选择合适的广播类型，优先使用本地广播以提高安全性。

---

## 广播权限设置的补充

```xml
<permission android:name="com.example.MY_PERMISSION"
    android:protectionLevel="signature"/>
```

解释：

`android:protectionLevel="signature"` 是在定义权限时使用的属性，用于指定权限的保护级别，可以不写，默认为normal。具体来说，signature 保护级别的权限意味着只有那些与定义该权限的应用具有相同签名（即由同一个开发者签名）的应用才能被授予该权限。

以下是 android:protectionLevel 的几种常见值及其含义：

- normal：低风险权限，不需要用户确认，系统会自动授予，即如果省略不写`android:protectionLevel`，系统默认赋予normal权限。
- dangerous：高风险权限，需要用户明确同意。
- signature：只有具有相同签名的应用才能被授予该权限。这通常用于同一个开发者提供的多个应用之间的通信。
- signatureOrSystem：与 signature 类似，但还可以被系统应用（即预装在系统中的应用）使用。

在你的例子中，android:protectionLevel="signature" 确保了只有那些由同一个开发者签名的应用才能接收带有 com.example.MY_PERMISSION 权限的广播。这增加了安全性，防止其他应用未经授权接收敏感信息。
