# APP ComposeUI设计文档

## 1. 背景

Android xml 使用太繁琐，功能如阴影、模糊等效果支持差、动画可能存在性能问题。基于以上，进行ComposeUI升级替换。

## 2. 整体目标

1. 使用ComposeUI 完全替换所有页面UI
2. 保证页面及功能操作流畅，响应快（明确具体指标，比如帧率、页面启动速度、事件响应速度）。

## 3. 技术方案设计

功能划分：

1. 账号管理
2. 首页
3. 闪屏页面
4. 登录页面
5. 设置页面

思考：

1. 怎么实现游客模式、点击判断是否登录，如果未登录调整登录页面，登录后继续执行原逻辑或跳转目标页
2. 使用哪种设计模式，封装可替换的网络请求模块
3. 整体架构
4. 图片加载速度、包括大图
5. 保证启动速度、帧率，同一时间怎么避免AssetManager被占用导致渲染慢、卡顿。
6. 怎么设计单元测试、执行单元测试？
7. 怎么进行性能分析，给出对外的性能报告？
8. 跨进程通信方案？

### 3.1 原则

#### 3.1.1 架构原则

1. 分离关注点：每个类不要写太多代码，可以进行拆分。
2. 通过数据模型驱动界面

    >如Flutter的redux、Vue中的vuex 等都是单向数据流，由数据驱动界面。

3. 单一数据源
4. 单向数据流
5. 依赖关系解耦
6. 可测试性
7. 遵照设计原则，合理使用设计模式

#### 3.1.2 开发原则

1. 遵照设计原则
2. 代码风格：采用Android studio默认格式
3. 按clean架构之道执行
    - 减少无用注释
    - 命名准确
4. 开发前先写好数据流脑图
5. 规范日志，严格日志等级的使用
6. 严格codereview
7. 做好质量保障，提测前执行测试左移

## 3.3 项目构建

1. Android gradle项目构建配置插件
2. 编译优化
3. AOP、注解处理器，实现自动化代码

## 3.4 APP技术选型

1. 整体架构：MVVM架构
2. 依赖注入框架：Hilt
3. UI：ComposeUI（主）、原生View、H5、Flutter
4. 响应式异步编程框架: RxJava、LiveData、协程
5. 网络请求：暂时先用Retrofit
6. 数据存储方案：
    1. 数据库：jetpack中的room数据库
    2. SharePreference
    3. 序列化选择
    4. JSON库
7. 账号管理方案：自定义
8. 下载组件：自定义封装下载能力组件
9. 插件化方案：shadow
10. 路由方案：自定义
    自定义路由地址：
    1. 拦截器
    2. 跳转其他应用是的校验、下载机制
    3. h5页面打开处理
11. 通信方案：
    1. 应用内：自定义
    2. 跨进程：自定义
        1. 大文件跨进程数据传输方案：ContentProvider
        2. 小文件跨进程通信方案：
            - 广播
            - aidl
        3. 频繁通信的方案：
            - aidl
            - Socket
12. 单元测试：自定义
    1. 每个功能写mock数据
    2. 每个功能可以进行单元测试
13. 屏幕适配，两种方式待选：
    1. 代码方式动态计算每个size值
    2. xml适配，使用SmallestWidth适配方案
14. 页面入口管理方案：
    1. 设定无view的Activity进行跳转
    2. 解析跳转uri及携带参数
15. UI统一：
    1. 弹窗集中管理，样式具体分为几种
    2. 公共样式参数管理
16. 日志管理：自定义
    1. 打印
    2. 三方库日志屏弊
    3. 开发者模式下日志开关及等级设置
17. 用户行为分析：
    1. 埋点
18. 风险管控：
    1. 频繁崩溃防御机制
    2. 异常数据日志上报
    3. 功能异常处理机制（非插件化推送升级的方式）
19. native库开发
    1. rust开发
    2. c++开发
20. 性能保证
    1. 无主线程耗时任务
    2. 日志打印，包括启动、动画执行、方法执行耗时
    3. 广播、Service无耗时任务
    4. Bitmap图片优化、动效优化（比如大分辨率帧动画可以采用缓存bitmap方式保证无卡顿）
    5. 拆分大类对象（看java虚拟机章节可以知道，特大类在gc管理时存入老年代，导致频繁回收，而回收会耗时）
21. 权限管理：自定义
22. 安全策略管理：
    1. 数据存储安全：加密方式
    2. 令牌
    3. app安全
        1. 混淆
        2. 签名
        3. 加固
21. 初始化管理：自定义初始化器

## 4. 具体实现方案

### 首页

#### 类图

#### 数据流脑图

现在通过数据流脑图

````mermaid

````

### 网络请求方案

### 数据存储方案

### 账号管理方案

### 通用工具提供方案

1. 管理工具：设备ID、网络连接接状态等
2. 系统信息管理：设备类型
3. 屏幕适配处理

### 单元测试

#### mock数据

全局设定mock模式开关，在数据层进行网络处理，网络请求处，采用什么设计模式封装，可自由切换网络框架

## 5. 问题
