# singleInstancePerTask

在 Android 开发中，`singleInstancePerTask` 是 Android 12（API 级别 31）引入的一个新的 Activity 启动模式。它用于更精细地控制 Activity 实例与任务栈（Task）的关系，尤其适用于多窗口、多任务场景下的复杂交互需求。

---

## **`singleInstancePerTask` 的核心行为**

1. **每个任务栈有且仅有一个实例**  
   - Activity 在它所属的**每个任务栈**中**只能存在一个实例**。
   - 如果尝试在同一个任务栈中再次启动该 Activity，系统会直接复用现有实例，并调用 `onNewIntent()` 传递新的 Intent。

2. **必须是任务栈的根 Activity**  
   - 该 Activity **必须作为任务栈的根（Root）**，即它所在的任务栈**只能由它自己创建**。
   - 如果通过该 Activity 启动其他 Activity，新 Activity 会被放置到**另一个独立的任务栈**中（取决于其启动模式和 `taskAffinity`）。

3. **任务栈独立性**  
   - 不同任务栈中的同一 `singleInstancePerTask` Activity **彼此独立**，互不影响。
   - 例如：在多窗口模式下，用户可以在两个分屏窗口中各自启动该 Activity，每个窗口对应一个独立的任务栈，每个任务栈中有一个该 Activity 的实例。

---

## **与 `singleTask` 的区别**

| 特性                | `singleTask`                     | `singleInstancePerTask`               |
|---------------------|----------------------------------|---------------------------------------|
| **实例数量**         | 每个任务栈最多一个实例           | 每个任务栈必须且只能有一个实例         |
| **是否必须为根**     | 不要求（可以是栈中任意位置）     | 必须为任务栈的根 Activity              |
| **任务栈复用逻辑**   | 可能复用其他任务栈               | 强制每个任务栈独立且唯一               |
| **典型场景**         | 主页（Home）等全局唯一入口       | 多窗口场景下独立任务栈的根 Activity    |

---

## **典型使用场景**

1. **多窗口/分屏模式**  
   当应用需要在多个窗口（如分屏模式）中独立运行时，每个窗口的任务栈需要一个独立的根 Activity 实例。  
   **示例**：文档编辑应用的分屏模式，每个窗口独立编辑不同文档。

2. **平行任务流**  
   允许用户通过不同入口（如通知、快捷方式）启动多个独立的任务流，每个任务流有独立的根 Activity。  
   **示例**：电商应用中，用户通过两个通知分别进入两个不同的商品详情页，各自独立操作。

3. **防止任务栈污染**  
   确保关键入口 Activity（如登录页）始终作为独立的根，避免被其他 Activity 覆盖或干扰。

---

## **配置方法**

在 `AndroidManifest.xml` 中声明 Activity 的启动模式：

```xml
<activity
    android:name=".MainActivity"
    android:launchMode="singleInstancePerTask" />
```

---

## **注意事项**

1. **任务栈亲和性（`taskAffinity`）**  
   - 默认情况下，`singleInstancePerTask` Activity 的 `taskAffinity` 为应用包名。
   - 若需为不同任务栈指定不同亲和性，需显式配置 `taskAffinity` 属性：

     ```xml
     <activity
         android:name=".DocumentActivity"
         android:launchMode="singleInstancePerTask"
         android:taskAffinity=".document_stack" />
     ```

2. **与 Intent Flags 的交互**  
   - `FLAG_ACTIVITY_MULTIPLE_TASK`：强制创建新任务栈（即使存在匹配的 `taskAffinity` 栈）。
   - `FLAG_ACTIVITY_NEW_DOCUMENT`：结合 `singleInstancePerTask` 可实现类似多文档模式的效果。

3. **兼容性**  
   - `singleInstancePerTask` 仅在 Android 12（API 31）及以上生效，低版本系统会回退到 `singleTask` 行为。

---

## **示例代码**

启动一个 `singleInstancePerTask` Activity：

```kotlin
val intent = Intent(this, DocumentActivity::class.java)
// 强制创建新任务栈（即使已有相同 taskAffinity 的栈）
intent.addFlags(Intent.FLAG_ACTIVITY_MULTIPLE_TASK or Intent.FLAG_ACTIVITY_NEW_TASK)
startActivity(intent)
```

---

## **调试技巧**

通过以下命令观察任务栈结构：

```bash
adb shell dumpsys activity activities
```

输出中会显示每个任务栈的 Affinity 和包含的 Activity 实例。

---

## **总结**

`singleInstancePerTask` 适用于需要**严格隔离任务栈**且**每个任务栈有独立根 Activity** 的场景，尤其在多窗口、多任务环境中能显著提升用户体验。但需注意其与 Android 版本的兼容性，合理设计 `taskAffinity` 和 Intent Flags 的组合逻辑。
