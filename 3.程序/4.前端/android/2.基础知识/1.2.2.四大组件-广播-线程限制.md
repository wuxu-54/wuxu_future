# 广播线程限制

在 Android 中，**发送广播没有特定的线程要求**，但**接收广播的处理线程有明确规则**。以下是详细说明和注意事项：

---

## 一、发送广播的线程行为

1. **无限制**  
   可以在**任意线程**（主线程或子线程）调用 `sendBroadcast()` 或 `sendOrderedBroadcast()`，例如：

   ```java
   // 主线程发送
   sendBroadcast(new Intent("MAIN_THREAD_ACTION"));

   // 子线程发送
   new Thread(() -> {
       sendBroadcast(new Intent("BACKGROUND_THREAD_ACTION"));
   }).start();
   ```

2. **发送过程是异步的**  
   - 调用 `sendBroadcast()` 后，系统会**立即返回**，广播的实际发送由系统调度。
   - 发送操作不会阻塞当前线程。

---

## 二、接收广播的线程规则

接收方的 `onReceive()` **固定运行在主线程**，无论发送方在哪个线程发送！

### 示例代码

```java
// 接收器的 onReceive 方法在主线程执行
private BroadcastReceiver receiver = new BroadcastReceiver() {
    @Override
    public void onReceive(Context context, Intent intent) {
        // 此处可直接操作 UI
        textView.setText("Received broadcast!");
        
        // 但禁止耗时操作（如网络请求）！否则会触发 ANR
        // 必须开启子线程处理耗时任务
        new Thread(() -> {
            // 子线程处理耗时逻辑
        }).start();
    }
};
```

### 关键限制

- **ANR 风险**：`onReceive()` 必须**在 10 秒内完成**，否则系统会抛出 `Application Not Responding` 错误。
- **UI 操作允许**：可直接更新 UI（因为运行在主线程）。
- **耗时操作禁止**：若需执行网络请求、数据库操作等，必须启动子线程。

---

## 三、常见场景与解决方案

### 场景 1：在子线程发送广播，接收方更新 UI

- **直接可行**，因为接收方的 `onReceive()` 在主线程运行：

  ```java
  new Thread(() -> {
      // 子线程发送广播
      sendBroadcast(new Intent("UPDATE_UI_ACTION"));
  }).start();

  // 接收方直接操作 UI
  receiver.onReceive = { textView.setText("Updated!") }
  ```

### 场景 2：接收方需要执行耗时操作

- **必须异步处理**（如使用 `Thread`、`Handler` 或 `Coroutine`）：

  ```java
  private BroadcastReceiver receiver = new BroadcastReceiver() {
      @Override
      public void onReceive(Context context, Intent intent) {
          // 启动子线程处理
          new Thread(() -> {
              // 执行耗时操作（如读取数据库）
          }).start();
      }
  };
  ```

---

## 四、注意事项

1. **避免内存泄漏**  
   - 动态注册的接收器需在 `onDestroy()` 中及时注销。
   - 静态注册（Manifest 声明）的接收器需谨慎使用。

2. **跨进程广播**  
   - 使用 `sendBroadcast(Intent, String)` 指定权限，防止恶意应用监听。

3. **Android 8.0+ 限制**  
   - 针对隐式广播（未指定目标包名的广播），需使用 `setPackage()` 或改用 `LocalBroadcastManager`。

---

## 总结

| 操作        | 线程要求                         | 注意事项                                   |
|-------------|----------------------------------|--------------------------------------------|
| **发送广播** | 任意线程（主/子线程均可）         | 确保 Context 有效性（如避免 Activity 泄露）|
| **接收处理** | 固定主线程（`onReceive()`）       | 禁止耗时操作，必须异步处理耗时任务           |

根据业务需求选择合适的线程发送广播，并严格遵守接收方的线程规则。
