# SP 单元测试

在Android应用开发中，SharedPreferences 是一种轻量级存储解决方案，用于存储简单的数据。对于SharedPreferences的单元测试，由于它依赖于Android系统和持久化存储，直接进行单元测试可能会比较复杂。以下是一些处理SharedPreferences单元测试的方法：

## 1.使用依赖注入

将SharedPreferences封装成一个接口，然后在应用中实现这个接口。在测试时，提供一个实现了该接口的假对象（Fake）或者存根（Stub），这样测试就不会依赖于实际的SharedPreferences。

```java
public interface SharedPreferencesHelper {
    void putString(String key, String value);
    String getString(String key, String defaultValue);
    // 其他需要的方法
}

// 实现类
public class SharedPreferencesImpl implements SharedPreferencesHelper {
    private SharedPreferences sharedPreferences;
    
    public SharedPreferencesImpl(Context context, String name) {
        sharedPreferences = context.getSharedPreferences(name, Context.MODE_PRIVATE);
    }
    
    @Override
    public void putString(String key, String value) {
        SharedPreferences.Editor editor = sharedPreferences.edit();
        editor.putString(key, value);
        editor.apply();
    }
    
    @Override
    public String getString(String key, String defaultValue) {
        return sharedPreferences.getString(key, defaultValue);
    }
    // 其他方法的实现...
}
```

## 2.模拟（Mocking）

使用模拟对象库如Mockito来创建SharedPreferences和SharedPreferences.Editor的模拟对象。在测试中，你可以定义模拟对象的行为，使其返回预期的值或在特定条件下触发特定的动作。

```java
@Test
public void testPreferencePutAndGet() {
    SharedPreferences mockSharedPreferences = Mockito.mock(SharedPreferences.class);
    SharedPreferences.Editor mockEditor = Mockito.mock(SharedPreferences.Editor.class);
    
    when(mockSharedPreferences.edit()).thenReturn(mockEditor);
    when(mockEditor.putString(anyString(), anyString())).thenReturn(mockEditor);
    when(mockEditor.apply()).thenReturn(null);
    when(mockSharedPreferences.getString(anyString(), anyString())).thenReturn("TestValue");
    
    // 现在可以测试你的逻辑，使用mockSharedPreferences替代实际的SharedPreferences
}
```

## 3.使用InMemorySharedPreferences

创建一个使用内存中存储的SharedPreferences实现，而不是使用文件系统。这样，你就可以在测试中使用它，而不用担心对设备或模拟器上的文件系统进行操作。

## 4.避免在单元测试中测试持久化

有时候，你可能不需要在单元测试中测试SharedPreferences的持久化行为。相反，你可以只测试逻辑层面，确保代码正确地调用了put和get方法。

## 5.使用Robolectric

Robolectric是一个Android测试框架，它允许你在普通JVM上运行Android代码。Robolectric可以更好地模拟Android环境，包括SharedPreferences，但请注意，它可能无法模拟所有Android API。

## 6.测试驱动开发（TDD）

如果你采用TDD方法，那么在编写代码之前，你会先编写测试。这有助于你设计出易于测试的接口和类。
