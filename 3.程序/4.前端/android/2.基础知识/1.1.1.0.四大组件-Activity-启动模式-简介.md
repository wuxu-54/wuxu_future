# Activity 启动模式

Android 中的 Activity 启动模式（Launch Mode）决定了 Activity 实例如何与任务栈（Task）交互，主要用于管理 Activity 的创建和复用逻辑。以下是四种标准启动模式的详解，以及任务栈（Task）和 Intent Flag 的相关知识。

---

## **1. 标准启动模式**

### **`standard`（默认模式）**

- **行为**：每次启动 Activity 都会创建一个新的实例，**无论是否已存在**。
- **任务栈位置**：新实例会放入当前任务栈（调用者所在的任务栈）。
- **典型场景**：普通页面，不涉及特殊复用逻辑（如新闻详情页）。
- **注意**：可能导致同一个 Activity 的多个实例存在（如多次跳转后按返回键会逐级退出）。

---

## **2. 栈顶复用模式**

### **`singleTop`**

- **行为**：
  - 如果目标 Activity **已处于当前任务栈的栈顶**，则直接复用该实例（不会新建），并通过 `onNewIntent()` 传递新 Intent。
  - 如果目标 Activity **不在栈顶**，则新建实例。
- **典型场景**：防止短时间内重复打开同一个页面（如点击通知跳转同一页面）。
- **示例**：推送通知跳转的详情页，避免多次点击通知后产生多个相同页面。

---

## **3. 栈内单例模式**

### **`singleTask`**

- **行为**：
  - 系统会寻找与目标 Activity **`taskAffinity` 匹配的任务栈**：
    - 如果存在匹配栈且栈中有该 Activity 实例，则直接复用该实例，并清除它**之上的所有 Activity**，通过 `onNewIntent()` 传递新 Intent。
    - 如果不存在匹配栈，则新建一个任务栈并创建实例。
  - **默认 `taskAffinity`**：应用包名（通常与主任务栈一致）。
- **典型场景**：应用的主页（Home），确保全局唯一且作为栈的根 Activity。
- **示例**：从子页面返回到主页时，清除所有中间页面。

---

## **4. 全局单例模式**

### **`singleInstance`**

- **行为**：
  - 目标 Activity 会独占一个**全新的任务栈**，且该栈中**只能存在该 Activity 的实例**。
  - 后续启动该 Activity 时，直接复用已有实例，通过 `onNewIntent()` 传递新 Intent。
- **典型场景**：需要与其他应用共享的独立页面（如系统拨号界面）。
- **注意**：此模式可能导致任务栈管理复杂化，需谨慎使用。

---

## **关键概念补充**

### **任务栈（Task）**

- 任务栈是一个 Activity 实例的集合，按“后进先出”管理。
- 用户感知为一个“任务”（如浏览器多标签页属于同一任务栈）。
- 可通过 `taskAffinity` 属性指定 Activity 期望的任务栈（默认为应用包名）。

### **Intent Flag**

启动模式可通过 `Intent` 的 Flag 动态调整（优先级高于 Manifest 中静态配置）：

- `FLAG_ACTIVITY_NEW_TASK`：在新任务栈中启动 Activity（类似 `singleTask`）。
- `FLAG_ACTIVITY_SINGLE_TOP`：栈顶复用（类似 `singleTop`）。
- `FLAG_ACTIVITY_CLEAR_TOP`：清除目标 Activity 之上的所有实例（常与 `singleTask` 配合）。

---

## **对比总结**

| 启动模式       | 实例复用规则                     | 任务栈影响                     | 典型场景               |
|----------------|----------------------------------|--------------------------------|-----------------------|
| `standard`     | 总是新建实例                     | 放入当前栈                     | 普通页面              |
| `singleTop`    | 栈顶时复用，否则新建             | 放入当前栈                     | 防重复跳转            |
| `singleTask`   | 栈内唯一，清除上方实例           | 可能新建或复用 Affinity 匹配栈 | 主页/入口页           |
| `singleInstance`| 全局唯一，独占新栈              | 强制新建独占栈                 | 独立功能（如拨号）    |

---

## **使用建议**

1. 优先使用 `standard` 和 `singleTop`，避免过度依赖 `singleTask` 和 `singleInstance`。
2. 结合 `taskAffinity` 和 Intent Flag 灵活控制任务栈。
3. 通过 `adb shell dumpsys activity activities` 命令观察任务栈结构，调试启动模式问题。

理解启动模式有助于优化用户体验（如避免页面重复、合理管理返回栈），但需结合实际业务逻辑权衡设计。
