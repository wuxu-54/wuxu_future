# 检查与调试

原地址：<https://developer.android.google.cn/develop/ui/compose/accessibility/inspect-debug?hl=zh-cn>

**Android Compose的无障碍检查和调试工具**包括：**Android无障碍套件**（含TalkBack等辅助技术，用于模拟用户体验）、**布局检查器**（调试语义属性与组件树结构）、**无障碍功能扫描仪应用**（扫描常见无障碍问题并提供建议）。调试时可通过布局检查器查看语义节点状态（如是否隐藏、是否有点击事件）、利用TalkBack开发者设置的TreeDebug或ComposeTestRule的printToLog方法追踪语义树问题，定位如焦点缺失、操作反馈不足等异常行为。

---

## 思维导图  

```mindmap
## **检查工具**
- Android无障碍套件
  - 包含TalkBack、随选朗读等
  - 模拟用户体验，验证语义有效性
- 布局检查器
  - 调试组件树的语义属性与边界
  - 识别缺失/错误语义（如hideFromAccessibility标记）
- 无障碍功能扫描仪应用
  - 扫描屏幕，识别常见无障碍陷阱
  - 提供改进建议（如缺少交互操作）
## **调试方法**
- 布局检查器
  - 查看组件树的语义节点状态（焦点、点击事件等）
  - 案例：调试三元素界面，定位隐藏元素和无操作按钮
- TalkBack TreeDebug
  - 跟踪语义树节点遍历顺序与属性
- ComposeTestRule.printToLog
  - 输出语义树日志，辅助分析合并/清除策略问题
```

---

## 详细总结  

### 一、核心检查工具  

| **工具名称**               | **功能描述**                                                                 | **适用场景**                               |  
|----------------------------|-----------------------------------------------------------------------------|------------------------------------------|  
| **Android无障碍套件**       | 包含TalkBack、开关控制、随选朗读等辅助技术，直接模拟用户与应用的交互，验证语义是否正确传达。 | 测试屏幕阅读器对组件的朗读顺序、交互反馈是否符合预期。 |  
| **布局检查器（Layout Inspector）** | 可视化组件树结构，显示每个可组合项的语义属性（如Role、OnClick、hideFromAccessibility），支持切换合并/未合并语义树。 | 调试语义缺失（如无点击事件）、属性错误（如错误标记为隐藏）或分组问题。 |  
| **无障碍功能扫描仪应用**   | 自动扫描屏幕内容，检测常见无障碍问题（如缺少内容描述、不可聚焦元素），提供优化建议。 | 快速定位基础无障碍缺陷，如装饰性图标未隐藏、按钮无交互逻辑。 |  

### 二、调试方法与案例  

#### 1. **布局检查器的典型用法**  

- **功能点**：  
  - 查看组件的**Declared Semantics**面板，确认是否包含必要属性（如`OnClick`、`Role.Button`）。  
  - 通过`Component Tree`识别被`hideFromAccessibility`标记的元素（如图标显示为灰色或带有隐藏标识）。  
  - 对比合并与未合并树，验证分组策略是否正确（如`Row`是否合并子元素语义）。  

- **案例：三元素界面调试**  
  - **元素1**：应用`hideFromAccessibility`，布局检查器显示`HideFromAccessibility=true`，对无障碍服务不可见。  
  - **元素2**：有焦点属性但无`OnClick`，表明缺少交互修饰符（如`clickable`），TalkBack无法触发操作。  
  - **元素3**：属性完整（`Focused=false`、`OnClick`存在、`Role.Button`），正常响应无障碍交互。  

#### 2. **TalkBack开发者设置**  

- **TreeDebug模式**：开启后可实时查看语义树节点遍历顺序，定位遍历顺序异常问题（如分组错误导致顺序混乱）。  

#### 3. **ComposeTestRule打印日志**  

- **方法**：  

  ```kotlin
  composeTestRule.onRoot().printToLog("SEMANTICS") // 输出合并语义树  
  composeTestRule.onRoot(useUnmergedTree=true).printToLog("SEMANTICS") // 输出未合并树  
  ```  

- **用途**：对比日志中的语义节点结构，排查合并策略（`mergeDescendants`）或清除策略（`clearAndSetSemantics`）导致的意外行为。  

### 三、关键调试场景  

1. **元素未被无障碍服务识别**  
   - 检查是否应用`hideFromAccessibility`或`clearAndSetSemantics`清空语义。  
   - 确认组件是否设置`Role`和交互属性（如`OnClick`），是否属于可聚焦元素（如非`Button`需手动设置`focusable=true`）。  

2. **交互反馈异常（如TalkBack无操作提示）**  
   - 验证是否缺少`clickable`、`toggleable`等修饰符，或自定义操作（`customActions`）未正确绑定。  
   - 检查语义合并是否导致子元素交互被父节点覆盖（如子按钮的`OnClick`被父`Row`合并后失效）。  

3. **遍历顺序混乱**  
   - 通过布局检查器查看`isTraversalGroup`和`traversalIndex`设置是否正确，确保分组边界和索引优先级符合逻辑。  

---

## 关键问题  

1. **Q：主要的无障碍检查工具有哪些？各自的核心作用是什么？**  
   **A**：  
   - **Android无障碍套件**：通过TalkBack等工具模拟用户体验，验证语义传达的准确性。  
   - **布局检查器**：可视化调试语义属性，定位缺失或错误的配置（如隐藏元素、无交互事件）。  
   - **无障碍功能扫描仪**：自动检测常见问题（如不可聚焦组件），提供优化建议。  

2. **Q：如何使用布局检查器定位“元素无法被TalkBack选中”的问题？**  
   **A**：  
   - 在布局检查器中选中目标元素，查看`Declared Semantics`面板：  
     - 若`HideFromAccessibility=true`，说明元素被标记为隐藏，需移除该属性。  
     - 若缺少`Role`或`OnClick`，需添加交互修饰符（如`clickable`）或手动设置语义（如`role = Role.Button`）。  
   - 检查父节点是否错误合并语义（如`mergeDescendants=true`导致子元素独立交互被屏蔽）。  

3. **Q：无障碍功能扫描仪的主要优势是什么？适合在什么阶段使用？**  
   **A**：  
   - **优势**：无需手动逐元素检查，可快速扫描全屏幕，识别如“装饰性图标未隐藏”“文本无对比度”等基础问题，生成结构化改进报告。  
   - **使用阶段**：开发初期或版本迭代时，作为自动化检测工具，优先解决高优先级无障碍缺陷，提升开发效率。
