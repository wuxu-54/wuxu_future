
# 自定义 Painter  

原地址：<https://developer.android.google.cn/develop/ui/compose/graphics/images/custompainter?hl=zh-cn>  

## 一、Painter 基础概念  

### 1.1 核心作用  

- **定义**：`Painter` 是 Compose 中用于绘制图形的核心对象，替代 Android 传统的 `Drawable`，负责处理图像渲染逻辑。  
- **分类**：  
  - `BitmapPainter`：绘制位图（`ImageBitmap`），如 JPEG、PNG。  
  - `VectorPainter`：绘制矢量图（`ImageVector`），如 SVG、VectorDrawable。  
- **关键特性**：  
  - 影响可组合项的 **测量（Measuring）** 和 **布局（Layout）**。  
  - 通过 `intrinsicSize` 定义自身固有尺寸，影响父组件布局。  

## 二、自定义 Painter 的实现步骤  

### 2.1 继承 `Painter` 类  

```kotlin  
abstract class Painter : Drawable() {  
    abstract fun onDraw(canvas: DrawScope)  
    abstract val intrinsicSize: Size  
}  
```  

### 2.2 实现 `onDraw` 方法  

- **作用**：在 `DrawScope` 中编写具体的绘制逻辑，支持绘制图像、图形、文本等。  
- **核心 API**：  
  - `drawImage`：绘制位图或矢量图。  
  - `blendMode`：设置混合模式（如叠加、变暗、滤色等）。  

  ```kotlin  
  override fun DrawScope.onDraw() {  
      // 绘制原图（无混合模式）  
      drawImage(  
          image = baseImage,  
          srcOffset = IntOffset.Zero,  
          srcSize = baseImage.size,  
          dstSize = size // 目标尺寸（由布局决定）  
      )  
      // 绘制叠加图（使用 Overlay 混合模式）  
      drawImage(  
          image = overlayImage,  
          blendMode = BlendMode.Overlay,  
          // 其他参数同上  
      )  
  }  
  ```  

### 2.3 重写 `intrinsicSize`  

- **作用**：定义 Painter 的固有尺寸，用于布局计算（如 `wrapContentSize`）。  
- **示例**：返回底层图像的尺寸。  

  ```kotlin  
  override val intrinsicSize: Size  
      get() = IntSize(baseImage.width, baseImage.height).toSize()  
  ```  

## 三、实战示例：叠加图像的自定义 Painter  

### 3.1 需求场景  

将两张图片叠加显示，底层为原图，上层为装饰图（如滤镜、水印），通过混合模式实现融合效果。  

### 3.2 代码实现  

```kotlin  
class OverlayImagePainter(  
    private val baseImage: ImageBitmap,  
    private val overlayImage: ImageBitmap,  
    private val offset: IntOffset = IntOffset.Zero  
) : Painter() {  
    // 计算固有尺寸（取底层图像尺寸）  
    override val intrinsicSize: Size  
        get() = IntSize(baseImage.width, baseImage.height).toSize()  

    // 核心绘制逻辑  
    override fun DrawScope.onDraw() {  
        // 绘制底层图像  
        drawImage(  
            image = baseImage,  
            srcOffset = offset,  
            srcSize = baseImage.size,  
            dstSize = size // 适应容器尺寸  
        )  
        // 绘制上层图像并设置混合模式  
        drawImage(  
            image = overlayImage,  
            srcOffset = offset,  
            srcSize = overlayImage.size,  
            dstSize = size,  
            blendMode = BlendMode.Overlay // 叠加混合模式  
        )  
    }  
}  
```  

### 3.3 使用方式  

```kotlin  
// 加载图片资源  
val dogImage = ImageBitmap.imageResource(R.drawable.dog)  
val rainbowOverlay = ImageBitmap.imageResource(R.drawable.rainbow)  

// 创建自定义 Painter（记忆化避免重复创建）  
val customPainter = remember {  
    OverlayImagePainter(baseImage = dogImage, overlayImage = rainbowOverlay)  
}  

// 在 Image 组件中使用  
Image(  
    painter = customPainter,  
    contentDescription = "叠加图像",  
    contentScale = ContentScale.Fit,  
    modifier = Modifier.size(300.dp)  
)  
```  

## 四、Painter vs DrawModifier  

| **特性**               | **Painter**                          | **DrawModifier**                   |  
|------------------------|--------------------------------------|------------------------------------|  
| **布局影响**           | 影响可组合项的测量和布局（通过 `intrinsicSize`） | 不影响布局，仅在指定边界内绘制       |  
| **适用场景**           | 需要动态计算尺寸或参与布局的复杂绘制   | 简单装饰性绘制（如背景、边框）       |  
| **性能**               | 较重（涉及布局逻辑）                  | 较轻（仅渲染层面）                  |  
| **典型用法**           | 自定义图标、动态图表、叠加图像        | 纯色背景、渐变、简单图形            |  

**选择建议**：  

- 需要控制组件大小时用 `Painter`。  
- 仅需装饰性绘制时用 `DrawModifier`（如 `Modifier.background()`、`Modifier.paint()`）。  

## 五、流程图  

```mermaid  
flowchart TD  
    A[创建自定义 Painter] --> B[继承 Painter 类]  
    B --> C[实现 onDraw 方法]  
    C --> D[调用 drawImage 绘制图形]  
    C --> E[设置混合模式（blendMode）]  
    B --> F[重写 intrinsicSize]  
    F --> G[返回固有尺寸（如底层图像大小）]  
    A --> H[在组件中使用]  
    H --> I[Image 组件：painter = 自定义 Painter]  
    H --> J[通用组件：Modifier.paint(自定义 Painter)]  
```  

## 六、关键注意事项  

### 6.1 内存管理  

- 避免在 `onDraw` 中执行耗时操作（如图片解码），应在构造函数或 `remember` 中预处理。  
- 使用 `ImageBitmap` 时，注意释放不再使用的资源（Compose 会自动管理记忆化对象的生命周期）。  

### 6.2 混合模式应用  

- 常见混合模式：`BlendMode.SrcIn`（源图像在目标区域内绘制）、`BlendMode.Overlay`（叠加）、`BlendMode.Darken`（变暗）。  
- 通过混合模式实现滤镜效果（如黑白、曝光、颜色叠加）。  

### 6.3 尺寸适配  

- `dstSize` 参数决定图像在容器中的渲染尺寸，需结合 `contentScale`（如 `Fit`、`Crop`）使用。  
- 若希望图片保持原始比例，可在 `onDraw` 中手动计算缩放比例。  

## 七、代码示例汇总  

| **场景**               | **核心代码**                                                                 |  
|------------------------|-----------------------------------------------------------------------------|  
| 基础自定义 Painter     | ```kotlin<br>class CustomPainter : Painter() {<br>    override fun onDraw(canvas: DrawScope) { ... }<br>    override val intrinsicSize: Size get() = ...<br>}<br>``` |  
| 图像叠加               | `drawImage(..., blendMode = BlendMode.Overlay)`                              |  
| 在 Box 中绘制背景      | `Box(modifier = Modifier.paint(customPainter))`                               |  
| 记忆化 Painter         | `val painter = remember { CustomPainter(...) }`                              |
