# DrawModifierNode

在 Android Compose 里，`DrawModifierNode` 是自定义绘制的核心机制，它能够让你在组件的绘制流程中插入自定义操作。下面为你详细解析 `DrawModifierNode` 的工作原理、使用方法以及相关注意事项。

## 基本概念

- **ModifierNode**：这是所有 Modifier 节点的基类，它定义了 Modifier 在布局和绘制流程中的行为。
- **DrawModifierNode**：作为 ModifierNode 的子类，它专门用于自定义绘制操作。
- **DrawScope**：这是一个提供了绘制 API（像 `drawRect`、`drawImage` 等）的作用域。

## DrawModifierNode 的生命周期

1. **创建阶段**：当组合发生时，`DrawModifierNode` 会被创建出来。
2. **更新阶段**：若 Modifier 的参数有变化，节点会进行更新。
3. **绘制阶段**：系统会调用 `DrawModifierNode` 的 `draw` 方法。
4. **销毁阶段**：当 Modifier 从组合中移除时，节点就会被销毁。

## 如何使用 DrawModifierNode

要创建自定义的绘制 Modifier，可按以下步骤操作：

### 1. 继承 DrawModifierNode

```kotlin
class CustomDrawModifierNode : DrawModifierNode, ModifierNode {
    override fun DrawScope.draw() {
        // 实现自定义绘制逻辑
        drawRect(Color.Red, size = size)
    }
}
```

### 2. 创建 Modifier 工厂

```kotlin
fun Modifier.customDraw() = this.then(
    object : Modifier.NodeFactory<CustomDrawModifierNode> {
        override fun create(): CustomDrawModifierNode = CustomDrawModifierNode()
        override fun update(node: CustomDrawModifierNode) = Unit
    }
)
```

### 3. 使用自定义 Modifier

```kotlin
Box(
    modifier = Modifier
        .size(200.dp)
        .customDraw()
)
```

## 高级用法示例

下面是一个更复杂的例子，展示了如何绘制带有边框的组件：

```kotlin
class BorderDrawModifier(
    private val borderWidth: Dp,
    private val borderColor: Color
) : Modifier.NodeFactory<BorderDrawModifier.Node>() {

    class Node(
        private val borderWidth: Dp,
        private val borderColor: Color
    ) : DrawModifierNode, ModifierNode {

        private val density = LocalDensity.current
        private val strokeWidthPx = with(density) { borderWidth.toPx() }

        override fun DrawScope.draw() {
            // 先绘制内容
            drawContent()
            
            // 再绘制边框
            val stroke = Stroke(width = strokeWidthPx)
            drawRect(
                color = borderColor,
                topLeft = Offset(strokeWidthPx / 2, strokeWidthPx / 2),
                size = Size(
                    width = size.width - strokeWidthPx,
                    height = size.height - strokeWidthPx
                ),
                style = stroke
            )
        }
    }

    override fun create(): Node = Node(borderWidth, borderColor)

    override fun update(node: Node) {
        // 更新节点参数
        node.borderWidth = borderWidth
        node.borderColor = borderColor
    }
}

// 扩展函数，方便使用
fun Modifier.border(width: Dp, color: Color) = this.then(BorderDrawModifier(width, color))
```

## DrawScope API 概览

DrawScope 提供了多种绘制方法，常见的有：

- `drawRect`：用于绘制矩形。
- `drawCircle`：用于绘制圆形。
- `drawLine`：用于绘制线条。
- `drawPath`：用于绘制自定义路径。
- `drawImage`：用于绘制图像。
- `drawText`：用于绘制文本（需要先创建 `TextMeasurer`）。

## 关键注意事项

1. **绘制顺序**：
   - `drawContent()` 会调用下层 Modifier 和内容的绘制。
   - 在 `drawContent()` 之前调用绘制方法，会在内容下方绘制。
   - 在 `drawContent()` 之后调用绘制方法，则会在内容上方绘制。

2. **性能方面**：
   - 尽量减少在 `draw` 方法中创建对象，因为该方法可能会被频繁调用。
   - 考虑使用 `clip` 或 `drawWithCache` 来提高性能。

3. **坐标系统**：
   - 坐标原点 `(0, 0)` 位于组件的左上角。
   - 可以通过 `size` 属性获取组件的尺寸。

## 与其他绘制方式的对比

| 方式 | 适用场景 | 性能 | 灵活性 |
|------|----------|------|--------|
| DrawModifierNode | 自定义绘制 | 高 | 高 |
| Canvas | 简单绘制 | 中 | 中 |
| drawWithContent | 装饰性绘制 | 中 | 中 |

## 总结

`DrawModifierNode` 是 Android Compose 里功能最强大的自定义绘制方式，它能让你完全掌控绘制流程。不过，由于它直接参与绘制循环，所以在使用时需要特别注意性能问题。建议在需要高性能或者复杂绘制效果的场景中使用 `DrawModifierNode`，而对于简单的装饰性绘制，可考虑使用 `drawWithContent`。
