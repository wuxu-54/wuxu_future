# 依据设计稿动态算出正确的尺寸（不推荐）

>依据设计稿的基准尺寸采用代码动态算出正确的dp。这种方式不好。入侵性太高，每次都要进行计算

## 一、采用设计稿是PX的方式

为了在不修改系统 Density 的前提下实现 Android Compose 的屏幕适配，可以创建一个工具类来根据设计稿的像素值动态计算实际显示的 dp 尺寸。这种方法通过对比当前设备和设计稿的尺寸比例来进行换算。

依据公式：dp = px * ratio(屏尺寸：设计稿px单位的尺寸) / denisty

```kotlin
import androidx.compose.runtime.Composable
import androidx.compose.ui.platform.LocalConfiguration
import androidx.compose.ui.platform.LocalDensity
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp

object ScreenAdaptation {
    // 设计稿的基准尺寸（单位：px）
    var designWidthPx: Float = 1080f
    var designHeightPx: Float = 1920f
    
    // 保存当前设备的屏幕尺寸信息
    private var currentWidthPx: Float = 0f
    private var currentHeightPx: Float = 0f
    private var density: Float = 0f
    
    // 初始化屏幕信息
    @Composable
    fun initScreenInfo() {
        val configuration = LocalConfiguration.current
        val density = LocalDensity.current
        
        currentWidthPx = with(density) { configuration.screenWidthDp.dp.toPx() }
        currentHeightPx = with(density) { configuration.screenHeightDp.dp.toPx() }
        this.density = density.density
    }
    
    // 根据设计稿的px值计算适配后的dp值（基于宽度比例）
    @Composable
    fun pxToDpWidth(px: Float): Dp {
        if (currentWidthPx == 0f) initScreenInfo()
        val ratio = currentWidthPx / designWidthPx
        return (px * ratio / density).dp
    }
    
    // 根据设计稿的px值计算适配后的dp值（基于高度比例）
    @Composable
    fun pxToDpHeight(px: Float): Dp {
        if (currentHeightPx == 0f) initScreenInfo()
        val ratio = currentHeightPx / designHeightPx
        return (px * ratio / density).dp
    }
    
    // 直接获取当前设备的宽度dp
    @Composable
    fun getScreenWidthDp(): Dp {
        if (currentWidthPx == 0f) initScreenInfo()
        return (currentWidthPx / density).dp
    }
    
    // 直接获取当前设备的高度dp
    @Composable
    fun getScreenHeightDp(): Dp {
        if (currentHeightPx == 0f) initScreenInfo()
        return (currentHeightPx / density).dp
    }
}

// 扩展函数，方便在Composable中使用
@Composable
fun Float.dpFromDesignWidth(): Dp = ScreenAdaptation.pxToDpWidth(this)

@Composable
fun Int.dpFromDesignWidth(): Dp = ScreenAdaptation.pxToDpWidth(this.toFloat())

@Composable
fun Float.dpFromDesignHeight(): Dp = ScreenAdaptation.pxToDpHeight(this)

@Composable
fun Int.dpFromDesignHeight(): Dp = ScreenAdaptation.pxToDpHeight(this.toFloat())    
```

### 注意事项

- 该方案在大多数情况下能够较好地适配不同屏幕，但在极端宽高比的设备上可能需要微调
- 字体大小建议使用 dpFromDesignWidth 以保持视觉一致性
- 对于有固定比例要求的元素，可以考虑同时使用宽度和高度比例进行计算
- 建议在应用初始化时设置一次设计稿尺寸，避免重复设置

---

## 二、采用设计稿是DP的方式（了解即可）

此方案太麻烦，一般设计稿基准宽度都给px单位的值，dp的得自己换算出来。而且可能有精度损失导致不准确。

依据DP的方式获取正确的dp值，依据公式：dp = 设计稿dp（px / 设计稿密度） * ratio(屏尺寸dp单位：设计稿dp单位的尺寸)

以下是具体方法：

### 1. **使用设计系统（Design System）**

将设计稿中的尺寸、颜色、字体等定义为 Kotlin 对象，确保全局一致性：

```kotlin
object DesignSystem {
    // 设计稿基准尺寸（如 iPhone 6/7/8 为 375x667pt）
    const val BASE_WIDTH = 375f
    const val BASE_HEIGHT = 667f

    // 尺寸映射函数（根据设计稿 px 值计算 dp）
    fun dp(value: Int): Dp = (value / 160f).dp  // 假设设计稿是基于 mdpi (160dpi)
}

// 使用示例
Box(modifier = Modifier.size(DesignSystem.dp(80)))
```

### 2. **统一密度基准**

设计稿通常基于特定设备（如 iPhone 或 Android 某机型），需要将设计尺寸转换为 Android 的 dp：

公式：

```txt
dp = px / (设计稿dpi / 160)
```

 (设计稿dpi / 160) 是获取Denisty

例如：

- 设计稿为 375pt（iPhone 6/7/8），对应 Android dp 为 `375dp`
- 设计稿中 20px 的元素，在 Android 中为 `20 / (320 / 160) = 10dp`

### 3. **自定义尺寸映射**

>屏幕适配应该按最小宽度来算，如：手机的宽最小，电视的高最小。

公式：算出真实与设计稿间的比例（屏宽/设计稿宽  注：dp单位）* px转换为设计稿的Dp值（设计稿px/设计稿密度） = 真正的dp

创建工具类将设计稿的 px 值映射到 Android 的 dp：

```kotlin
object DesignUtils {
    /**
     * 仅用于特殊元素的精确比例适配
     * @param px 设计稿像素值（基于xhdpi）
     */
    @Composable
    fun pxToDp(px: Int): Dp {
        // 设计稿基准密度（xhdpi=320dpi）  这是假定设计稿的屏为 320dpi 密度屏
        val designDensity = 320f / 160f // =2.0  密度比值  这里可以看官方的说明，160dpi的屏，1px = 1dp
        
        // 转换为基准dp：设计稿px / 设计稿密度
        val baseDp = px / designDensity
        
        // 获取当前设备宽度比例
        val screenWidthDp = LocalConfiguration.current.screenWidthDp
        val widthRatio = screenWidthDp / 360f // 360=设计稿基准宽度，单位dp  假定宽度为360f
        
        return (baseDp * widthRatio).dp
    }
}

// 使用示例
Button(
    modifier = Modifier.size(DesignUtils.pxToDp(240)) // 设计稿标注240px
)
```

| 设备规格         | 屏幕宽度(px) | 系统density | 逻辑宽度(dp) | 设计稿元素100px → 实际dp |
|------------------|--------------|-------------|--------------|--------------------------|
| 基准设备 (360dp) | 1080px       | 3.0         | 360dp        | 50dp (100px/2)           |
| 窄屏设备         | 900px        | 2.5         | 360dp        | 50dp (比例1:1)           |
| 宽屏设备         | 1440px       | 3.5         | 411dp        | 57dp (411/360≈1.14)      |

### 4. **字体大小适配**

使用 `sp` 单位并结合缩放因子：

```kotlin
// 设计稿字体大小（如 16px）
val textSize = 16.sp

// 或根据设计稿映射
val textSize = 16.fromDesignWidth().sp
```

### 5. **处理不同屏幕密度**

通过 `LocalDensity` 动态调整尺寸：

```kotlin
@Composable
fun DesignSize(value: Int): Dp {
    val density = LocalDensity.current
    return with(density) { (value / density).dp }
}
```

### 6. **使用预览验证**

设置预览设备与设计稿一致：

```kotlin
@Preview(
    name = "Design Spec",
    widthDp = 375, // 设计稿宽度
    heightDp = 667, // 设计稿高度
    apiLevel = 33
)
@Composable
fun PreviewDesignMatch() {
    MyAppTheme {
        MyScreen()
    }
}
```

### 7. **处理特殊场景**

- **刘海屏/挖孔屏**：使用 `WindowInsets` 避开安全区域
- **折叠屏**：通过 `Activity#onMultiWindowModeChanged` 监听窗口变化
- **横屏**：使用 `Orientation` 或 `WindowSizeClass` 调整布局

```kotlin
@Composable
fun SafeContent() {
    val insets = WindowInsets.systemBars.asPaddingValues()
    Box(modifier = Modifier.padding(insets)) {
        // 内容
    }
}
```

### 8. **与设计师协作**

- 要求设计师提供基于标准设备的设计稿（如 iPhone 6/7/8 或 360x640dp 的 Android 设备）
- 使用 Figma 等工具的测量功能直接获取 dp 值
- 建立设计系统文档，统一尺寸命名（如 `spacingSmall = 8dp`）

### 9. **避免常见问题**

- **不要直接使用 px**：Android 中 px 会导致不同设备显示差异
- **慎用硬编码尺寸**：使用常量或函数统一管理
- **测试多种设备**：通过 Android Studio 的 Device Manager 预览不同屏幕

### 示例代码

假设设计稿为 375x667pt，实现一个与设计稿完全匹配的登录按钮：

```kotlin
@Composable
fun LoginButton() {
    Button(
        onClick = {},
        modifier = Modifier
            .width(300.fromDesignWidth()) // 设计稿中 300pt 宽
            .height(48.fromDesignHeight()) // 设计稿中 48pt 高
            .padding(top = 24.fromDesignHeight()),
        shape = RoundedCornerShape(8.fromDesignWidth())
    ) {
        Text(
            text = "登录",
            fontSize = 16.fromDesignWidth().sp,
            fontWeight = FontWeight.Medium
        )
    }
}
```
