# Modifier.Node

在 Android Compose 中，`Modifier.Node` 是实现自定义修饰符行为的核心抽象类，它允许你精确控制组件的测量、布局和绘制过程。以下是对 `Modifier.Node` 的详细解析：

## **1. 基本概念**

`Modifier.Node` 是所有修饰符节点的基类，它定义了修饰符在组件生命周期中的行为：

- **测量阶段**：控制组件的尺寸计算。
- **布局阶段**：控制组件的位置和大小。
- **绘制阶段**：控制组件的绘制内容。

通过继承 `Modifier.Node`，你可以创建自定义修饰符，实现复杂的交互效果或优化性能。

## **2. 核心方法与属性**

### **关键方法**

- **`measure`**：
  自定义组件的测量逻辑，决定组件的大小。

  ```kotlin
  override fun MeasureScope.measure(
      measurables: List<Measurable>,
      constraints: Constraints
  ): MeasureResult {
      // 自定义测量逻辑
      val placeable = measurables.first().measure(constraints)
      return layout(placeable.width, placeable.height) {
          placeable.placeRelative(0, 0)
      }
  }
  ```

- **`draw`**：
  自定义组件的绘制内容，可在内容前后添加效果。

  ```kotlin
  override fun DrawScope.draw() {
      // 在内容下方绘制背景
      drawRect(Color.Red)
      drawContent() // 绘制原始内容
      // 在内容上方绘制装饰
      drawCircle(Color.Blue, radius = 10f)
  }
  ```

- **`onGloballyPositioned`**：
  组件布局完成后回调，可获取组件在屏幕中的位置。

  ```kotlin
  override fun onGloballyPositioned(positionProvider: () -> IntOffset) {
      val position = positionProvider()
      // 使用组件的全局位置
  }
  ```

### **关键属性**

- **`layoutDirection`**：
  当前布局方向（LTR 或 RTL）。
- **`density`**：
  当前设备的密度，用于单位转换。
- **`fontScale`**：
  字体缩放比例，影响文本大小。

## **3. 自定义 Modifier.Node 的步骤**

### **步骤 1：创建 Node 类**

继承 `Modifier.Node` 并实现所需的接口（如 `MeasureModifier`、`DrawModifier`）：

```kotlin
class CustomNode : Modifier.Node(), MeasureModifier, DrawModifier {
    // 实现测量和绘制方法
    override fun MeasureScope.measure(
        measurables: List<Measurable>,
        constraints: Constraints
    ): MeasureResult { /* ... */ }

    override fun DrawScope.draw() { /* ... */ }
}
```

### **步骤 2：创建 Modifier 工厂**

通过 `Modifier.NodeFactory` 创建修饰符：

```kotlin
fun Modifier.customModifier() = this.then(
    object : Modifier.NodeFactory<CustomNode> {
        override fun create() = CustomNode()
        override fun update(node: CustomNode) = Unit
    }
)
```

### **步骤 3：使用自定义修饰符**

```kotlin
Box(
    modifier = Modifier
        .size(100.dp)
        .customModifier()
)
```

## **4. 常见接口与用途**

### **测量相关接口**

- **`MeasureModifier`**：
  自定义测量逻辑，控制组件尺寸。
- **`LayoutModifier`**：
  调整子组件的位置和大小。

### **绘制相关接口**

- **`DrawModifier`**：
  自定义绘制内容。
- **`GraphicsLayerModifier`**：
  修改组件的图形层属性（如旋转、缩放、阴影等）。

### **交互相关接口**

- **`PointerInputModifier`**：
  处理触摸事件。
- **`FocusModifier`**：
  控制焦点行为。

## **5. 高级用法示例**

### **示例 1：自定义测量与绘制**

```kotlin
class SizeReportingNode(
    private val onSizeChanged: (IntSize) -> Unit
) : Modifier.Node(), MeasureModifier {

    override fun MeasureScope.measure(
        measurables: List<Measurable>,
        constraints: Constraints
    ): MeasureResult {
        val placeable = measurables.first().measure(constraints)
        val size = IntSize(placeable.width, placeable.height)
        onSizeChanged(size) // 报告尺寸变化
        return layout(placeable.width, placeable.height) {
            placeable.placeRelative(0, 0)
        }
    }
}

// 使用方法
fun Modifier.onSizeChanged(onSizeChanged: (IntSize) -> Unit) = this.then(
    object : Modifier.NodeFactory<SizeReportingNode> {
        override fun create() = SizeReportingNode(onSizeChanged)
        override fun update(node: SizeReportingNode) {
            node.onSizeChanged = onSizeChanged
        }
    }
)
```

### **示例 2：自定义绘制边框**

```kotlin
class BorderNode(
    private val width: Dp,
    private val color: Color
) : Modifier.Node(), DrawModifier {

    override fun DrawScope.draw() {
        drawContent() // 绘制原始内容
        val strokeWidth = width.toPx()
        drawRect(
            color = color,
            style = Stroke(width = strokeWidth)
        )
    }
}

// 使用方法
fun Modifier.border(width: Dp, color: Color) = this.then(
    object : Modifier.NodeFactory<BorderNode> {
        override fun create() = BorderNode(width, color)
        override fun update(node: BorderNode) {
            node.width = width
            node.color = color
        }
    }
)
```

## **6. 性能优化建议**

1. **避免在测量/绘制中创建对象**：
   - 测量和绘制方法可能被频繁调用，应复用对象（如 Paint、Path）。

2. **使用 `Modifier.drawWithCache`**：
   - 对于静态绘制内容，可缓存绘制操作以提高性能。

3. **延迟计算**：
   - 使用 `LaunchedEffect` 或 `onGloballyPositioned` 进行一次性计算。

## **7. 与其他 Modifier 的对比**

| 类型               | 适用场景                          | 性能      |
|--------------------|-----------------------------------|-----------|
| `Modifier.Node`    | 复杂测量、布局或绘制逻辑          | 高        |
| `Modifier.composed`| 组合现有修饰符或添加状态          | 中        |
| 内置修饰符          | 简单场景（如 padding、background）| 最高      |

## **总结**

`Modifier.Node` 是 Android Compose 中最底层的自定义修饰符方式，适用于需要精确控制组件测量、布局和绘制的场景。通过实现不同的接口（如 `MeasureModifier`、`DrawModifier`），你可以创建高度定制化的交互效果和视觉表现。不过，由于其直接影响组件生命周期，使用时需注意性能优化。
