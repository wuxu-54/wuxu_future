
# Jetpack Compose 性能

原地址：<https://developer.android.google.cn/develop/ui/compose/performance?hl=zh-cn>

## 一、主要概念

### 1. 阶段

- **组合阶段**：构建可组合项树，生成界面描述。此阶段若频繁重组会影响性能，需优化状态依赖。
- **布局阶段**：确定界面元素的位置和尺寸。合理使用布局策略（如延迟布局）可减少计算开销。
- **绘制阶段**：将界面元素渲染到屏幕。避免复杂绘制操作，减少过度绘制。

### 2. 基准配置文件

- **作用**：预编译关键用户流程的代码，加快应用启动速度，实现更顺畅的用户互动。
- **配置**：Compose 包含默认配置文件，建议创建应用专用配置文件以针对性优化。

### 3. 稳定性

- **目标**：通过确保状态和可组合项的稳定性，高效跳过不必要的重组，提升性能。
- **方法**：使用稳定的参数（如不可变数据结构）、避免在可组合项中创建可变状态等。

## 二、正确配置您的应用

### 1. 使用 R8 在发布模式下构建

- **原因**：调试模式存在性能成本，可能掩盖真实性能问题。发布模式启用 R8 编译器的优化和缩减功能，可生成更高效的代码。
- **操作**：确保在发布构建时启用 R8，减少代码冗余，优化应用性能。

### 2. 使用基准配置文件

- **优势**：通过预编译关键代码，降低运行时编译开销，提升应用启动和交互流畅度。
- **建议**：结合默认配置文件与自定义配置文件，针对应用特定场景进行优化。

## 三、工具

- **作用**：用于衡量和分析 Compose 应用的性能，定位性能瓶颈。
- **要点**：熟悉官方推荐的性能分析工具（如 Android Profiler 等），掌握其使用方法以监控各阶段性能表现。

## 四、最佳实践

### 1. 避免开销高的计算

- **方法**：使用 `remember` 缓存开销大的计算结果，避免重复计算。
- **示例**：复杂数据转换、网络请求结果等可通过 `remember` 缓存，减少重组时的计算量。

### 2. 帮助延迟布局

- **方法**：为延迟布局的可组合项提供稳定的 `key` 参数。
- **作用**：确保布局系统能正确识别元素，最大限度减少不必要的重组和布局计算。

### 3. 限制不必要的重组

- **方法**：在状态快速变化时，使用 `derivedStateOf` 对状态进行转换，将多个状态变化合并为一个稳定的状态。
- **优势**：避免因细粒度状态变化导致的频繁重组，提升界面更新效率。

### 4. 推迟状态读取

- **方法**：将状态读取封装在 lambda 函数中，尽可能延后读取状态。
- **原理**：减少组合阶段对状态的依赖，避免因无关状态变化触发不必要的重组。

### 5. 使用 lambda 修饰符更改状态

- **场景**：对于经常更改的状态变量（如动画中的偏移量），使用基于 lambda 的修饰符（如 `Modifier.offset { ... }`）。
- **好处**：确保每次重组时获取最新的状态值，避免缓存过时数据，同时保持代码简洁。

### 6. 避免向后写入

- **规则**：切勿向可组合项中已读取的状态写入数据，防止引发不可预测的重组和状态不一致问题。
- **示例**：在可组合项中读取状态后，若需修改该状态，应通过外部回调或状态更新函数进行，避免直接修改。

## 五、次观看

- **提示**：若项目中仍在使用 View 而非 Compose，可参阅专门的改进布局性能指南，针对 View 系统进行性能优化。

```mermaid
graph LR
A[Jetpack Compose 性能优化] --> B[主要概念]
A --> C[正确配置应用]
A --> D[工具]
A --> E[最佳实践]
B --> B1(阶段: 组合、布局、绘制)
B --> B2(基准配置文件: 预编译关键代码)
B --> B3(稳定性: 减少不必要重组)
C --> C1(发布模式+R8编译)
C --> C2(使用基准配置文件)
E --> E1[避免高开销计算(remember)]
E --> E2[延迟布局(key参数)]
E --> E3[限制重组(derivedStateOf)]
E --> E4[推迟状态读取(lambda封装)]
E --> E5[lambda修饰符改状态]
E --> E6[禁止向后写入]
```
