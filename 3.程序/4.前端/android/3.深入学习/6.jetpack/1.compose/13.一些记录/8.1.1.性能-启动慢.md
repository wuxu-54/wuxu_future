# å¯åŠ¨æ…¢

Jetpack Compose çš„ Activity å¯åŠ¨ç¼“æ…¢é€šå¸¸ç”±é…ç½®é”™è¯¯ã€èµ„æºè´Ÿè½½è¿‡é‡æˆ–è®¾è®¡ç¼ºé™·å¯¼è‡´ã€‚ä»¥ä¸‹ä»æ ¸å¿ƒåŸå› åˆ°ä¼˜åŒ–æ–¹æ¡ˆè¿›è¡Œç³»ç»Ÿåˆ†æï¼Œå¹¶æä¾›å…·ä½“è§£å†³ç­–ç•¥ï¼š

---

## âš™ï¸ **ä¸€ã€é…ç½®é—®é¢˜å¯¼è‡´å¯åŠ¨ç¼“æ…¢**

1. **æœªå¯ç”¨ R8 ä¼˜åŒ–ï¼ˆå‘å¸ƒæ¨¡å¼ï¼‰**  
   - **é—®é¢˜**ï¼šè°ƒè¯•æ¨¡å¼ç¦ç”¨ä»£ç ä¼˜åŒ–ä¸èµ„æºå‹ç¼©ï¼Œæ˜¾è‘—é™ä½å¯åŠ¨é€Ÿåº¦ã€‚  
   - **è§£å†³**ï¼šåœ¨ `build.gradle` ä¸­å¯ç”¨å‘å¸ƒæ¨¡å¼é…ç½®ï¼š  

     ```kotlin
     buildTypes {
         release {
             isMinifyEnabled = true   // å¯ç”¨ R8 ä»£ç ç¼©å‡
             isShrinkResources = true // ç§»é™¤æœªç”¨èµ„æº
             proguardFiles(getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro")
         }
     }
     ```

2. **ç¼ºå¤± Baseline Profile**  
   - **é—®é¢˜**ï¼šCompose åº“éœ€ JIT ç¼–è¯‘ï¼Œé¦–æ¬¡åŠ è½½è€—æ—¶ã€‚  
   - **è§£å†³**ï¼š  
     - ä½¿ç”¨é»˜è®¤ Baseline Profileï¼ˆCompose 1.6+ è‡ªå¸¦ï¼Œæ— éœ€é…ç½®ï¼‰ã€‚  
     - è‡ªå®šä¹‰ Profile é€šè¿‡ [Macrobenchmark æµ‹è¯•éªŒè¯](https://developer.android.com/topic/performance/benchmarking/macrobenchmark-overview)ï¼Œå¯æå‡å¯åŠ¨é€Ÿåº¦ 20%~30%ã€‚

---

## ğŸ–¼ï¸ **äºŒã€UI è®¾è®¡ä¸æ¸²æŸ“ç“¶é¢ˆ**

1. **è¿‡åº¦å¤æ‚çš„å¸ƒå±€æˆ–åŠ¨ç”»**  
   - **é—®é¢˜**ï¼š  
     - æ·±åº¦åµŒå¥—å¸ƒå±€ï¼ˆå¦‚å¤šå±‚ `Column/Row`ï¼‰å¢åŠ æµ‹é‡æ—¶é—´ã€‚  
     - æ— é™å¾ªç¯åŠ¨ç”»ï¼ˆå¦‚ `LaunchedEffect` å¾ªç¯ï¼‰æŒç»­æ¶ˆè€—ä¸»çº¿ç¨‹èµ„æºã€‚  
   - **è§£å†³**ï¼š  
     - ç”¨ `ConstraintLayout` æ›¿ä»£åµŒå¥—å¸ƒå±€ï¼Œå‡å°‘å±‚çº§ï¼š  

       ```kotlin
       ConstraintLayout {
           val (text, button) = createRefs()
           Text(..., Modifier.constrainAs(text) { ... })
           Button(..., Modifier.constrainAs(button) { ... })
       }
       ```  

     - é™åˆ¶åŠ¨ç”»æ‰§è¡Œæ¡ä»¶ï¼ˆä¾‹å¦‚ä»…å½“ç•Œé¢å¯è§æ—¶å¯åŠ¨ï¼‰ï¼š  

       ```kotlin
       DisposableEffect(Unit) {
           onDispose { animation.stop() } // ç•Œé¢ä¸å¯è§æ—¶åœæ­¢åŠ¨ç”»
       }
       ```

2. **ä½æ•ˆçš„æ‡’åŠ è½½åˆ—è¡¨**  
   - **é—®é¢˜**ï¼š`LazyColumn`/`LazyRow` æœªè®¾ `key` å¯¼è‡´é¡¹ç§»åŠ¨æ—¶å…¨å±€é‡ç»„ã€‚  
   - **è§£å†³**ï¼šä¸ºé¡¹åˆ†æ´¾å”¯ä¸€é”®å€¼ä¼˜åŒ–å±€éƒ¨æ›´æ–°ï¼š  

     ```kotlin
     LazyColumn {
         items(items, key = { it.id }) { item -> 
             ItemView(item)
         }
     }
     ```

---

## â³ **ä¸‰ã€èµ„æºåˆå§‹åŒ–ç­–ç•¥ä¸å½“**

1. **ä¸»çº¿ç¨‹é˜»å¡æ“ä½œ**  
   - **é—®é¢˜**ï¼šåœ¨ `@Composable` ä¸­åŒæ­¥åŠ è½½å›¾ç‰‡ã€æ’åºå¤§å‹åˆ—è¡¨ç­‰æ“ä½œé˜»å¡ä¸»çº¿ç¨‹ã€‚  
   - **è§£å†³**ï¼š  
     - ä½¿ç”¨ `remember` ç¼“å­˜è€—æ—¶è®¡ç®—ç»“æœï¼š  

       ```kotlin
       val sortedList = remember(contacts) { contacts.sortedBy { it.name } }
       ```  

     - å°†æ•°æ®é¢„å¤„ç†ç§»è‡³ `ViewModel` æˆ–åå°åç¨‹ã€‚

2. **é›†ä¸­å¼åˆå§‹åŒ–ç»„ä»¶**  
   - **é—®é¢˜**ï¼šæ‰€æœ‰ä¾èµ–åœ¨ `onCreate` ä¸­åˆå§‹åŒ–ï¼Œå»¶é•¿å¯åŠ¨æ—¶é—´ã€‚  
   - **è§£å†³**ï¼šç”¨ **App Startup åº“** åˆ†æ­¥åˆå§‹åŒ–ï¼š  

     ```kotlin
     // å®šä¹‰åˆå§‹åŒ–å™¨
     class WorkManagerInitializer : Initializer<WorkManager> {
         override fun create(context: Context): WorkManager {
             WorkManager.initialize(context, Configuration.Builder().build())
             return WorkManager.getInstance(context)
         }
         override fun dependencies() = emptyList<Class<out Initializer<*>>>()
     }
     ```  

     ```xml
     <!-- AndroidManifest.xml -->
     <provider android:name="androidx.startup.InitializationProvider" ... >
         <meta-data android:name="com.example.WorkManagerInitializer" android:value="androidx.startup" />
     </provider>
     ```

---

## ğŸ”„ **å››ã€çŠ¶æ€ç®¡ç†å¼•å‘æ— æ•ˆé‡ç»„**

1. **é¢‘ç¹çŠ¶æ€æ›´æ–°è§¦å‘é‡ç»„**  
   - **é—®é¢˜**ï¼šå¦‚æ»šåŠ¨ç›‘å¬ä¸­ç›´æ¥è¯»å– `LazyListState.firstVisibleItemIndex`ï¼Œæ¯å¸§è§¦å‘é‡ç»„ã€‚  
   - **è§£å†³**ï¼šç”¨ `derivedStateOf` è¿‡æ»¤ä¸å¿…è¦æ›´æ–°ï¼š  

     ```kotlin
     val showButton by remember {
         derivedStateOf { listState.firstVisibleItemIndex > 0 }
     } // ä»…å½“æ¡ä»¶å˜åŒ–æ—¶é‡ç»„
     ```

2. **å‰¯ä½œç”¨æœªç»‘å®šç”Ÿå‘½å‘¨æœŸ**  
   - **é—®é¢˜**ï¼šåå°åç¨‹æœªåœ¨ç•Œé¢é”€æ¯æ—¶å–æ¶ˆï¼Œå¯¼è‡´èµ„æºæ³„æ¼ã€‚  
   - **è§£å†³**ï¼šä½¿ç”¨ `LaunchedEffect` + ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥æ§åˆ¶ï¼š  

     ```kotlin
     LaunchedEffect(viewModel.data) {
         viewModel.loadData() // è‡ªåŠ¨éšä½œç”¨åŸŸå–æ¶ˆ
     }
     ```

---

## ğŸ” **äº”ã€è¯Šæ–­å·¥å…·å®šä½ç“¶é¢ˆ**

1. **Android Studio Profiler**  
   - æ£€æµ‹ CPU/GPU å³°å€¼ã€å†…å­˜æ³„æ¼ã€‚
2. **é‡ç»„é«˜äº®å·¥å…·**  
   - å¯ç”¨ `Debug Composition` æ¨¡å¼ï¼Œè¯†åˆ«è¿‡åº¦é‡ç»„çš„ç»„ä»¶ã€‚
3. **å¤šè®¾å¤‡é¢„è§ˆæµ‹è¯•**  
   - éªŒè¯ä¸åŒå±å¹•å°ºå¯¸ä¸‹çš„è¡¨ç°ï¼š  

     ```kotlin
     @Preview(device = Devices.PHONE)
     @Preview(device = Devices.TABLET)
     @Composable fun PreviewMyScreen() { ... }
     ```

---

## ğŸ’ **ä¼˜åŒ–æ–¹æ¡ˆä¼˜å…ˆçº§å»ºè®®**

| **ä¼˜åŒ–æ–¹å‘**         | **æªæ–½**                     | **å½±å“èŒƒå›´** | **å®æ–½éš¾åº¦** |
|----------------------|------------------------------|--------------|--------------|
| æ„å»ºé…ç½®            | å¯ç”¨ R8 + å‘å¸ƒæ¨¡å¼           | å…¨å±€æ€§èƒ½     | ä½           |
| èµ„æºåˆå§‹åŒ–          | App Startup åˆ†æ­¥åŠ è½½         | å¯åŠ¨é€Ÿåº¦     | ä¸­           |
| å¸ƒå±€ç®€åŒ–            | å‡å°‘åµŒå¥— + ConstraintLayout  | æ¸²æŸ“æ•ˆç‡     | ä¸­           |
| çŠ¶æ€ç®¡ç†            | `derivedStateOf` + `key`     | é‡ç»„é¢‘ç‡     | ä¸­é«˜         |
| åŠ¨ç”»æ§åˆ¶            | ç»‘å®šç”Ÿå‘½å‘¨æœŸ + æ¡ä»¶è§¦å‘      | è¿è¡Œæ—¶æµç•…åº¦ | é«˜           |

> ğŸ’¡ **å…³é”®å®è·µ**ï¼šå¯åŠ¨è€—æ—¶æ“ä½œå¼‚æ­¥åŒ–ã€åˆ—è¡¨é¡¹å¿…é¡»è®¾ `key`ã€æ— é™åŠ¨ç”»æ·»åŠ æš‚åœé€»è¾‘ã€å¤æ‚è®¡ç®—ç§»å‡º Composableã€‚

---

## ğŸ’ **æ€»ç»“**

å¯åŠ¨ç¼“æ…¢çš„ä¸»å› æ˜¯ **é…ç½®ä¸å½“**ã€**UI è¿‡è½½** åŠ **åˆå§‹åŒ–é˜»å¡**ã€‚ä¼˜åŒ–æ ¸å¿ƒæ­¥éª¤ï¼š  
1ï¸âƒ£ **å¼ºåˆ¶å¯ç”¨å‘å¸ƒæ¨¡å¼+R8**ï¼›  
2ï¸âƒ£ **ç®€åŒ–å¸ƒå±€å±‚çº§** å¹¶ç§»é™¤ä½æ•ˆåŠ¨ç”»ï¼›  
3ï¸âƒ£ ä½¿ç”¨ **æ‡’åŠ è½½/åˆ†æ­¥åˆå§‹åŒ–** æ¨è¿Ÿéå…³é”®ä»»åŠ¡ï¼›  
4ï¸âƒ£ é€šè¿‡ **`derivedStateOf` ä¸ `key`** æŠ‘åˆ¶æ— æ•ˆé‡ç»„ï¼›  
5ï¸âƒ£ ä½¿ç”¨ **Profiler å®šä½å…·ä½“ç“¶é¢ˆ**ã€‚  

å‡çº§è‡³ Compose 1.6+ å¯é¢å¤–è· 20% æ»šåŠ¨æ€§èƒ½æå‡åŠ 12% å¯åŠ¨åŠ é€Ÿã€‚è‹¥é—®é¢˜ä»åœ¨ï¼Œè¯·æä¾› `onCreate` ä»£ç æ®µè¿›ä¸€æ­¥åˆ†æä¼˜åŒ–ç‚¹ã€‚
