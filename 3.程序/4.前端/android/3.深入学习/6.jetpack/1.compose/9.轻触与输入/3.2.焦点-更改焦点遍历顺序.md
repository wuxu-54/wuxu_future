
# 更改焦点遍历顺序

原地址：<https://developer.android.google.cn/develop/ui/compose/touch-input/focus/change-focus-traversal-order?hl=zh-cn>

## 一、核心场景与目标

在Jetpack Compose中，默认焦点遍历顺序基于组件声明顺序（一维Tab键/二维箭头键）。但在复杂布局或特殊交互需求下，需手动修改焦点移动逻辑，实现以下目标：

- **自定义一维导航路径**（如Tab键跳转顺序与声明顺序不一致）。
- **精细控制二维导航方向**（如箭头键移动时指定特定目标组件）。

## 二、一维导航（Tab键）遍历顺序修改

### 1. 关键类与修饰符

- **`FocusRequester`**：创建焦点引用，关联可组合项。
- **`focusRequester`修饰符**：将焦点引用绑定到组件。
- **`focusProperties`修饰符**：配置焦点遍历规则，通过`next`属性指定下一个焦点目标。

### 2. 实现步骤

#### 步骤1：创建焦点引用

```kotlin
// 声明多个FocusRequester引用，对应每个可聚焦组件
val (first, second, third, fourth) = remember { FocusRequester.createRefs() }
```

#### 步骤2：绑定引用到组件

```kotlin
Column {
    Row {
        // 第一个组件绑定first引用
        TextButton(
            onClick = {},
            modifier = Modifier.focusRequester(first)
        ) { Text("First field") }
        
        // 第三个组件绑定third引用
        TextButton(
            onClick = {},
            modifier = Modifier.focusRequester(third)
        ) { Text("Third field") }
    }
    Row {
        // 第二个组件绑定second引用
        TextButton(
            onClick = {},
            modifier = Modifier.focusRequester(second)
        ) { Text("Second field") }
        
        // 第四个组件绑定fourth引用
        TextButton(
            onClick = {},
            modifier = Modifier.focusRequester(fourth)
        ) { Text("Fourth field") }
    }
}
```

#### 步骤3：配置自定义遍历顺序

```kotlin
Column {
    Row {
        // First的下一个焦点设为Second
        TextButton(
            onClick = {},
            modifier = Modifier
                .focusRequester(first)
                .focusProperties { next = second }
        ) { Text("First field") }
        
        // Third的下一个焦点设为Fourth
        TextButton(
            onClick = {},
            modifier = Modifier
                .focusRequester(third)
                .focusProperties { next = fourth }
        ) { Text("Third field") }
    }
    Row {
        // Second的下一个焦点设为Third
        TextButton(
            onClick = {},
            modifier = Modifier
                .focusRequester(second)
                .focusProperties { next = third }
        ) { Text("Second field") }
        
        // Fourth的下一个焦点设为First（形成循环）
        TextButton(
            onClick = {},
            modifier = Modifier
                .focusRequester(fourth)
                .focusProperties { next = first }
        ) { Text("Fourth field") }
    }
}
```

- **效果**：Tab键遍历顺序为 **First → Second → Third → Fourth → First**（打破声明顺序）。

## 三、二维导航（箭头键）遍历顺序修改

### 1. 关键属性

通过`focusProperties`修饰符指定箭头键方向对应的焦点目标：

- `up`：向上箭头键目标
- `down`：向下箭头键目标
- `left`：向左箭头键目标
- `right`：向右箭头键目标

### 2. 代码示例：指定多方向导航

```kotlin
TextButton(
    onClick = {},
    modifier = Modifier
        .focusRequester(fourth) // 绑定第四个组件的引用
        .focusProperties {
            // 向下箭头键指向第三个组件
            down = third
            // 向右箭头键指向第二个组件
            right = second
        }
) { Text("Fourth field") }
```

- **场景**：当焦点在第四个组件时：
  - 按↓键→焦点移动到第三个组件（`down = third`）。
  - 按→键→焦点移动到第二个组件（`right = second`）。

## 四、流程图：焦点遍历顺序修改流程

```mermaid
graph LR
A[需求分析] --> B{导航类型}
B -->|一维（Tab键）| C[创建FocusRequester引用]
B -->|二维（箭头键）| D[直接配置方向属性]
C --> E[绑定modifier.focusRequester]
E --> F[通过focusProperties.next指定顺序]
D --> G[通过focusProperties.{up/down/left/right}指定目标]
```

## 五、适用场景与最佳实践

1. **复杂嵌套布局**：如网格状布局中，需跳过某些组件或自定义跨行列跳转。
2. **无障碍优化**：为屏幕阅读器或键盘用户提供更符合逻辑的导航路径。
3. **游戏或特殊交互**：使用控制器方向键时，按需定制焦点移动逻辑（如对角线导航）。

## 六、注意事项

- **引用必须唯一**：每个可聚焦组件需绑定独立的`FocusRequester`引用。
- **循环引用需谨慎**：避免设置`next`形成无限循环（如A→B→A），可能导致焦点卡死。
- **二维方向全覆盖**：若未指定某个方向（如`left`），则沿用默认遍历逻辑（如向左返回上一个同级组件）。
