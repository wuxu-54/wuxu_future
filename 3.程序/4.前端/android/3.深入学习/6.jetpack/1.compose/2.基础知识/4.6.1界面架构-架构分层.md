# 架构分层

Jetpack Compose由**Material、Foundation、UI、Runtime**等主要层构成，各层基于下层逐级构建。其设计遵循提供可组合的小块功能原则，开发者可根据需求选择合适抽象级别组件，通过“降级”使用低级组件获取更多控制权和自定义能力，但需注意避免功能降级，同时应优先基于能满足需求的最高级组件构建以利用最佳实践

---

## 思维导图

```mindmap
## **Jetpack Compose架构层**
- Material：实现Material Design系统，含主题、样式组件等
- Foundation：提供与设计系统无关构建块，如布局、手势识别
- UI：由多个模块组成，实现界面基本组件，如布局、输入处理
- Runtime：提供Compose运行时基本组件，如remember、mutableStateOf
## **设计原则**
- 控制：高级组件操作多但控制权少，可“降级”用低级API获取更多控制
- 自定义：组件由小构建块组合，方便自定义，可“降级”构建分支组件
- 选择抽象级别：优先基于能满足需求的最高级组件构建，融入最佳实践
```

---

## 详细总结

1. **架构层构成**
Jetpack Compose由多个架构层组成，各层相互协作构建完整功能。
    - **Runtime层**：提供Compose运行时的基本组件，像`remember`、`mutableStateOf`、`@Composable`注释和`SideEffect`。若仅需Compose的树管理功能，可基于此层构建。
    - **UI层**：由`ui - text`、`ui - graphics`和`ui - tooling`等多个模块构成，实现了界面工具包的基本组件，比如`LayoutNode`、`Modifier`、输入处理程序、自定义布局和绘图等。若只需使用界面工具包基本概念，可考虑基于该层构建。
    - **Foundation层**：为Compose界面提供与设计系统无关的构建块，像`Row`、`Column`、`LazyColumn`和特定手势识别等。开发者可基于此层构建自己的设计系统。
    - **Material层**：为Compose界面提供Material Design系统的实现，包括主题系统、样式化组件、涟漪效果指示元素和图标。当应用使用Material Design时，可基于此层构建。
2. **设计原则**
    - **控制**：高级组件功能多但直接控制权少，开发者可“降级”使用低级组件获取更多控制权。例如，为组件颜色添加动画，`animateColorAsState` API无法满足组件始终从灰色开始的需求，可改用低级的`Animatable` API ，尽管过程更复杂，但能实现更精细控制。
    - **自定义**：通过组合小构建块成高级组件，降低了自定义难度。以Material层的`Button`为例，它由`Surface`、`CompositionLocalProvider`、`ProvideTextStyle`、`Row` 4个组件组合而成，约40行代码。若要在组件参数外自定义，如为按钮设置渐变背景（Material Design规定按钮为纯色背景），可“降级”构建分支组件，如`GradientButton` 。若不想使用Material概念，可仅用Foundation层组件构建，如`BespokeButton` 。
    - **选择合适的抽象化级别**：Compose旨在构建可复用分层组件，开发者不应总着眼于构建低级构建块。许多高级组件功能更丰富，融入了最佳实践，如支持无障碍功能。例如，为自定义组件添加手势支持，除了使用`Modifier.pointerInput`从头构建，还可选用`Modifier.draggable`、`Modifier.scrollable`或`Modifier.swipeable`等更高级组件作为起点 。一般优先基于能满足需求的最高级组件构建。

|设计原则|描述|示例|注意事项|
|---|---|---|---|
|控制|高级组件控制权少，可“降级”使用低级组件获取更多控制|`animateColorAsState`与`Animatable` API对比|选择符合需求的抽象化级别|
|自定义|组件由小构建块组合，方便自定义，可“降级”构建分支组件|`Button`及其自定义组件`GradientButton`、`BespokeButton`|“降级”自定义时确保功能不降级，创建分支不会受益于上游更新|
|选择合适的抽象化级别|优先基于能满足需求的最高级组件构建，融入最佳实践|为自定义组件添加手势支持时选择合适组件|避免过度构建低级构建块|

---

## 关键问题

1. **Jetpack Compose中不同架构层的主要作用分别是什么？**
    - Runtime层提供Compose运行时基本组件；UI层实现界面工具包基本组件；Foundation层提供与设计系统无关的构建块；Material层实现Material Design系统并提供相关组件和主题系统。
2. **在Jetpack Compose中，“降级”使用低级组件进行自定义有哪些优缺点？**
    - 优点是能获取更多控制权，实现更个性化的功能，如为按钮设置渐变背景。缺点是过程更复杂，且创建分支组件后无法从上游组件的未来增补项或bug修复中受益，同时需注意避免因自定义导致功能降级，如忽视无障碍功能支持。
3. **为什么在Jetpack Compose中建议优先基于能满足需求的最高级组件构建？**
    - 因为许多高级组件不仅能提供更多功能，还融入了最佳实践，例如支持无障碍功能等。使用这些高级组件作为构建起点，能让开发更高效，同时保证应用的质量和用户体验。
