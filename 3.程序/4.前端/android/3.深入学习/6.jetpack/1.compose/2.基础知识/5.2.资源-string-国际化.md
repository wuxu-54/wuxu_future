# 国际化

在 Android Jetpack Compose 中实现国际化（i18n）主要涉及多语言字符串资源管理、布局适配和动态语言切换。以下是关键实现步骤和最佳实践：

---

## 一、基础实现：资源国际化

1. **创建多语言资源目录**  
   在 `res` 目录下为每种语言创建对应的 `values-xx` 文件夹，例如：
   - 英语（美国）：`values-en-rUS/strings.xml`
   - 简体中文：`values-zh-rCN/strings.xml`  

2. **定义字符串资源**  
   在每个目录的 `strings.xml` 中定义相同键名的字符串，例如：  

   ```xml
   <!-- values-en-rUS/strings.xml -->
   <string name="welcome">Welcome!</string>
   
   <!-- values-zh-rCN/strings.xml -->
   <string name="welcome">欢迎！</string>
   ```

3. **图片资源国际化**  
   同样按语言创建 `drawable-xx` 目录，放置本地化图片（如文化特定的图标）。

---

## 二、Compose 中使用国际化字符串

通过 `stringResource()` 动态获取当前语言环境的字符串：  

```kotlin
@Composable
fun Greeting() {
    Text(text = stringResource(R.string.welcome))
}
```

系统会根据设备语言自动选择对应资源。

---

## 三、动态切换语言（无需重启）

1. **自定义 Locale 控制**  
   使用 `LocalConfiguration` 和 `LocalContext` 覆盖系统语言设置：

   ```kotlin
   @Composable
   fun SetAppLocale(locale: Locale) {
       val context = LocalContext.current
       val configuration = LocalConfiguration.current
       configuration.setLocale(locale)
       context.resources.updateConfiguration(configuration, context.resources.displayMetrics)
   }
   ```

2. **结合状态管理**  
   将语言选择存储在 `ViewModel` 或 `DataStore` 中，触发重组更新界面：  

   ```kotlin
   val selectedLocale = remember { mutableStateOf(Locale.ENGLISH) }
   
   LaunchedEffect(selectedLocale.value) {
       SetAppLocale(selectedLocale.value)
   }
   ```

---

## 四、高级场景适配

1. **布局方向（RTL/LTR）**  
   针对阿拉伯语等从右向左（RTL）的语言，使用 `CompositionLocalProvider` 控制布局方向：  

   ```kotlin
   CompositionLocalProvider(
       LocalLayoutDirection provides if (isRTL) LayoutDirection.Rtl else LayoutDirection.Ltr
   ) {
       MyScreen() // 内部组件自动适配RTL
   }
   ```

2. **动态内容拼接**  
   避免硬编码拼接字符串，使用占位符：  

   ```xml
   <string name="unread_count">%d unread messages</string>
   ```

   ```kotlin
   stringResource(R.string.unread_count, messageCount)
   ```

3. **自定义形状与布局**  
   某些语言可能导致文本长度变化（如德语较长）。解决方案：
   - 使用 `Modifier.wrapContentSize()` 避免布局溢出。
   - 为聊天气泡等自定义组件设计弹性布局（参考中可拉伸的气泡形状实现）。

---

## 五、最佳实践

1. **分离逻辑与资源**  
   将所有文本、图片资源放在资源文件中，**禁止**在代码中硬编码字符串。

2. **覆盖全部区域变体**  
   区分区域变体（如英文分 `en-US` 和 `en-GB`），避免文化差异问题。

3. **测试工具**  
   使用 Android Studio 的 **Layout Inspector** 或第三方库（如 `Lokalise`）快速验证多语言布局。

---

## 六、常见问题解决

| 问题场景                  | 解决方案                                                                 |
|---------------------------|--------------------------------------------------------------------------|
| 切换语言后界面未更新      | 确保使用 `remember` 保存语言状态，并触发重组（如通过 `LaunchedEffect`） |
| 特殊语言布局错乱          | 检查约束布局的 RTL 支持，使用 `Modifier.layoutDirection` 手动调整方向   |
| 资源未翻译导致回退到默认  | 在 `build.gradle` 添加 `resConfigs "en", "zh"` 过滤支持的语言           |

---

通过以上步骤，Compose 应用可高效适配多语言环境。关键点是**将 UI 文本/资源与代码解耦**，并利用状态管理实现动态切换。谷歌官方示例 [Compose Internationalization](https://github.com/android/compose-samples) 提供了完整参考实现。
