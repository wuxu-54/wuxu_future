
# build变体

原文：<https://developer.android.google.cn/build/build-variants?hl=zh-cn#kts>

## 一段话总结

本文介绍Android Studio中**build变体**的配置方法，**build变体**由**build类型（如debug、release）**和**产品变种（如demo、full）**组合而成，可用于生成不同版本的应用。内容涵盖配置build类型（如设置applicationIdSuffix、使用initWith复制配置）、产品变种（需分配至变种维度，如version、api）、创建源代码集（按优先级合并代码和资源）、管理变体感知型依赖项（通过matchingFallbacks和missingDimensionStrategy解决匹配问题）及签名配置（使用signingConfigs定义密钥库）等关键操作，帮助开发者灵活管理多版本应用构建。

---

## 思维导图

```mindmap
## **一、build变体基础**
- 由build类型和产品变种组合而成
- 示例：demoDebug（demo产品变种+debug build类型）
## **二、配置build类型**
- 默认类型：debug（自动配置debuggable=true）、release
- 自定义配置：applicationIdSuffix、manifestPlaceholders
- 复制配置：initWith（如staging类型复制debug配置）
## **三、配置产品变种**
- 必须分配至变种维度（如version、api）
- 单维度示例：version维度下的demo和full变种
- 多维度组合：api+mode维度，生成12种变体
- 过滤变体：通过variantFilter移除无效组合
## **四、源代码集管理**
- 目录结构：main/（公共）、debug/、demo/、demoDebug/等
- 优先级顺序：build变体>build类型>产品变种>main
- 配置方式：手动创建目录或通过Android Studio生成
## **五、依赖项管理**
- 变体感知机制：自动匹配同名变体（如freeDebug用库的freeDebug）
- 匹配问题解决
  - matchingFallbacks：指定备用build类型或产品变种
  - missingDimensionStrategy：处理缺失维度的默认匹配
## **六、签名配置**
- 创建密钥库和私钥
- 在signingConfigs中定义签名信息
- 安全建议：从环境变量或属性文件获取密码，备份密钥库
```

---

## 详细总结

### 一、build变体概述

- **核心概念**：build变体是**build类型**和**产品变种**的组合结果，用于生成不同版本的应用（如免费版/付费版、调试版/发布版）。
- **组成要素**
  - **build类型**：控制构建行为（如调试选项、签名配置），默认包含debug和release。
  - **产品变种**：定义功能差异（如API级别、资源文件），需分配至**变种维度**（如version、api）。

### 二、配置build类型

- **默认配置**
  - debug：自动启用调试（debuggable=true），使用默认调试密钥库。
  - release：默认启用代码混淆（minifyEnabled=true），需手动配置签名。
- **自定义build类型**

  ```kotlin
  // 示例：创建staging类型，复制debug配置并修改宿主地址
  android {
      buildTypes {
          create("staging") {
              initWith(getByName("debug"))
              manifestPlaceholders["hostName"] = "internal.example.com"
              applicationIdSuffix = ".debugStaging"
          }
      }
  }
  ```

### 三、配置产品变种

- **变种维度要求**：所有产品变种必须属于某个变种维度，否则报错。

  ```kotlin
  // 单维度示例：version维度下的demo和full变种
  android {
      flavorDimensions += "version"
      productFlavors {
          create("demo") {
              dimension = "version"
              applicationIdSuffix = ".demo"
          }
          create("full") {
              dimension = "version"
              applicationIdSuffix = ".full"
          }
      }
  }
  ```

- **多维度组合**：如api（minApi21/minApi23/minApi24）+mode（demo/full）维度，生成**3×2×2=12种变体**。
- **过滤无效变体**：通过variantFilter移除无用组合（如demo+minApi21）。

### 四、源代码集管理

- **目录结构**

  | 类型         | 路径示例               | 用途                         |
  |--------------|------------------------|------------------------------|
  | 主源代码集   | src/main/              | 公共代码和资源               |
  | build类型     | src/debug/             | debug特有的代码和资源        |
  | 产品变种     | src/demo/              | demo变种特有的代码和资源     |
  | build变体    | src/demoDebug/         | demoDebug变体特有的代码和资源|

- **优先级顺序**：build变体（如demoDebug） > build类型（debug） > 产品变种（demo） > 主源代码集（main）。

### 五、依赖项管理

- **变体感知型匹配**：自动匹配同名变体（如应用的freeDebug使用库的freeDebug）。
- **匹配问题解决方案**

  | 问题场景                     | 解决方案                  | 示例代码（Kotlin）                          |
  |------------------------------|---------------------------|---------------------------------------------|
  | 应用build类型多于库           | matchingFallbacks         | buildTypes.staging.matchingFallbacks += listOf("debug", "release") |
  | 应用产品变种多于库           | matchingFallbacks         | productFlavors.free.matchingFallbacks += listOf("demo", "trial") |
  | 库存在应用缺失的变种维度     | missingDimensionStrategy  | defaultConfig.missingDimensionStrategy("minApi", "minApi18") |

### 六、签名配置

- **关键步骤**
  1. 创建密钥库（.keystore文件）和私钥。
  2. 在build.gradle中配置signingConfigs：

     ```kotlin
     android {
         signingConfigs {
             create("release") {
                 storeFile = file("myreleasekey.keystore")
                 storePassword = System.getenv("KSTOREPWD") // 从环境变量获取密码
                 keyAlias = "MyReleaseKey"
                 keyPassword = System.getenv("KEYPWD")
             }
         }
         buildTypes.release.signingConfig = signingConfigs.getByName("release")
     }
     ```

- **安全注意事项**：避免在代码中硬编码密码，建议通过环境变量或本地属性文件管理。

---

## 关键问题

### 1. build变体如何组合生成？

**答案**：build变体由**build类型**和**产品变种**组合而成，命名规则为“产品变种名+build类型名”（如demoDebug）。Gradle会自动将每个变种维度的产品变种与所有build类型组合，生成全部可能的变体（如2个产品变种+2个build类型=4个变体）。

### 2. 为什么需要为产品变种分配变种维度？

**答案**：变种维度用于对产品变种进行分组，确保Gradle能正确组合不同维度的变种。若未分配维度，会报错“All flavors must now belong to a named flavor dimension”。例如，将“demo”和“full”分配至“version”维度，可与“api”维度的变种（如minApi21）组合生成多维度变体。

### 3. 如何解决应用与库依赖项的变体不匹配问题？

**答案**：通过以下方式处理

- **matchingFallbacks**：为build类型或产品变种指定备用匹配项（如应用的staging类型无对应库变种时，尝试使用debug或release）。
- **missingDimensionStrategy**：为库存在但应用缺失的变种维度指定默认变种（如库有“minApi”维度，应用未定义时，默认使用minApi18）。
