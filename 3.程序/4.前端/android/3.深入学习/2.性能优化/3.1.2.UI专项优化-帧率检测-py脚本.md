# 帧率检测-py脚本

以下是一个简单的 Android 帧率测试脚本示例，使用 Python 和 ADB（Android Debug Bridge）工具：

```python
import subprocess
import re
import time


def get_fps(package_name):
    # 执行 adb shell dumpsys gfxinfo 命令获取图形信息
    command = f"adb shell dumpsys gfxinfo {package_name}"
    result = subprocess.check_output(command.split()).decode('utf-8')
    # 使用正则表达式匹配 FrameStats 部分
    frame_stats = re.search(r'View hierarchy:\n(.*)Total frames', result, re.DOTALL)
    if frame_stats:
        frame_stats = frame_stats.group(1)
        # 计算帧率
        lines = frame_stats.split('\n')
        frame_times = []
        for line in lines:
            if "Draw" in line:
                parts = line.split()
                # 获取帧的时间信息
                frame_time = int(parts[-1])
                frame_times.append(frame_time)
        if len(frame_times) >= 2:
            # 计算相邻帧之间的时间差
            time_diffs = [frame_times[i] - frame_times[i - 1] for i in range(1, len(frame_times))]
            # 计算平均帧率
            average_frame_time = sum(time_diffs) / len(time_diffs)
            fps = 1000 / average_frame_time
            return fps
    return 0


if __name__ == "__main__":
    # 替换为你要测试的 Android 应用的包名
    package_name = "com.example.yourpackage"
    start_time = time.time()
    # 测试持续时间，可根据需要调整
    test_duration = 10
    while time.time() - start_time < test_duration:
        fps = get_fps(package_name)
        print(f"Current FPS: {fps}")
        time.sleep(1)
```

**代码解释和使用说明**：

- 首先，我们定义了一个 `get_fps` 函数，它接受一个参数 `package_name`，表示要测试的 Android 应用的包名。
  - 在函数内部，使用 `subprocess.check_output` 执行 `adb shell dumpsys gfxinfo <package_name>` 命令，该命令会输出应用的图形性能信息。
  - 然后，使用 `re.search` 配合正则表达式提取出 `View hierarchy` 到 `Total frames` 之间的内容，这里包含了帧的详细信息。
  - 遍历这些信息，找到包含 `Draw` 的行，提取帧的时间信息。
  - 计算相邻帧之间的时间差，通过 `time_diffs` 列表存储。
  - 计算平均帧时间，然后根据公式 `fps = 1000 / average_frame_time` 得到帧率。
- 在 `__main__` 部分：
  - 替换 `package_name` 为你要测试的 Android 应用的实际包名。
  - 设定测试的持续时间（这里是 10 秒），并在循环中每秒调用 `get_fps` 函数获取帧率并打印出来。

请确保你已经安装了 ADB 工具并将其添加到系统路径中，并且你的 Android 设备已经通过 USB 连接到计算机，并且已经启用了 USB 调试模式。你可以通过以下步骤检查 ADB 是否正常工作：

1. 打开命令行终端。
2. 输入 `adb devices`，如果你的设备正确连接并开启了 USB 调试，你会看到设备列表。

需要注意的是，这个脚本只是一个简单的示例，实际的帧率测试可能会受到多种因素的影响，例如设备性能、系统负载等。你可以根据需要对脚本进行扩展和优化，例如添加异常处理、增加更多的性能指标，以及将测试结果存储到文件中进行后续分析。

如果你需要更精确的帧率测试，可能需要使用专业的性能测试工具，如 Systrace 或 Perfetto，它们提供了更详细的系统性能分析和可视化功能。此外，还可以考虑使用 Android 的 Profiler 工具，它可以在 Android Studio 中使用，提供了更全面的性能数据，包括 CPU、内存、网络和 GPU 性能等，同时也可以对帧率进行实时监测和分析。

如果你在使用此脚本时遇到问题，可能是因为设备未正确连接、包名错误或者 ADB 命令执行权限问题。请检查设备连接状态、包名是否正确，并确保你有足够的权限执行 ADB 命令。
