# Systrace

Systrace 是 Android 平台上一个强大的性能分析工具，它能够捕获系统级别和应用级别的活动数据，帮助开发者诊断性能问题。
>Android 9 及更高版本的设备是以 Perfetto 工具替换Systrace

以下是 Systrace 命令的使用详解和示例：

## Systrace 简介

Systrace 允许开发者收集和检查设备上运行的所有进程的计时信息，包括 CPU 调度、磁盘 I/O 和应用线程等。通过生成的 HTML 报告，可以方便地查看和分析这些数据。

## 使用 Systrace 的方法

1. **抓取 Systrace 文件**：
   使用 Android Device Monitor 或命令行工具 `systrace` 来捕获系统级的跟踪数据。

2. **分析 Systrace 数据**：
   使用 Chrome 浏览器打开生成的 HTML 报告文件，检查 CPU 使用情况、线程状态、I/O 操作等。

3. **解决性能问题**：
   根据分析结果，优化代码、调整系统设置或使用其他工具进一步分析问题。

## 命令行抓取 Systrace

使用命令行工具 `systrace` 可以方便地捕获和生成 Systrace 报告。基本命令格式如下：

```sh
python systrace.py [options] [categories]
```

- `options`：选项，如设置抓取时间、输出文件名等。
- `categories`：要捕获的跟踪类别，如 `gfx`、`view`、`binder` 等。

查看连接设备支持的类别列表

```sh
python systrace.py --list-categories
```

## 示例

1. **基本抓取命令**：

   ```sh
   python systrace.py --time=10 -o mytrace.html gfx view
   ```

   这个命令将捕获 10 秒的 `gfx` 和 `view` 类别的跟踪数据，并生成名为 `mytrace.html` 的报告文件。

2. **查看支持的类别**：

   ```sh
   python systrace.py --list-categories
   ```

3. **使用快捷键分析报告**：
   - `W/S`：放大/缩小视图。
   - `A/D`：在时间轴上左右移动。
   - `M`：聚焦当前选中区域。
   - `F`：放大当前选区。
   - `V`：高亮 Vsync 信号。
   - `左键/右键`：切换上一个/下一个事件。

## 注意事项

- 确保安装了正确版本的 Python（推荐 Python 2.7），因为 Systrace 脚本不支持 Python 3.x 版本。
- Systrace 的系统开销非常小，可以在插桩测试期间体验实际卡顿情况。
- 从 Android Studio 33.0.1 开始，Systrace 被移除，如果需要使用，可以下载安装前一个版本的 platform-tools。

---

## systrace.py 文件未找到

如果您遇到 `systrace.py` 文件未找到的问题，请按照以下步骤进行排查和解决：

1. **确认安装**：
   确保您已经安装了 Android SDK Platform-Tools。`systrace.py` 脚本位于 Platform-Tools 目录中。

2. **检查路径**：
   `systrace.py` 通常位于 Android SDK 的 `platform-tools` 目录下。在命令行中，导航到该目录并检查是否存在 `systrace.py` 文件。

   ```sh
   cd path/to/your/android-sdk/platform-tools
   ls -l systrace.py
   ```

3. **环境变量**：
   确保 Android SDK 的 `platform-tools` 目录已经添加到系统的环境变量 `PATH` 中。这样您就可以在任何位置调用 `systrace.py`。

4. **下载对应版本的 SDK Tools**：
   如果您使用的是较新版本的 Android Studio，可能需要下载特定版本的 SDK Tools 来获取 `systrace.py`。可以从 Android SDK Manager 中下载或通过以下链接直接下载：

   ```sh
   https://dl.google.com/android/repository/platform-tools_r${version}-windows.zip
   ```

   替换 `${version}` 为实际的版本号。

5. **使用 Android Studio**：
   如果您无法在命令行中使用 `systrace.py`，可以尝试在 Android Studio 中使用 Profiler 工具进行性能分析。

6. **检查 Python 版本**：
   `systrace.py` 需要 Python 2.7 环境。如果您的系统默认是 Python 3.x，可能需要创建一个虚拟环境或使用 `python2` 命令来运行脚本。

7. **重新安装或更新 SDK Tools**：
   如果 `systrace.py` 丢失或损坏，尝试重新安装或更新 Android SDK Platform-Tools。

8. **使用替代工具**：
   如果 `systrace.py` 不可用，可以考虑使用其他性能分析工具，如 Android Studio 的 Profiler 或 `perfetto`。

9. **查看文档**：
   查看官方文档或相关博客，了解如何正确安装和使用 `systrace.py`。

10. **社区支持**：
    如果问题仍然无法解决，可以在 Stack Overflow 或 Android 开发者社区寻求帮助。

通过以上步骤，您应该能够找到并使用 `systrace.py` 文件进行性能分析。如果问题依旧存在，可能需要考虑使用其他工具或方法来替代 Systrace。

---

## platform-tools中找不到systrace.py

谷歌官方在22年3月发布的33.0.1版本的platform-tools包中移除了systrace

需要使用systrace需要币33.0.1更低的sdk包

下载SDK历史版本的方法：

- `https://dl.google.com/android/repository/platform-tools_r[版本]-[系统].zip`

示例，下载33.0.0的SDK包：

- `https://dl.google.com/android/repository/platform-tools_r33.0.0-linux.zip`
- `https://dl.google.com/android/repository/platform-tools_r33.0.0-windows.zip`
- `https://dl.google.com/android/repository/platform-tools_r33.0.0-darwin.zip`

[可查阅Google的SDK 平台工具版本说明](https://developer.android.google.cn/tools/releases/platform-tools?hl=zh-cn)

### 抓取信息

最后，进入`platform-tools`里面的`systrace`文件夹里，使用`python systrace.py --输入你的指令`

指令示例：

```sh
python systrace.py --time=180 -o mytrace3.html -a 应用包名 gfx view memreclaim input hal dalvik idle am sm wm freq disk sched
```

`--time=180` 是抓取的时间，单位秒。示例中很多指令信息在上面官网地址可以看到解释。

---

## systrace html 解析

- [官文](https://developer.android.google.cn/topic/performance/tracing/navigate-report?hl=zh-cn)
- [csdn 博客](https://blog.csdn.net/hfreeman2008/article/details/53538155)

Systrace 是 Android 平台上一个强大的性能分析工具，它通过收集设备活动数据生成 HTML 报告，帮助开发者分析和优化应用性能。以下是 Systrace 生成的 HTML 报告中各个颜色的含义和 frames 图标的意义：

### 颜色含义

1. **灰色**：线程正在休眠（Sleeping）。
2. **蓝色**：线程可运行（Runnable），即线程可以运行但尚未被调度器调度运行。
3. **绿色**：线程正在运行（Actively running），调度器认为线程当前正在运行。
4. **红色**：不可中断的休眠（Uninterruptible sleep），通常处于内核中休眠锁定状态，一般是在进行 I/O 操作时出现。
5. **橙色**：由于 I/O 负载而不可中断的休眠（Uninterruptible sleep due to I/O load）。

### Frames 图标意义

1. **绿色圆圈**：表示在 16.6 毫秒内呈现的帧，即在一帧的标准时间内完成渲染，保持每秒 60 帧的稳定帧率。
2. **黄色或红色圆圈**：表示渲染时间超过 16.6 毫秒的帧，意味着帧渲染时间较长，可能导致卡顿或掉帧。

### Systrace 报告查看细解

1. **用户互动**：报告的第一部分包含表示应用或游戏中的具体用户互动的条形图，如屏幕点按等，作为时间标记。
2. **CPU 活动**：显示每个 CPU 中的线程活动条形图，可以展开查看每个 CPU 的时钟频率。
3. **系统事件**：直方图显示特定的系统级事件，如 SurfaceView 的纹理计数和总大小。
4. **显示帧**：多色线条表示特定线程的状态和帧堆栈，线条上方的多色线条表示线程随时间变化的状态。

### 使用工具帮助定位性能问题

1. **选择时间间隔**：通过在时间间隔周围绘制一个矩形来选择所需的时间间隔。
2. **使用标尺工具**：标记或突出显示问题区域。
3. **高亮 VSync**：点击 View Options > Highlight VSync，显示每项显示屏刷新操作。
4. **过滤信息**：点击 Processes 菜单进行筛选，减少页面中的信息量。

### 检查界面帧和提醒

1. **渲染界面帧**：报告列出渲染界面帧的每个进程，并指明沿时间轴渲染的每个帧。
2. **帧提醒**：点击某个帧圆圈可将其突出显示，并提供有关系统为渲染该帧所做工作的其他信息，包括提醒。Alerts 面板可帮助了解跟踪记录中出现的问题及频率。
