# 检测

在分析任何问题前，一定要思考，按逻辑梳理问题原因及其可能性，根据问题可能性大小进行具体排查。

## 官方

[官方-性能](https://developer.android.google.cn/topic/performance/tracing?hl=zh-cn)

## APM

对Android性能分析工具的统一简称。

## 性能检测、优化工具

* Matrix：腾讯的APM工具，提供了包括卡顿检测、内存泄漏检测、CPU和内存使用率监控等在内的多种功能。
* LeakCanary：一个用于检测Java和Android内存泄漏的库。
* Emmagee：网易开源的APM工具，可以监控内存、CPU、流量等。
* Mobileperf：阿里的APM工具，支持多种性能监控。
* GT (Google Tracer)：腾讯的一个性能测试工具，可以在手机上进行快速的性能测试。

* Android studio profile：这是Android开发者官方集成的性能分析工具，可以用来监控CPU、内存、网络和磁盘使用情况。[在线hprof分析工具](https://heaphero.io/index.jsp)
    >旧版sdk是DDMS，位于sdk的 `tools\ddms\` 文件夹。目前已被废弃
* Android studio Layout inspector：查看布局，处理焦点问题、view层级嵌套问题很好用。
* MAT、JProfiler：内存分析工具
* Systrace（推荐）：一个性能分析工具，可以帮助开发者理解应用的运行时行为，识别性能瓶颈（Android 9 及更高版本的设备是以 Perfetto 工具替换Systrace）
* Android Device Monitor：该工具可以实时监控设备的各种状态，包括电池使用、CPU负载、内存使用等。
* ProGuard：是一个代码优化和混淆工具，用于减小APK大小，提高应用的安全性。
* StrictMode：Android SDK中的一个工具，可以在开发者选项中启用，用于捕获主线程上长时间的阻塞操作。
* Simpleperf：是一款适用于Android平台上的应用和本机进程的原生分析工具，可以用来进行CPU性能分析。
* Traceview：是一个基于GUI的实时分析工具，可以显示程序运行时的方法调用和时间。获取TraceView方式：Profiler、DDMS、Debug代码跟踪
* Battery Historian：用于分析电池使用情况的工具。
* Hierarchy Viewer：用于分析应用布局的性能，可以找出布局渲染的性能瓶颈。
* GPU Profiler：用于分析GPU渲染性能，帮助开发者优化渲染效率。
* Power Profiler：Android Studio提供的工具，用于分析应用的功耗。

## 代码

* 通过获取代码执行时长，判断卡顿情况、内存。
* 使用代码中的API，如：Trace、Debug追踪。
  
### 使用Debug追踪

1. 开始：`Debug.startMethodTracing("test")`
2. 结束：`Debug.stopMethodTracing()`  结束上一个，无法交叉跟踪
3. 获取跟踪文件：路径默认是 `/storage/emulated/0/Android/data/your.package.name/files/test.trace`,可以自己设定path比如传入`/sdcard/test`
4. 使用adb pull获取文件到本地：`adb shell /sdcard/test.trace`
5. 文件路径配置处源码：

    ```java

    //会将路径补全
    private static String fixTracePath(String tracePath) {
        if (tracePath == null || tracePath.charAt(0) != '/') {
            final Context context = AppGlobals.getInitialApplication();
            final File dir;
            if (context != null) {
                dir = context.getExternalFilesDir(null);//这就是上面trace所在目录：/storage/emulated/0/Android/data/your.package.name/files
            } else {
                dir = Environment.getExternalStorageDirectory();//路径是：  /storage/emulated/0
            }

            if (tracePath == null) {
                tracePath = new File(dir, DEFAULT_TRACE_BODY).getAbsolutePath();
            } else {
                tracePath = new File(dir, tracePath).getAbsolutePath();
            }
        }
        if (!tracePath.endsWith(DEFAULT_TRACE_EXTENSION)) {
            tracePath += DEFAULT_TRACE_EXTENSION;
        }
        return tracePath;
    }
    ```

6. 使用Profiler打开即可进行性能分析。
