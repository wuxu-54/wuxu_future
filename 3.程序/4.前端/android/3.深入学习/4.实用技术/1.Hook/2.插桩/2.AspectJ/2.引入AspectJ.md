# 引入AspectJ

[官网地址](https://eclipse.dev/aspectj/doc/latest/index.html#documentation)
[AspectJ项目开源地址](https://github.com/eclipse-aspectj/aspectj)

在Android中引入和使用AspectJ主要涉及以下几个步骤：

1. **添加依赖**：
   在项目的根目录`build.gradle`文件中添加AspectJ插件的依赖。

   ```gradle
   buildscript {
       dependencies {
           classpath 'org.aspectj:aspectjtools:1.9.8'
           classpath 'org.aspectj:aspectjweaver:1.9.8'
       }
   }
   ```

   在模块的`build.gradle`中，添加依赖：

   ```gradle
   dependencies {
       implementation 'org.aspectj:aspectjrt:1.9.8'
   }
   ```

2. **配置AspectJ编译器（AJC）**：
   创建`aspectj.gradle`文件，配置AspectJ编译器以在编译时织入代码。

   ```groovy
   buildscript {
       repositories {
           maven { url 'https://maven.aliyun.com/nexus/content/groups/public/' }
           google()
           mavenCentral()
       }
       // ...
   }
   ```

3. **在模块中引入脚本**：
   在模块的`build.gradle`文件末尾，添加以下代码引入`aspectj.gradle`脚本。

   ```gradle
   apply from: "../aspectj.gradle"
   ```

## 使用AspectJ

1. **定义切面（Aspect）**：
   创建一个类使用`@Aspect`注解声明为切面。

   ```java
   @Aspect
   public class SampleAspect {
       // ...
   }
   ```

2. **定义切入点（Pointcut）**：
   使用`@Pointcut`注解声明切入点，指定需要织入代码的位置。
   >通知注解可以直接写`execution`切入点表达式，也可以抽取切入点`Pointcut`，目的是复用切入点表达式。

   ```java
   @Pointcut("execution(void android.view.View.OnClickListener.onClick(..))")
   public void methodViewOnClick() {//注意如果访问修饰符是private表示只能在当前类使用。
   }
   ```

3. **定义通知（Advice）**：
   使用`@Before`、`@After`或`@Around`注解声明在切入点处执行的代码。
   >注意通知的参数可以是切入点，也可以不设定切入点直接传入`execution(void android.view.View.OnClickListener.onClick(..))`

   ```java
   @Around("methodViewOnClick()")
   public void aroundViewOnClick(ProceedingJoinPoint joinPoint) throws Throwable {
       // ...
       joinPoint.proceed(); // 执行原方法
   }
   ```

   >有五种基本类型的通知：前置通知（Before）、后置通知（After returning）、异常通知（After throwing）、最终通知（After（finally））和环绕通知（Around）。

4. **集成AspectJX插件**（可选）：
   使用如AspectJX等第三方库简化集成过程。

   ```gradle
   dependencies {
       classpath 'com.hujiang.aspectjx:gradle-android-plugin-aspectjx:2.0.4'
   }
   ```

5. **编写测试代码**：
   调用**织入**代码的方法，观察日志输出或其他预期行为。

6. **编译项目**：
   编译项目时，AspectJ会自动执行**织入**操作，生成最终的类文件。

通过AspectJ，你可以实现诸如按钮防快速点击、日志打印、性能监控等功能，而无需修改原有业务逻辑代码。AspectJ的使用可以提高代码的模块化和可维护性，但需要注意其对编译时长的影响。

---

## 补充：同类型通知执行顺序

对于同类型通知如`@Before`、`@After`，遵循以下执行顺序：

1. 使用`Order`注解标注切入类，自定义执行顺序，值为整数。目标通知方法**前**的通知（如`@Before`）越小越先执行，目标通知方法**后**的通知（如`@After`）越小越先后行。
2. 未使用`Order`或其同值，按切入类的类名大小排序。目标通知方法前的通知（如`@Before`）越小越先执行，比如对于`@Before`：**A优先B执行** 或 **A1优先A2执行**。目标通知方法后的通知（如`@After`）越小越先后行，比如对于`@After`：**A在B后执行** 或 **A1在A2后执行**。
