# 主要API及示例

以下是 Javassist 的主要 API 及其示例，涵盖类的创建、修改、字段、方法、构造方法等操作：

## 1. ClassPool

ClassPool 是 Javassist 的核心类，用于管理类的字节码信息。

```java
//获取默认的 ClassPool：
ClassPool pool = ClassPool.getDefault();
//加载类：
CtClass cc = pool.get("java.lang.String"); // 加载已存在的类
//创建新类：
CtClass newClass = pool.makeClass("com.example.MyClass");
//将修改后的类写入文件：
cc.writeFile(); // 写入到默认目录
cc.writeFile("output"); // 写入到指定目录
//获取字节码：
byte[] bytecode = cc.toBytecode();
//加载为 Java 类：
Class<?> clazz = cc.toClass();
```

## 2. CtClass

CtClass 表示一个类的字节码信息，用于操作类的结构。

```java
//添加字段：
CtField field = new CtField(pool.get("java.lang.String"), "name", cc);
cc.addField(field);
//添加方法：
CtMethod method = CtNewMethod.make("public void sayHello() { System.out.println(\"Hello\"); }", cc);
cc.addMethod(method);
//设置父类：
CtClass superClass = pool.get("java.lang.Object");
cc.setSuperclass(superClass);
//添加接口：
CtClass interfaceClass = pool.get("java.lang.Runnable");
cc.addInterface(interfaceClass);
```

## 3. CtMethod

CtMethod 用于操作类中的方法。

```java
//获取方法：
CtMethod m = cc.getDeclaredMethod("toString");
//修改方法体：
m.setBody("{ System.out.println(\"Modified method\"); }");
//插入代码：
m.insertBefore("{ System.out.println(\"Before method execution\"); }");//类似这种插入位置，学了AspectJ就能明白，在方法执行前执行还是方法后执行
m.insertAfter("{ System.out.println(\"After method execution\"); }");
```

## 4. CtConstructor

CtConstructor 用于操作类中的构造方法。

```java
//添加构造方法：
CtConstructor constructor = new CtConstructor(new CtClass[]{}, cc);
constructor.setBody("{ System.out.println(\"New Constructor\"); }");
cc.addConstructor(constructor);
//修改构造方法：
CtConstructor existingConstructor = cc.getDeclaredConstructor(new CtClass[]{});
existingConstructor.insertBefore("{ System.out.println(\"Before Constructor Execution\"); }");
existingConstructor.insertAfter("{ System.out.println(\"After Constructor Execution\"); }");
```

## 5. CtField

CtField 用于操作类中的字段。

```java
//添加字段：
CtField field = new CtField(pool.get("int"), "count", cc);
cc.addField(field);
//修改字段修饰符：
field.setModifiers(Modifier.PUBLIC);
```

## 6. 完整示例：动态生成类

以下示例展示了如何使用 Javassist 动态生成一个类，包含构造方法、字段和方法：

```java
import javassist.*;

public class JavassistExample {
    public static void main(String[] args) throws Exception {
        ClassPool pool = ClassPool.getDefault();
        CtClass cc = pool.makeClass("com.example.MyClass");

        // 添加字段
        CtField nameField = new CtField(pool.get("java.lang.String"), "name", cc);
        nameField.setModifiers(Modifier.PRIVATE);
        cc.addField(nameField, CtField.Initializer.constant("张三"));

        // 添加无参构造方法
        CtConstructor noArgsConstructor = new CtConstructor(new CtClass[]{}, cc);
        noArgsConstructor.setBody("{}");
        cc.addConstructor(noArgsConstructor);

        // 添加有参构造方法
        CtConstructor argsConstructor = new CtConstructor(new CtClass[]{
                pool.get("java.lang.String")
        }, cc);
        argsConstructor.setBody("{$0.name = $1;}");
        cc.addConstructor(argsConstructor);

        // 添加方法
        CtMethod sayHelloMethod = CtNewMethod.make(
                "public String sayHello() { return \"Hello, Javassist。I am :\" + name; }",
                cc
        );
        cc.addMethod(sayHelloMethod);

        // 生成类
        Class<?> clazz = cc.toClass();
        Object instance = clazz.getDeclaredConstructor().newInstance();
        System.out.println(clazz.getMethod("sayHello").invoke(instance));
    }
}

//输出结果：
//Hello, Javassist。I am :张三
```

## 7. 其他功能

冻结和解冻类：

```java
cc.writeFile(); // 写入文件后，类会被冻结
cc.defrost(); // 解冻类，允许再次修改
```

防止类被修剪：

```java
cc.stopPruning(true); // 防止类被修剪
```

使用自定义类加载器：

```java
Class<?> clazz = cc.toClass(customClassLoader); // 使用自定义类加载器加载类
```

通过这些 API，Javassist 提供了强大的功能来动态生成、修改和操作 Java 类的字节码，适用于 AOP、动态代理等场景。更多高级用法可以参考 Javassist 官方文档。
