# 插件方案

- 腾讯开源的shadow框架。选择原因：关键位置无Hack操作不受谷歌政策限制，插件框架动态化解耦宿主依赖。

  - [传送门](https://gitee.com/Tencent/Shadow)
  - [腾讯工蜂镜像源码](https://git.code.tencent.com/Tencent_Open_Source/Shadow)
  - [作者掘金首页](https://juejin.cn/user/536217405890903/posts)

## 策略

apk，分为验收环境、灰度环境、正式环境。其中灰度是预开放某些功能的环境。

插件标签、发布平台。

1. 更新策略：插件是否强制升级
2. 启动策略
    - 跟随app启动的策略：解压安装插件后，根据该字段决定是否加载到内存
    - 服务启动策略：解压安装插件后，根据该字段启动相应服务。字符为服务的包名+类名，如有多个用英文`,`符号隔开。
3. 生效策略：如果已经加载老版本插件，新版本插件需要重启app后才能生效，即为插件生效，重启app的策略。分为以下5种（按顺序排列）：
    - 立即强制重启：弹提示窗，只有一个重启按钮，不可关闭。
    - 可选重启：弹提示窗，一个重启按钮，一个关闭按钮。
    - 10分钟重启：切换后台10分钟后重启（10分钟app在后台才重启，前台不重启）
    - 24小时定时重启：24小时后，如果app在前台则弹窗提示，用户点击重启。app在后台直接重启。
    - 不强制重启，下次启动生效。

## 页面跳转

- 插件未安装时，跳转至插件内：按策略下载更新安装插件，按生效策略进行选择。
- 插件安装后，跳转至插件内：判断插件更新策略，如果更新按策略进行新版本下载更新安装，按生效策略进行选择。

获取插件信息后，获取插件内的路由管理，在插件内部解析路由后加载出界面。

### 插件下架

- 获取插件信息后，判断下架状态，如果已下架，提示toast错误信息，将插件清除（具体怎么清除，我理解是从宿主配置清单中移除，表示没这个插件）。

---

## 测试

1. 加载速度性能
2. 插件包
3. 内存占用

---

## CI配置

流水线自动打包配置，插件库与普通Android项目有区别，需要执行特定脚本，替换插件名pluginname为真实插件名，然后编译。
