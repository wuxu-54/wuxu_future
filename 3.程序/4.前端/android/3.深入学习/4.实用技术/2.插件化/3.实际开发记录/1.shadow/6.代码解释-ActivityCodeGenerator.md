# ä»£ç è§£é‡Š-ActivityCodeGenerator

## 1. ä»£ç†æ¥å£å…¼å®¹é—®é¢˜åŸå› åŠè§£å†³æ–¹æ¡ˆ

```kotlin
 /**
         * è¿™ä¸ªç±»é›†ä¸­è§£å†³ä¸€ä¸ªé—®é¢˜çš„é€»è¾‘ã€‚é—®é¢˜Issueè§https://github.com/Tencent/Shadow/issues/230
         *
         * é—®é¢˜æè¿°ï¼š
         * ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç±»çš„æ–¹æ³•ç­¾åä¸­å¦‚æœå«æœ‰æ‰¾ä¸åˆ°çš„ç±»ï¼Œåœ¨è¿™ä¸ªç±»æœ¬èº«è¢«newå‡ºæ¥æ—¶æ˜¯ä¸ä¼šå‡ºé”™çš„ã€‚
         * JVMä¸ä¼šå»æ£€æŸ¥ä¸€ä¸ªç±»çš„æ‰€æœ‰æ–¹æ³•çš„ç­¾åä¸­æ¶‰åŠåˆ°çš„ç±»æ˜¯å¦éƒ½å­˜åœ¨ã€‚åªæœ‰å½“è°ƒç”¨è¯¥æ–¹æ³•æ—¶æ‰ä¼šå‘ç°ç­¾åä¸Šçš„ç±»æ‰¾ä¸åˆ°ã€‚
         *
         * ä½†æ˜¯åœ¨com.tencent.shadow.core.loader.ShadowPluginLoader.getHostActivityDelegateä¸­ï¼Œ
         * å°†å®ç°ä»¥æ¥å£ç±»å‹è¿”å›æ—¶ï¼Œæ¶‰åŠä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œå°±æ˜¯å®ç°å’Œæ¥å£ä¸æ˜¯ç”±åŒä¸€ä¸ªClassLoaderåŠ è½½çš„ã€‚
         * åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJVMä¼šæ£€æŸ¥å®ç°æ˜¯å¦çœŸçš„å®ç°äº†æ¥å£çš„æ¯ä¸€ä¸ªæ–¹æ³•å®šä¹‰ã€‚æ‰€ä»¥ä¼šå»å°è¯•åŠ è½½æ¥å£ä¸Šæ‰€æœ‰æ–¹æ³•ç­¾åæ¶‰åŠçš„ç±»ã€‚
         * è¿™ä¼šå¯¼è‡´åœ¨ä½ç‰ˆæœ¬ç³»ç»Ÿä¸Šå°è¯•åŠ è½½é«˜ç‰ˆæœ¬å¼•å…¥çš„ç±»ï¼Œæ¯”å¦‚android.app.role.RoleManageræ˜¯API29å¼•å…¥çš„ï¼Œ
         * åœ¨API28çš„æ‰‹æœºä¸Šå°±ä¼šå‡ºç°LinkageErrorã€‚
         *
         * è§£å†³æ–¹æ¡ˆå°±æ˜¯å¯¹äºé«˜ç‰ˆæœ¬APIå¼•å…¥çš„ç±»åœ¨ç”Ÿæˆä»£ç†è½¬è°ƒç›¸å…³ä»£ç æ—¶:åœ¨Delegateã€ShadowActivityDelegate
         * ä¸¤ä¸ªç”Ÿæˆç±»ä¸­ä½¿ç”¨Objectç±»å‹æ›¿ä»£åŸæœ¬ç±»å‹ï¼Œåœ¨PluginContainerActivityä¸­è°ƒç”¨Delegateæ–¹æ³•æ—¶å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œ
         * åœ¨ShadowActivityDelegateè°ƒç”¨PluginActivityæ–¹æ³•æ—¶ä¹Ÿå¯¹å‚æ•°è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚
         *
         * è¿™ä¸ªæ–¹æ³•ä¸­å®šä¹‰å“ªäº›ç±»å‹å¯¹äºä½ç‰ˆæœ¬APIæ˜¯å®‰å…¨çš„ï¼Œä¸éœ€è¦é‡‡ç”¨ä¸Šè¿°æ–¹æ¡ˆã€‚å…¶ä½™ç±»å‹åˆ™é‡‡ç”¨ä¸Šè¿°æ–¹æ¡ˆã€‚
         */
        private fun Class<*>.isSafeForLowApi(): Boolean {
            val safeType: List<String?> = listOf(
                android.app.Activity::class,
                android.app.Dialog::class,
                android.app.Fragment::class,
                android.content.ComponentName::class,
                android.content.Context::class,
                android.content.Intent::class,
                android.content.res.Configuration::class,
                android.content.res.Resources.Theme::class,
                android.content.res.Resources::class,
                android.graphics.Bitmap::class,
                android.graphics.Canvas::class,
                android.net.Uri::class,
                android.os.Bundle::class,
                android.util.AttributeSet::class,
                android.view.ActionMode.Callback::class,
                android.view.ActionMode::class,
                android.view.ContextMenu.ContextMenuInfo::class,
                android.view.ContextMenu::class,
                android.view.KeyEvent::class,
                android.view.Menu::class,
                android.view.MenuItem::class,
                android.view.MotionEvent::class,
                android.view.View::class,
                android.view.WindowManager.LayoutParams::class,
                android.view.accessibility.AccessibilityEvent::class,
                android.view.LayoutInflater::class
            ).map { it.java.canonicalName }

            return isPrimitive or
                    (isArray && componentType.isSafeForLowApi()) or
                    (canonicalName.startsWith("java.lang")) or
                    safeType.contains(canonicalName) // isPrimitive æ˜¯å¦æ˜¯åŸºæœ¬ç±»å‹
        }
```

æŒ‰æ³¨é‡Šè§£é‡Šï¼Œå› ä¸ºæ¥å£åŸå› ï¼Œjvmä¼šå¯¹æ–¹æ³•ç­¾åè¿›è¡Œæ ¡éªŒï¼Œä»è€Œå¯èƒ½å‡ºç°ç‰ˆæœ¬å…¼å®¹é—®é¢˜ã€‚ä½œè€…è§£æ³•ï¼šç‰ˆæœ¬å…¼å®¹çš„ç±»å‹ä¸åšç‰¹æ®Šå¤„ç†ï¼Œä¸å…¼å®¹çš„ç±»å‹åœ¨æ¥å£ä¸­çš„å‡½æ•°æ–¹æ³•å‚æ•°è®¾å®šä¸ºObjectï¼Œä»¥å¼ºåˆ¶ç±»å‹è½¬æ¢æ–¹å¼è°ƒç”¨ã€‚

## 2. javassistå¯¹äºjavaç‰ˆæœ¬çš„å…¼å®¹é—®é¢˜è®°å½•

javassist åœ¨java9ä»¥åçš„ç‰ˆæœ¬ä¼šæœ‰ç±»åŠ è½½é—®é¢˜ï¼Œå…·ä½“è¯´æ˜è¯·æŸ¥çœ‹ï¼š[javassisté—®é¢˜è®°å½•](../../../1.Hook/2.%E6%8F%92%E6%A1%A9/3.javassist/1.2.%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95.md)

```kotlin
// å…¼å®¹javassistå‡çº§åçš„ClassPool#appendSystemPath()æ”¹åŠ¨ï¼š
// https://github.com/jboss-javassist/javassist/commit/e41e0790c0cb073e9e2e30071afecfcdc4621d42
if (javassist.bytecode.ClassFile.MAJOR_VERSION < javassist.bytecode.ClassFile.JAVA_9) {
    //å¦‚æœå°äº9ï¼Œé‚£ä¹ˆç›´æ¥åŠ ClassPathè·¯å¾„
    val cl = Thread.currentThread().contextClassLoader
    classPool.appendClassPath(LoaderClassPath(cl))
}
```

ä¸Šé¢çš„è§£å†³æ–¹æ¡ˆï¼Œä¹Ÿæ˜¯shadowä½œè€…ç»™å‡ºçš„ï¼ˆğŸ‘ğŸ»ï¼‰ï¼Œå…¶æœ¬è´¨å°±æ˜¯ï¼Œæ ¹æ®ä¸åŒç‰ˆæœ¬ï¼Œè®¾ç½®ä¸åŒclassPathæ¥åŠ è½½ç±»ï¼Œè¾¾æˆå…¼å®¹æ•ˆæœã€‚
