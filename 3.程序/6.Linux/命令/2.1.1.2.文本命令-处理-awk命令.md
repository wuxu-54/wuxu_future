# awk

`awk` 是一款强大的文本处理工具，擅长按模式扫描文本、提取字段、进行计算和格式化输出，广泛用于日志分析、数据清洗、报表生成等场景。其核心思想是“按行处理文本，按字段分割内容”，支持自定义逻辑和函数。以下是其详细用法（涵盖选项、内置变量、模式、函数及示例）：

## 一、基本语法与调用方式

`awk` 的基本结构为 **`模式 { 动作 }`**，即对匹配“模式”的行执行“动作”。基本调用格式：

```bash
# 1. 命令行直接指定脚本（适合简单逻辑）
awk 'pattern { action }' [选项] 文件名

# 2. 从文件读取脚本（适合复杂逻辑，脚本文件中每行是awk命令）
awk -f 脚本文件 [选项] 文件名
```

示例：处理 `data.txt`（内容为 `name age\nAlice 25\nBob 30`），打印年龄大于25的行：

```bash
awk '$2 > 25 { print $1, "is old" }' data.txt  # 输出 "Bob is old"
```

## 二、核心选项（命令行参数）

| 选项 | 功能说明 | 示例 |
|------|----------|------|
| `-F <分隔符>` | 指定字段分隔符（默认空格/制表符，多个分隔符用正则表示） | `awk -F ':' '{print $1}' /etc/passwd` → 以 `:` 分割，打印第1列（用户名） |
| `-v <变量名=值>` | 在处理前定义变量（传递外部变量到awk） | `awk -v threshold=25 '$2 > threshold {print $0}' data.txt` → 用变量控制阈值 |
| `-f <脚本文件>` | 从文件读取awk脚本（而非命令行） | `awk -f process.awk data.txt` → 执行 `process.awk` 中的逻辑 |
| `-n` | 不自动打印所有行（默认情况下，不匹配任何模式的行也会被打印，`-n` 禁用此行为） | `awk -n '/error/ {print}' log.txt` → 只打印含 "error" 的行（等价于 `grep error log.txt`） |
| `-i <文件>` | 包含其他awk脚本文件（类似代码复用，GNU awk扩展） | `awk -i common.awk '...' data.txt` → 先加载 `common.awk` 中的函数 |
| `-E` | 启用扩展正则表达式（部分awk版本默认不支持，如 `|`、`()` 等） | `awk -E '/error|warning/ {print}' log.txt` → 匹配含 "error" 或 "warning" 的行 |
| `--posix` | 启用POSIX标准模式（严格遵循POSIX规范，禁用GNU扩展） | `awk --posix '...' file.txt` |

## 三、内置变量（核心！控制字段、行、文件等信息）

`awk` 预定义了大量变量，用于获取文本的结构信息（行号、字段数等），常用如下：

| 变量 | 含义 | 示例（处理 `data.txt` 第2行 `Alice 25`） |
|------|------|------------------------------------------|
| `$0` | 完整的当前行 | `$0` → `Alice 25` |
| `$n` | 第n个字段（n为正整数，`$1` 是第1个字段，`$NF` 是最后一个字段） | `$1` → `Alice`，`$2` → `25` |
| `NF` | 当前行的字段总数（Number of Fields） | `NF` → `2`（该行有2个字段） |
| `NR` | 当前处理的行号（全局，跨文件累计，Number of Records） | 处理第2行时，`NR` → `2` |
| `FNR` | 当前文件的行号（单个文件内的行号，与NR的区别：多文件时重置） | 处理第2个文件的第1行时，`FNR` → `1`，`NR` 继续累计 |
| `FS` | 输入字段分隔符（默认空格/制表符，等价于 `-F` 选项） | `FS=":"` → 以 `:` 分割字段 |
| `OFS` | 输出字段分隔符（默认空格，控制 `print $1,$2` 中字段的分隔） | `OFS="|"` → `print $1,$2` 输出 `Alice|25` |
| `RS` | 输入记录分隔符（默认换行符 `\n`，可自定义行的划分） | `RS=";"` → 以 `;` 作为行分隔符 |
| `ORS` | 输出记录分隔符（默认换行符，控制打印后的换行方式） | `ORS=";"` → 打印的行以 `;` 结尾而非换行 |
| `FILENAME` | 当前处理的文件名 | 处理 `data.txt` 时，`FILENAME` → `data.txt` |
| `ARGC` | 命令行参数总数（包括awk命令本身） | `awk 'BEGIN{print ARGC}' a.txt b.txt` → 输出 `3`（参数为 `awk`、`a.txt`、`b.txt`） |
| `ARGV` | 命令行参数数组（`ARGV[0]` 是 `awk`，`ARGV[1]` 是第一个文件等） | `awk 'BEGIN{print ARGV[1]}' a.txt` → 输出 `a.txt` |

## 四、模式（Pattern）：匹配行的条件

模式用于指定“对哪些行执行动作”，支持多种类型：

### 1. 正则表达式模式（最常用）

格式：`/正则表达式/`，匹配包含该正则的行。

```bash
# 打印含 "error" 的行（忽略大小写）
awk '/error/i {print}' log.txt

# 打印以 "user_" 开头的行
awk '/^user_/ {print $0}' data.txt
```

### 2. 比较/逻辑表达式模式

用 `==`、`!=`、`>`、`<`、`&&`（与）、`||`（或）等判断条件。

```bash
# 年龄（$2）大于25且姓名（$1）是Bob的行
awk '$2 > 25 && $1 == "Bob" {print}' data.txt

# 第3个字段不等于空的行
awk '$3 != "" {print}' file.txt
```

### 3. 行号范围模式

格式：`start, end`，匹配从 `start` 到 `end` 的所有行（闭区间）。

```bash
# 打印第2到第5行
awk 'NR == 2, NR == 5 {print}' file.txt

# 从含 "start" 的行到含 "end" 的行
awk '/start/, /end/ {print}' log.txt
```

### 4. 特殊模式：`BEGIN` 和 `END`

- `BEGIN`：在处理任何行之前执行（用于初始化变量、打印表头）。
- `END`：在处理所有行之后执行（用于汇总结果、打印统计信息）。

```bash
# 打印表头，处理行，最后统计总数
awk 'BEGIN {print "Name\tAge"; count=0}  # 表头和初始化
     {print $1 "\t" $2; count++}         # 处理每行
     END {print "Total: " count}' data.txt  # 汇总
```

## 五、动作（Action）：对匹配行的处理

动作由 `{ }` 包裹，包含打印、计算、条件判断等语句，支持常见编程逻辑：

### 1. 打印输出（`print` 和 `printf`）

- `print`：简单打印，默认添加换行符。

  ```bash
  awk '{print $1, "的年龄是", $2}' data.txt  # 输出 "Alice 的年龄是 25"
  ```

- `printf`：格式化打印（类似C语言，需显式指定换行 `\n`）。

  ```bash
  awk '{printf "Name: %-10s Age: %d\n", $1, $2}' data.txt  # 左对齐10位，数字格式
  ```

### 2. 变量与计算

支持数值/字符串变量，可进行加减乘除、字符串拼接等。

```bash
# 计算年龄总和并平均
awk 'BEGIN {sum=0} {sum += $2} END {print "平均年龄:", sum/NR}' data.txt
```

### 3. 条件语句（`if-else`）

```bash
# 根据年龄分类
awk '{
  if ($2 < 18) category = "未成年";
  else if ($2 < 60) category = "成年";
  else category = "老年";
  print $1, category
}' data.txt
```

### 4. 循环语句（`for`、`while`）

```bash
# 打印每行的所有字段（倒序）
awk '{
  for (i=NF; i>=1; i--) {  # 从最后一个字段到第一个
    printf "%s ", $i;
  }
  print ""  # 换行
}' data.txt
```

## 六、常用内置函数

`awk` 提供丰富的内置函数，覆盖字符串处理、数值计算、时间操作等：

### 1. 字符串函数

| 函数 | 功能 | 示例 |
|------|------|------|
| `length(str)` | 返回字符串长度（省略str则返回当前行长度） | `length("abc")` → `3`；`length($1)` → 姓名长度 |
| `substr(str, start, len)` | 提取子串（从start位置开始，取len个字符，start从1开始） | `substr("hello", 2, 3)` → `ell` |
| `index(str, substr)` | 返回子串在str中的位置（无则返回0） | `index("hello", "ll")` → `3` |
| `split(str, arr, sep)` | 按sep分割str到数组arr，返回字段数 | `split("a,b,c", arr, ",")` → `3`，`arr[1]`=a |
| `sub(regex, repl, str)` | 替换str中第一个匹配regex的子串为repl（默认str为$0） | `sub(/error/, "WARN", $0)` → 替换第一个error为WARN |
| `gsub(regex, repl, str)` | 全局替换（替换所有匹配，区别于sub） | `gsub(/error/, "WARN", $0)` → 替换所有error为WARN |
| `toupper(str)`/`tolower(str)` | 转换为大写/小写 | `toupper("abc")` → `ABC` |

### 2. 数值函数

| 函数 | 功能 | 示例 |
|------|------|------|
| `int(num)` | 取整数部分（截断小数） | `int(3.8)` → `3` |
| `sqrt(num)` | 平方根 | `sqrt(16)` → `4` |
| `rand()` | 生成0~1的随机数（需用`srand()`初始化） | `BEGIN {srand(); print rand()}` → 如 `0.382` |
| `srand(seed)` | 初始化随机数种子（无参数则用当前时间） | `srand(123)` → 固定种子，使rand()结果可复现 |

### 3. 时间函数

| 函数 | 功能 | 示例 |
|------|------|------|
| `systime()` | 返回当前时间戳（从1970-01-01 00:00:00到现在的秒数） | `systime()` → `1692500000` |
| `strftime(format, timestamp)` | 将时间戳格式化为字符串（默认用当前时间戳） | `strftime("%Y-%m-%d %H:%M:%S")` → `2023-08-20 15:30:00` |

## 七、高级用法示例

### 1. 日志分析：统计不同状态码的请求数（如nginx日志）

假设日志格式为 `IP 时间 "请求" 状态码 大小`：

```bash
awk '{status[$9]++}  # 用数组统计第9列（状态码）出现次数
     END {for (code in status) print code, status[code]}' access.log
```

### 2. 数据格式化：将空格分隔转为CSV

```bash
awk 'BEGIN {OFS=","} {print $1, $2, $3}' data.txt  # 用逗号分隔输出字段
```

### 3. 多文件处理：计算多个文件的总行数

```bash
awk 'END {print "总记录数:", NR}' file1.txt file2.txt  # NR是全局行号，累加所有文件
```

### 4. 自定义函数：计算平方和

```bash
awk '
function sum_squares(a, b) {  # 定义函数：计算a² + b²
  return a*a + b*b
}
{print $1, sum_squares($2, $3)}  # 调用函数，假设$2、$3是数值
' data.txt
```

## 八、注意事项

- **字段分隔符**：默认情况下，连续的空格/制表符会被视为一个分隔符（自动忽略空字段），若需保留空字段，需显式设置 `FS=""`。
- **字符串与数值**：`awk` 会自动转换类型（如 `"123" + 1` 结果为124），但建议显式处理避免歧义。
- **版本差异**：`awk` 有多个版本（如 `nawk`、`mawk`、`gawk`），GNU awk（`gawk`）支持更多扩展（如正则捕获组、多维数组），建议优先使用 `gawk`。

`awk` 的强大之处在于将模式匹配、字段处理和编程逻辑结合，通过灵活组合上述功能，可轻松应对复杂的文本处理任务。
