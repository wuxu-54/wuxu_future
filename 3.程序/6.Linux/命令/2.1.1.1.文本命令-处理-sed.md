# Linux sed 命令完全指南：从入门到精通

## 一、sed 命令简介

### 1.1 什么是 sed？

**sed（Stream Editor）** 是一种流编辑器，用于对文本进行过滤和转换。它以非交互式方式工作，逐行读取输入，应用用户指定的编辑命令，然后输出结果。sed 是 Linux/Unix 系统中最强大的文本处理工具之一，常用于日志分析、配置文件修改、数据清洗等场景。

### 1.2 sed 的历史与应用场景

sed 由 Lee E. McMahon 在 1973-1974 年间开发，最初用于 AT&T 贝尔实验室的 Unix 系统。如今，sed 已成为现代 Linux 发行版的标准组件，广泛应用于：

- 批量文本替换
- 日志文件过滤
- 配置文件自动化修改
- 数据格式转换
- 脚本编程中的文本处理

## 二、sed 基本工作原理

### 2.1 模式空间与保持空间

sed 的核心工作机制基于两个缓冲区：

- **模式空间（Pattern Space）**：当前正在处理的行
- **保持空间（Hold Space）**：辅助存储区，用于复杂操作

### 2.2 处理流程

1. 从输入读取一行到模式空间
2. 对模式空间应用所有编辑命令
3. 将模式空间内容输出到标准输出
4. 清空模式空间
5. 重复步骤 1-4 直到文件结束

## 三、sed 基本语法

### 3.1 命令格式

```bash
sed [选项] '编辑命令' [输入文件]
```

如果未指定输入文件，则从标准输入读取数据。

### 3.2 常用选项

| 选项       | 功能描述                                                     |
|------------|--------------------------------------------------------------|
| `-n`       | 抑制自动输出，仅显示通过 `p` 命令明确打印的内容            |
| `-e`       | 指定多个编辑命令，例如：`sed -e '命令1' -e '命令2' 文件`   |
| `-f` 文件  | 从文件读取编辑命令                                           |
| `-i`       | 直接修改输入文件（危险操作，建议先备份）                   |
| `-r`       | 使用扩展正则表达式（部分系统用 `-E` 替代）                  |
| `-s`       | 分别处理多个输入文件，而不是将它们视为一个连续的流         |

### 3.3 编辑命令基本格式

```bash
[地址范围]命令[参数]
```

- **地址范围**：可选，指定命令作用的行范围（如 `1,5` 表示第 1 到第 5 行）
- **命令**：sed 操作指令（如 `s` 替换、`d` 删除）
- **参数**：命令的参数（如 `s` 命令的替换模式）

## 四、sed 基础命令详解

### 4.1 替换命令（s）

**语法**：`s/模式/替换内容/标志`

**标志说明**：

- `g`：全局替换（替换一行中的所有匹配项）
- `数字`：替换第 N 个匹配项
- `p`：打印替换后的行（需配合 `-n` 使用）
- `i`：忽略大小写

**示例**：

```bash
# 将每行第一个 "apple" 替换为 "orange"
sed 's/apple/orange/' fruits.txt

# 全局替换（替换所有匹配项）
sed 's/apple/orange/g' fruits.txt

# 仅替换第 2 个匹配项
sed 's/apple/orange/2' fruits.txt

# 替换并打印修改后的行
sed -n 's/apple/orange/p' fruits.txt

# 忽略大小写替换
sed 's/apple/orange/gi' fruits.txt
```

### 4.2 删除命令（d）

**语法**：`[地址范围]d`

**示例**：

```bash
# 删除第 3 行
sed '3d' file.txt

# 删除包含 "error" 的行
sed '/error/d' log.txt

# 删除空行
sed '/^$/d' file.txt

# 删除第 10 行到文件末尾
sed '10,$d' file.txt

# 删除偶数行
sed 'n;d' file.txt
```

### 4.3 打印命令（p）

**语法**：`[地址范围]p`

**示例**：

```bash
# 打印第 5 行
sed -n '5p' file.txt

# 打印包含 "pattern" 的行
sed -n '/pattern/p' file.txt

# 打印第 10 行到第 20 行
sed -n '10,20p' file.txt

# 打印最后一行
sed -n '$p' file.txt
```

### 4.4 插入命令（i）和追加命令（a）

**语法**：

- `[地址范围]i\新内容`：在匹配行前插入内容
- `[地址范围]a\新内容`：在匹配行后追加内容

**示例**：

```bash
# 在第 1 行前插入注释
sed '1i\# This is a header' file.txt

# 在包含 "config" 的行后追加配置项
sed '/config/a\    new_option = value' config.txt

# 在文件末尾添加新行
sed '$a\End of file' file.txt
```

### 4.5 修改命令（c）

**语法**：`[地址范围]c\新内容`

**示例**：

```bash
# 将第 5 行替换为新内容
sed '5c\This line has been replaced' file.txt

# 将所有包含 "old" 的行替换为 "new"
sed '/old/c\new' file.txt
```

### 4.6 复制命令（y）

**语法**：`y/源字符集/目标字符集/`

**示例**：

```bash
# 将所有小写字母转换为大写
sed 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/' file.txt

# 替换特殊字符
sed 'y/|/ /' data.txt  # 将所有 | 替换为空格
```

## 五、地址范围与正则表达式

### 5.1 地址范围表示法

- **数字地址**：`5`（第 5 行）、`10,20`（第 10 到 20 行）
- **正则表达式地址**：`/pattern/`（匹配正则的行）
- **混合地址**：`/start/,/end/`（从匹配 `start` 到匹配 `end` 的行）
- **相对地址**：`5,+3`（第 5 行及其后 3 行）

### 5.2 正则表达式

sed 默认使用基础正则表达式（BRE），部分功能需转义：

| 元字符   | 含义               | BRE 写法 | 扩展正则（ERE）写法 |
|----------|--------------------|----------|---------------------|
| `*`      | 零次或多次匹配     | `\*`     | `*`                 |
| `+`      | 一次或多次匹配     | `\+`     | `+`                 |
| `?`      | 零次或一次匹配     | `\?`     | `?`                 |
| `()`     | 分组               | `\(\)`   | `()`                |
| `\|`     | 或操作             | `\|`     | `|`                 |

**示例**：

```bash
# 匹配以数字开头的行
sed -n '/^[0-9]/p' file.txt

# 匹配包含 IP 地址的行（使用扩展正则）
sed -nr '/[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+/p' log.txt

# 匹配邮箱地址
sed -nr '/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/p' contacts.txt
```

### 5.3 反向引用

使用 `\( \)` 分组，通过 `\1`, `\2` 引用分组内容：

```bash
# 交换姓和名
sed 's/\(John\) \(Doe\)/\2, \1/' names.txt  # 输出 "Doe, John"

# 提取日期中的年、月、日
sed -r 's/([0-9]{4})-([0-9]{2})-([0-9]{2})/\3\/\2\/\1/' dates.txt  # 2023-05-15 → 15/05/2023
```

## 六、sed 高级命令与技巧

### 6.1 保持空间命令

| 命令 | 功能描述 |
|------|----------|
| `h`  | 将模式空间复制到保持空间 |
| `H`  | 将模式空间追加到保持空间 |
| `g`  | 将保持空间复制到模式空间 |
| `G`  | 将保持空间追加到模式空间 |
| `x`  | 交换模式空间和保持空间 |

**示例：反转文件内容**：

```bash
sed -n '1!G;h;$p' file.txt
```

### 6.2 分支与跳转命令

| 命令 | 功能描述 |
|------|----------|
| `b`  | 无条件跳转 |
| `t`  | 如果上一次替换成功则跳转 |
| `:label` | 定义标签 |

**示例：条件替换**：

```bash
sed ':a; s/foo/bar/; t a' file.txt  # 重复替换直到没有更多匹配
```

### 6.3 多行操作

```bash
# 合并连续的空行为单个空行
sed '/^$/{N;/^\n$/D}' file.txt

# 处理多行记录（例如：合并姓名和地址）
sed '/^Name:/{N; s/\nAddress:/: /}' contacts.txt
```

### 6.4 使用脚本文件

创建 `script.sed`：

```bash
#!/bin/sed -f
# 注释行
s/old/new/g
/^#/d
$a\This is the end
```

执行：

```bash
chmod +x script.sed
./script.sed input.txt
```

或

```bash
sed -f script.sed input.txt
```

## 七、实用案例与最佳实践

### 7.1 配置文件管理

```bash
# 修改 Nginx 配置中的端口
sed -i 's/listen 80;/listen 8080;/' nginx.conf

# 启用配置项（取消注释）
sed -i 's/^#\(server_names_hash_bucket_size\)/\1/' nginx.conf

# 替换数据库连接字符串
sed -i 's/connection_string = ".*"/connection_string = "new_value"/' config.ini
```

### 7.2 日志分析与过滤

```bash
# 提取错误日志
sed -n '/ERROR/p' application.log

# 统计请求次数
sed -n 's/.*"\(GET\|POST\) .*"/\1/p' access.log | sort | uniq -c

# 提取 IP 地址
sed -nr 's/^([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+).*/\1/p' access.log
```

### 7.3 数据格式转换

```bash
# CSV 转 TSV
sed 's/,/\t/g' data.csv > data.tsv

# 提取 HTML 中的链接
sed -nr 's/.*<a href="([^"]+)".*/\1/p' index.html

# 格式化 JSON（简化版）
sed -e 's/{/{\n  /g' -e 's/,/,\n  /g' -e 's/}/\n}/g' raw.json
```

### 7.4 安全操作建议

- 使用 `-i.bak` 创建备份：`sed -i.bak 's/old/new/' file.txt`
- 在处理重要文件前先测试：`sed 's/old/new/' file.txt > temp.txt && mv temp.txt file.txt`
- 使用扩展正则时明确指定 `-r` 选项，避免兼容性问题

## 八、sed 与其他工具的比较

### 8.1 sed vs awk

- **sed**：专注于简单的文本替换、删除和过滤
- **awk**：更适合复杂的数据处理、字段提取和计算

### 8.2 sed vs grep

- **sed**：修改和转换文本
- **grep**：仅用于文本搜索和过滤

### 8.3 sed vs 编辑器（vim/emacs）

- **sed**：非交互式、适合自动化脚本
- **编辑器**：交互式、适合复杂手动编辑

## 九、常见问题与解决方案

### 9.1 特殊字符转义

```bash
# 替换包含 $ 的字符串
sed 's/\$/USD/g' prices.txt

# 替换斜杠
sed 's/\//\\\//g' paths.txt  # 替换 / 为 \/
```

### 9.2 处理包含换行符的文本

```bash
# 读取整个文件到模式空间（GNU sed）
sed -z 's/\n/ /g' multiline.txt
```

### 9.3 提高大文件处理效率

- 使用 `-n` 抑制自动输出
- 避免不必要的正则匹配
- 考虑使用 `awk` 处理复杂的大数据集

## 十、总结与进阶资源

### 10.1 核心要点回顾

- sed 是强大的非交互式文本处理工具
- 掌握替换、删除、打印等基础命令
- 理解模式空间和保持空间的工作原理
- 熟练使用正则表达式和反向引用
- 注意安全操作和性能优化

### 10.2 进阶学习资源

- 《Sed & Awk》（Arnold Robbins 著）
- GNU sed 官方文档：<https://www.gnu.org/software/sed/manual/>
- 在线练习平台：<https://regex101.com/>
- 社区论坛：Stack Overflow、Unix & Linux Stack Exchange

通过系统学习和实践，sed 将成为你日常工作中不可或缺的文本处理利器。
