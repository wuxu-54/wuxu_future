# top监控

`top` 是 Linux/Unix 系统中实时监控进程资源占用的核心命令，能动态显示 CPU、内存、进程状态等信息。以下是其详细用法及全选项说明，按功能分类整理：

## 一、基础用法

```bash
top  # 直接运行，进入交互式界面（按 q 退出）
```

默认界面展示：

- 顶部：系统概览（运行时间、负载、CPU/内存使用率、进程总数等）。
- 中部：进程列表（默认按 CPU 使用率排序），包含 PID（进程ID）、USER（所有者）、%CPU、%MEM 等字段。

## 二、核心选项（启动时指定）

| 选项 | 功能说明 | 示例 |
|------|----------|------|
| `-d <秒数>` | 设置刷新间隔（默认3秒，支持小数如 `-d 0.5`） | `top -d 1` → 每秒刷新一次 |
| `-n <次数>` | 刷新指定次数后退出（非交互式） | `top -n 3` → 刷新3次后自动退出 |
| `-b` | 批处理模式（非交互式，可输出到文件或管道） | `top -b -n 1 > top.log` → 将一次快照保存到文件 |
| `-p <PID1,PID2>` | 只监控指定 PID 的进程（多个用逗号分隔） | `top -p 123,456` → 仅显示 PID 为123和456的进程 |
| `-u <用户>` | 只显示指定用户的进程 | `top -u root` → 仅显示 root 用户的进程 |
| `-H` | 显示线程模式（将进程的线程作为独立条目显示） | `top -H -p 123` → 显示 PID 123 进程的所有线程 |
| `-i` | 不显示闲置（IDLE）进程 | `top -i` → 过滤掉 CPU 使用率为0的进程 |
| `-c` | 显示进程的完整命令行（默认只显示命令名） | `top -c` → 例如显示 `/usr/bin/nginx -c /etc/nginx/nginx.conf` 而非 `nginx` |
| `-s <列号>` | 启动时按指定列排序（需配合内部排序键，见下文） | `top -s 3` → 按第3列（%CPU）排序（默认） |
| `-o <字段>` | 按指定字段排序（更直观，字段名见交互模式） | `top -o %MEM` → 启动时按内存使用率排序 |
| `-w` | 宽屏模式（显示更多列，避免字段截断） | `top -w` → 适合查看长命令行或多列信息 |

## 三、交互式操作（进入 top 后按以下键）

进入 `top` 界面后，可通过快捷键实时调整显示和排序，常用操作：

### 1. 排序相关

| 按键 | 功能 | 对应字段 |
|------|------|----------|
| `P` | 按 **CPU 使用率** 降序排序（默认） | `%CPU` |
| `M` | 按 **内存使用率** 降序排序 | `%MEM` |
| `N` | 按 **PID** 升序排序 | `PID` |
| `T` | 按 **累计运行时间** 降序排序 | `TIME+` |
| `R` | 反转当前排序（升序 ↔ 降序） | - |
| `O`（大写） | 手动选择排序字段（输入字段名，如 `%MEM`） | 所有字段 |

### 2. 显示控制

| 按键 | 功能 |
|------|------|
| `q` | 退出 top |
| `h` 或 `?` | 显示帮助信息（快捷键说明） |
| `k` | 终止指定进程（输入 PID 并按回车，默认发送 SIGTERM 信号） |
| `r` | 重新设置进程优先级（输入 PID 和 nice 值，范围 -20~19，值越小优先级越高） |
| `z` | 切换彩色/黑白显示（彩色更易区分状态） |
| `b` | 加粗显示当前排序列（突出显示排序依据） |
| `x` | 高亮显示当前排序列（背景色突出） |
| `c` | 切换显示 **命令名** / **完整命令行**（与启动选项 `-c` 功能相同） |
| `i` | 切换是否显示闲置进程（与启动选项 `-i` 功能相同） |
| `S`（大写） | 切换累计时间模式（`TIME+` 字段显示格式） |
| `l`（小写 L） | 隐藏/显示顶部系统负载信息（第一行） |
| `t` | 隐藏/显示 CPU 状态信息（第二行） |
| `m` | 隐藏/显示内存状态信息（第三、四行） |
| `1`（数字1） | 展开 CPU 核心（多核心时显示每个核心的使用率） |

### 3. 筛选与搜索

| 按键 | 功能 |
|------|------|
| `u` | 输入用户名，只显示该用户的进程（与启动选项 `-u` 相同） |
| `p` | 输入 PID，只显示该进程（与启动选项 `-p` 相同） |
| `/` | 输入关键词，搜索进程命令行（按 `n` 跳至下一个匹配） |

### 4. 列调整（自定义显示字段）

| 按键 | 功能 |
|------|------|
| `f` 或 `F` | 进入字段选择界面（按 `a-z` 切换字段显示/隐藏，按 `Enter` 确认） |
| `o` 或 `O` | 调整字段显示顺序（在字段选择界面按 `上下键` 移动，按 `Enter` 确认） |
| `s` | 设置刷新间隔（与启动选项 `-d` 相同） |

## 四、顶部系统信息解读（默认前5行）

1. **第一行：任务队列与负载**  
   `top - 15:30:00 up 5 days, 2h,  1 user,  load average: 0.50, 0.30, 0.20`  
   - `15:30:00`：当前时间  
   - `up 5 days, 2h`：系统运行时间  
   - `1 user`：当前登录用户数  
   - `load average: 0.50, 0.30, 0.20`：1/5/15分钟系统负载（数值 ≤ CPU核心数为正常）

2. **第二行：进程总数**  
   `Tasks: 200 total,   1 running, 199 sleeping,   0 stopped,   0 zombie`  
   - `total`：总进程数  
   - `running`：正在运行的进程数  
   - `sleeping`：休眠进程数  
   - `stopped`：停止的进程数  
   - `zombie`：僵尸进程数（需关注，过多可能占用资源）

3. **第三行：CPU 使用率（汇总）**  
   `%Cpu(s): 10.0 us,  5.0 sy,  0.0 ni, 85.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st`  
   - `us`（user）：用户空间CPU使用率  
   - `sy`（system）：内核空间CPU使用率  
   - `ni`（nice）：低优先级用户进程CPU使用率  
   - `id`（idle）：CPU空闲率  
   - `wa`（iowait）：CPU等待IO的时间占比（过高可能是磁盘IO瓶颈）  
   - `hi`/`si`：硬件/软件中断占用CPU时间  
   - `st`（steal）：虚拟机被宿主机抢占的CPU时间（仅虚拟机可见）

4. **第四/五行：内存信息**  
   `MiB Mem :  16000.0 total,   8000.0 free,   5000.0 used,   3000.0 buff/cache`  
   `MiB Swap:   4000.0 total,   3000.0 free,   1000.0 used.  10000.0 avail Mem`  
   - `total`：总内存  
   - `free`：完全空闲的内存  
   - `used`：已使用的内存  
   - `buff/cache`：用于缓存和缓冲区的内存（可释放）  
   - `avail Mem`：可用内存（含可释放的缓存）  

## 五、高级用法示例

1. **非交互式导出进程快照**（用于脚本分析）：  

   ```bash
   top -b -n 1 -o %MEM | head -n 20  # 导出内存占用前20的进程快照
   ```

2. **监控特定进程的线程**（分析多线程程序资源占用）：  

   ```bash
   top -H -p $(pgrep nginx)  # 显示所有 nginx 进程的线程
   ```

3. **按用户统计CPU使用率**（结合 `grep` 和 `awk`）：  

   ```bash
   top -b -n 1 | grep -v "PID" | awk '{print $2}' | sort | uniq -c  # 统计每个用户的进程数
   ```

4. **持续监控并记录高CPU进程**：  

   ```bash
   top -b -d 5 -n 12 | grep -E "PID|%CPU" > high_cpu.log  # 每5秒记录一次，共12次
   ```

## 六、注意事项

- **与 `htop` 的区别**：`top` 是系统自带工具，`htop` 是增强版（支持鼠标操作、更直观的界面），但需额外安装。
- **权限问题**：非 root 用户只能查看自己的进程，root 可查看所有进程。
- **资源消耗**：`top` 本身会占用少量 CPU（通常 < 1%），高频刷新（如 `-d 0.1`）可能增加开销。

通过灵活使用 `top` 的选项和交互式操作，可快速定位 CPU/内存占用异常的进程，是系统性能调优和故障排查的必备工具。
