# 模块

---

## Rust 模块系统详解：从基础到实践

---

### **1. 模块基础**

**模块（Module）**是 Rust 中代码组织的核心单元，通过 `mod` 关键字定义，形成树状结构。每个模块可包含函数、结构体、枚举、常量等，并控制其可见性。

#### **核心规则**

- **默认私有性**：模块内的项（函数、结构体等）默认私有，需用 `pub` 关键字公开。
- **路径访问**：通过绝对路径（`crate::`）或相对路径（`self`/`super`）访问模块中的项。
- **模块树结构**：模块树以 `crate` 为根，所有模块嵌套在根下。

**示例**：

```rust
// src/lib.rs
mod front_of_house {
    pub mod hosting {
        pub fn add_to_waitlist() {}
    }
}

pub fn eat_at_restaurant() {
    // 绝对路径
    crate::front_of_house::hosting::add_to_waitlist();
    // 相对路径
    front_of_house::hosting::add_to_waitlist();
}
```

---

### **2. 模块的可见性与访问控制**

#### **`pub` 关键字**

- **模块级**：`pub mod` 公开模块，允许外部访问。
- **项级**：`pub` 标记函数、结构体等，控制其可见性。
- **结构体与枚举**：
  - 结构体字段需单独标记 `pub`。
  - 枚举变体默认全部公开。

**示例**：

```rust
mod back_of_house {
    pub struct Breakfast {
        pub toast: String,     // 公有字段
        seasonal_fruit: String, // 私有字段
    }

    pub enum Appetizer { Soup, Salad } // 变体自动公开
}
```

#### **跨模块访问**

- **父模块可访问子模块的公有项**，但不可访问私有项。
- **子模块可访问祖先模块的私有项**（Rust 的“向上可见性”规则）。

---

### **3. 路径与 `use` 关键字**

#### **路径类型**

这里是不通过mod导入，直接以路径方式访问模块

- **绝对路径**：从 `crate::` 开始，适用于跨模块访问。
- **相对路径**：使用 `self`（当前模块）、`super`（父模块）或直接模块名。

**示例**：

```rust
// 在子模块中使用父模块的项
mod serving {
    fn fix_order() {
        super::hosting::add_to_waitlist(); // 通过super访问父模块
    }
}
```

#### **`use` 关键字**

- 将路径引入当前作用域，简化代码。
- **重导出（`pub use`）**：允许外部代码通过新路径访问内部项。

**示例**：

```rust
use crate::front_of_house::hosting;
pub use self::front_of_house::hosting; // 重导出

fn main() {
    hosting::add_to_waitlist();
}
```

---

### **4. 模块拆分与文件组织**

#### **模块拆分为文件**

- **单文件模块**：`mod module_name;` 会查找 `module_name.rs` 或 `module_name/mod.rs`。
- **目录模块**：目录名作为模块名，入口文件为 `mod.rs` 或与目录同名的 `.rs` 文件。

**目录结构示例**：

```txt
src/
├── lib.rs
├── front_of_house.rs      // 模块 front_of_house
└── front_of_house/
    ├── hosting.rs         // 子模块 hosting
    └── serving.rs         // 子模块 serving
```

**代码示例**：

```rust
// src/lib.rs
mod front_of_house; // 引入 front_of_house 模块

// src/front_of_house.rs
pub mod hosting;
pub mod serving;

// src/front_of_house/hosting.rs
pub fn add_to_waitlist() {}
```

---

### **5. 高级用法与常见问题**

#### **`as` 别名**

解决命名冲突：

```rust
use std::io as Io;
```

#### **Glob 运算符**

引入模块所有公有项（慎用）：

```rust
use std::collections::*;
```

#### **工作空间（Workspace）**

管理多个关联包：

```toml
# Cargo.toml
[workspace]
members = ["crate1", "crate2"]
```

---

### **6. 常见问题解决**

1. **“找不到模块”错误**  
   - 检查 `mod` 声明与文件路径是否匹配。
   - 确保模块文件位于 `src/` 下的正确目录。

2. **可见性错误**  
   - 确认是否遗漏 `pub` 关键字。
   - 子模块无法直接访问同级模块的私有项。

3. **循环依赖**  
   - 使用 `pub use` 或重构模块结构。

---

### 标准库

在学习了本章的概念之后，我们可以轻松的导入系统库([Rust 官方标准库字典](https://doc.rust-lang.org/stable/std/all.html)
)来方便的开发程序了：

```rust
use std::f64::consts::PI;

fn main() {
    println!("{}", (PI / 2.0).sin());
}
```

>所有的系统库模块都是被默认导入的，所以在使用的时候只需要使用 use 关键字简化路径就可以方便的使用了。

---

### **总结**

- **模块**是代码的逻辑组织单元，通过树状结构管理作用域。
- **路径**和 `use` 简化跨模块访问，`pub` 控制可见性。
- **文件拆分**遵循约定：`mod module_name` 对应 `module_name.rs` 或目录。
- **Cargo** 管理包和依赖，`Cargo.toml` 定义项目元数据。

掌握模块系统能有效提升代码可维护性，适用于从简单脚本到大型工作空间的所有场景。
