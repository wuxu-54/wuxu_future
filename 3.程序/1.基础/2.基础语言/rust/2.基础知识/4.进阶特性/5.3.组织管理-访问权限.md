# 访问权限

在 Rust 语言中，访问权限控制主要通过模块系统（Module System）和 `pub` 关键字实现，其核心机制基于 **模块可见性规则** 和 **作用域隔离**。

可见性规则：

1. 默认规则：
    - 所有项默认私有
    - 子模块可以使用父模块的内容
    - 父模块不能使用子模块的私有内容

2. pub关键字：
    - 将项标记为公开可见
    - 可应用于模块、函数、结构体等
    - 结构体字段需要单独标记pub

3. 可见性级别：
    - pub: 完全公开
    - pub(crate): 仅在当前包内可见
    - pub(super): 仅在父模块可见
    - pub(in path): 仅在指定路径可见

以下是详细说明：

---

## 一、基础访问权限机制

1. **默认私有（Private）**
   - Rust 中所有项（item）默认是**私有**的，包括：
     - 函数、结构体、枚举、常量、模块等
     - 结构体字段默认私有（需显式标记 `pub` 才能公开）
     - 模块内定义的项只能被同一模块或其子模块访问

2. **公有（Public）**
   - 使用 `pub` 关键字显式公开项：

     ```rust
     pub fn public_function() {} // 全局可访问
     pub struct PublicStruct {  // 结构体公开
         pub field: i32,        // 字段需单独标记 pub 才能公开
     }
     ```

3. **受限可见性**
   - 通过 `pub(...)` 语法限制可见范围：

     ```rust
     pub(crate) fn internal_util() {}  // 仅当前 crate 可见
     pub(super) fn parent_module_fn() {} // 仅父模块可见
     pub(in path::to::module) fn specific_visibility() {} // 指定模块可见
     ```

---

## 二、模块系统的可见性规则

### 1. 模块层次与访问关系

```rust
mod outer {
    pub mod inner {
        pub fn public_in_inner() {}
        fn private_in_inner() {}
    }

    fn test() {
        inner::public_in_inner();  // ✅ 父模块可访问子模块的公共项
        // inner::private_in_inner(); ❌ 无法访问子模块私有项
    }
}

// 外部访问
fn main() {
    outer::inner::public_in_inner(); // ✅ 通过公有路径访问
}
```

### 2. `pub use` 重导出

- 将深层次模块的项提升到更外层作用域：

  ```rust
  mod network {
      pub mod http {
          pub fn connect() {}
      }
  }
  
  // 重导出简化访问路径
  pub use network::http::connect;
  
  fn main() {
      connect(); // 直接调用，无需完整路径
  }
  ```

---

## 三、结构体与枚举的可见性

### 1. 结构体字段控制

```rust
pub struct User {
    pub username: String,   // 公有字段
    age: u32,               // 私有字段（外部无法直接访问）
}

impl User {
    // 提供公共方法访问私有字段
    pub fn get_age(&self) -> u32 {
        self.age
    }
}
```

### 2. 枚举的可见性

- 枚举变体（variants）的可见性继承自枚举本身：

  ```rust
  pub enum Status {
      PublicVariant,      // 自动公有
      #[allow(dead_code)]
      PrivateVariant,     // 虽然枚举公有，但未使用的变体会警告
  }
  ```

---

## 四、高级权限管理技巧

### 1. 使用 `mod` 组织代码

```rust
// src/lib.rs
pub mod api;        // 公开模块
mod internal {      // 私有模块（仅当前 crate 可见）
    pub(crate) fn helper() {}
}
```

### 2. 测试模块的特殊权限

- 测试模块可访问父模块的私有项：

  ```rust
  #[cfg(test)]
  mod tests {
      use super::*; // 导入父模块所有项（包括私有）
      
      #[test]
      fn test_private_function() {
          assert_eq!(private_function(), 42);
      }
  }
  ```

---

## 五、关键总结

| 特性               | 描述                                                                 |
|--------------------|----------------------------------------------------------------------|
| **默认私有**       | 所有项默认仅在定义模块内可见                                        |
| **`pub` 关键字**   | 显式公开项，支持不同级别的可见性限制（如 `pub(crate)`）             |
| **结构体字段**     | 需单独标记 `pub` 才能公开                                           |
| **模块路径控制**   | 使用 `pub use` 重导出简化外部接口                                   |
| **测试模块特权**   | 测试代码可访问父模块的私有项                                        |

通过合理组合这些机制，开发者可以精确控制代码的暴露范围，实现安全的封装与模块化设计。
