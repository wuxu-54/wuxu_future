# 组织管理简介

Rust 的代码组织管理系统是其工程化设计的核心，通过模块（Module）、包（Package）、Crate 和工作空间（Workspace）等机制，提供了灵活的代码组织和复用能力。

## 组织管理-箱、包、模块

在 Rust 中，**箱（Crate）**、**包（Package）** 和 **模块（Module）** 是代码组织和管理的核心机制。
>wuxu：代码组织管理，箱：文件（类似java中的.java文件）、包：文件夹（类似java中的包名）、模块：项目中的不同模块（类似java中的类包装，有主入口）

---

## 介绍

### 一、基础单元：模块（Module）

#### 1. 模块定义

- **作用**：代码逻辑分组、管理可见性（公有/私有）。
- **声明方式**：

  ```rust
  mod my_module {  // 内联模块
      pub fn public_func() {}
      fn private_func() {}
  }
  ```

- **文件模块**：将模块拆分为独立文件

  ```rust
  // 文件结构
  src/
    main.rs
    my_module.rs   // 或 my_module/mod.rs

  // main.rs 中声明
  mod my_module;  // 从 my_module.rs 或 my_module/mod.rs 加载模块
  ```

#### 2. 模块路径与访问

- **绝对路径**：从 crate 根开始，格式为 `crate::path::to::item`
- **相对路径**：从当前模块开始，使用 `self`、`super` 或同级模块名
- **可见性规则**：
  - 默认私有（仅模块内部和子模块可见）
  - 通过 `pub` 关键字开放访问权限

    ```rust
    pub mod inner {
        pub(crate) fn semi_public() {}  // 当前 crate 可见
        pub(super) fn parent_visible() {}  // 父模块可见
    }
    ```

#### 3. 使用 `use` 简化路径

- 引入路径到当前作用域：

  ```rust
  use std::collections::HashMap;
  use crate::my_module::inner::public_func as func;
  ```

- 支持重导出（Re-export）：

  ```rust
  pub use crate::my_module::inner;  // 外部可通过当前模块访问 inner
  ```

例如：文件A中的函数路径太长，在文件B中使用时可以通过use先指定路径，后面直接调用函数名即可。

caculate_tool.rs:

```rust
//模拟计算器
use std::io;

pub  fn  caculateTool(){
    // + - * /
    println!("请输入第一个数字：");

}
```

main.rs:

```rust
mod caculate_tool; //声明
use crate::caculate_tool::caculateTool;

fn main() {
    caculateTool();//由于use声明了路径，这里直接调用函数即可
}
```

---

### 二、包（Package）与 Crate

#### 1. 核心概念

- **Crate**：Rust 的编译单元，分为：
  - **二进制 Crate**（可执行程序）：入口为 `src/main.rs`
  - **库 Crate**（共享代码）：入口为 `src/lib.rs`
- **Package**：包含一个 `Cargo.toml` 和至少一个 Crate，可包含多个二进制 Crate 和一个库 Crate。

#### 2. 包结构示例

```txt
my_package/
  Cargo.toml
  src/
    main.rs          # 二进制 Crate 入口
    lib.rs           # 库 Crate 入口
    bin/             # 多个二进制文件
      tool1.rs
      tool2.rs
    utils/           # 模块目录
      mod.rs         # utils 模块声明
      helper.rs      # 子模块
```

#### 3. Cargo.toml 关键配置

```toml
[package]
name = "my_package"
version = "0.1.0"

[dependencies]          # 外部依赖
serde = "1.0"

[dev-dependencies]     # 测试依赖
testcontainers = "3.0"

[[bin]]                # 自定义二进制目标
name = "tool1"
path = "src/bin/tool1.rs"
```

---

### 三、复杂模块的文件组织

#### 1. 多文件模块规则

- **模块树**：目录结构反映模块层次。
- **文件约定**：
  - `mod.rs` 或同名的 `.rs` 文件定义模块内容。
  - 示例：

    ```txt
    src/
      network/
        mod.rs         // 声明模块：pub mod server;
        server.rs      // 子模块实现
    ```

有点像c中的 `.h` 和 `.c` 文件。`mod.rs`中声明，`server.rs`中实现

#### 2. 示例：跨模块引用

```rust
// src/network/mod.rs
pub mod server;  // 引入 server.rs 作为子模块

// src/network/server.rs
pub fn connect() { println!("Server connected!"); }

// src/main.rs
mod network;
use network::server::connect;

fn main() {
    connect();
}
```

---

### 四、可见性控制

#### 1. 精细化的访问权限

- **层级**：
  - `pub`: 全局公开
  - `pub(crate)`: 当前 crate 内可见
  - `pub(super)`: 父模块可见
  - `pub(in path)`: 指定路径可见，如 `pub(in crate::utils)`

#### 2. 结构体可见性

```rust
pub struct Breakfast {
    pub toast: String,   // 字段需单独设置 pub
    seasonal_fruit: String,  // 默认私有
}

impl Breakfast {
    pub fn summer(toast: &str) -> Self { /* 工厂方法 */ }
}
```

---

### 五、测试组织

#### 1. 单元测试

- **同文件测试**：

  ```rust
  #[cfg(test)]
  mod tests {
      use super::*;

      #[test]
      fn test_func() { assert_eq!(func(), 42); }
  }
  ```

#### 2. 集成测试

- **独立目录**：项目根目录下的 `tests/`

  ```txt
  tests/
    integration_test.rs
  ```

- **注意**：集成测试需通过 `extern crate` 导入库 Crate。

---

### 六、工作空间（Workspace）

#### 1. 多包联合管理

- **共享配置**：统一依赖版本和构建输出。
- **目录结构**：

  ```txt
  my_workspace/
    Cargo.toml         # 工作空间配置
    pkg1/
      Cargo.toml       # 子包配置
      src/
    pkg2/
      Cargo.toml
      src/
  ```

#### 2. 工作空间 Cargo.toml

```toml
[workspace]
members = ["pkg1", "pkg2"]
resolver = "2"  # 可选，用于统一依赖解析
```

---

### 七、最佳实践

1. **模块拆分原则**：单一职责，一个模块专注于一个功能。
2. **路径简洁性**：使用 `use` 缩短长路径，但避免过度简化导致歧义。
3. **可见性最小化**：优先限制为私有，逐步开放必要接口。
4. **测试分层**：单元测试靠近代码，集成测试验证外部行为。
5. **工作空间适用场景**：大型项目或多关联包协同开发。

通过合理运用这些机制，可以构建出结构清晰、易于维护的 Rust 项目。
