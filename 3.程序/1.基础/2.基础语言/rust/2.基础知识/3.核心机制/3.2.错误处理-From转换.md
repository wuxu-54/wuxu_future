# From 转换

在 Rust 中，`From` 和 `Into` trait 用于处理类型之间的安全转换。它们是 trait 系统的重要组成部分，允许你定义类型之间的显式转换规则。以下是关键知识点和示例：

---

## 1. **`From` Trait**

`From<T>` trait 允许类型 `U` 从类型 `T` 转换而来。实现 `From<T>` 会自动获得 `Into<U>` 的实现。

```rust
trait From<T> {
    fn from(value: T) -> Self;
}
```

### 示例：将 `i32` 转换为自定义类型

```rust
struct Point {
    x: i32,
    y: i32,
}

impl From<i32> for Point {
    fn from(value: i32) -> Self {
        Point { x: value, y: value }
    }
}

fn main() {
    let p = Point::from(42); // 使用 From
    let p: Point = 42.into(); // 自动获得 Into 实现
}
```

---

## 2. **`Into` Trait**

`Into<U>` 是 `From<T>` 的逆操作，但通常推荐优先实现 `From<T>`，因为 Rust 会为所有实现了 `From<T>` 的类型自动实现 `Into<U>`。

```rust
trait Into<T> {
    fn into(self) -> T;
}
```

---

## 3. **`TryFrom` 和 `TryInto`**

当转换可能失败时（例如数据截断或无效值），使用 `TryFrom` 和 `TryInto`，它们返回 `Result` 类型。

```rust
use std::convert::TryFrom;

impl TryFrom<u32> for u16 {
    type Error = String;

    fn try_from(value: u32) -> Result<Self, Self::Error> {
        if value <= u16::MAX as u32 {
            Ok(value as u16)
        } else {
            Err("Value too large for u16".to_string())
        }
    }
}

fn main() {
    let x: u32 = 65536;
    match u16::try_from(x) {
        Ok(v) => println!("Converted: {}", v),
        Err(e) => println!("Error: {}", e),
    }
}
```

---

## 4. **常见场景**

### 场景 1：字符串转换

```rust
struct User {
    name: String,
}

impl From<&str> for User {
    fn from(name: &str) -> Self {
        User { name: name.to_string() }
    }
}

fn main() {
    let user = User::from("Alice");
    let user: User = "Bob".into();
}
```

### 场景 2：结构体之间的转换

```rust
struct Celsius(f64);
struct Fahrenheit(f64);

impl From<Celsius> for Fahrenheit {
    fn from(c: Celsius) -> Self {
        Fahrenheit(c.0 * 1.8 + 32.0)
    }
}

fn main() {
    let c = Celsius(100.0);
    let f = Fahrenheit::from(c);
}
```

---

## 5. **孤儿规则（Orphan Rule）**

Rust 要求：在实现 trait 时，要么 trait 定义在当前 crate，要么类型定义在当前 crate。这避免了不同 crate 之间的冲突。

✅ 允许：

```rust
// 当前 crate 的类型
struct MyType;

impl From<i32> for MyType { /* ... */ }
```

❌ 不允许：

```rust
// 尝试为外部类型实现外部 trait
impl From<SomeExternalType> for AnotherExternalType { /* ... */ }
```

---

## 6. **选择 `From` vs `Into`**

- 优先实现 `From<T>`，因为它会自动提供 `Into<U>`。
- 当需要从外部类型转换到你的类型时，使用 `From`。
- 当需要将你的类型转换到外部类型时，使用 `Into`（但受孤儿规则限制）。

---

## 总结

- **`From`/`Into`**：用于无错误的、必定成功的转换。
- **`TryFrom`/`TryInto`**：用于可能失败的转换。
- 遵循孤儿规则，确保类型或 trait 中至少有一个定义在当前 crate。
- 优先实现 `From` 以自动获得 `Into` 的实现。
