# 函数

以下是 Rust 函数的详细解析，涵盖定义、调用、参数传递和返回值等核心内容：

---

## 一、函数定义

### 1. 基础语法

```rust
// 无参数无返回值
fn greet() {
    println!("Hello, Rust!");
}

// 带参数和返回值
fn add(a: i32, b: i32) -> i32 {
    a + b // 隐式返回（无分号）
}
```

**关键点**：

- 使用 `fn` 关键字定义
- 参数必须显式声明类型
- 返回值类型用 `->` 指定
- 最后一个表达式隐式返回，或用 `return` 显式返回

---

## 二、函数调用

### 1. 基本调用

```rust
fn main() {
    greet(); // 输出: Hello, Rust!
    
    let sum = add(5, 3);
    println!("5 + 3 = {}", sum); // 输出: 8
}
```

### 2. 方法调用（关联函数）

```rust
struct Rectangle {
    width: u32,
    height: u32,
}

impl Rectangle {
    // 关联函数（类似构造函数）
    fn new(w: u32, h: u32) -> Self {
        Rectangle { width: w, height: h }
    }

    // 实例方法
    fn area(&self) -> u32 {
        self.width * self.height
    }
}

fn main() {
    let rect = Rectangle::new(10, 20);
    println!("面积: {}", rect.area()); // 输出: 200
}
```

---

## 三、参数传递

### 1. 值传递（所有权转移）

```rust
fn take_ownership(s: String) {
    println!("获得所有权: {}", s);
}

fn main() {
    let s = String::from("Hello");
    take_ownership(s); // s的所有权转移给函数
    // println!("{}", s); // 错误！s已失效
}
```

### 2. 引用传递（不转移所有权）

```rust
fn borrow_string(s: &String) -> usize {
    s.len() // 只读借用
}

fn modify_string(s: &mut String) {
    s.push_str(", World!");
}

fn main() {
    let mut s = String::from("Hello");
    let len = borrow_string(&s);
    println!("长度: {}", len); // 输出: 5
    
    modify_string(&mut s);
    println!("修改后: {}", s); // 输出: Hello, World!
}
```

---

## 四、返回值处理

### 1. 基本返回值

```rust
fn max(a: i32, b: i32) -> i32 {
    if a > b { a } else { b }
}
```

### 2. 返回多个值（元组）

```rust
fn calculate(a: i32, b: i32) -> (i32, i32) {
    (a + b, a * b)
}

fn main() {
    let (sum, product) = calculate(4, 5);
    println!("和: {}, 积: {}", sum, product); // 输出: 9, 20
}
```

### 3. 返回所有权

```rust
fn create_string() -> String {
    String::from("New String")
}

fn main() {
    let s = create_string(); // 函数返回值的所有权转移给s
    println!("{}", s);
}
```

---

## 五、高阶函数特性

### 1. 函数作为参数

```rust
fn apply<F>(f: F, x: i32) -> i32 
where
    F: Fn(i32) -> i32,
{
    f(x)
}

fn main() {
    let square = |x| x * x;
    println!("平方: {}", apply(square, 5)); // 输出: 25
}
```

### 2. 返回闭包

```rust
fn multiplier(factor: i32) -> impl Fn(i32) -> i32 {
    move |x| x * factor
}

fn main() {
    let times3 = multiplier(3);
    println!("5 × 3 = {}", times3(5)); // 输出: 15
}
```

---

## 六、错误处理模式

### 1. 返回 Result 类型

```rust
fn divide(a: f64, b: f64) -> Result<f64, String> {
    if b == 0.0 {
        Err("除数不能为零".to_string())
    } else {
        Ok(a / b)
    }
}

fn main() {
    match divide(10.0, 2.0) {
        Ok(res) => println!("结果: {}", res),
        Err(e) => println!("错误: {}", e),
    }
}
```

---

## 关键总结

1. **所有权规则**：函数参数和返回值涉及所有权转移，需注意生命周期
2. **类型安全**：参数和返回值必须显式声明类型
3. **表达式特性**：函数体由表达式构成，最后一行隐式返回
4. **高阶函数**：支持将函数作为参数和返回值，结合泛型实现灵活逻辑
5. **错误处理**：推荐使用 `Result` 和 `Option` 处理潜在错误

通过合理运用函数特性，可以构建出高效且安全的 Rust 程序。建议结合 Rust 的所有权系统和类型系统深入理解函数设计的最佳实践。
