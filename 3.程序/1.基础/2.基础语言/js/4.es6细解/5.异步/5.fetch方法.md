# `fetch`

JavaScript 的 `fetch` API （js自带的，用于取代`XMLHttpRequest (XHR)` 和 `WebSockets`），其提供了一个强大且灵活的方式来进行网络请求，特别是异步请求资源，如从服务器获取数据。以下是 `fetch` API 的一些关键点和使用方法的详解：

## 基本用法

`fetch` 函数返回一个 Promise，该 Promise 解析为 `Response` 对象。基本语法如下：

```javascript
fetch(url, options)
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error('Error:', error));
```

- `url`：请求的资源地址。
- `options`：可选参数，用于配置请求（如方法、头部、超时等）。

## 请求方法

默认情况下，`fetch` 发送的是 GET 请求。你可以通过 `options` 参数中的 `method` 属性来指定其他 HTTP 方法：

```javascript
fetch(url, {
  method: 'POST', // 或 'PUT', 'DELETE', 等
  // 其他选项...
});
```

## 请求体

对于 POST 或 PUT 请求，你可能需要发送数据。可以通过 `options` 参数中的 `body` 属性来设置：

```javascript
fetch(url, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    key: 'value',
  }),
});
```

## 请求头部

你可以在 `options` 参数中设置 `headers` 来添加请求头部：

```javascript
fetch(url, {
  headers: {
    'Authorization': 'Bearer token',
    'Accept': 'application/json',
  },
});
```

## 响应处理

`fetch` 返回的 Promise 解析为 `Response` 对象，你可以从这个对象中获取响应状态、头部和体。通常，你会使用 `.json()` 方法来解析 JSON 格式的响应体：

```javascript
fetch(url)
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => console.log(data))
  .catch(error => console.error('Error:', error));
```

## 错误处理

`fetch` 本身不会在网络错误时拒绝 Promise，只会在请求不能发出时（如网络断开）才会拒绝。如果你需要在响应状态码不是 2xx 时处理错误，你需要在 `.then()` 中进行检查：

```javascript
fetch(url)
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => console.log(data))
  .catch(error => console.error('Error:', error));
```

## 超时处理

`fetch` API 本身不支持超时，但你可以通过设置一个计时器来实现：

```javascript
const fetchWithTimeout = (resource, options) => {
  const { timeout = 8000 } = options;

  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);

  const response = fetch(resource, {
    ...options,
    signal: controller.signal
  }).then(response => {
    clearTimeout(id);
    return response;
  }).catch(() => {
    clearTimeout(id);
    throw new Error('Request timed out');
  });

  return response;
};

// 使用
fetchWithTimeout(url, { timeout: 5000 })
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error('Error:', error));
```

## 并发请求

你可以使用 `Promise.all` 来同时发送多个请求：

```javascript
Promise.all([fetch(url1), fetch(url2)])
  .then(responses => Promise.all(responses.map(r => r.json())))
  .then(data => {
    console.log(data[0]); // 第一个请求的数据
    console.log(data[1]); // 第二个请求的数据
  })
  .catch(error => console.error('Error:', error));
```

`fetch` API 提供了一种现代、强大且灵活的方式来处理网络请求，它支持 Promise，使得异步代码更加简洁和易于管理。
