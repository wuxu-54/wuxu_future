# 闭包

在Swift中，闭包（Closure）是一种自包含的函数代码块，它可以被保存和传递。闭包可以捕获并包含在它们定义时所在上下文中的常量和变量。Swift中的闭包对于实现高阶函数和操作非常有用的，并且它们在很多API中都有应用，如数组的`map`、`filter`和`sort`方法。
>很多语言都有闭包。闭包就是一个函数，可以访问所在作用域的变量或常量，并且可以返回给到更外部。简单来说闭包：函数作为值传递使用即是闭包函数，通过闭包函数外部可以访问闭包函数所在函数中的数据。如：函数A套闭包函数B，B可访问A变量，B可作为返回值被A给到外部，这样外部可通过B访问A的数据。

闭包通常具有以下特点：

- **匿名性**：闭包通常没有名称，是一种匿名函数。
- **可捕获性**：闭包可以捕获并包含其创建时所在上下文中的变量和常量（即使这些变量和常量在闭包被调用时已经离开了它们原本的作用域）。
- **延迟执行**：闭包可以延迟执行，即在被创建后，可以在之后的任何时间点调用。
- **参数列表**：闭包可以接收输入参数，执行一些操作，并返回一个值。
- **返回值**：闭包可以指定返回值类型，或者根据上下文进行类型推断。
- **自包含性**：闭包是一个自包含的代码块，它包含了执行任务所需的所有信息。
- **函数嵌套**：闭包可以作为参数传递给其他函数，或者作为其他函数的返回值。
- **语法简洁**：在很多语言中，闭包的语法比传统函数更简洁，使得编写和阅读代码更加容易。

以下是Swift闭包的一些关键特性和用法：

1. **语法**：
   Swift闭包的语法类似于C#的lambda表达式或Python的匿名函数。

   ```swift
   { (parameters) -> returnType in
       // 代码
   }
   ```

2. **类型推断**：
   Swift可以推断闭包的参数类型和返回类型，如果上下文环境足够明确的话。

   ```swift
   let numbers = [1, 2, 3, 4, 5]
   let squares = numbers.map { $0 * $0 }
   ```

3. **参数和返回值**：
   闭包可以有零个或多个参数，也可以有一个返回值。

   ```swift
   let sum = { (numbers: [Int]) -> Int in
       return numbers.reduce(0, +)
   }
   ```

4. **捕获上下文**：
   闭包可以捕获和使用定义它们的上下文中的变量。

   ```swift
   var number = 5
   let addNumber = { () -> Int in
       return number
   }
   ```

5. **尾随闭包**：
   当函数的最后一个参数是一个闭包时，可以将其写在参数名之后，实现尾随闭包语法。

   ```swift
   func performOperation(with value: Int, and operation: (Int) -> Int) -> Int {
       return operation(value)
   }
   performOperation(with: 10) { $0 * 2 }
   ```

6. **逃逸闭包**：
   如果闭包可能会在定义它的函数返回之后被调用，需要使用`@escaping`来标记。

   ```swift
   var completionHandlers: [() -> Void] = []
   func executeAfterDelay(_ delay: TimeInterval, completion: @escaping () -> Void) {
       completionHandlers.append(completion)
   }
   ```

7. 使用`inout`参数：
   闭包可以包含`inout`参数，允许在闭包内部修改参数值。

   ```swift
   func modifyValue(_ value: inout Int) {
       value += 10
   }
   let value = 5
   modifyValue(&value)
   ```

8. **闭包作为返回类型**：
   函数可以返回闭包，实现函数式编程范式。

   ```swift
   func createMultiplier() -> (Int, Int) -> Int {
       func multiply(_ a: Int, _ b: Int) -> Int {
           return a * b
       }
       return multiply
   }
   let multiplier = createMultiplier()
   let result = multiplier(3, 4) // 12
   ```

9. **闭包作为属性**：
   类、结构体或枚举可以拥有闭包作为属性。

   ```swift
   class Calculator {
       var operation: (Int, Int) -> Int
       init(operation: @escaping (Int, Int) -> Int) {
           self.operation = operation
       }
   }
   let adder = Calculator { $0 + $1 }
   ```

10. **闭包的内存管理**：
    由于闭包可能捕获并持有上下文中的变量，需要注意闭包和捕获变量之间的强引用循环问题。

Swift中的闭包是一种非常强大的特性，它提供了一种灵活的方式来编写和使用函数代码。闭包的使用在Swift标准库和Cocoa框架中非常普遍，是Swift编程中不可或缺的一部分。

---

## 补充

- `$0`是一个特殊的占位符，用于在闭包（closure）内部引用闭包的第一个参数。当你为函数或者方法提供闭包作为参数时，如果闭包的参数列表没有被显式命名，你可以使用 `$0`、`$1`、`$2` 等来引用参数。这种写法可以使闭包更加简洁。
