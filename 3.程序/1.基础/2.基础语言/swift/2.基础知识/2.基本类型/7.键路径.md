# 键路径

在 Swift 中，键路径（Key Path）是一种表达式，用于引用类或结构体中的属性或子属性。键路径提供了一种类型安全的方式来访问和修改属性，而不需要知道具体的属性名。它们在 Swift 的许多特性中都有应用，比如 `NSPredicate`、KVC（Key-Value Coding）以及 Swift 的属性包装器。

## 键路径基本语法

键路径的基本语法是使用反引号（`\`）包围属性名。例如，如果你有一个名为 `person` 的变量，它是一个包含 `name` 属性的结构体实例，你可以使用键路径来引用这个属性：

```swift
struct Person {
    var name: String
}

let person = Person(name: "John")
let nameKeyPath = \Person.name // 等同于js中，取key
let name = person[keyPath: nameKeyPath] // "John"
```

## 使用场景

1. **属性包装器**：
   在属性包装器中，键路径用于引用存储属性。

   ```swift
   @propertyWrapper
   struct OptionalValue {
       private var value: String?

       var wrappedValue: String? {
           get { value }
           set { value = newValue }
       }
   }

   struct Person {
       @OptionalValue var name: String?
   }

   let person = Person()
   person.name = "John"
   let nameKeyPath = \Person.name
   print(person[keyPath: nameKeyPath]) // Optional("John")
   ```

2. **动态成员查找**：
   使用键路径可以动态地访问属性，这在编写泛型代码或处理未知属性时非常有用。

   ```swift
   @dynamicMemberLookup
   struct Person {
       private var properties: [String: Any] = [:]

       subscript<T>(dynamicMember keyPath: WritableKeyPath<Person, T>) -> T {
           get { properties[keyPath: keyPath]! }
           set { properties[keyPath: keyPath] = newValue }
       }
   }

   let person = Person()
   person[\.name] = "John"
   print(person[\.name]) // "John"
   ```

3. **排序和过滤**：
   在集合操作中，键路径用于指定排序和过滤条件。

   ```swift
   let people = [Person(name: "John"), Person(name: "Alice")]
   let sortedPeople = people.sorted(by: { $0[keyPath: \Person.name] < $1[keyPath: \Person.name] })
   ```

4. **KVC（Key-Value Coding）**：
   键路径与 KVC 兼容，可以在 Objective-C 兼容的代码中使用。

   ```swift
   let person = Person(name: "John")
   let name = person.value(forKeyPath: "name") as? String // "John"
   ```

5. **SwiftUI**：
   在 SwiftUI 中，键路径用于绑定和更新视图的状态。

   ```swift
   import SwiftUI

   struct ContentView: View {
       @State private var name: String = "John"

       var body: some View {
           Text(name)
               .onAppear {
                   self.name = "Alice"
               }
           }
   }
   ```

## 注意事项

- 键路径是类型安全的，只能在编译时检查。
- 键路径只能引用存储属性，不能引用计算属性或类型属性。
- 使用键路径时，需要确保引用的属性在运行时存在，否则会导致运行时错误。

键路径是 Swift 语言的一个强大特性，它提供了一种灵活的方式来访问和操作属性，同时保持代码的类型安全和清晰。

---

## 与属性包装器区别

在 Swift 中，键路径（Key Paths）和属性包装器（Property Wrappers）是两个不同的概念，它们各自有不同的用途和特点。

## 键路径（Key Paths）

键路径是一种引用类或结构体属性的表达式。它们允许你以类型安全的方式引用属性，而不需要直接使用属性名。键路径在 Swift 的许多地方都有应用，比如在排序、过滤数组时指定属性，或者在 SwiftUI 中绑定数据。

键路径的特点包括：

- 键路径是引用属性的路径，可以用于动态成员访问。
- 它们通常用于定义属性之间的关联，如在 `NSPredicate` 或 `@dynamicMemberLookup` 属性中。
- 键路径可以用于 `@FetchRequest`、`@ObservedObject`、`@State` 等属性包装器中。

## 属性包装器（Property Wrappers）

属性包装器是一种定义属性时使用的包装类型，它允许你在属性的存储和访问过程中插入自定义代码。属性包装器可以用来实现诸如延迟加载、观察属性变化、序列化等通用功能。

属性包装器的特点包括：

- 属性包装器定义了一个新的类型，该类型遵循 `@propertyWrapper` 协议。
- 它们通过 `wrappedValue` 属性来存储和获取实际的属性值。
- 属性包装器可以定义初始化器、`willSet` 和 `didSet` 观察器，以及其他自定义行为。
- 属性包装器可以用来封装和管理属性的生命周期和行为。

## 示例

### 键路径示例

```swift
struct Person {
    var name: String
}

let person = Person(name: "John")
let keyPath: KeyPath<Person, String> = \Person.name
let name = person[keyPath: keyPath] // 使用键路径访问属性
```

### 属性包装器示例

```swift
@propertyWrapper
struct OptionalValue {
    private var value: String?

    var wrappedValue: String? {
        get { value }
        set { value = newValue }
    }
}

struct Person {
    @OptionalValue var name: String?
}

let person = Person()
person.name = "John"
let name = person.name // 使用属性包装器访问属性
```

## 区别

- **用途**：键路径用于引用属性，而属性包装器用于定义和管理属性的行为。
- **定义**：键路径是一个表达式，属性包装器是一个遵循 `@propertyWrapper` 协议的类型。
- **应用**：键路径通常用于访问属性，属性包装器用于定义属性的存储和访问逻辑。
- **类型**：键路径是一个编译时的概念，属性包装器是一个运行时的类型。

总的来说，键路径和属性包装器是 Swift 语言中两个不同的特性，它们在不同的场景下提供了强大的功能。键路径更多地用于引用和操作属性，而属性包装器则用于封装和管理属性的存储和行为。

---

## 实际例子

`@Environment(\.verticalSizeClass) private var verticalSizeClass`的意思如下：

在 Swift 和 SwiftUI 中，`\.verticalSizeClass` 是一个键路径，用于引用环境值 `verticalSizeClass`。这个键路径通常与 `@Environment` 属性包装器一起使用，以便在视图中访问当前的垂直尺寸类别。

### 键路径的写法

键路径是一种 Swift 语法，用于引用类的属性或下标。在 SwiftUI 中，键路径经常用于访问环境值或模型的属性。`\.verticalSizeClass` 的写法如下：

- `\`：表示这是一个键路径。
- `verticalSizeClass`：是环境值的名称。

### 使用 @Environment 属性包装器

当你在 SwiftUI 视图中使用 `@Environment` 属性包装器时，你可以使用键路径来注入环境值。例如：

```swift
import SwiftUI

struct ContentView: View {
    @Environment(\.verticalSizeClass) private var verticalSizeClass
    
    var body: some View {
        switch verticalSizeClass {
        case .compact:
            Text("Compact vertical size class")
        case .regular:
            Text("Regular vertical size class")
        @unknown default:
            Text("Unknown vertical size class")
        }
    }
}
```

在这个例子中，`@Environment(\.verticalSizeClass)` 注入了当前的垂直尺寸类别，然后视图根据这个类别显示不同的文本。

### 环境值的提供

为了使 `@Environment` 属性包装器能够工作，环境值必须由视图的父视图或视图的根视图提供。在 SwiftUI 中，环境值通常是通过在视图层次结构中某个点上使用 `.environment(\.verticalSizeClass, value)` 修饰符来提供的。

### 示例注意事项

- 确保在使用 `@Environment` 属性包装器时，环境值已经在视图层次结构中被提供。
- 键路径是 Swift 语言的一个强大特性，它不仅用于访问环境值，还用于访问类的属性、结构体的存储属性、枚举的原始值等。
- 在使用键路径时，确保引用的属性或下标在当前上下文中是可用的。

`\.verticalSizeClass` 的写法是 Swift 和 SwiftUI 中键路径的标准写法，用于在视图中访问和使用环境值。

### 总结

这里是介绍键路径与`@Environment`属性包装器联合使用，作用是将视图中的`.verticalSizeClass`的值获取到，并给到新变量。
