# NSURLSession简介

在Objective-C中，`NSURLSession`是一个用于执行网络请求的高级API。它是基于`NSURLConnection`的现代替代品，提供了更灵活和强大的网络请求功能。以下是`NSURLSession`的一些关键特性和使用方法：

## NSURLSession的关键特性

1. **会话配置**：
   `NSURLSessionConfiguration`定义了会话的行为，如缓存策略、网络协议、请求超时等。

2. **任务**：
   `NSURLSession`支持多种类型的任务，包括数据任务（`NSURLSessionDataTask`）、上传任务（`NSURLSessionUploadTask`）和下载任务（`NSURLSessionDownloadTask`）。

3. **并发执行**：
   `NSURLSession`可以在后台并发执行多个网络请求。

4. **代理**：
   通过实现`NSURLSessionDelegate`、`NSURLSessionTaskDelegate`和`NSURLSessionDownloadDelegate`协议，可以接收网络请求的回调和状态更新。

5. **数据缓存**：
   `NSURLSession`可以自动缓存响应数据，减少重复请求。

6. **后台模式**：
   `NSURLSession`支持后台模式，即使应用程序进入后台，也可以继续执行网络请求。

7. **优先级**：
   可以为每个任务设置优先级，以控制任务的执行顺序。

## 使用NSURLSession

1. **创建NSURLSession**：
   使用配置创建`NSURLSession`实例。

   ```objc
   NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];
   NSURLSession *session = [NSURLSession sessionWithConfiguration:configuration delegate:self delegateQueue:nil];
   ```

2. **创建和启动任务**：
   根据需要创建不同类型的任务，并启动任务。

   ```objc
   // 创建一个GET请求的数据任务
   NSURL *url = [NSURL URLWithString:@"https://example.com/data"];
   NSURLSessionDataTask *dataTask = [session dataTaskWithURL:url completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
       if (error == nil) {
           // 处理响应数据
       }
   }];
   [dataTask resume];
   ```

3. **处理响应**：
   在任务的完成回调中处理响应数据、响应对象和可能的错误。

4. **代理方法**：
   实现代理方法来接收额外的状态更新和控制任务的行为。

   ```objc
   - (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task didCompleteWithError:(NSError *)error {
       if (error) {
           // 处理错误
       }
   }
   ```

5. **后台任务**：
   通过配置`NSURLSessionConfiguration`的`discretionary`属性，可以让任务在后台执行。

6. **任务依赖**：
   可以创建任务之间的依赖关系，确保任务按特定顺序执行。

7. **取消和暂停任务**：
   可以通过调用任务的`cancel`或`suspend`方法来取消或暂停任务。

8. **验证响应**：
   使用`NSURLConnection`的响应验证方法来验证服务器响应的合法性。

## 注意事项

- 确保在正确的线程上调用`NSURLSession`的方法。大多数情况下，应避免在主线程上执行耗时的网络请求。
- 管理好会话的生命周期，避免不必要的资源占用。
- 使用代理模式时，确保代理对象的生命周期和会话对象的生命周期相匹配。
- 处理网络请求中可能出现的各种错误，如网络错误、超时、数据解析错误等。

`NSURLSession`是iOS和macOS开发中处理网络请求的强大工具。通过合理使用`NSURLSession`，可以编写出高效、灵活且易于维护的网络代码。

## 示例

以下是一个示例，展示如何创建一个POST请求，并将JSON数据作为请求体发送。

首先，你需要准备JSON数据。可以使用`NSDictionary`和`NSJSONSerialization`来生成JSON格式的`NSData`对象。

然后，创建一个`NSMutableURLRequest`对象，设置其HTTP方法为`POST`，添加必要的HTTP头（例如，指定内容类型为`application/json`），并设置请求体为JSON数据。

最后，使用`NSURLSession`发送请求，并处理响应。

以下是具体的代码示例：

```objective-c
// 某个ViewController中的方法
- (void)sendPostRequestWithJSON {
    // 准备JSON数据
    NSDictionary *jsonDict = @{@"key1": @"value1", @"key2": @"value2"};
    NSError *jsonError = nil;
    NSData *jsonData = [NSJSONSerialization dataWithJSONObject:jsonDict
                                                       options:NSJSONWritingPrettyPrinted
                                                         error:&jsonError];
    if (!jsonData) {
        NSLog(@"Error creating JSON data: %@", jsonError);
        return;
    }
    
    // 创建URL对象
    NSURL *url = [NSURL URLWithString:@"https://api.example.com/post"];
    
    // 创建NSMutableURLRequest对象
    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];
    request.HTTPMethod = @"POST"; // 设置HTTP方法为POST
    [request setValue:@"application/json" forHTTPHeaderField:@"Content-Type"]; // 设置HTTP头，指定内容类型为JSON
    request.HTTPBody = jsonData; // 设置请求体为JSON数据
    
    // 创建NSURLSession
    NSURLSession *session = [NSURLSession sessionWithConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];
    
    // 创建并启动数据任务
    NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
        if (error) {
            NSLog(@"Error: %@", error);
        } else {
            // 处理响应数据
            NSString *result = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
            NSLog(@"Response: %@", result);
        }
    }];
    
    [task resume]; // 启动任务
}
```

在这个示例中，我们首先创建了一个包含键值对的`NSDictionary`对象，然后使用`NSJSONSerialization`将其序列化为JSON格式的`NSData`对象。接着，我们创建了一个`NSMutableURLRequest`对象，设置了必要的HTTP头，并把JSON数据设置为请求体。最后，我们使用`NSURLSession`发送了POST请求，并在completion handler中处理了响应。

请注意，这个示例使用了默认的`NSURLSessionConfiguration`。在实际应用中，你可能需要根据需求配置不同的会话配置，例如使用`NSURLSessionConfiguration background(withIdentifier:)`来创建后台会话。此外，错误处理在实际应用中应该更加健壮，以确保应用的稳定性。
