# 内存管理简说

Objective-C 的内存管理主要基于引用计数机制，这是一种自动内存管理技术。在这种机制下，每个对象都有一个与之关联的计数器，称为引用计数（reference count），它跟踪了当前有多少个强引用指向该对象。当对象的引用计数降到0时，系统会自动释放该对象占用的内存。

Objective-C 内存管理技术可以大致分为两类:

- 手动保留释放（Manual Retain-Release，即 MRR）
- 自动引用计算（Automatic Reference Counting，即 ARC）

---

## MRR

### 基本概念

1. **引用计数（Reference Counting）**：每个 Objective-C 对象都有一个与之关联的整数计数器，表示有多少个强引用指向该对象。

2. **强引用（Strong Reference）**：当一个对象被强引用时，其引用计数会增加。强引用是默认的引用类型。

3. **弱引用（Weak Reference）**：弱引用不会增加对象的引用计数。当对象被释放时，其弱引用会自动置为 `nil`，以避免野指针。

4. **内存释放（Memory Deallocation）**：当对象的引用计数降到0时，系统会自动调用 `dealloc` 方法来释放对象占用的内存。

### 内存管理规则

1. **创建对象时**：使用 `alloc`、`new`、`copy` 或 `mutableCopy` 方法创建的对象，引用计数从1开始。

2. **保留对象时**：使用 `retain` 方法可以增加对象的引用计数。

3. **释放对象时**：使用 `release` 方法会减少对象的引用计数。

4. **自动释放对象**：使用 `autorelease` 方法可以将对象放入自动释放池（Autorelease Pool），在自动释放池被清空时，对象的引用计数会减少。

5. **弱引用**：使用 `__weak` 修饰符声明的变量是弱引用，它们不会增加对象的引用计数。

### 示例

```objc
// 创建对象
NSObject *object = [[NSObject alloc] init];

// 增加引用计数
[object retain];

// 减少引用计数
[object release];// 如果引用计数已经是0，还使用对象实例，就会出现野指针，因为内存已经被回收，但如果仍去访问这个内存那么就会出现问题

// 自动释放
[object autorelease];
```

详细示例：

```objc
#import <Foundation/Foundation.h>
@interface SampleClass:NSObject
- (void)sampleMethod;
@end
@implementation SampleClass
- (void)sampleMethod {
  NSLog(@"Hello, World! \n");
}
- (void)dealloc {
 NSLog(@"Object deallocated");
 [super dealloc];
}
@end
int main() {
  /* my first program in Objective-C */
  SampleClass *sampleClass = [[SampleClass alloc]init];
  [sampleClass sampleMethod];
  NSLog(@"Retain Count after initial allocation: %d", 
  [sampleClass retainCount]);
  [sampleClass retain];
  NSLog(@"Retain Count after retain: %d", [sampleClass retainCount]);
  [sampleClass release];
  NSLog(@"Retain Count after release: %d", [sampleClass retainCount]);
  [sampleClass release];
  NSLog(@"SampleClass dealloc will be called before this");
  // Should set the object to nil
  sampleClass = nil;
  return 0;
}
/*
结果如下：

2022-07-07 12:39:52.310 demo[8385] Hello, World!
2022-07-07 12:39:52.311 demo[8385] Retain Count after initial allocation: 1
2022-07-07 12:39:52.311 demo[8385] Retain Count after retain: 2
2022-07-07 12:39:52.311 demo[8385] Retain Count after release: 1
2022-07-07 12:39:52.311 demo[8385] Object deallocated
2022-07-07 12:39:52.311 demo[8385] SampleClass dealloc will be called before this
 */
```

### 自动释放池（Autorelease Pool）

自动释放池是一种管理内存的工具，用于收集并释放在特定代码块中创建的对象。在循环或大量创建临时对象的情况下，使用自动释放池可以提高性能。

```objc
@autoreleasepool {
    // 在这个代码块中创建的对象将在自动释放池被清空时释放
    NSObject *object = [[NSObject alloc] init];
    // ... 其他代码 ...
}
```

### 循环引用

当两个对象互相强引用时，它们的引用计数永远不会降到0，导致内存泄漏。使用弱引用可以解决循环引用问题。

## 注意事项

- 从 iOS 5 和 OS X 10.7 开始，Apple 推荐使用自动引用计数（Automatic Reference Counting，ARC）来管理内存，它简化了内存管理并减少了内存泄漏的风险。

- 在使用 ARC 时，编译器会自动插入 `retain`、`release` 和 `autorelease` 调用，开发者不需要手动管理这些操作。

- 在非 ARC 环境下，开发者需要手动管理内存，遵循上述内存管理规则。

## ARC

ARC（Automatic Reference Counting，自动引用计数）是 Objective-C 中的一种内存管理机制，它在编译时自动插入内存管理代码来控制对象的生命周期，从而简化了内存管理。以下是对 ARC 的详解：

### ARC 的基本概念

ARC 自动引用计数是在 iOS 4 之后引入的技术，它使得在代码中使用 `release`、`retain` 等方法时会报错，因为这些方法被禁用了。你可以在项目的 Build Settings 中设置 “Objective-C Automatic Reference Counting” 为 NO 来不启用 ARC。不同于 MRC（Manual Retain-Release），ARC 通过编译器自动管理内存，减少了内存泄漏的风险 。

### ARC 的工作原理

ARC 通过引用计数来追踪对象的引用次数。当对象的引用计数为零时，ARC 会自动插入 `release` 调用来释放对象。此外，ARC 也会在适当的地方自动插入 `retain` 和 `autorelease` 调用来管理对象的生命周期 。

### ARC 的使用规则

1. **对象的 Alloc/Init**：创建对象的方法不变，但不能手动调用 `retain`、`release`、`autorelease` 或 `retainCount`。
2. **Dealloc 方法**：不能直接调用 `dealloc`，但可以创建自定义的 `dealloc` 方法来释放非 ARC 管理的资源。
3. **属性声明**：使用 `strong` 和 `weak` 来代替 MRC 时代的 `retain` 和 `assign`。
4. **C 结构中的对象指针**：不能使用 ARC 管理的对象指针作为 C 结构的成员。
5. **临时互转 id 和 void***：在 Core Foundation 和 Foundation 间传递对象时，使用 `__bridge`、`__bridge_retain` 和 `__bridge_transfer` 来告知编译器 。

### ARC 的内存管理关键字

- `__strong`：默认限定符，创建强引用，阻止对象被回收。
- `__weak`：创建弱引用，不增加引用计数，对象被回收时自动置为 `nil`。
- `__unsafe_unretained`：类似弱引用，但对象被回收后不会置为 `nil`，可能会形成野指针。
- `__autoreleasing`：用于引用传递，如 NSError 的传递 。

### ARC 的优势

- 减少内存泄漏的风险。
- 减少代码量，简化内存管理。
- 自动处理内存释放，提高开发效率。

### ARC 的局限性

- 不适用于所有类型的对象，如 Core Foundation 对象。
- 需要遵守严格的语法规则。
- 与 MRC 混编时需要特别注意内存管理规则。

### ARC 的启用和转换

在 Xcode 中，可以在项目的 Build Settings 中设置 ARC。如果需要将 MRC 代码转换为 ARC，可以使用 Xcode 提供的自动转换工具，它会自动重写源代码，去掉多余的语句并重写 property 关键字 。

总的来说，ARC 是 Objective-C 内存管理的一种现代化方式，它通过编译器自动管理内存，大大简化了开发过程，但也需要开发者对内存管理有一定的理解，以避免潜在的内存问题 。
