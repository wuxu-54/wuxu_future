# invokeOnCancellation 触发问题

suspendCancellableCoroutine 的 invokeOnCancellation 在正常回调执行结束会触发吗?

## 答案

在 Kotlin 协程中，`suspendCancellableCoroutine` 的 **`invokeOnCancellation` 仅在协程被主动取消时触发**，而**不会在正常回调执行结束后触发**。以下是详细解释和示例：

### **核心结论**

1. **正常完成（`resume`/`resumeWithException`）**  
   当回调调用 `continuation.resume()` 或 `continuation.resumeWithException()` 时，协程会**正常结束**，此时 **`invokeOnCancellation` 不会执行**。

2. **主动取消（`job.cancel()`）**  
   当外部调用 `job.cancel()` 或协程因父协程取消而被级联取消时，**`invokeOnCancellation` 会执行**，用于清理资源。

### **示例验证**

以下代码演示了两种情况的区别：

```kotlin
suspend fun testCoroutineCancellation() {
    val job = GlobalScope.launch {
        suspendCancellableCoroutine<Unit> { continuation ->
            // 模拟异步回调
            val timer = Timer()
            timer.schedule(object : TimerTask() {
                override fun run() {
                    if (!continuation.isCancelled) {
                        println("回调正常执行，resume 协程")
                        continuation.resume(Unit) // 正常完成
                    }
                }
            }, 1000)

            // 确保协程取消时停止定时器
            continuation.invokeOnCancellation {
                println("取消定时器")
                timer.cancel()
            }
        }
    }

    // 场景1：正常完成（注释掉下面的 cancel()）
    // 输出：回调正常执行，resume 协程
    //       invokeOnCancellation 不会被调用

    // 场景2：主动取消（取消注释）
    delay(500) // 在回调触发前取消
    job.cancel()
    // 输出：协程被取消: kotlinx.coroutines.JobCancellationException
    //       取消定时器
}
```

### **为什么需要 `invokeOnCancellation`？**

虽然正常完成时不需要清理资源（因为回调逻辑已结束），但**主动取消时必须释放资源**（如网络请求、定时器、文件句柄）。例如：

```kotlin
suspend fun fetchData(): Result {
    return suspendCancellableCoroutine { continuation ->
        val request = api.startAsyncRequest(object : Callback {
            override fun onSuccess(result: Result) {
                if (!continuation.isCancelled) {
                    continuation.resume(result) // 正常完成，无需额外清理
                }
            }
        })

        // 仅在协程被取消时触发
        continuation.invokeOnCancellation {
            request.cancel() // 取消未完成的网络请求
        }
    }
}
```

### **总结**

| 情况                 | `invokeOnCancellation` 是否触发 |
|----------------------|---------------------------------|
| 正常回调 `resume`    | ❌ 不触发                       |
| 回调 `resumeWithException` | ❌ 不触发                   |
| 外部调用 `job.cancel()` | ✅ 触发                       |
| 父协程取消导致级联取消 | ✅ 触发                     |

**关键点**：`invokeOnCancellation` 专门用于处理**协程非正常结束**（取消）的场景，与正常完成流程无关。
