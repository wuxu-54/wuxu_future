# MongoDB

MongoDB 是一个基于文档的 NoSQL 数据库，它以其高性能、高可用性和易扩展性而闻名。Python 可以通过 `pymongo` 库与 MongoDB 交互。以下是使用 `pymongo` 库进行 MongoDB 操作的详解和示例。

## 安装 `pymongo`

首先，确保安装了 `pymongo`：

```sh
pip install pymongo
```

## 连接 MongoDB

使用 `pymongo` 连接 MongoDB 数据库的基本代码：

```python
from pymongo import MongoClient

# 连接到 MongoDB（默认端口为 27017）
client = MongoClient('mongodb://localhost:27017/')

# 选择数据库
db = client['mydatabase']

# 选择集合
collection = db['mycollection']
```

## 插入文档

使用 `insert_one()` 方法插入单个文档，或使用 `insert_many()` 方法插入多个文档：

```python
# 插入单个文档
doc = {"name": "John Doe", "age": 30, "address": "123 Elm St"}
insert_result = collection.insert_one(doc)
print(f"Inserted document with ID: {insert_result.inserted_id}")

# 插入多个文档
docs = [
    {"name": "Jane Smith", "age": 25},
    {"name": "Emily Johnson", "age": 35}
]
insert_many_result = collection.insert_many(docs)
print(f"Inserted documents with IDs: {insert_many_result.inserted_ids}")
```

## 查询文档

使用 `find()` 方法查询文档：

```python
# 查询所有文档
for doc in collection.find():
    print(doc)

# 查询特定条件的文档
query = {"age": {"$gt": 30}}
for doc in collection.find(query):
    print(doc)
```

## 更新文档

使用 `update_one()` 或 `update_many()` 方法更新文档：

```python
# 更新单个文档
update_result = collection.update_one(
    {"name": "John Doe"},
    {"$set": {"age": 31}}
)
print(f"Matched {update_result.matched_count} documents, modified {update_result.modified_count} documents.")

# 更新多个文档
update_many_result = collection.update_many(
    {"age": {"$lt": 30}},
    {"$set": {"active": True}}
)
print(f"Matched {update_many_result.matched_count} documents, modified {update_many_result.modified_count} documents.")
```

## 删除文档

使用 `delete_one()` 或 `delete_many()` 方法删除文档：

```python
# 删除单个文档
delete_result = collection.delete_one({"name": "John Doe"})
print(f"Deleted {delete_result.deleted_count} documents.")

# 删除多个文档
delete_many_result = collection.delete_many({"age": {"$gt": 30}})
print(f"Deleted {delete_many_result.deleted_count} documents.")
```

## 聚合操作

MongoDB 强大的聚合框架可以执行复杂的数据处理：

```python
# 聚合示例：计算年龄大于 30 的用户的平均年龄
pipeline = [
    {"$match": {"age": {"$gt": 30}}},
    {"$group": {"_id": None, "average_age": {"$avg": "$age"}}}
]
result = collection.aggregate(pipeline)
for doc in result:
    print(f"Average age: {doc['average_age']}")
```

## 完整的数据库操作示例

```python
from pymongo import MongoClient

# 连接数据库
client = MongoClient('mongodb://localhost:27017/')

# 选择数据库和集合
db = client['mydatabase']
collection = db['mycollection']

# 插入文档
doc = {"name": "John Doe", "age": 30}
insert_result = collection.insert_one(doc)
print(f"Inserted document with ID: {insert_result.inserted_id}")

# 查询文档
for doc in collection.find():
    print(doc)

# 更新文档
update_result = collection.update_one(
    {"name": "John Doe"},
    {"$set": {"age": 31}}
)
print(f"Modified {update_result.modified_count} documents.")

# 删除文档
delete_result = collection.delete_one({"name": "John Doe"})
print(f"Deleted {delete_result.deleted_count} documents.")

# 关闭数据库连接
client.close()
```

## 注意事项

- MongoDB 的文档是 BSON 格式，它与 JSON 类似，但支持更多的数据类型。
- `pymongo` 库自动处理 BSON 和 Python 数据类型之间的转换。
- 在执行更新或删除操作时，可以通过返回的 `result` 对象检查匹配和修改的文档数量。
- 确保在完成数据库操作后关闭连接。

通过上述步骤和示例，你可以使用 `pymongo` 库在 Python 3 中进行 MongoDB 数据库的各种操作。
