# 上下文管理器

Python 的上下文管理器是一种优雅处理资源的协议，它确保了代码块执行前后的资源管理，比如打开和关闭文件、获取和释放锁等。上下文管理器通过 `with` 语句实现。

细讲上下文管理器前，先看一个例子：

```python
for line in open("myfile.txt"):
    print(line, end="")
```

以上这段代码的问题是，当执行完毕后，文件会保持打开状态，并没有被关闭。那我们怎么规避这种问题呢？答：使用上下文管理器，保证最后会清理资源：

```python
with open("myfile.txt") as f:
    for line in f:
        print(line, end="")
```

以上这段代码执行完毕后，就算在处理过程中出问题了，文件 f 总是会关闭。

---

## 1. 基本概念

上下文管理器需要实现两个魔术方法（magic methods）：

- `__enter__()`：在 `with` 语句的代码块执行之前调用，返回值会被赋给 `as` 后面的变量。
- `__exit__(exc_type, exc_val, exc_tb)`：在 `with` 语句的代码块执行之后调用，无论代码块是否正常结束。它负责处理资源清理工作。

## 2. 使用 `with` 语句

`with` 语句的基本用法如下：

```python
with context_manager as variable:
    # 执行一些操作
    # 如果发生异常，将跳到 except 子句
```

## 3. 内置的上下文管理器

Python 中一些内置的上下文管理器包括：

- 文件操作：`open()` 函数。
- 线程同步：`threading.Lock()`、`threading.Semaphore()` 等。

### 3.1 内置的上下文管理器示例

Python 中一些内置的上下文管理器包括：

- **文件操作**：使用 open() 函数打开文件时，会返回一个文件对象，该对象是一个上下文管理器。

    ```python
    with open('file.txt', 'r') as file:
        contents = file.read()
    ```

- **线程锁**：threading 模块中的 Lock 对象可以用来同步线程。

    ```python
    from threading import Lock

    lock = Lock()
    with lock:
        # 线程安全的代码块
    ```

## 4. 自定义上下文管理器

可以通过以下两种方式自定义上下文管理器：

### 4.1 使用类

定义一个类并实现 `__enter__()` 和 `__exit__()` 方法：

```python
class MyResource:
    def __enter__(self):
        # 资源获取逻辑
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        # 资源释放逻辑
        pass

with MyResource() as resource:
    # 使用资源
    pass
```

### 4.2 使用 `contextlib` 模块

`contextlib` 模块提供了工具来简化上下文管理器的创建，特别是 `contextmanager` 装饰器，它允许你用一个生成器函数来定义上下文管理器：

```python
from contextlib import contextmanager

@contextmanager
def my_resource():
    print("Resource setup")
    yield
    print("Resource cleanup")

with my_resource():
    # 使用资源
    pass
```

## 5. `__exit__()` 方法的参数

- `exc_type`：异常类型，如果没有异常发生，则为 `None`。
- `exc_val`：异常值，如果没有异常发生，则为 `None`。
- `exc_tb`：异常的 traceback 对象，如果没有异常发生，则为 `None`。

如果 `__exit__()` 方法返回 `False` 或者没有返回值（默认），则异常会被正常抛出。如果返回 `True`，则可以抑制异常（即不抛出）。

## 6. 上下文管理器的优势

- 代码更简洁、易读。
- 确保资源的合理管理，即使在发生异常时也能正确清理。
- 可以嵌套使用，方便同时管理多个资源。

## 注意事项

- 并不是所有的对象都支持 `with` 语句。对象必须实现 `__enter__()` 和 `__exit__()` 方法。
- `__exit__()` 方法的三个参数对应了异常的类型、值和追踪信息。如果 with 语句块中没有发生异常，这三个参数都将是 None。
- 如果 `__exit__()` 方法返回 `False`（或没有返回值），则异常会被正常抛出；如果返回 `True`，则可以抑制异常。

上下文管理器是 Python 中处理资源的推荐方式，它提供了一种结构化和可预测的方法来管理资源的生命周期。
