# 常量

在 Dart 里，常量是程序运行过程中不可变的值，使用常量可以提高代码的可读性、可维护性和安全性。Dart 中有多种定义和使用常量的方式，下面为你详细介绍：

## 编译时常量（`const`）

### 基本概念

`const` 关键字用于定义编译时常量，这些常量在编译阶段就被确定值，并且在整个程序运行期间保持不变。编译时常量可以是基本数据类型（如 `int`、`double`、`String` 等），也可以是集合（如 `List`、`Map`）。

### 示例代码

```dart
// 定义基本数据类型的常量
const int MAX_COUNT = 100;
const String APP_NAME = 'MyApp';

// 定义集合类型的常量
const List<int> numbers = [1, 2, 3];
const Map<String, int> scores = {'Alice': 85, 'Bob': 90};

void main() {
  print(MAX_COUNT); // 输出: 100
  print(APP_NAME);  // 输出: MyApp
  print(numbers);   // 输出: [1, 2, 3]
  print(scores);    // 输出: {Alice: 85, Bob: 90}
}
```

### 注意事项

- 编译时常量必须在声明时就初始化，且初始化值必须是编译时已知的常量表达式。
- 多个 `const` 常量如果值相同，它们在内存中实际上是同一个对象。

## 运行时常量（`final`）

### 运行时常量基本概念

`final` 关键字用于定义运行时常量，这些常量在第一次赋值后就不能再改变。与 `const` 不同，`final` 变量的值可以在运行时确定，但一旦赋值就不能再修改。

### 编译时常量示例代码

```dart
final int userAge;

void main() {
  // 在运行时赋值
  userAge = 25;
  print(userAge); // 输出: 25

  // 尝试重新赋值会报错
  // userAge = 30; 
}
```

### 编译时常量注意事项

- `final` 变量可以在声明时不初始化，但必须在使用前赋值。
- `final` 变量只能赋值一次，之后不能再修改其值。

## 类中的常量

### 静态常量

在类中，可以使用 `static const` 来定义静态常量，这些常量属于类本身，而不是类的实例。

```dart
class MathConstants {
  static const double PI = 3.1415926;
  static const int MAX_VALUE = 100;
}

void main() {
  print(MathConstants.PI); // 输出: 3.1415926
  print(MathConstants.MAX_VALUE); // 输出: 100
}
```

### 常量构造函数

如果类的所有成员变量都是 `final` 的，并且在构造函数中初始化，那么可以将该构造函数定义为常量构造函数，使用 `const` 关键字修饰。通过常量构造函数创建的对象也是常量对象。

```dart
class Point {
  final num x;
  final num y;

  const Point(this.x, this.y);
}

void main() {
  const p1 = Point(1, 2);
  const p2 = Point(1, 2);

  print(identical(p1, p2)); // 输出: true，因为它们是同一个常量实例
}
```

## 常量集合

### 常量列表

使用 `const` 关键字可以创建常量列表，列表中的元素必须是编译时常量。

```dart
const List<int> evenNumbers = const [2, 4, 6, 8];
```

### 常量映射

同样，也可以创建常量映射，映射的键和值都必须是编译时常量。

```dart
const Map<String, int> daysInMonth = const {
  'January': 31,
  'February': 28,
  'March': 31
};
```

## 常量表达式

常量表达式是在编译时就能计算出结果的表达式，只有常量表达式才能用于初始化 `const` 常量。

```dart
const int a = 5;
const int b = 3;
const int sum = a + b; // 常量表达式，编译时可确定结果
```

## 总结

- `const` 用于定义编译时常量，值在编译阶段就确定，多个相同值的 `const` 常量共享同一内存地址。
- `final` 用于定义运行时常量，值在运行时确定，但一旦赋值就不能再修改。
- 在类中可以使用 `static const` 定义静态常量，使用常量构造函数创建常量对象。
- 常量集合（列表、映射等）的元素必须是编译时常量。

---

## const 在类中必须使用static的原因

在 Dart 类里其实是可以用 `const` 标记常量的，但存在一定的规则和限制。
>总结就是：const是编译时明确，而类的实例是运行时确定的。

下面为你详细解释：

## 可以使用 `const` 标记的情况

### 静态常量`static const`

在 Dart 中，类内可以使用 `static const` 来定义编译时常量。这些常量在类加载时就被初始化，并且在整个程序运行期间保持不变。

```dart
class MathConstants {
  // 使用 static const 定义常量
  static const double pi = 3.1415926;
  static const int maxValue = 100;
}

void main() {
  print(MathConstants.pi); // 输出: 3.1415926
  print(MathConstants.maxValue); // 输出: 100
}
```

在上述示例中，`pi` 和 `maxValue` 都是 `MathConstants` 类的静态常量，通过 `类名.常量名` 的方式可以访问它们。

### 常量构造函数与常量实例

如果类有常量构造函数，那么可以使用 `const` 来创建该类的常量实例。

```dart
class Point {
  final num x;
  final num y;

  // 常量构造函数
  const Point(this.x, this.y);
}

void main() {
  // 创建常量实例
  const p1 = Point(1, 2);
  const p2 = Point(1, 2);

  print(identical(p1, p2)); // 输出: true，因为它们是同一个常量实例
}
```

这里的 `Point` 类有一个常量构造函数，通过 `const` 关键字创建的 `p1` 和 `p2` 是常量实例，并且由于它们的参数相同，实际上是同一个对象。

## 不能直接使用 `const` 标记的情况

### 实例变量

不能直接在实例变量前使用 `const`。`const` 定义的常量必须在编译时就确定其值，而实例变量是每个对象独有的，其值在对象创建时才确定，因此不能用 `const` 修饰。

```dart
class Example {
  // 错误示例，不能直接用 const 修饰实例变量
  // const int value = 10; 

  final int value;

  Example(this.value);
}
```

在这个例子中，如果尝试使用 `const` 修饰 `value` 会导致编译错误，因为实例变量的值依赖于对象的创建过程，不是编译时常量。

### 方法和函数

不能使用 `const` 标记类的方法和函数。`const` 主要用于定义常量值，而方法和函数是用于执行代码逻辑的，它们的行为在运行时确定，不符合 `const` 的使用场景。

```dart
class MyClass {
  // 错误示例，不能用 const 标记方法
  // const void myMethod() {
  //   print('Hello');
  // }

  void myMethod() {
    print('Hello');
  }
}
```

综上所述，在 Dart 类里可以使用 `static const` 定义静态常量，也可以使用常量构造函数创建常量实例，但要注意 `const` 不能用于实例变量、方法和函数等不满足编译时常量要求的场景。
