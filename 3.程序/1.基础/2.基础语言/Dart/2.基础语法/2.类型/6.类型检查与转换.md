# 类型检查和类型转换

在 Dart 中，类型检查和类型转换是处理对象类型相关操作的重要机制，它们可以帮助你在运行时确定对象的实际类型，以及在必要时将对象转换为不同的类型。

[TOC]

以下是关于 Dart 中类型检查和类型转换的详细解释：

## 一、类型检查

Dart是强类型语言，支持**静态类型检查**和**运行时类型检查**。

### 1. 静态类型检查

- **声明时指定类型**：变量声明时显式定义类型，编译器会在编译时检查类型兼容性。

  ```dart
  int number = 42;
  String text = "Hello";
  // number = "World"; // 编译错误：类型不匹配
  ```

- **类型推断**：使用`var`或`final`时，Dart根据初始值自动推断类型，后续赋值需匹配推断类型。

  ```dart
  var a = 10;    // 推断为int
  a = 20;        // 合法
  // a = "text"; // 编译错误：类型不匹配
  ```

### 2. 运行时类型检查

#### 2.1 `is` 操作符

`is` 操作符用于检查一个对象是否是某个特定类型或其子类型的实例。如果对象是指定类型或其子类型，则返回 `true`，否则返回 `false`。

**示例代码**：

```dart
class Animal {}
class Dog extends Animal {}

void main() {
  Dog dog = Dog();
  // 检查 dog 是否是 Dog 类型的实例
  bool isDog = dog is Dog; 
  print(isDog); // 输出: true

  // 检查 dog 是否是 Animal 类型的实例
  bool isAnimal = dog is Animal; 
  print(isAnimal); // 输出: true
}
```

### 2.2 `is!` 操作符

`is!` 操作符是 `is` 操作符的否定形式，用于检查一个对象是否不是某个特定类型或其子类型的实例。如果对象不是指定类型或其子类型，则返回 `true`，否则返回 `false`。

**示例代码**：

```dart
class Animal {}
class Dog extends Animal {}

void main() {
  Dog dog = Dog();
  // 检查 dog 是否不是 Cat 类型的实例
  bool isNotCat = dog is! Cat; 
  print(isNotCat); // 输出: true
}
```

- **`is`和`is!`运算符**：检查对象是否为特定类型。

  ```dart
  Object obj = "Hello";
  if (obj is String) {
    print(obj.length); // 类型提升为String，可直接访问.length
  }
  ```

#### 2.3 `dynamic`类型

**`dynamic`类型**：绕过静态检查，允许任何操作，但运行时可能抛出错误。

```dart
dynamic value = "Hello";
value = 42;          // 合法（动态类型）
print(value + 10);   // 合法，但运行时若value非int会报错。
```

---

## 二、类型转换

类型转换是将对象从一种类型显式转换为另一种类型，需谨慎处理以避免运行时错误。

### 1. 显式转换（`as`关键字）

- **语法**：`对象 as 目标类型`
- **要求**：对象必须是目标类型的实例，否则抛出`TypeError`。

  ```dart
  Object obj = "Hello";
  String str = obj as String; // 合法，obj实际是String
  // int num = obj as int;    // 运行时错误：类型不匹配
  ```

### 2. 安全转换策略

- **结合`is`检查**：先检查类型，再转换。

  ```dart
  if (obj is String) {
    print(obj.length); // 自动提升为String，无需显式转换
  }
  ```

- **`try-catch`处理异常**：

  ```dart
  try {
    int num = obj as int;
  } catch (e) {
    print("转换失败: $e");
  }
  ```

### 3. 数值类型转换

- **int ↔ double**：需显式调用方法（无隐式转换）。

  ```dart
  int i = 42;
  double d = i.toDouble(); // int转double
  int j = d.toInt();      // double转int
  ```

### 4. 泛型类型转换

- **泛型擦除问题**：Dart的泛型在运行时类型参数会被擦除，无法直接检查泛型参数。

  ```dart
  List<Object> objList = ["a", "b"];
  // List<String> strList = objList as List<String>; // 运行时错误：类型不匹配
  List<String> strList = objList.cast<String>();    // 正确方式：遍历检查元素类型
  ```

### 5. 空安全类型转换

在 Dart 的空安全环境中，你可以使用 `as?` 操作符进行安全的类型转换。如果对象不能转换为指定类型，`as?` 操作符会返回 `null`，而不是抛出异常。

**示例代码**：

```dart
class Animal {}
class Dog extends Animal {
  void bark() {
    print('Woof!');
  }
}

void main() {
  Animal animal = Animal();
  Dog? dog = animal as? Dog;
  if (dog != null) {
    dog.bark();
  } else {
    print('animal 不是 Dog 类型的实例'); // 输出: animal 不是 Dog 类型的实例
  }
}
```

---

## 三、类型提升（Type Promotion）

Dart在条件判断后自动提升变量类型，无需显式转换。

```dart
void printLength(Object obj) {
  if (obj is String) {
    print(obj.length); // 此处obj类型提升为String
  }
}
```

---

## 四、常见错误与最佳实践

- **错误示例**：

  ```dart
  dynamic value = "Hello";
  int num = value as int; // 运行时TypeError
  ```

- **最佳实践**：
  1. 优先使用静态类型而非`dynamic`。
  2. 转换前用`is`检查类型。
  3. 处理泛型时使用`.cast<T>()`或显式遍历元素。

---

## **总结**

- **类型检查**：静态检查（编译时） + 运行时检查（`is`）。
- **类型转换**：用`as`显式转换，需确保类型兼容，否则可能会抛出 `CastError` 异常；使用 `as?` 操作符进行安全转换，转换失败时返回 `null`。通过结合类型检查和类型转换，可以更安全地处理不同类型的对象。
- **安全措施**：结合`is`检查、类型提升和异常处理，避免运行时错误。

通过合理使用这些机制，可以编写出既安全又灵活的Dart代码。
